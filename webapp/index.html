<!DOCTYPE html>
<html>
<head>
    <title>Retirement Planning System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Light theme (default) */
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #ecf0f1;
            --text-primary: #333;
            --text-secondary: #666;
            --text-light: #999;
            --header-bg: #2c3e50;
            --header-text: #ffffff;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --border-color: #ddd;
            --shadow: rgba(0,0,0,0.1);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --card-gradient-1: #667eea;
            --card-gradient-2: #764ba2;
        }

        body.dark-mode {
            /* Dark theme */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-light: #808080;
            --header-bg: #1f1f1f;
            --header-text: #ffffff;
            --accent-color: #4dabf7;
            --accent-hover: #339af0;
            --border-color: #404040;
            --shadow: rgba(0,0,0,0.3);
            --success-color: #51cf66;
            --warning-color: #ffd43b;
            --danger-color: #ff6b6b;
            --card-gradient-1: #5c7cfa;
            --card-gradient-2: #9775fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header .header-content {
            flex: 1;
        }

        header .settings-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--header-text);
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        header .settings-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #ecf0f1;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 500;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border: 1px solid var(--border-color);
            border-bottom: none;
            transition: all 0.3s;
        }

        .tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent-color);
            color: white;
            font-weight: 600;
            border-color: var(--accent-color);
        }

        .tab-content {
            display: none;
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            color: white;
        }
        
        .metric-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .metric-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .metric-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        
        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        button {
            background: var(--accent-color);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: var(--accent-hover);
        }

        button.secondary {
            background: var(--text-secondary);
        }

        button.secondary:hover {
            background: var(--text-primary);
        }

        button.ai-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-left: 10px;
        }

        button.ai-button:hover {
            background: linear-gradient(135deg, #5568d3 0%, #63408a 100%);
        }

        .action-items-list {
            list-style: none;
        }
        
        .action-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        
        .action-item.critical {
            border-left-color: #e74c3c;
        }
        
        .action-item.high {
            border-left-color: #e67e22;
        }
        
        .action-item.medium {
            border-left-color: #f39c12;
        }
        
        .action-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .action-item-category {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .action-item-priority {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-critical {
            background: #e74c3c;
            color: white;
        }
        
        .priority-high {
            background: #e67e22;
            color: white;
        }
        
        .priority-medium {
            background: #f39c12;
            color: white;
        }
        
        .analysis-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .analysis-section h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #ecf0f1;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
        }

        .chat-message.user {
            background: #3498db;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid #ddd;
        }

        .chat-message.error {
            background: #e74c3c;
            color: white;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            background: white;
            border-top: 1px solid #ddd;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 40px;
        }

        .chat-button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .chat-button:hover {
            background: #2980b9;
        }

        .chat-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .api-key-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #856404;
        }

        .api-key-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .api-key-input input {
            flex: 1;
        }

        .scenario-parameters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        .scenario-parameters h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        .slider-value {
            font-weight: 700;
            color: #3498db;
            font-size: 15px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            transition: background 0.3s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #2980b9;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
            transition: background 0.3s;
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: #2980b9;
        }

        .advanced-toggle {
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .advanced-parameters {
            display: none;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
        }

        .advanced-parameters.show {
            display: block;
        }

        .reset-button {
            background: #95a5a6;
            margin-top: 10px;
        }

        .reset-button:hover {
            background: #7f8c8d;
        }

        .auto-update-option {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-update-option input[type="checkbox"] {
            width: auto;
        }

        .assumptions-used {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .assumptions-used h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .assumptions-used p {
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .settings-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .settings-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px var(--shadow);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 20px 30px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            font-size: 22px;
            margin: 0;
        }

        .close-settings {
            background: transparent;
            color: var(--header-text);
            border: none;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-settings:hover {
            background: rgba(255,255,255,0.1);
        }

        .settings-body {
            padding: 30px;
        }

        .setting-group {
            margin-bottom: 30px;
        }

        .setting-group h3 {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .setting-item label {
            flex: 1;
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .setting-item .description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .setting-item select,
        .setting-item input[type="text"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            min-width: 150px;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.4s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .settings-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-reset {
            background: var(--danger-color);
        }

        .btn-reset:hover {
            background: #c82333;
        }

        /* Font Size Classes */
        body.font-small {
            font-size: 13px;
        }

        body.font-small h1 {
            font-size: 24px;
        }

        body.font-small h2 {
            font-size: 20px;
        }

        body.font-small h3 {
            font-size: 17px;
        }

        body.font-medium {
            font-size: 15px;
        }

        body.font-large {
            font-size: 17px;
        }

        body.font-large h1 {
            font-size: 32px;
        }

        body.font-large h2 {
            font-size: 26px;
        }

        body.font-large h3 {
            font-size: 22px;
        }

        /* Compact Mode */
        body.compact-mode .container {
            padding: 15px;
        }

        body.compact-mode header {
            padding: 15px;
            margin-bottom: 20px;
        }

        body.compact-mode .tab-content {
            padding: 20px;
        }

        body.compact-mode .metric-grid {
            gap: 15px;
            margin-bottom: 20px;
        }

        body.compact-mode .metric-card {
            padding: 15px;
        }

        body.compact-mode .analysis-section {
            padding: 15px;
            margin-bottom: 15px;
        }

        body.compact-mode .setting-item {
            padding: 10px;
            margin-bottom: 8px;
        }

        /* Disable Animations */
        body.no-animations * {
            animation: none !important;
            transition: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Retirement & Wealth Planning System</h1>
                <div class="subtitle">Comprehensive financial, tax, estate, and legacy planning</div>
            </div>
            <button class="settings-btn" onclick="openSettings()">
                <span>‚öôÔ∏è</span>
                <span>Settings</span>
            </button>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="showTab('profile')">Profile & Data</button>
            <button class="tab" onclick="showTab('accounts')">Withdrawal Strategy</button>
            <button class="tab" onclick="showTab('analysis')">Analysis</button>
            <button class="tab" onclick="showTab('comparison')">Compare Scenarios</button>
            <button class="tab" onclick="showTab('actions')">Action Items</button>
            <button class="tab" onclick="showTab('advisor')">AI Advisor</button>
        </div>
        
        <div id="dashboard-tab" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Financial Control Center</h2>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <select id="dashboard-profile-select" style="padding: 6px; font-size: 13px; border-radius: 4px; border: 1px solid #ddd; max-width: 200px;" onchange="if(this.value) loadProfile(this.value)">
                        <option value="" disabled selected>Load Profile...</option>
                    </select>
                    <div style="font-size: 13px; color: #666;">
                        <span id="dashboard-last-updated">Last updated: Never</span>
                    </div>
                </div>
            </div>

            <!-- Top Row: Key Metrics -->
            <div id="dashboard-metrics" class="metric-grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <!-- Populated by JS -->
            </div>

            <!-- NEW: Critical Actions Widget -->
            <div id="critical-actions-widget" style="display: none; margin-bottom: 20px; background: #fff5f5; border: 1px solid #feb2b2; border-radius: 8px; padding: 15px; border-left: 5px solid #f56565;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">‚ö†Ô∏è</span>
                        <div>
                            <strong style="color: #c53030;">Critical Actions Required</strong>
                            <p style="font-size: 12px; color: #742a2a; margin-top: 2px;" id="critical-actions-count">You have 0 urgent tasks pending.</p>
                        </div>
                    </div>
                    <button onclick="startWizard()" style="background: #f56565; color: white; padding: 8px 16px; font-size: 13px;">‚ö° Resolve Now</button>
                </div>
            </div>

            <!-- Middle Row: Main Chart -->
            <div class="analysis-section" style="padding: 20px; background: white; border: 1px solid #ddd; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">Wealth Timeline Projection</h4>
                    <div style="font-size: 12px; display: flex; gap: 15px;">
                        <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #3498db; border-radius: 50%;"></span> Median</span>
                        <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #2ecc71; border-radius: 50%;"></span> Best Case</span>
                        <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #e74c3c; border-radius: 50%;"></span> Worst Case</span>
                    </div>
                </div>
                <div style="height: 350px; position: relative;">
                    <canvas id="dashboard-chart"></canvas>
                </div>
            </div>

            <!-- Bottom Row: Quick Levers -->
            <div class="analysis-section" style="background: #f8f9fa; border-top: 4px solid #3498db;">
                <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    üéõÔ∏è Scenario Sandbox <span style="font-size: 12px; font-weight: normal; color: #666;">(Adjust to see immediate impact)</span>
                </h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                    <!-- Lever 1: Spending -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label for="db-spending" style="margin: 0;">Annual Spending</label>
                            <span style="font-weight: 700; color: #3498db;" id="db-spending-val">$100,000</span>
                        </div>
                        <input type="range" id="db-spending" min="40000" max="300000" step="1000" value="100000" style="width: 100%;">
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">Impacts portfolio depletion rate</div>
                    </div>

                    <!-- Lever 1b: Withdrawal Rate -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label for="db-withdraw-rate" style="margin: 0;">Initial Withdrawal Rate</label>
                            <span style="font-weight: 700; color: #3498db;" id="db-withdraw-rate-val">4.0%</span>
                        </div>
                        <input type="range" id="db-withdraw-rate" min="0" max="10" step="0.1" value="4.0" style="width: 100%;">
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">% of portfolio withdrawn in year 1</div>
                    </div>

                    <!-- Lever 2: Retirement Year (Person 1) -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label for="db-retire-year" style="margin: 0;"><span id="db-p1-label">Person 1</span> Retirement</label>
                            <span style="font-weight: 700; color: #3498db;" id="db-retire-year-val">2035</span>
                        </div>
                        <input type="range" id="db-retire-year" min="2024" max="2050" step="1" value="2035" style="width: 100%;">
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">Affects accumulation vs. withdrawal</div>
                    </div>

                    <!-- Lever 2b: Retirement Year (Person 2) -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label for="db-retire-year-p2" style="margin: 0;"><span id="db-p2-label">Person 2</span> Retirement</label>
                            <span style="font-weight: 700; color: #3498db;" id="db-retire-year-p2-val">2035</span>
                        </div>
                        <input type="range" id="db-retire-year-p2" min="2024" max="2050" step="1" value="2035" style="width: 100%;">
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">Affects accumulation vs. withdrawal</div>
                    </div>

                    <!-- Lever 3: Stock Allocation -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label for="db-allocation" style="margin: 0;">Stock Allocation</label>
                            <span style="font-weight: 700; color: #3498db;" id="db-allocation-val">50%</span>
                        </div>
                        <input type="range" id="db-allocation" min="0" max="100" step="5" value="50" style="width: 100%;">
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">Growth potential vs volatility</div>
                    </div>

                    <!-- Lever 4: Assumed Tax Rate -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label for="db-tax-rate" style="margin: 0;">Assumed Tax Rate</label>
                            <span style="font-weight: 700; color: #3498db;" id="db-tax-rate-val">22%</span>
                        </div>
                        <input type="range" id="db-tax-rate" min="0" max="40" step="1" value="22" style="width: 100%;">
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">Estimated effective tax drag on withdrawals</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="profile-tab" class="tab-content">
            <h2>Financial Profile</h2>
            
            <div style="background: #e8f4f8; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #bce0fd;">
                <h3 style="margin-bottom: 15px; color: #2980b9;">Profile Management</h3>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label style="font-size: 12px; display: block; margin-bottom: 5px;">Select Existing Profile</label>
                        <select id="profile-select" style="width: 100%; padding: 8px;" onchange="onProfileSelectChange()">
                            <option value="" disabled selected>Select a profile...</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: flex-end;">
                        <button class="secondary" style="background-color: #e74c3c; height: 38px; margin-top: 21px;" onclick="deleteSelectedProfile()">Delete</button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: flex-end; border-top: 1px dashed #bce0fd; padding-top: 15px;">
                    <div style="flex: 1;">
                        <label style="font-size: 12px; display: block; margin-bottom: 5px;">Profile Name (Save As...)</label>
                        <input type="text" id="profile-name-input" placeholder="e.g. 'Conservative Scenario', 'Main Plan'" style="width: 100%;">
                    </div>
                    <button onclick="saveCurrentProfile()" style="height: 38px;">Save Profile</button>
                </div>
            </div>

            <div class="form-section">
                <h3>You</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="p1-name" value="Person 1">
                    </div>
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="p1-birth" value="1970-01-01">
                    </div>
                    <div class="form-group">
                        <label>Retirement Date</label>
                        <input type="date" id="p1-retire" value="2035-01-01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Social Security (monthly)</label>
                        <input type="number" id="p1-ss" value="3000">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Spouse</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="p2-name" value="Person 2">
                    </div>
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="p2-birth" value="1972-01-01">
                    </div>
                    <div class="form-group">
                        <label>Retirement Date (age 55)</label>
                        <input type="date" id="p2-retire" value="2037-01-01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Social Security (monthly)</label>
                        <input type="number" id="p2-ss" value="2500">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Assets & Investments</h3>
                <p style="margin-bottom: 15px; font-size: 14px; color: #666;">
                    List all your investment holdings below. Categorize them by account type (e.g., Traditional IRA, Roth IRA) so we can apply the correct tax treatment.
                </p>
                
                <div style="overflow-x: auto;">
                    <table id="investment-types-table" style="margin-bottom: 15px;">
                        <thead>
                            <tr>
                                <th>Asset Name</th>
                                <th>Account Type</th>
                                <th>Value</th>
                                <th>Cost Basis</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="investment-types-body">
                            <!-- Rows rendered via JS -->
                        </tbody>
                        <tfoot>
                            <tr style="background: #f8f9fa;">
                                <td colspan="2"><strong>Grand Total</strong></td>
                                <td id="investment-total-value"><strong>$0.00</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div style="background: #f1f2f6; padding: 15px; border-radius: 4px; display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px;">
                    <div class="form-group" style="flex: 2; min-width: 200px;">
                        <label style="font-size: 12px;">Asset Name</label>
                        <input type="text" id="new-inv-class" placeholder="e.g., S&P 500 Index">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label style="font-size: 12px;">Account Type</label>
                        <select id="new-inv-account" onchange="highlightAccountFields()">
                            <option value="Liquid">Liquid (Cash/Brokerage)</option>
                            <option value="Traditional IRA">Traditional IRA</option>
                            <option value="401k">401(k)</option>
                            <option value="403b">403(b)</option>
                            <option value="401a">401(a)</option>
                            <option value="457b">457(b)</option>
                            <option value="Roth IRA">Roth IRA</option>
                            <option value="Pension">Pension Lump Sum</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label style="font-size: 12px;">Value ($)</label>
                        <input type="number" id="new-inv-value" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 100px;">
                        <label style="font-size: 12px;">Basis ($)</label>
                        <input type="number" id="new-inv-basis" placeholder="Optional">
                    </div>
                    <button id="add-inv-btn" class="secondary" onclick="addInvestmentType()" style="height: 42px;">Add</button>
                </div>

                <!-- NEW: Integrated Paste Area -->
                <div id="asset-paste-area" 
                     style="border: 2px dashed #9b59b6; border-radius: 8px; padding: 30px; text-align: center; background: #fdfaff; cursor: pointer; transition: all 0.3s; margin-bottom: 20px;"
                     onclick="document.getElementById('asset-image-upload').click()"
                     onmouseover="this.style.background='#f5eeff'"
                     onmouseout="this.style.background='#fdfaff'">
                    <div style="font-size: 24px; margin-bottom: 10px;">üìã</div>
                    <div style="font-weight: 600; color: #9b59b6;">Paste image here (Cmd+V) or Click to Upload</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Take a screenshot of your accounts and paste it here to sync balances instantly.</div>
                    <input type="file" id="asset-image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this.files[0])">
                </div>
            </div>
            
            <div class="form-section">
                <h3>Income Streams & Pensions</h3>
                <p style="margin-bottom: 15px; font-size: 14px; color: #666;">
                    Add fixed income sources like pensions, rental income, or annuities. (Social Security is calculated separately above).
                </p>
                
                <div style="overflow-x: auto;">
                    <table id="income-streams-table" style="margin-bottom: 15px;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Owner</th>
                                <th>Annual Amount</th>
                                <th>Start Date</th>
                                <th>Inflation Adj.</th>
                                <th>Survivor %</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="income-streams-body">
                            <!-- Rows rendered via JS -->
                        </tbody>
                        <tfoot>
                            <tr style="background: #f8f9fa;">
                                <td colspan="2"><strong>Total Annual Income</strong></td>
                                <td id="income-streams-total"><strong>$0.00</strong></td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div style="background: #f1f2f6; padding: 15px; border-radius: 4px; display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 2; min-width: 150px;">
                        <label style="font-size: 12px;">Name</label>
                        <input type="text" id="new-inc-name" placeholder="e.g. IBM Pension" oninput="highlightIncomeFields()">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label style="font-size: 12px;">Owner</label>
                        <select id="new-inc-owner" onchange="suggestIncomeStartDate()">
                            <option value="person1">Person 1</option>
                            <option value="person2">Person 2</option>
                            <option value="joint">Joint</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 100px;">
                        <label style="font-size: 12px;">Amount ($/yr)</label>
                        <input type="number" id="new-inc-amount" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label style="font-size: 12px;">Start Date</label>
                        <input type="date" id="new-inc-start">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 80px;">
                        <label style="font-size: 12px;">Survivor %</label>
                        <input type="number" id="new-inc-survivor" placeholder="100" min="0" max="100" value="100">
                    </div>
                    <div class="form-group" style="width: 80px; align-items: center;">
                        <label style="font-size: 12px; margin-bottom: 8px;">Inflation?</label>
                        <input type="checkbox" id="new-inc-inflation" checked style="width: 18px; height: 18px;">
                    </div>
                    <button id="add-inc-btn" class="secondary" onclick="addIncomeStream()" style="height: 42px;">Add</button>
                </div>
            </div>

            <div class="form-section">
                <h3>Expenses & Goals</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Current Annual Expenses</label>
                        <input type="number" id="expenses" value="100000">
                    </div>
                    <!-- Legacy Pension Field (Hidden or Read-only if needed, kept for backward compat) -->
                    <div class="form-group" style="display:none;">
                        <label>Annual Pension Income (Legacy)</label>
                        <input type="number" id="pension-annual" value="0">
                    </div>
                    <div class="form-group">
                        <label>Target Retirement Income (Net)</label>
                        <input type="number" id="target-income" value="150000">
                    </div>
                    <div class="form-group">
                        <label>Risk Tolerance</label>
                        <select id="risk">
                            <option value="conservative">Conservative</option>
                            <option value="moderate" selected>Moderate</option>
                            <option value="aggressive">Aggressive</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="accounts-tab" class="tab-content">
            <h2>Tax-Efficient Withdrawal Strategy</h2>
            <p style="color: #666; margin-bottom: 30px;">Optimize the order and timing of withdrawals to minimize lifetime taxes and maximize wealth transfer.</p>

            <div class="analysis-section" style="background: #e8f4f8; border-left: 4px solid #3498db;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üìä Current Account Balances</h3>
                <div id="account-balances-summary"></div>
            </div>

            <div class="analysis-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üéØ Recommended Withdrawal Sequence</h3>
                <p style="margin-bottom: 20px; line-height: 1.6;">For <strong>tax efficiency</strong>, withdraw in this order to minimize taxes and preserve Roth accounts for wealth transfer:</p>

                <div style="display: grid; gap: 15px;">
                    <div style="padding: 15px; background: #f8f9fa; border-left: 4px solid #27ae60; border-radius: 4px;">
                        <div style="font-weight: 700; color: #2c3e50; margin-bottom: 5px;">1Ô∏è‚É£ Taxable Accounts (Liquid Assets) ‚Äî FIRST</div>
                        <div style="font-size: 13px; color: #555; line-height: 1.6;">
                            <strong>Why:</strong> Taxed at lower capital gains rates (0-20%) vs ordinary income rates (10-37%). Use these before age 73 to delay RMDs and allow tax-deferred accounts to grow. Creates "tax-free" space for Roth conversions.
                        </div>
                    </div>

                    <div style="padding: 15px; background: #f8f9fa; border-left: 4px solid #3498db; border-radius: 4px;">
                        <div style="font-weight: 700; color: #2c3e50; margin-bottom: 5px;">1.5Ô∏è‚É£ 457(b) Governmental Plans ‚Äî EARLY OPTION</div>
                        <div style="font-size: 13px; color: #555; line-height: 1.6;">
                            <strong>Why:</strong> Unique benefit: No 10% early withdrawal penalty regardless of age (once separated from service). If you retire before 59.5, use this <em>before</em> your IRAs/401ks to bridge the gap.
                        </div>
                    </div>

                    <div style="padding: 15px; background: #f8f9fa; border-left: 4px solid #f39c12; border-radius: 4px;">
                        <div style="font-weight: 700; color: #2c3e50; margin-bottom: 5px;">2Ô∏è‚É£ Traditional IRA / 401(k) / 403(b) / 401(a) ‚Äî SECOND</div>
                        <div style="font-size: 13px; color: #555; line-height: 1.6;">
                            <strong>Why:</strong> Withdrawals taxed as ordinary income. Start taking strategic withdrawals after liquid is depleted to "fill up" lower tax brackets (12%, 22%). Warning: 10% penalty if under age 59.5 (unless using Rule of 55). At age 73, RMDs force withdrawals.
                        </div>
                        <div id="rmd-info" style="margin-top: 10px; padding: 10px; background: white; border-radius: 3px; font-size: 12px;"></div>
                    </div>

                    <div style="padding: 15px; background: #f8f9fa; border-left: 4px solid #9b59b6; border-radius: 4px;">
                        <div style="font-weight: 700; color: #2c3e50; margin-bottom: 5px;">3Ô∏è‚É£ Roth IRA ‚Äî LAST (Preserve for Heirs)</div>
                        <div style="font-size: 13px; color: #555; line-height: 1.6;">
                            <strong>Why:</strong> Tax-free withdrawals with no RMDs during your lifetime. Let this grow tax-free as long as possible. Excellent for wealth transfer - heirs get tax-free inherited Roth IRA. Only use if other accounts depleted or for strategic tax management.
                        </div>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üí° Tax Optimization Strategies</h3>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">Roth Conversions (Age 62-73)</h4>
                        <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Convert Traditional IRA ‚Üí Roth IRA before RMDs begin:</p>
                        <ul style="font-size: 13px; color: #555; margin-left: 20px; line-height: 1.8;">
                            <li>Fill 12% tax bracket (~$94k income)</li>
                            <li>Pay taxes now at low rates vs higher rates later</li>
                            <li>Reduces future RMDs</li>
                            <li>Creates tax-free growth</li>
                        </ul>
                        <div id="roth-conversion-suggestion" style="margin-top: 10px; padding: 8px; background: white; border-radius: 3px; font-size: 12px;"></div>
                    </div>

                    <div style="padding: 15px; background: #d1ecf1; border-radius: 4px; border: 1px solid #17a2b8;">
                        <h4 style="color: #0c5460; margin-bottom: 10px;">QCDs (Age 70.5+)</h4>
                        <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Qualified Charitable Distributions:</p>
                        <ul style="font-size: 13px; color: #555; margin-left: 20px; line-height: 1.8;">
                            <li>Direct IRA ‚Üí charity (up to $105k/year in 2024)</li>
                            <li>Counts toward RMD but excluded from taxable income</li>
                            <li>Reduces AGI (helps avoid IRMAA surcharges)</li>
                            <li>More tax-efficient than itemized deduction</li>
                        </ul>
                    </div>

                    <div style="padding: 15px; background: #d4edda; border-radius: 4px; border: 1px solid #28a745;">
                        <h4 style="color: #155724; margin-bottom: 10px;">Tax Bracket Management</h4>
                        <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Strategic annual planning:</p>
                        <ul style="font-size: 13px; color: #555; margin-left: 20px; line-height: 1.8;">
                            <li>"Fill" 12% and 22% brackets each year</li>
                            <li>Avoid IRMAA thresholds (Medicare surcharges)</li>
                            <li>Consider state income taxes</li>
                            <li>Time capital gains with low-income years</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üßÆ RMD Calculator</h3>
                <div id="rmd-calculator"></div>
            </div>

            <div class="analysis-section" style="background: #fff9e6; border-left: 4px solid #f39c12;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">‚ö†Ô∏è Common Withdrawal Mistakes to Avoid</h3>
                <div style="display: grid; gap: 10px;">
                    <div style="padding: 10px; background: white; border-radius: 3px;">
                        <strong style="color: #c0392b;">‚ùå Withdrawing from Roth first</strong> ‚Äî Loses tax-free growth and wealth transfer benefits
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 3px;">
                        <strong style="color: #c0392b;">‚ùå Ignoring Roth conversions before RMDs</strong> ‚Äî Miss 11-year window (62-73) for tax arbitrage
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 3px;">
                        <strong style="color: #c0392b;">‚ùå Large IRA withdrawals pushing into high brackets</strong> ‚Äî Can trigger 22-24% rates unnecessarily
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 3px;">
                        <strong style="color: #c0392b;">‚ùå Not planning for IRMAA</strong> ‚Äî High income years (age 63+) increase Medicare premiums 2 years later
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; font-size: 13px; color: #666;">
                <strong>üìö Resources:</strong>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li><a href="https://www.irs.gov/retirement-plans/plan-participant-employee/retirement-topics-required-minimum-distributions-rmds" target="_blank">IRS RMD Rules</a></li>
                    <li><a href="https://www.irs.gov/retirement-plans/retirement-plans-faqs-regarding-iras-distributions-withdrawals" target="_blank">IRA Distribution Rules</a></li>
                    <li><a href="https://www.medicare.gov/your-medicare-costs/part-b-costs" target="_blank">Medicare IRMAA Thresholds</a></li>
                </ul>
            </div>
        </div>

        <div id="analysis-tab" class="tab-content">
            <h2>Financial Analysis</h2>

            <div class="scenario-parameters">
                <h3>Scenario Parameters</h3>

                <div class="slider-group">
                    <label>
                        <span>Stock Allocation: <span class="slider-value" id="stocks-value">50</span>% (Bonds: <span id="bonds-value">50</span>%)</span>
                    </label>
                    <input type="range" id="stocks-slider" min="0" max="100" value="50" step="5">
                </div>

                <div class="slider-group">
                    <label>
                        <span>Stock Return Rate: <span class="slider-value" id="stock-return-value">10.00</span>%</span>
                    </label>
                    <input type="range" id="stock-return-slider" min="4" max="15" value="10" step="0.25">
                </div>

                <div class="slider-group">
                    <label>
                        <span>Bond Return Rate: <span class="slider-value" id="bond-return-value">4.00</span>%</span>
                    </label>
                    <input type="range" id="bond-return-slider" min="2" max="8" value="4" step="0.25">
                </div>

                <div class="slider-group">
                    <label>
                        <span>Inflation Rate: <span class="slider-value" id="inflation-value">3.00</span>%</span>
                    </label>
                    <input type="range" id="inflation-slider" min="0" max="6" value="3" step="0.25">
                </div>

                <div class="advanced-toggle">
                    <button class="secondary" onclick="toggleAdvanced()">Show Advanced Parameters</button>
                </div>

                <div class="advanced-parameters" id="advanced-parameters">
                    <div class="slider-group">
                        <label>
                            <span>Stock Volatility (Std Dev): <span class="slider-value" id="stock-volatility-value">18.00</span>%</span>
                        </label>
                        <input type="range" id="stock-volatility-slider" min="5" max="30" value="18" step="0.5">
                    </div>

                    <div class="slider-group">
                        <label>
                            <span>Bond Volatility (Std Dev): <span class="slider-value" id="bond-volatility-value">6.00</span>%</span>
                        </label>
                        <input type="range" id="bond-volatility-slider" min="2" max="12" value="6" step="0.5">
                    </div>

                    <div class="slider-group">
                        <label>
                            <span>Inflation Volatility (Std Dev): <span class="slider-value" id="inflation-volatility-value">1.00</span>%</span>
                        </label>
                        <input type="range" id="inflation-volatility-slider" min="0" max="3" value="1" step="0.25">
                    </div>

                    <div class="slider-group">
                        <label>
                            <span>Social Security Discount Rate: <span class="slider-value" id="ss-discount-value">3.00</span>%</span>
                        </label>
                        <input type="range" id="ss-discount-slider" min="0" max="8" value="3" step="0.25">
                    </div>
                </div>

                <div class="auto-update-option">
                    <input type="checkbox" id="auto-update-checkbox">
                    <label for="auto-update-checkbox" style="margin: 0;">Auto-update analysis when sliders change</label>
                </div>

                <button class="reset-button" onclick="resetToDefaults()">Reset to Defaults</button>
            </div>

            <div style="margin-bottom: 20px;">
                <button onclick="runAnalysis()">Run Complete Analysis</button>
                <button class="ai-button" onclick="getAIRecommendations()">ü§ñ AI Recommendations</button>
            </div>
            <div id="ai-recommendations" style="margin-bottom: 20px;"></div>
            <div id="analysis-results"></div>
        </div>

        <div id="comparison-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Compare Scenarios</h2>
                <button onclick="refreshScenarios()" class="secondary">Refresh List</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Saved Scenarios</h3>
                    <div id="scenarios-list" style="max-height: 400px; overflow-y: auto;">
                        <!-- List of scenarios -->
                        <div class="loading">Loading scenarios...</div>
                    </div>
                </div>
                
                <div>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">Comparison Charts</h3>
                        <div style="height: 300px; margin-bottom: 30px;">
                            <canvas id="comparison-chart-bar"></canvas>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="comparison-chart-line"></canvas>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">Assumption Comparison</h3>
                        <div style="overflow-x: auto;">
                            <table id="comparison-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">
                                        <th style="padding: 10px; text-align: left;">Parameter</th>
                                        <!-- Scenario columns added by JS -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows added by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="actions-tab" class="tab-content">
            <h2>Action Items</h2>
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button onclick="startWizard()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">‚ú® Start Wizard</button>
                <button class="secondary" onclick="loadActionItems()">Refresh</button>
                <button class="secondary" onclick="generateActionItems()">Auto-Generate Items</button>
                <button class="secondary" onclick="runSelfAssessment()" style="background: #9b59b6;">Run AI Self-Assessment</button>
                <button class="secondary" onclick="cleanupActionItems()" style="background: #95a5a6;">Cleanup Duplicates</button>
            </div>
            <ul id="action-items-list" class="action-items-list"></ul>
        </div>

        <div id="advisor-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>AI Financial Advisor</h2>
                <div id="active-llm-indicator" style="font-size: 13px; padding: 4px 10px; background: var(--bg-tertiary); border-radius: 20px; border: 1px solid var(--border-color); color: var(--text-secondary);">
                    Provider: <span id="current-llm-name" style="font-weight: 600; color: var(--accent-color);">Gemini</span>
                </div>
            </div>
            <p style="margin-bottom: 20px; color: #555;">
                Ask questions about your retirement plan, get personalized advice, and explore different scenarios.
                The AI advisor has full access to your financial profile and analysis results.
            </p>

            <div id="api-key-notice" class="api-key-notice" style="display: none;">
                <strong>API Key Required:</strong> To use the AI Advisor, please configure your API keys in the ‚öôÔ∏è Settings menu.
                <button class="secondary" onclick="openSettings()" style="margin-top: 10px; display: block;">Open Settings</button>
            </div>

            <div id="api-key-status" style="margin-bottom: 15px;">
                <button onclick="clearConversation()" class="secondary">Clear Conversation</button>
            </div>

            <div class="chat-container">
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <textarea
                        id="chat-input"
                        class="chat-input"
                        placeholder="Ask me anything about your retirement plan..."
                        onkeydown="handleChatKeypress(event)"></textarea>
                    <button id="send-button" class="chat-button" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        const API_URL = '/api';
        let investmentTypes = [
            { name: 'Checking Account', account: 'Liquid', value: 25000, change: 0 },
            { name: 'Savings/HYSA', account: 'Liquid', value: 75000, change: 0 },
            { name: '401k (Vanguard)', account: 'Traditional IRA', value: 2800000, change: 0 },
            { name: 'Roth IRA (Fidelity)', account: 'Roth IRA', value: 850000, change: 0 }
        ];
        let incomeStreams = [];
        let accounts = []; // Legacy support for profile data structure
        let editingIncomeIndex = -1;

        function getCurrentProfileName() {
            return document.getElementById('profile-name-input').value || 'main';
        }

        function highlightIncomeFields() {
            const name = document.getElementById('new-inc-name').value.toLowerCase();
            const survivorInput = document.getElementById('new-inc-survivor');
            const survivorGroup = survivorInput.parentElement;

            if (name.includes('pension')) {
                survivorInput.style.borderColor = '#3498db';
                if (!document.getElementById('survivor-note')) {
                    const note = document.createElement('div');
                    note.id = 'survivor-note';
                    note.style.fontSize = '10px';
                    note.style.color = '#3498db';
                    note.style.marginTop = '2px';
                    note.textContent = "Check survivor options";
                    survivorGroup.appendChild(note);
                }
            } else {
                survivorInput.style.borderColor = '#ddd';
                const note = document.getElementById('survivor-note');
                if (note) note.remove();
            }
        }

        // --- Income Stream Functions ---

        function updateIncomeOwnerLabels() {
            const person1Name = document.getElementById('p1-name').value || 'Person 1';
            const person2Name = document.getElementById('p2-name').value || 'Person 2';
            const select = document.getElementById('new-inc-owner');
            if (select) {
                select.options[0].text = person1Name;
                select.options[1].text = person2Name;
            }
        }

        function renderIncomeStreams() {
            const tbody = document.getElementById('income-streams-body');
            tbody.innerHTML = '';

            let totalValue = 0;

            incomeStreams.forEach((item, index) => {
                totalValue += item.amount;

                const tr = document.createElement('tr');
                if (index === editingIncomeIndex) {
                    tr.style.backgroundColor = '#fff3cd';
                }

                // Use actual person names from profile
                const person1Name = document.getElementById('p1-name').value || 'Person 1';
                const person2Name = document.getElementById('p2-name').value || 'Person 2';
                const ownerLabel = item.owner === 'person1' ? person1Name : item.owner === 'person2' ? person2Name : 'Joint';
                const survivorPct = item.survivor_benefit !== undefined ? item.survivor_benefit : 100;
                
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td><span style="padding: 2px 6px; background: #e8f4f8; border-radius: 4px; font-size: 12px; color: #2980b9;">${ownerLabel}</span></td>
                    <td>$${item.amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${item.start_date}</td>
                    <td>${item.inflation_adjusted ? '‚úÖ' : '‚ùå'}</td>
                    <td>${survivorPct}%</td>
                    <td>
                        <button onclick="editIncomeStream(${index})" style="padding: 5px 10px; background: #f39c12; color: white; border: none; border-radius: 3px; font-size: 12px; margin-right: 5px; cursor: pointer;">Edit</button>
                        <button onclick="deleteIncomeStream(${index})" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; font-size: 12px; cursor: pointer;">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('income-streams-total').innerHTML = `<strong>$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>`;
        }

        function suggestIncomeStartDate() {
            const owner = document.getElementById('new-inc-owner').value;
            let dateFieldId = '';
            
            if (owner === 'person1') {
                dateFieldId = 'p1-retire';
            } else if (owner === 'person2') {
                dateFieldId = 'p2-retire';
            } else {
                dateFieldId = 'p1-retire'; // Default joint to p1
            }
            
            const retireDate = document.getElementById(dateFieldId).value;
            if (retireDate) {
                document.getElementById('new-inc-start').value = retireDate;
            }
        }

        function addIncomeStream() {
            const nameInput = document.getElementById('new-inc-name');
            const ownerInput = document.getElementById('new-inc-owner');
            const amountInput = document.getElementById('new-inc-amount');
            const startInput = document.getElementById('new-inc-start');
            const inflationInput = document.getElementById('new-inc-inflation');
            const survivorInput = document.getElementById('new-inc-survivor');
            
            const name = nameInput.value.trim();
            const owner = ownerInput.value;
            const amount = parseFloat(amountInput.value);
            const start_date = startInput.value;
            const inflation_adjusted = inflationInput.checked;
            const survivor_benefit = survivorInput.value ? parseFloat(survivorInput.value) : 100;
            
            if (!name || isNaN(amount) || !start_date) {
                alert('Please enter valid name, amount, and start date');
                return;
            }
            
            if (editingIncomeIndex > -1) {
                // Update existing
                incomeStreams[editingIncomeIndex] = { name, owner, amount, start_date, inflation_adjusted, survivor_benefit };
                editingIncomeIndex = -1;
                document.getElementById('add-inc-btn').textContent = 'Add';
            } else {
                // Add new
                incomeStreams.push({ name, owner, amount, start_date, inflation_adjusted, survivor_benefit });
            }

            renderIncomeStreams();
            debouncedAutoSave(); // Auto-save after adding/editing income stream

            // Clear inputs
            nameInput.value = '';
            amountInput.value = '';
            survivorInput.value = '100';
            nameInput.focus();
        }

        function editIncomeStream(index) {
            const item = incomeStreams[index];
            document.getElementById('new-inc-name').value = item.name;
            document.getElementById('new-inc-owner').value = item.owner;
            document.getElementById('new-inc-amount').value = item.amount;
            document.getElementById('new-inc-start').value = item.start_date;
            document.getElementById('new-inc-inflation').checked = item.inflation_adjusted;
            document.getElementById('new-inc-survivor').value = item.survivor_benefit !== undefined ? item.survivor_benefit : 100;
            
            editingIncomeIndex = index;
            document.getElementById('add-inc-btn').textContent = 'Update';
            renderIncomeStreams();
        }

        function deleteIncomeStream(index) {
            if (confirm('Remove this income stream?')) {
                if (index === editingIncomeIndex) {
                    editingIncomeIndex = -1;
                    document.getElementById('add-inc-btn').textContent = 'Add';
                } else if (index < editingIncomeIndex) {
                    editingIncomeIndex--;
                }
                incomeStreams.splice(index, 1);
                renderIncomeStreams();
                debouncedAutoSave(); // Auto-save after deleting income stream
            }
        }

        // Render Withdrawal Strategy tab with user's data
        function renderWithdrawalStrategy() {
            // Get current account balances from investment types
            let liquid = 0;
            let tradIra = 0;
            let rothIra = 0;
            let pension = 0;

            investmentTypes.forEach(item => {
                if (item.account === 'Liquid') liquid += item.value;
                else if (item.account === 'Traditional IRA' || item.account === '401k' || item.account === '403b' || item.account === '401a' || item.account === '457b') tradIra += item.value;
                else if (item.account === 'Roth IRA') rothIra += item.value;
                else if (item.account === 'Pension') pension += item.value;
                else if (item.name === 'Cash') liquid += item.value;
                else tradIra += item.value;
            });

            const totalAssets = liquid + tradIra + rothIra + pension;

            // Render account balances summary
            const balancesHtml = `
                <div class="metric-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #ddd;">
                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">üíµ Liquid/Taxable</div>
                        <div style="font-size: 20px; font-weight: 700; color: #27ae60;">$${liquid.toLocaleString()}</div>
                        <div style="font-size: 11px; color: #999; margin-top: 3px;">${totalAssets > 0 ? ((liquid / totalAssets) * 100).toFixed(1) : 0}% of total</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #ddd;">
                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">üè¶ Traditional IRA/401(k)</div>
                        <div style="font-size: 20px; font-weight: 700; color: #e67e22;">$${tradIra.toLocaleString()}</div>
                        <div style="font-size: 11px; color: #999; margin-top: 3px;">${totalAssets > 0 ? ((tradIra / totalAssets) * 100).toFixed(1) : 0}% of total</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #ddd;">
                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">üíé Roth IRA</div>
                        <div style="font-size: 20px; font-weight: 700; color: #9b59b6;">$${rothIra.toLocaleString()}</div>
                        <div style="font-size: 11px; color: #999; margin-top: 3px;">${totalAssets > 0 ? ((rothIra / totalAssets) * 100).toFixed(1) : 0}% of total</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #ddd;">
                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">üìä Total Assets</div>
                        <div style="font-size: 20px; font-weight: 700; color: #2c3e50;">$${totalAssets.toLocaleString()}</div>
                        <div style="font-size: 11px; color: #999; margin-top: 3px;">All retirement accounts</div>
                    </div>
                </div>
            `;
            document.getElementById('account-balances-summary').innerHTML = balancesHtml;

            // Calculate RMD info
            const p1BirthDate = new Date(document.getElementById('p1-birth').value || '1965-03-24');
            const ageNow = (new Date() - p1BirthDate) / (365.25 * 24 * 60 * 60 * 1000);
            const yearsUntilRMD = Math.max(0, 73 - ageNow);
            const ageAtRMD = Math.ceil(ageNow + yearsUntilRMD);

            let rmdHtml = '';
            if (yearsUntilRMD > 0) {
                rmdHtml = `<strong style="color: #27ae60;">‚úì You have ${Math.floor(yearsUntilRMD)} years until RMDs begin (age 73)</strong><br>
                           This is your <strong>Roth conversion window</strong> - convert Traditional IRA to Roth at low tax rates before RMDs force withdrawals.`;
            } else {
                const rmdFactor = ageAtRMD >= 73 ? (27.4 - (ageAtRMD - 73) * 1.0) : 27.4;
                const estimatedRMD = tradIra / rmdFactor;
                rmdHtml = `<strong style="color: #e67e22;">‚ö†Ô∏è RMDs have begun (age ${Math.floor(ageNow)})</strong><br>
                           Estimated RMD this year: <strong>$${estimatedRMD.toLocaleString(undefined, {maximumFractionDigits: 0})}</strong> (must withdraw annually)`;
            }
            document.getElementById('rmd-info').innerHTML = rmdHtml;

            // Roth conversion suggestion
            if (window.currentAnalysis && window.currentAnalysis.roth_conversion) {
                const roth = window.currentAnalysis.roth_conversion;
                let rothSuggestion = '';
                if (roth.opportunity === 'excellent') {
                    rothSuggestion = `<strong style="color: #27ae60;">‚úì Based on your analysis:</strong><br>
                                     Convert $${roth.annual_conversion_12_bracket?.toLocaleString() || 'N/A'}/year for ${roth.conversion_years} years<br>
                                     Tax cost: ~$${roth.tax_cost_12?.toLocaleString() || 'N/A'} (${((roth.tax_cost_12 / roth.total_convertible_12) * 100).toFixed(1)}% effective rate)`;
                } else {
                    rothSuggestion = `Run analysis to see your Roth conversion opportunity`;
                }
                document.getElementById('roth-conversion-suggestion').innerHTML = rothSuggestion;
            }

            // RMD Calculator
            let rmdCalcHtml = '<table style="font-size: 13px; width: 100%; border-collapse: collapse;"><thead><tr style="background: #f1f2f6;"><th style="padding: 8px; text-align: left;">Age</th><th style="padding: 8px; text-align: right;">Life Expectancy Factor</th><th style="padding: 8px; text-align: right;">Est. RMD Amount</th><th style="padding: 8px; text-align: right;">% of Account</th></tr></thead><tbody>';

            for (let age = 73; age <= 85; age++) {
                const factor = 27.4 - (age - 73) * 1.0;
                const rmd = tradIra / factor;
                const pct = (rmd / tradIra) * 100;
                rmdCalcHtml += `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 8px;">${age}</td><td style="padding: 8px; text-align: right;">${factor.toFixed(1)}</td><td style="padding: 8px; text-align: right; font-weight: 600;">$${rmd.toLocaleString(undefined, {maximumFractionDigits: 0})}</td><td style="padding: 8px; text-align: right;">${pct.toFixed(2)}%</td></tr>`;
            }
            rmdCalcHtml += '</tbody></table>';
            rmdCalcHtml += '<p style="margin-top: 10px; font-size: 12px; color: #666;">Note: RMD factors decrease each year (you must withdraw larger % as you age). Calculated using 2024 Uniform Lifetime Table.</p>';
            document.getElementById('rmd-calculator').innerHTML = rmdCalcHtml;
        }

        async function handleImageUpload(file) {
            if (!file) return;

            // Check API Key
            const apiKey = checkApiKey();
            if (!apiKey) {
                alert("Please set your API Keys in Settings to use image extraction.");
                openSettings();
                return;
            }

            const pasteArea = document.getElementById('asset-paste-area');
            const originalHtml = pasteArea.innerHTML;
            pasteArea.style.borderColor = "#3498db";
            pasteArea.innerHTML = `
                <div class="loading" style="padding: 0;">
                    <div style="font-size: 24px; margin-bottom: 10px;">ü§ñ</div>
                    <div style="font-weight: 600; color: #3498db;">Analyzing Screenshot...</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">This usually takes 3-5 seconds.</div>
                </div>
            `;

            try {
                const base64Image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Send existing assets to preserve field values (especially account types)
                const existing_assets = investmentTypes.map(asset => ({
                    name: asset.name,
                    type: asset.account,  // Maps to backend 'type' field
                    value: asset.value,
                    cost_basis: asset.cost_basis || 0
                }));

                const response = await fetch(`${API_URL}/extract-assets`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        image: base64Image,
                        api_key: apiKey,
                        llm_provider: localStorage.getItem('default_llm') || 'gemini',
                        existing_assets: existing_assets
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    if (data.assets && data.assets.length > 0) {
                        applyExtractedAssets(data.assets);
                    } else {
                        alert("No assets could be identified in the image.");
                    }
                } else {
                    alert("Error extracting assets: " + (data.error || "Unknown error"));
                }

            } catch (error) {
                console.error("Image upload error:", error);
                alert("Failed to process image: " + error.message);
            } finally {
                pasteArea.style.borderColor = "#9b59b6";
                pasteArea.innerHTML = originalHtml;
                document.getElementById('asset-image-upload').value = ''; // Reset
            }
        }

        function applyExtractedAssets(assets) {
            const updates = [];
            const adds = [];
            const matches = [];

            assets.forEach(extracted => {
                const value = parseFloat(extracted.value) || 0;
                if (value <= 0) return;

                // Simple name matching (case-insensitive, trimmed)
                const existing = investmentTypes.find(i => 
                    i.name.toLowerCase().trim() === extracted.name.toLowerCase().trim()
                );

                if (existing) {
                    if (Math.abs(existing.value - value) > 0.01) {
                        updates.push({
                            original: existing,
                            newName: extracted.name,
                            newValue: value,
                            type: extracted.type || existing.account
                        });
                    } else {
                        matches.push(existing.name);
                    }
                } else {
                    adds.push(extracted);
                }
            });

            if (updates.length === 0 && adds.length === 0) {
                alert(`Reconciliation complete: All ${matches.length} accounts in the image already match your profile.`);
                return;
            }

            // Build Confirmation Message
            let msg = "üìä Portfolio Reconciliation\n\n";
            
            if (updates.length > 0) {
                msg += "Update Existing Balances:\n";
                updates.forEach(u => {
                    msg += `‚Ä¢ ${u.original.name}: $${u.original.value.toLocaleString()} ‚Üí $${u.newValue.toLocaleString()}\n`;
                });
                msg += "\n";
            }

            if (adds.length > 0) {
                msg += "Add New Accounts:\n";
                adds.forEach(a => {
                    msg += `‚Ä¢ ${a.name} (${a.type}): $${parseFloat(a.value).toLocaleString()}\n`;
                });
                msg += "\n";
            }

            if (matches.length > 0) {
                msg += `(${matches.length} other accounts already matched perfectly)\n\n`;
            }

            msg += "Apply these changes?";

            if (confirm(msg)) {
                // Perform Updates
                // Backend has already merged data properly, so trust the type it returns
                updates.forEach(u => {
                    u.original.value = u.newValue;
                    // Only update type if backend provided one (it preserves existing types when image doesn't show type)
                    if (u.type) {
                        u.original.account = u.type;
                    }
                });

                // Perform Adds
                // Backend already provided correct type (either from image or defaulted to Liquid)
                adds.forEach(a => {
                    investmentTypes.push({
                        name: a.name,
                        account: a.type || 'Liquid',  // Trust backend's type determination
                        value: parseFloat(a.value),
                        cost_basis: parseFloat(a.cost_basis) || 0  // Preserve cost_basis if provided
                    });
                });

                renderInvestmentTypes();
                
                // Final Check: Are there accounts in our list NOT in the image?
                const extractedNames = assets.map(a => a.name.toLowerCase().trim());
                const missingInImage = investmentTypes.filter(i => 
                    !extractedNames.includes(i.name.toLowerCase().trim())
                );

                if (missingInImage.length > 0) {
                    const removeMsg = `The image did not contain ${missingInImage.length} accounts currently in your profile:\n` +
                        missingInImage.map(m => `‚Ä¢ ${m.name}`).join('\n') +
                        `\n\nShould these be DELETED (assuming the image is your complete portfolio)? \n\nClick CANCEL to keep them, or OK to delete.`;

                    if (confirm(removeMsg)) {
                        missingInImage.forEach(m => {
                            const idx = investmentTypes.indexOf(m);
                            if (idx > -1) investmentTypes.splice(idx, 1);
                        });
                        renderInvestmentTypes();
                    }
                }

                debouncedAutoSave(); // Auto-save after asset extraction
                alert("‚úÖ Portfolio synchronized successfully.");
            }
        }

        // Add paste event listener to the container
        document.addEventListener('paste', (event) => {
            // Only handle if we are on the profile tab
            if (!document.getElementById('profile-tab').classList.contains('active')) return;
            
            const clipboardData = event.clipboardData || (event.originalEvent ? event.originalEvent.clipboardData : null);
            if (!clipboardData) return;

            const items = clipboardData.items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    handleImageUpload(blob);
                    event.preventDefault(); 
                    return;
                }
            }
        });

        // Add Drag and Drop support
        window.addEventListener('DOMContentLoaded', () => {
            const pasteArea = document.getElementById('asset-paste-area');
            if (!pasteArea) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                pasteArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                pasteArea.addEventListener(eventName, () => {
                    pasteArea.style.background = '#f5eeff';
                    pasteArea.style.borderColor = '#3498db';
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                pasteArea.addEventListener(eventName, () => {
                    pasteArea.style.background = '#fdfaff';
                    pasteArea.style.borderColor = '#9b59b6';
                }, false);
            });

            pasteArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files && files[0]) {
                    handleImageUpload(files[0]);
                }
            }, false);
        });

        function highlightAccountFields() {
            const type = document.getElementById('new-inv-account').value;
            const basisInput = document.getElementById('new-inv-basis');
            const basisGroup = basisInput.parentElement;
            
            // Reset styles
            basisInput.style.borderColor = '#ddd';
            basisGroup.style.opacity = '1';

            if (type === 'Liquid') {
                basisInput.style.borderColor = '#3498db';
                basisInput.placeholder = "Enter Basis";
                // Add a small tooltip-like note if not exists
                if (!document.getElementById('basis-note')) {
                    const note = document.createElement('div');
                    note.id = 'basis-note';
                    note.style.fontSize = '10px';
                    note.style.color = '#3498db';
                    note.style.marginTop = '2px';
                    note.textContent = "Required for capital gains calc";
                    basisGroup.appendChild(note);
                }
            } else {
                basisInput.placeholder = "Optional";
                const note = document.getElementById('basis-note');
                if (note) note.remove();
            }
        }

        // State for editing
        let editingIndex = -1;

        function renderInvestmentTypes() {
            const tbody = document.getElementById('investment-types-body');
            tbody.innerHTML = '';
            
            const totalValue = investmentTypes.reduce((sum, item) => sum + item.value, 0);
            
            investmentTypes.forEach((item, index) => {
                const account = item.account || 'Unspecified';
                
                const tr = document.createElement('tr');
                if (index === editingIndex) {
                    tr.style.backgroundColor = '#fff3cd'; // Highlight row being edited
                }
                
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td><span style="padding: 2px 6px; background: #e8f4f8; border-radius: 4px; font-size: 12px; color: #2980b9;">${account}</span></td>
                    <td>$${item.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${item.cost_basis ? '$' + item.cost_basis.toLocaleString() : '-'}</td>
                    <td>
                        <button onclick="editInvestmentType(${index})" style="padding: 5px 10px; background: #f39c12; color: white; border: none; border-radius: 3px; font-size: 12px; margin-right: 5px; cursor: pointer;">Edit</button>
                        <button onclick="deleteInvestmentType(${index})" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; font-size: 12px; cursor: pointer;">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('investment-total-value').innerHTML = `<strong>$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>`;
        }

        function addInvestmentType() {
            const nameInput = document.getElementById('new-inv-class');
            const accountInput = document.getElementById('new-inv-account');
            const valueInput = document.getElementById('new-inv-value');
            const basisInput = document.getElementById('new-inv-basis');
            
            const name = nameInput.value.trim();
            const account = accountInput.value;
            const value = parseFloat(valueInput.value);
            const cost_basis = basisInput.value ? parseFloat(basisInput.value) : 0;
            
            if (!name || isNaN(value)) {
                alert('Please enter a valid name and value');
                return;
            }
            
            if (editingIndex > -1) {
                // Update existing
                investmentTypes[editingIndex] = { name, account, value, cost_basis, change: 0 };
                editingIndex = -1;
                document.getElementById('add-inv-btn').textContent = 'Add';
            } else {
                // Add new
                investmentTypes.push({ name, account, value, cost_basis, change: 0 });
            }

            renderInvestmentTypes();
            debouncedAutoSave(); // Auto-save after adding/editing investment

            // Clear inputs
            nameInput.value = '';
            valueInput.value = '';
            basisInput.value = '';
            nameInput.focus();
        }

        function editInvestmentType(index) {
            const item = investmentTypes[index];
            document.getElementById('new-inv-class').value = item.name;
            document.getElementById('new-inv-account').value = item.account || 'Liquid';
            document.getElementById('new-inv-value').value = item.value;
            document.getElementById('new-inv-basis').value = item.cost_basis || '';
            
            editingIndex = index;
            document.getElementById('add-inv-btn').textContent = 'Update';
            renderInvestmentTypes();
        }

        function deleteInvestmentType(index) {
            if (confirm('Are you sure you want to remove this investment type?')) {
                if (index === editingIndex) {
                    editingIndex = -1;
                    document.getElementById('add-inv-btn').textContent = 'Add';
                    document.getElementById('new-inv-class').value = '';
                    document.getElementById('new-inv-value').value = '';
                    document.getElementById('new-inv-basis').value = '';
                } else if (index < editingIndex) {
                    editingIndex--; // Shift index if deleting item before current edit
                }

                investmentTypes.splice(index, 1);
                renderInvestmentTypes();
                debouncedAutoSave(); // Auto-save after deleting investment
            }
        }
        
        function showTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('onclick').includes(`'${tabName}'`)) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // Render withdrawal strategy tab when opened
            if (tabName === 'accounts') {
                renderWithdrawalStrategy();
            }
            
            // Refresh action items if switching to that tab
            if (tabName === 'actions') {
                loadActionItems();
            }

            // Refresh chat history if switching to advisor
            if (tabName === 'advisor') {
                loadConversationHistory();
            }
        }
        
        function getFormData() {
            // Aggregate assets from investmentTypes
            let liquid = 0;
            let tradIra = 0;
            let rothIra = 0;
            let pension = 0;

            investmentTypes.forEach(item => {
                if (item.account === 'Liquid') liquid += item.value;
                else if (item.account === 'Traditional IRA' || item.account === '401k' || item.account === '403b' || item.account === '401a' || item.account === '457b') tradIra += item.value;
                else if (item.account === 'Roth IRA') rothIra += item.value;
                else if (item.account === 'Pension') pension += item.value;
                // Fallback for legacy or unspecified
                else if (item.name === 'Cash') liquid += item.value;
                else tradIra += item.value; // Default bucket
            });

            return {
                person1: {
                    name: document.getElementById('p1-name').value,
                    birth_date: document.getElementById('p1-birth').value,
                    retirement_date: document.getElementById('p1-retire').value,
                    social_security: parseFloat(document.getElementById('p1-ss').value)
                },
                person2: {
                    name: document.getElementById('p2-name').value,
                    birth_date: document.getElementById('p2-birth').value,
                    retirement_date: document.getElementById('p2-retire').value,
                    social_security: parseFloat(document.getElementById('p2-ss').value)
                },
                children: [
                    {name: 'Child 1', birth_date: '2010-01-01'},
                    {name: 'Child 2', birth_date: '2012-01-01'}
                ],
                liquid_assets: liquid,
                traditional_ira: tradIra,
                roth_ira: rothIra,
                pension_lump_sum: pension,
                pension_annual: parseFloat(document.getElementById('pension-annual').value) || 0,
                annual_expenses: parseFloat(document.getElementById('expenses').value),
                target_annual_income: parseFloat(document.getElementById('target-income').value),
                risk_tolerance: document.getElementById('risk').value,
                asset_allocation: {
                    stocks: parseFloat(document.getElementById('stocks-slider').value) / 100,
                    bonds: (100 - parseFloat(document.getElementById('stocks-slider').value)) / 100
                },
                future_expenses: [],
                investment_types: investmentTypes,
                income_streams: incomeStreams,
                accounts: accounts,
                assumed_tax_rate: (parseFloat(document.getElementById('db-tax-rate')?.value) || 22) / 100,
                market_assumptions: {
                    stock_allocation: parseFloat(document.getElementById('stocks-slider').value) / 100,
                    stock_return_mean: parseFloat(document.getElementById('stock-return-slider').value) / 100,
                    bond_return_mean: parseFloat(document.getElementById('bond-return-slider').value) / 100,
                    inflation_mean: parseFloat(document.getElementById('inflation-slider').value) / 100,
                    stock_return_std: parseFloat(document.getElementById('stock-volatility-slider').value) / 100,
                    bond_return_std: parseFloat(document.getElementById('bond-volatility-slider').value) / 100,
                    inflation_std: parseFloat(document.getElementById('inflation-volatility-slider').value) / 100,
                    ss_discount_rate: parseFloat(document.getElementById('ss-discount-slider').value) / 100
                }
            };
        }
        
        async function fetchProfiles() {
            try {
                const response = await fetch(`${API_URL}/profiles`);
                const profiles = await response.json();
                
                const select = document.getElementById('profile-select');
                const dbSelect = document.getElementById('dashboard-profile-select');
                
                const currentVal = select.value;
                
                // Helper to populate a select
                const populate = (selElement, placeholder) => {
                    selElement.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                    profiles.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.name;
                        option.textContent = `${p.name} (${new Date(p.updated_at).toLocaleDateString()})`;
                        selElement.appendChild(option);
                    });
                };

                populate(select, "Select a profile...");
                populate(dbSelect, "Load Profile...");
                
                // Restore selection if still exists
                if (currentVal && profiles.some(p => p.name === currentVal)) {
                    select.value = currentVal;
                    dbSelect.value = currentVal;
                }
            } catch (error) {
                console.error('Error fetching profiles:', error);
            }
        }

        function onProfileSelectChange() {
            const select = document.getElementById('profile-select');
            const nameInput = document.getElementById('profile-name-input');
            if (select.value) {
                nameInput.value = select.value;
                loadProfile(select.value);
            }
        }

        async function saveCurrentProfile() {
            const name = document.getElementById('profile-name-input').value.trim();
            if (!name) {
                alert('Please enter a profile name');
                return;
            }

            const data = getFormData();
            console.log("Saving profile data:", data);

            try {
                const response = await fetch(`${API_URL}/profile/${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    await fetchProfiles();
                    document.getElementById('profile-select').value = name;
                    document.getElementById('dashboard-profile-select').value = name;

                    // Show success notification
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 4px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        z-index: 10000;
                        font-weight: 600;
                    `;
                    notification.textContent = `‚úì Profile "${name}" saved successfully`;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                } else {
                    const result = await response.json();
                    alert('Error saving profile: ' + (result.error || response.statusText));
                }
            } catch (error) {
                console.error("Save error:", error);
                alert('Error saving profile: ' + error.message);
            }
        }

        // Silent auto-save without notifications
        async function autoSaveProfile() {
            const settings = getSettings();
            if (!settings.autoSave) return;

            const name = document.getElementById('profile-name-input').value.trim();
            if (!name) return; // Don't auto-save if no profile name

            const data = getFormData();

            try {
                const response = await fetch(`${API_URL}/profile/${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    // Update selects silently
                    document.getElementById('profile-select').value = name;
                    document.getElementById('dashboard-profile-select').value = name;
                    console.log(`Auto-saved profile: ${name}`);
                } else {
                    console.error('Auto-save failed:', response.statusText);
                }
            } catch (error) {
                console.error("Auto-save error:", error);
            }
        }

        // Debounced auto-save (1 second delay)
        const debouncedAutoSave = debounce(autoSaveProfile, 1000);
        
        async function loadSelectedProfile() {
            const name = document.getElementById('profile-select').value;
            if (!name) {
                alert('Please select a profile to load');
                return;
            }
            
            await loadProfile(name);
        }

        async function deleteSelectedProfile() {
            const name = document.getElementById('profile-select').value;
            if (!name) {
                alert('Please select a profile to delete');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete profile "${name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/profile/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    document.getElementById('profile-name-input').value = '';
                    fetchProfiles();
                } else {
                    alert('Error deleting profile');
                }
            } catch (error) {
                alert('Error deleting profile: ' + error.message);
            }
        }
        
        // Main load function (internal use)
        async function loadProfile(profileName = 'main') {
            console.log("Loading profile:", profileName);
            try {
                // Try to load specific profile
                let response = await fetch(`${API_URL}/profile/${encodeURIComponent(profileName)}`);
                
                // Fallback for backward compatibility if 404
                if (response.status === 404 && profileName === 'main') {
                    console.log("Main profile not found, skipping.");
                    return; 
                }

                if (!response.ok) {
                    throw new Error(`Failed to load profile (Status: ${response.status})`);
                }
                
                const data = await response.json();
                console.log("Loaded profile data:", data);
                
                if (data) {
                    document.getElementById('p1-name').value = data.person1.name;
                    document.getElementById('p1-birth').value = data.person1.birth_date;
                    document.getElementById('p1-retire').value = data.person1.retirement_date;
                    document.getElementById('p1-ss').value = data.person1.social_security;
                    
                    document.getElementById('p2-name').value = data.person2.name;
                    document.getElementById('p2-birth').value = data.person2.birth_date;
                    document.getElementById('p2-retire').value = data.person2.retirement_date;
                    document.getElementById('p2-ss').value = data.person2.social_security;
                    
                    // No inputs to populate for assets anymore, handled by investmentTypes table
                    // document.getElementById('liquid').value = data.liquid_assets;
                    // ...
                    
                    document.getElementById('expenses').value = data.annual_expenses;
                    document.getElementById('pension-annual').value = data.pension_annual || 0;
                    document.getElementById('target-income').value = data.target_annual_income;
                    document.getElementById('risk').value = data.risk_tolerance;

                    // Load market assumptions if present
                    if (data.market_assumptions) {
                        const ma = data.market_assumptions;
                        if (ma.stock_allocation !== undefined) {
                            document.getElementById('stocks-slider').value = ma.stock_allocation * 100;
                        }
                        if (ma.stock_return_mean !== undefined) {
                            document.getElementById('stock-return-slider').value = ma.stock_return_mean * 100;
                        }
                        if (ma.bond_return_mean !== undefined) {
                            document.getElementById('bond-return-slider').value = ma.bond_return_mean * 100;
                        }
                        if (ma.inflation_mean !== undefined) {
                            document.getElementById('inflation-slider').value = ma.inflation_mean * 100;
                        }
                        if (ma.stock_return_std !== undefined) {
                            document.getElementById('stock-volatility-slider').value = ma.stock_return_std * 100;
                        }
                        if (ma.bond_return_std !== undefined) {
                            document.getElementById('bond-volatility-slider').value = ma.bond_return_std * 100;
                        }
                        if (ma.inflation_std !== undefined) {
                            document.getElementById('inflation-volatility-slider').value = ma.inflation_std * 100;
                        }
                        if (ma.ss_discount_rate !== undefined) {
                            document.getElementById('ss-discount-slider').value = ma.ss_discount_rate * 100;
                        }
                        
                        // Update displays
                        const sliders = ['stocks-slider', 'stock-return-slider', 'bond-return-slider', 
                                       'inflation-slider', 'stock-volatility-slider', 'bond-volatility-slider', 
                                       'inflation-volatility-slider', 'ss-discount-slider'];
                        sliders.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) updateSliderDisplay(el);
                        });
                    }

                    if (data.investment_types && Array.isArray(data.investment_types) && data.investment_types.length > 0) {
                        investmentTypes = data.investment_types;
                    } else {
                        // Migration: Create rows from legacy data fields if they exist and are > 0
                        investmentTypes = [];
                        if (data.liquid_assets > 0) {
                            investmentTypes.push({ name: 'Liquid Assets (Legacy)', account: 'Liquid', value: data.liquid_assets, change: 0 });
                        }
                        if (data.traditional_ira > 0) {
                            investmentTypes.push({ name: 'Traditional IRA/401k (Legacy)', account: 'Traditional IRA', value: data.traditional_ira, change: 0 });
                        }
                        if (data.roth_ira > 0) {
                            investmentTypes.push({ name: 'Roth IRA (Legacy)', account: 'Roth IRA', value: data.roth_ira, change: 0 });
                        }
                        if (data.pension_lump_sum > 0) {
                            investmentTypes.push({ name: 'Pension Lump Sum (Legacy)', account: 'Pension', value: data.pension_lump_sum, change: 0 });
                        }
                    }

                    if (data.income_streams && Array.isArray(data.income_streams)) {
                        incomeStreams = data.income_streams;
                    } else if (data.pension_annual > 0) {
                        // Migration: Move legacy pension annual to streams if it exists and streams is empty
                        incomeStreams = [{
                            name: 'Pension (Legacy)',
                            owner: 'person1', // Default
                            amount: data.pension_annual,
                            start_date: data.person1.retirement_date, // Guess
                            inflation_adjusted: true
                        }];
                    } else {
                        incomeStreams = [];
                    }
                    
                    if (data.accounts && Array.isArray(data.accounts)) {
                        accounts = data.accounts;
                    } else {
                        // Keep the default parsed data if nothing saved, or clear it if loading a different profile?
                        // For now, let's NOT clear it if it matches our initial hardcoded data, 
                        // but if we are loading a profile that *should* have empty accounts, we should probably clear it.
                        // However, to satisfy the user request "update the app with the following data", 
                        // we want this data to persist in the current session until saved.
                        // So we will only overwrite 'accounts' if data.accounts is explicitly present.
                    }

                    renderInvestmentTypes();
                    renderIncomeStreams();
                    updateIncomeOwnerLabels();

                    // Update input name to match loaded profile
                    document.getElementById('profile-name-input').value = profileName;
                    
                    // Sync selectors
                    const dbSelect = document.getElementById('dashboard-profile-select');
                    const mainSelect = document.getElementById('profile-select');
                    if (dbSelect) dbSelect.value = profileName;
                    if (mainSelect) mainSelect.value = profileName;

                    // Show success feedback
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 4px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        z-index: 10000;
                        font-weight: 600;
                    `;
                    notification.textContent = `‚úì Profile "${profileName}" loaded successfully`;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);

                    // Run analysis immediately to populate dashboard
                    runAnalysis();
                }
            } catch (error) {
                alert('Error loading profile: ' + error.message);
            }
        }
        
        async function runAnalysis() {
            const data = getFormData();

            document.getElementById('analysis-results').innerHTML = '<div class="loading">Running analysis...</div>';

            try {
                const response = await fetch(`${API_URL}/analysis`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const results = await response.json();
                window.currentAnalysis = results;

                displayAnalysis(results);
                updateDashboard(results);
            } catch (error) {
                document.getElementById('analysis-results').innerHTML = '<div class="loading">Error: ' + error.message + '</div>';
            }
        }

        async function getAIRecommendations() {
            const resultsDiv = document.getElementById('ai-recommendations');
            resultsDiv.innerHTML = '<div class="loading">ü§ñ AI analyzing your financial profile and generating personalized recommendations...</div>';

            // Check if we need an API key
            const apiKey = checkApiKey();
            const provider = localStorage.getItem('default_llm') || 'gemini';
            
            if (!apiKey) {
                alert('Please configure your API keys in Settings.');
                openSettings();
                return;
            }

            try {
                const prompt = `Based on my complete financial profile and the comprehensive analysis results, please provide:

1. **Overall Assessment**: What's the most critical issue with my retirement plan?
2. **Primary Recommendation**: What single action would have the biggest impact on improving my retirement security?
3. **Social Security Strategy**: Should I claim at 62, 67, or 70? Why?
4. **Roth Conversion Strategy**: Should I do Roth conversions? How much and when?
5. **Spending Adjustments**: Do I need to reduce my target income? By how much?
6. **Risk Management**: What risks am I not addressing?
7. **Action Priority List**: Give me 3-5 specific actions ranked by impact

Please be direct and actionable. My success rate is currently ${window.currentAnalysis?.monte_carlo?.success_rate || 'unknown'}%.`;

                const response = await fetch(`${API_URL}/advisor/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: prompt,
                        include_context: true,
                        api_key: apiKey,
                        profile_data: getFormData(),
                        llm_provider: provider
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to get AI recommendations');
                }

                const data = await response.json();

                // Store the recommendations for later use
                window.currentAIRecommendations = data.response;

                // Format and display the recommendations
                const html = `
                    <div class="analysis-section" style="background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">ü§ñ AI-Powered Strategic Recommendations</h4>
                            <button class="secondary" onclick="getAIRecommendations()" style="font-size: 12px; padding: 6px 12px;">Refresh</button>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 4px; line-height: 1.8; white-space: pre-wrap;">${data.response}</div>

                        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #667eea33;">
                            <h5 style="margin: 0 0 10px 0; color: #667eea;">üìã Implement These Recommendations</h5>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="convertRecommendationsToActionItems()" style="background: #667eea; color: white;">
                                    ‚úÖ Convert to Action Items
                                </button>
                                <button onclick="showQuickApplyOptions()" class="secondary">
                                    ‚ö° Quick Apply
                                </button>
                                <button onclick="saveRecommendationsAsScenario()" class="secondary">
                                    üíæ Save as Scenario
                                </button>
                            </div>
                            <div id="quick-apply-options" style="margin-top: 15px;"></div>
                        </div>

                        <div style="margin-top: 10px; font-size: 12px; color: #666; font-style: italic;">
                            Powered by Google Gemini ‚Ä¢ <a href="#" onclick="localStorage.removeItem('gemini_api_key'); alert('API key cleared'); return false;">Clear API Key</a>
                        </div>
                    </div>
                `;

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="analysis-section" style="background: #f8d7da; border-left: 4px solid #dc3545;">
                        <h4 style="color: #721c24;">‚ùå Error Getting AI Recommendations</h4>
                        <p style="color: #721c24;">${error.message}</p>
                        <p style="font-size: 13px;">
                            <strong>Troubleshooting:</strong><br>
                            ‚Ä¢ Check that your Gemini API key is valid<br>
                            ‚Ä¢ Ensure you have internet connectivity<br>
                            ‚Ä¢ <a href="#" onclick="localStorage.removeItem('gemini_api_key'); alert('API key cleared. Click AI Recommendations again to enter a new key.'); return false;">Click here to reset API key</a>
                        </p>
                    </div>
                `;
            }
        }

        async function convertRecommendationsToActionItems() {
            if (!window.currentAIRecommendations) {
                alert('No recommendations to convert. Please get AI recommendations first.');
                return;
            }

            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                alert('API key not found. Please get AI recommendations first.');
                return;
            }

            const loadingMsg = document.createElement('div');
            loadingMsg.innerHTML = '<div class="loading" style="margin-top: 10px;">ü§ñ Parsing recommendations into action items...</div>';
            document.getElementById('quick-apply-options').appendChild(loadingMsg);

            try {
                // Ask Gemini to parse the recommendations into structured action items
                const structurePrompt = `Please analyze these recommendations and extract specific, actionable items. For each action item, provide:
1. A category (one of: "Tax Planning", "Social Security", "Retirement Planning", "Investment Strategy", "Estate Planning", "Insurance", "Spending", "Income")
2. A clear, concise description (one sentence, action-oriented)
3. A priority (high, medium, or low)
4. A suggested due date (e.g., "Within 1 month", "Before retirement", "This year")
5. OPTIONAL: If the action involves changing a specific number or setting in the financial profile, provide an "action_data" object with "field" and "value".
   Supported fields:
   - "target_annual_income" (number)
   - "annual_expenses" (number)
   - "retirement_date_p1" (YYYY-MM-DD)
   - "retirement_date_p2" (YYYY-MM-DD)
   - "risk_tolerance" ("conservative", "moderate", "aggressive")
   - "social_security_p1" (monthly benefit number)
   - "stock_allocation" (number 0-100)

Return ONLY a JSON array of objects with this structure:
[
  {
    "category": "Tax Planning",
    "description": "Schedule meeting with CPA",
    "priority": "high",
    "due_date": "Within 1 month"
  },
  {
    "category": "Spending",
    "description": "Reduce annual spending goal to $140,000",
    "priority": "high",
    "due_date": "Immediate",
    "action_data": { "field": "target_annual_income", "value": 140000 }
  }
]

Here are the recommendations to parse:

${window.currentAIRecommendations}

Return ONLY the JSON array, no other text.`;

                const response = await fetch(`${API_URL}/advisor/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: structurePrompt,
                        include_context: false,
                        api_key: apiKey
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to parse recommendations');
                }

                const data = await response.json();

                // Try to extract JSON from the response
                let actionItems;
                try {
                    // Remove markdown code blocks if present
                    let jsonText = data.response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    actionItems = JSON.parse(jsonText);
                } catch (e) {
                    throw new Error('Could not parse AI response as JSON. Response: ' + data.response.substring(0, 200));
                }

                // Create action items via API
                let createdCount = 0;
                let existingCount = 0;
                for (const item of actionItems) {
                    const res = await fetch(`${API_URL}/action-items`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            category: item.category,
                            description: item.description,
                            priority: item.priority,
                            due_date: item.due_date,
                            action_data: item.action_data // Pass the smart action data
                        })
                    });
                    const resData = await res.json();
                    if (resData.status === 'success') {
                        createdCount++;
                    } else if (resData.status === 'exists') {
                        existingCount++;
                    }
                }

                loadingMsg.remove();

                const successMsg = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                        <p style="margin: 0; color: #155724;">
                            ‚úÖ Processed ${actionItems.length} recommendations:<br>
                            ‚Ä¢ ${createdCount} new action items created<br>
                            ${existingCount > 0 ? `‚Ä¢ ${existingCount} items already existed<br>` : ''}
                            <a href="#" onclick="showTab('actions'); return false;" style="margin-left: 10px; text-decoration: underline;">View Action Items ‚Üí</a>
                        </p>
                    </div>
                `;
                document.getElementById('quick-apply-options').innerHTML = successMsg;

            } catch (error) {
                loadingMsg.remove();
                document.getElementById('quick-apply-options').innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 4px; border-left: 4px solid #dc3545;">
                        <p style="margin: 0; color: #721c24;">‚ùå Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        function showQuickApplyOptions() {
            const optionsDiv = document.getElementById('quick-apply-options');

            // Get current analysis data
            const analysis = window.currentAnalysis;
            if (!analysis) {
                optionsDiv.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 4px; border-left: 4px solid #ffc107;">
                        <p style="margin: 0; color: #856404;">‚ö†Ô∏è Please run an analysis first to see quick apply options.</p>
                    </div>
                `;
                return;
            }

            // Parse recommendations to find common actions
            const recommendations = window.currentAIRecommendations || '';
            const lowerRecs = recommendations.toLowerCase();

            const options = [];

            // Check for Social Security delay recommendation
            if (lowerRecs.includes('delay') && (lowerRecs.includes('social security') || lowerRecs.includes('ss'))) {
                options.push({
                    label: 'üìÖ Delay Social Security to Age 70',
                    action: 'delaySocialSecurity',
                    description: 'Updates both retirement dates to age 70 for maximum benefits'
                });
            }

            // Check for income reduction recommendation
            const incomeMatch = recommendations.match(/reduce.*income.*?(\d+)%/i) ||
                               recommendations.match(/reduce.*spending.*?(\d+)%/i) ||
                               recommendations.match(/reduce.*target.*?(\d+)%/i);
            if (incomeMatch) {
                const percentage = incomeMatch[1];
                options.push({
                    label: `üí∞ Reduce Target Income by ${percentage}%`,
                    action: 'reduceIncome',
                    data: percentage,
                    description: `Adjusts target annual income down by ${percentage}%`
                });
            }

            // Check for Roth conversion recommendation
            if (analysis.roth_conversion_opportunity &&
                (lowerRecs.includes('roth conversion') || lowerRecs.includes('convert to roth'))) {
                options.push({
                    label: 'üîÑ Note Roth Conversion Strategy',
                    action: 'rothConversion',
                    description: 'Creates action item to implement Roth conversion plan'
                });
            }

            // Check for risk adjustment
            if (lowerRecs.includes('reduce risk') || lowerRecs.includes('conservative')) {
                options.push({
                    label: 'üìâ Adjust to Conservative Allocation',
                    action: 'conservativeAllocation',
                    description: 'Changes asset allocation to 40% stocks / 60% bonds'
                });
            } else if (lowerRecs.includes('increase') && lowerRecs.includes('stock')) {
                options.push({
                    label: 'üìà Adjust to Moderate Allocation',
                    action: 'moderateAllocation',
                    description: 'Changes asset allocation to 60% stocks / 40% bonds'
                });
            }

            if (options.length === 0) {
                optionsDiv.innerHTML = `
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 4px; border-left: 4px solid #2196f3;">
                        <p style="margin: 0; color: #014361;">
                            ‚ÑπÔ∏è No quick-apply options detected in recommendations. Use "Convert to Action Items" instead.
                        </p>
                    </div>
                `;
                return;
            }

            const html = `
                <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #667eea;">
                    <h6 style="margin: 0 0 10px 0; color: #667eea;">‚ö° Quick Apply Options</h6>
                    ${options.map(opt => `
                        <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 3px;">${opt.label}</div>
                                    <div style="font-size: 12px; color: #666;">${opt.description}</div>
                                </div>
                                <button onclick="applyQuickAction('${opt.action}', ${opt.data ? `'${opt.data}'` : 'null'})"
                                        style="padding: 6px 12px; font-size: 12px; background: #667eea; color: white; white-space: nowrap;">
                                    Apply
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            optionsDiv.innerHTML = html;
        }

        async function applyQuickAction(action, data) {
            const optionsDiv = document.getElementById('quick-apply-options');

            try {
                switch(action) {
                    case 'delaySocialSecurity':
                        // Update retirement dates to age 70
                        const p1Birth = new Date(document.getElementById('p1-birth').value);
                        const p2Birth = new Date(document.getElementById('p2-birth').value);

                        const p1Age70 = new Date(p1Birth);
                        p1Age70.setFullYear(p1Age70.getFullYear() + 70);

                        const p2Age70 = new Date(p2Birth);
                        p2Age70.setFullYear(p2Age70.getFullYear() + 70);

                        document.getElementById('p1-retire').value = p1Age70.toISOString().split('T')[0];
                        document.getElementById('p2-retire').value = p2Age70.toISOString().split('T')[0];

                        optionsDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724;">
                                    ‚úÖ Updated retirement dates to age 70. Don't forget to save your profile and re-run analysis!
                                </p>
                            </div>
                        `;
                        break;

                    case 'reduceIncome':
                        const currentIncome = parseFloat(document.getElementById('target-income').value);
                        const reduction = parseFloat(data) / 100;
                        const newIncome = Math.round(currentIncome * (1 - reduction));

                        document.getElementById('target-income').value = newIncome;

                        optionsDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724;">
                                    ‚úÖ Reduced target income from $${currentIncome.toLocaleString()} to $${newIncome.toLocaleString()}. Save profile and re-run analysis.
                                </p>
                            </div>
                        `;
                        break;

                    case 'rothConversion':
                        const rothItem = await fetch(`${API_URL}/action-items`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                category: 'Tax Planning',
                                description: 'Implement Roth conversion strategy as recommended by AI advisor',
                                priority: 'high',
                                due_date: 'Before next tax year'
                            })
                        });

                        optionsDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724;">
                                    ‚úÖ Created action item for Roth conversion strategy.
                                    <a href="#" onclick="showTab('action-items'); return false;" style="margin-left: 10px; text-decoration: underline;">View Action Items ‚Üí</a>
                                </p>
                            </div>
                        `;
                        break;

                    case 'conservativeAllocation':
                        document.getElementById('stocks').value = 40;
                        document.getElementById('bonds').value = 60;
                        updateAllocationBars();

                        optionsDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724;">
                                    ‚úÖ Updated allocation to 40% stocks / 60% bonds (conservative). Save profile and re-run analysis.
                                </p>
                            </div>
                        `;
                        break;

                    case 'moderateAllocation':
                        document.getElementById('stocks').value = 60;
                        document.getElementById('bonds').value = 40;
                        updateAllocationBars();

                        optionsDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724;">
                                    ‚úÖ Updated allocation to 60% stocks / 40% bonds (moderate). Save profile and re-run analysis.
                                </p>
                            </div>
                        `;
                        break;
                }
            } catch (error) {
                optionsDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 4px; border-left: 4px solid #dc3545;">
                        <p style="margin: 0; color: #721c24;">‚ùå Error applying action: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function saveRecommendationsAsScenario() {
            if (!window.currentAnalysis || !window.currentAIRecommendations) {
                alert('Please run an analysis and get AI recommendations first.');
                return;
            }

            const scenarioName = prompt('Enter a name for this scenario:', 'AI Recommended Plan');
            if (!scenarioName) return;

            try {
                const response = await fetch(`${API_URL}/scenarios`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: scenarioName,
                        parameters: getFormData(),
                        results: window.currentAnalysis,
                        ai_recommendations: window.currentAIRecommendations
                    })
                });

                if (response.ok) {
                    document.getElementById('quick-apply-options').innerHTML = `
                        <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                            <p style="margin: 0; color: #155724;">
                                ‚úÖ Saved scenario "${scenarioName}" with AI recommendations!
                            </p>
                        </div>
                    `;
                } else {
                    throw new Error('Failed to save scenario');
                }
            } catch (error) {
                alert('Error saving scenario: ' + error.message);
            }
        }

        function displayAnalysis(results) {
            const assumptions = results.market_assumptions_used;

            const html = `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 10px; gap: 10px;">
                    <button class="secondary" onclick="downloadPDF()" style="font-size: 13px;">Download PDF Report</button>
                    <button class="secondary" onclick="saveAsScenario()" style="font-size: 13px;">Save Results as Scenario</button>
                </div>

                <div class="assumptions-used">
                    <h4>Analysis Parameters Used:</h4>
                    <p><strong>Asset Allocation:</strong> ${(assumptions.stock_allocation * 100).toFixed(0)}% stocks, ${(100 - assumptions.stock_allocation * 100).toFixed(0)}% bonds</p>
                    <p><strong>Expected Returns:</strong> ${(assumptions.stock_return_mean * 100).toFixed(2)}% stocks, ${(assumptions.bond_return_mean * 100).toFixed(2)}% bonds</p>
                    <p><strong>Expected Inflation:</strong> ${(assumptions.inflation_mean * 100).toFixed(2)}%</p>
                    <p><strong>Volatility (Std Dev):</strong> Stocks ${(assumptions.stock_return_std * 100).toFixed(2)}%, Bonds ${(assumptions.bond_return_std * 100).toFixed(2)}%, Inflation ${(assumptions.inflation_std * 100).toFixed(2)}%</p>
                    <p><strong>Social Security Discount Rate:</strong> ${(assumptions.ss_discount_rate * 100).toFixed(2)}%</p>
                </div>

                <div class="analysis-section">
                    <h4>Monte Carlo Retirement Simulation</h4>
                    <p><strong>Success Rate:</strong> ${results.monte_carlo.success_rate.toFixed(1)}%</p>
                    <p><strong>Starting Portfolio:</strong> $${results.monte_carlo.starting_portfolio.toLocaleString()}</p>
                    <p><strong>Annual Withdrawal Need:</strong> $${results.monte_carlo.annual_withdrawal_need.toLocaleString()}</p>
                    <p><strong>Median Ending Balance:</strong> $${results.monte_carlo.median_ending_balance.toLocaleString()}</p>
                    <p><strong>5th Percentile (worst case):</strong> $${results.monte_carlo.percentile_5.toLocaleString()}</p>
                    <p><strong>95th Percentile (best case):</strong> $${results.monte_carlo.percentile_95.toLocaleString()}</p>

                    ${(() => {
                        const settings = getSettings();
                        const targetRate = settings.targetSuccessRate || 90;
                        const warningThreshold = targetRate - 10;
                        const withdrawalRate = (results.monte_carlo.annual_withdrawal_need / results.monte_carlo.starting_portfolio) * 100;
                        const successRate = results.monte_carlo.success_rate;
                        let rationale = '';
                        let rationaleBg = '';
                        let rationaleIcon = '';

                        if (successRate >= targetRate) {
                            rationaleBg = '#d4edda';
                            rationaleIcon = '‚úì';
                            if (withdrawalRate <= 4) {
                                rationale = `Your ${withdrawalRate.toFixed(2)}% withdrawal rate is conservative and aligns with the "4% rule." This exceeds your ${targetRate}% target with a ${successRate.toFixed(1)}% probability.`;
                            } else {
                                rationale = `Despite a ${withdrawalRate.toFixed(2)}% withdrawal rate (above the 4% rule), your success rate of ${successRate.toFixed(1)}% exceeds your ${targetRate}% target due to favorable factors.`;
                            }
                        } else if (successRate >= warningThreshold) {
                            rationaleBg = '#fff3cd';
                            rationaleIcon = '‚ö†';
                            rationale = `Your ${withdrawalRate.toFixed(2)}% withdrawal rate gives you a ${successRate.toFixed(1)}% success rate, which is below your ${targetRate}% target. Consider small adjustments to reach your goal.`;
                        } else if (successRate >= 50) {
                            rationaleBg = '#f8d7da';
                            rationaleIcon = '‚ö†';
                            rationale = `Your ${withdrawalRate.toFixed(2)}% withdrawal rate results in a ${successRate.toFixed(1)}% success rate, significantly below your ${targetRate}% target. The median scenario ends with $0.`;
                        } else {
                            rationaleBg = '#f8d7da';
                            rationaleIcon = '‚úó';
                            rationale = `Your ${withdrawalRate.toFixed(2)}% withdrawal rate is unsustainable with only a ${successRate.toFixed(1)}% success rate (Target: ${targetRate}%). Significant action needed.`;
                        }

                        return `
                            <div style="margin-top: 15px; padding: 15px; background: ${rationaleBg}; border-left: 4px solid ${successRate >= targetRate ? '#28a745' : successRate >= warningThreshold ? '#ffc107' : '#dc3545'}; border-radius: 4px;">
                                <p style="margin: 0;"><strong>${rationaleIcon} Rationale:</strong> ${rationale}</p>
                            </div>
                        `;
                    })()}

                    <div style="margin-top: 20px; height: 300px;">
                        <canvas id="analysis-timeline-chart"></canvas>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h4>Social Security Optimization</h4>
                    <table>
                        <tr>
                            <th>Strategy</th>
                            <th>You Claim At</th>
                            <th>Spouse Claim At</th>
                            <th>Your Monthly</th>
                            <th>Spouse Monthly</th>
                            <th>Lifetime NPV</th>
                        </tr>
                        ${results.social_security_optimization.map(s => `
                            <tr>
                                <td>${s.person1_claim_age === 70 && s.person2_claim_age === 70 ? '‚úì Recommended' : ''}</td>
                                <td>${s.person1_claim_age}</td>
                                <td>${s.person2_claim_age}</td>
                                <td>$${s.person1_monthly.toLocaleString()}</td>
                                <td>$${s.person2_monthly.toLocaleString()}</td>
                                <td>$${s.lifetime_benefit_npv.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
                
                <div class="analysis-section">
                    <h4>Roth Conversion Opportunity</h4>
                    <p><strong>Status:</strong> ${results.roth_conversion.opportunity}</p>
                    ${results.roth_conversion.conversion_years ? `
                        <p><strong>Conversion Window:</strong> ${results.roth_conversion.conversion_years} years</p>
                        <p><strong>Annual Conversion (12% bracket):</strong> $${results.roth_conversion.annual_conversion_12_bracket.toLocaleString()}</p>
                        <p><strong>Total Convertible:</strong> $${results.roth_conversion.total_convertible_12.toLocaleString()}</p>
                        <p><strong>Tax Cost:</strong> $${results.roth_conversion.tax_cost_12.toLocaleString()}</p>
                        <p><strong>Recommendation:</strong> ${results.roth_conversion.recommendation}</p>
                    ` : `<p>${results.roth_conversion.reason}</p>`}
                </div>
                
                <div class="analysis-section">
                    <h4>Wealth Transfer Strategy</h4>
                    <p><strong>Annual Gift Capacity:</strong> $${results.wealth_transfer.annual_gift_capacity.toLocaleString()}</p>
                    <p><strong>Per Child:</strong> $${results.wealth_transfer.per_child_annual.toLocaleString()}/year</p>
                    <p><strong>Lifetime Gifting:</strong> $${results.wealth_transfer.lifetime_gift_capacity.toLocaleString()} over ${results.wealth_transfer.years_of_gifting} years</p>
                    <p><strong>% of Estate:</strong> ${results.wealth_transfer.percentage_transferred.toFixed(1)}%</p>
                    <p><strong>Recommendation:</strong> ${results.wealth_transfer.recommendation}</p>
                </div>
            `;
            
            document.getElementById('analysis-results').innerHTML = html;
            
            // Render Timeline Chart
            if (results.monte_carlo.timeline) {
                const ctx = document.getElementById('analysis-timeline-chart').getContext('2d');
                
                // Destroy existing if any (pseudo-check)
                if (window.analysisChart) window.analysisChart.destroy();
                
                window.analysisChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: results.monte_carlo.timeline.years,
                        datasets: [
                            {
                                label: 'Median Portfolio',
                                data: results.monte_carlo.timeline.median,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: '95th Percentile',
                                data: results.monte_carlo.timeline.p95,
                                borderColor: '#2ecc71',
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: '5th Percentile',
                                data: results.monte_carlo.timeline.p5,
                                borderColor: '#e74c3c',
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Projected Portfolio Balance'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Balance ($)' }
                            }
                        }
                    }
                });
            }
        }
        
        // Scenario Management
        async function downloadPDF() {
            if (!window.currentAnalysis) {
                alert('Please run an analysis first.');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/report/pdf`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        profile: getFormData(),
                        analysis: window.currentAnalysis
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `retirement_plan_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('Failed to generate PDF');
                }
            } catch (error) {
                alert('Error downloading PDF: ' + error.message);
            }
        }

        async function saveAsScenario() {
            if (!window.currentAnalysis) return;
            
            const currentProfileName = document.getElementById('profile-name-input').value || 'New Scenario';
            const name = prompt("Enter a name for this scenario:", currentProfileName);
            
            if (!name) return;
            
            // We save the inputs (from form) and the outputs (currentAnalysis)
            const payload = {
                name: name,
                parameters: getFormData(),
                results: window.currentAnalysis
            };
            
            try {
                const response = await fetch(`${API_URL}/scenarios`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    refreshScenarios();
                } else {
                    alert('Failed to save scenario');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        let savedScenarios = [];
        let selectedScenarioIds = [];
        
        async function refreshScenarios() {
            try {
                const response = await fetch(`${API_URL}/scenarios`);
                savedScenarios = await response.json();
                renderScenariosList();
            } catch (e) {
                console.error("Failed to load scenarios", e);
            }
        }
        
        function renderScenariosList() {
            const list = document.getElementById('scenarios-list');
            list.innerHTML = '';
            
            savedScenarios.forEach(s => {
                const item = document.createElement('div');
                item.style.padding = '10px';
                item.style.borderBottom = '1px solid #eee';
                item.style.display = 'flex';
                item.style.alignItems = 'center';
                item.style.gap = '10px';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = s.id;
                checkbox.onchange = (e) => {
                    if (e.target.checked) selectedScenarioIds.push(s.id);
                    else selectedScenarioIds = selectedScenarioIds.filter(id => id !== s.id);
                    compareScenarios();
                };
                
                const label = document.createElement('div');
                label.style.flex = 1;
                label.innerHTML = `<strong>${s.name}</strong><br><span style="font-size:11px;color:#777">${new Date(s.created_at).toLocaleString()}</span>`;
                
                const delBtn = document.createElement('button');
                delBtn.textContent = '√ó';
                delBtn.style.padding = '2px 6px';
                delBtn.style.fontSize = '12px';
                delBtn.style.background = '#e74c3c';
                delBtn.onclick = async () => {
                    await fetch(`${API_URL}/scenarios/${s.id}`, { method: 'DELETE' });
                    refreshScenarios();
                };
                
                item.append(checkbox, label, delBtn);
                list.append(item);
            });
        }
        
        async function compareScenarios() {
            if (selectedScenarioIds.length === 0) {
                // Clear charts
                if (window.compBarChart) window.compBarChart.destroy();
                if (window.compLineChart) window.compLineChart.destroy();
                return;
            }
            
            // Fetch details for selected
            const details = await Promise.all(selectedScenarioIds.map(id => 
                fetch(`${API_URL}/scenarios/${id}`).then(r => r.json())
            ));
            
            renderComparisonCharts(details);
        }
        
        function renderComparisonCharts(scenarios) {
            // Bar Chart: Success Rate & Outcomes
            const ctxBar = document.getElementById('comparison-chart-bar').getContext('2d');
            if (window.compBarChart) window.compBarChart.destroy();
            
            window.compBarChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: scenarios.map(s => s.name),
                    datasets: [
                        {
                            label: 'Success Rate (%)',
                            data: scenarios.map(s => s.results.monte_carlo.success_rate),
                            backgroundColor: '#2ecc71',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Median Ending Balance ($M)',
                            data: scenarios.map(s => s.results.monte_carlo.median_ending_balance / 1000000),
                            backgroundColor: '#3498db',
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Worst Case (5th %ile) ($M)',
                            data: scenarios.map(s => s.results.monte_carlo.percentile_5 / 1000000),
                            backgroundColor: '#e74c3c',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Success Rate (%)' },
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Balance ($M)' },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 0) {
                                        label += context.parsed.y.toFixed(1) + '%';
                                    } else {
                                        label += '$' + context.parsed.y.toFixed(2) + 'M';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // Line Chart: Median Trajectory Comparison
            const ctxLine = document.getElementById('comparison-chart-line').getContext('2d');
            if (window.compLineChart) window.compLineChart.destroy();
            
            const colors = ['#3498db', '#e74c3c', '#9b59b6', '#f1c40f', '#34495e'];
            
            // Ensure we have data before rendering
            if (scenarios.length > 0 && scenarios[0].results.monte_carlo.timeline) {
                window.compLineChart = new Chart(ctxLine, {
                    type: 'line',
                    data: {
                        labels: scenarios[0].results.monte_carlo.timeline.years, 
                        datasets: scenarios.map((s, i) => ({
                            label: s.name,
                            data: s.results.monte_carlo.timeline.median,
                            borderColor: colors[i % colors.length],
                            fill: false,
                            tension: 0.1
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Median Portfolio Performance Comparison' }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: 'Balance ($)' },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Assumption Comparison Table
            const table = document.getElementById('comparison-table');
            const thead = table.tHead.rows[0];
            const tbody = table.tBodies[0];
            
            // Reset headers (keep first 'Parameter' col)
            while (thead.cells.length > 1) {
                thead.deleteCell(1);
            }
            tbody.innerHTML = '';
            
            // Add Scenario Columns
            scenarios.forEach(s => {
                const th = document.createElement('th');
                th.textContent = s.name;
                th.style.padding = '10px';
                th.style.textAlign = 'center';
                thead.appendChild(th);
            });
            
            // Helper to add row
            const addRow = (label, getValue) => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #eee';
                
                const tdLabel = document.createElement('td');
                tdLabel.textContent = label;
                tdLabel.style.padding = '8px';
                tdLabel.style.fontWeight = '500';
                tr.appendChild(tdLabel);
                
                scenarios.forEach(s => {
                    const td = document.createElement('td');
                    try {
                        td.textContent = getValue(s.parameters);
                    } catch (e) {
                        td.textContent = '-';
                    }
                    td.style.padding = '8px';
                    td.style.textAlign = 'center';
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            };
            
            // Add Data Rows
            addRow('Stock Allocation', p => (p.market_assumptions.stock_allocation * 100).toFixed(0) + '%');
            addRow('Stock Return', p => (p.market_assumptions.stock_return_mean * 100).toFixed(2) + '%');
            addRow('Bond Return', p => (p.market_assumptions.bond_return_mean * 100).toFixed(2) + '%');
            addRow('Inflation', p => (p.market_assumptions.inflation_mean * 100).toFixed(2) + '%');
            addRow('Annual Expenses', p => '$' + p.annual_expenses.toLocaleString());
            addRow('Retirement Date', p => new Date(p.person1.retirement_date).getFullYear());
        }
        
        function updateDashboard(results) {
            updateDashboardMetrics(results);
            updateDashboardChart(results);
        }

        function updateDashboardMetrics(results) {
            const settings = getSettings();
            const targetRate = settings.targetSuccessRate || 90;
            const warningThreshold = targetRate - 10;

            const successClass = results.monte_carlo.success_rate >= targetRate ? 'success' : 
                               results.monte_carlo.success_rate >= warningThreshold ? 'warning' : 'danger';
            
            const successBg = results.monte_carlo.success_rate >= targetRate ? 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' :
                            results.monte_carlo.success_rate >= warningThreshold ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' :
                            'linear-gradient(135deg, #ff6b6b 0%, #c0392b 100%)';

            const withdrawalRate = (results.monte_carlo.annual_withdrawal_need / results.monte_carlo.starting_portfolio) * 100;
            const withdrawalClass = withdrawalRate <= 4.0 ? '#2ecc71' : withdrawalRate <= 5.0 ? '#f39c12' : '#e74c3c';

            const html = `
                <div class="metric-card" style="background: ${successBg}; transition: background 0.3s ease;">
                    <div class="metric-label">Success Rate (Target: ${targetRate}%)</div>
                    <div class="metric-value">${results.monte_carlo.success_rate.toFixed(0)}%</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Probability money lasts to age 90</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Median Net Worth (Age 90)</div>
                    <div class="metric-value">$${(results.monte_carlo.median_ending_balance / 1000000).toFixed(2)}M</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Inflation-adjusted legacy</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%)">
                    <div class="metric-label">Safe Withdrawal Rate</div>
                    <div class="metric-value">${withdrawalRate.toFixed(2)}%</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Target: < 4.0%</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #f39c12 0%, #d35400 100%)">
                    <div class="metric-label">RMD Age (Start)</div>
                    <div class="metric-value">73</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Tax planning deadline</div>
                </div>
            `;
            
            document.getElementById('dashboard-metrics').innerHTML = html;
            document.getElementById('dashboard-last-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();

            // --- Sync Dashboard Levers ---
            
            // 1. Spending Lever
            if (document.activeElement.id !== 'db-spending') {
                const spending = parseInt(document.getElementById('expenses').value) || 0;
                const slider = document.getElementById('db-spending');
                
                // Dynamic Range Adjustment
                if (spending > parseInt(slider.max)) slider.max = Math.ceil(spending * 1.5 / 1000) * 1000;
                if (spending < parseInt(slider.min) && spending > 0) slider.min = 0;
                
                slider.value = spending;
                document.getElementById('db-spending-val').textContent = '$' + spending.toLocaleString();
            }

            // 2. Withdrawal Rate Lever (Derived)
            if (document.activeElement.id !== 'db-withdraw-rate') {
                document.getElementById('db-withdraw-rate').value = withdrawalRate.toFixed(1);
                document.getElementById('db-withdraw-rate-val').textContent = withdrawalRate.toFixed(1) + '%';
            }

            // 3. Retirement Year Levers
            const syncRetireLever = (inputId, sliderId, labelId, nameInputId) => {
                if (document.activeElement.id !== sliderId) {
                    const dateVal = document.getElementById(inputId).value;
                    const year = dateVal ? new Date(dateVal).getFullYear() : new Date().getFullYear();
                    const slider = document.getElementById(sliderId);
                    
                    // Dynamic Range
                    if (year > parseInt(slider.max)) slider.max = year + 5;
                    if (year < parseInt(slider.min)) slider.min = year - 5;
                    
                    slider.value = year;
                    document.getElementById(sliderId + '-val').textContent = year;
                }
                // Update Name Label
                const name = document.getElementById(nameInputId).value || (nameInputId.includes('p1') ? 'Person 1' : 'Person 2');
                const label = document.getElementById(labelId);
                if (label) label.textContent = name;
            };

            syncRetireLever('p1-retire', 'db-retire-year', 'db-p1-label', 'p1-name');
            syncRetireLever('p2-retire', 'db-retire-year-p2', 'db-p2-label', 'p2-name');

            // 4. Allocation Lever
            if (document.activeElement.id !== 'db-allocation') {
                const allocation = document.getElementById('stocks-slider').value;
                document.getElementById('db-allocation').value = allocation;
                document.getElementById('db-allocation-val').textContent = allocation + '%';
            }
        }

        function updateDashboardChart(results) {
            // Render Dashboard Chart
            if (results.monte_carlo.timeline) {
                const ctx = document.getElementById('dashboard-chart').getContext('2d');
                
                if (window.dashboardChart) window.dashboardChart.destroy();
                
                window.dashboardChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: results.monte_carlo.timeline.years,
                        datasets: [
                            {
                                label: 'Median Portfolio',
                                data: results.monte_carlo.timeline.median,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0
                            },
                            {
                                label: 'Best Case (95%)',
                                data: results.monte_carlo.timeline.p95,
                                borderColor: '#2ecc71',
                                borderDash: [5, 5],
                                borderWidth: 1,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0
                            },
                            {
                                label: 'Worst Case (5%)',
                                data: results.monte_carlo.timeline.p5,
                                borderColor: '#e74c3c',
                                borderDash: [5, 5],
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + Math.round(context.raw).toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#f0f0f0' },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        function attachDashboardListeners() {
            // Spending Lever
            const spendingSlider = document.getElementById('db-spending');
            spendingSlider.addEventListener('input', () => {
                const val = parseInt(spendingSlider.value);
                document.getElementById('db-spending-val').textContent = '$' + val.toLocaleString();
                // Update main form
                document.getElementById('expenses').value = val;
                
                // Update Rate Slider locally for immediate feedback (approximate)
                if (window.currentAnalysis) {
                    const portfolio = window.currentAnalysis.monte_carlo.starting_portfolio;
                    // We need guaranteed income. Estimate it:
                    const currentNeed = window.currentAnalysis.monte_carlo.annual_withdrawal_need;
                    const oldSpending = parseFloat(window.currentAnalysis.market_assumptions_used?.last_spending || val); // Fallback
                    // Actually, simpler: Analysis result has annual_withdrawal_need based on the INPUT spending.
                    // If we change spending, need changes by same amount.
                    // Guaranteed = Spending - Need.
                    // New Need = New Spending - Guaranteed.
                    // Rate = New Need / Portfolio * 100.
                    
                    // But we don't have guaranteed easily available without calculating.
                    // Let's just let the debounce analysis update the rate slider.
                    // Or do a rough calc if we want:
                    // const guaranteed = val - currentNeed; // This assumes val matches the analysis input, which it might not yet.
                }
            });
            spendingSlider.addEventListener('change', debounce(() => {
                runAnalysis();
            }, 300));

            // Withdrawal Rate Lever
            const rateSlider = document.getElementById('db-withdraw-rate');
            rateSlider.addEventListener('input', () => {
                const rate = parseFloat(rateSlider.value);
                document.getElementById('db-withdraw-rate-val').textContent = rate.toFixed(1) + '%';
                
                if (window.currentAnalysis) {
                    const portfolio = window.currentAnalysis.monte_carlo.starting_portfolio;
                    // Calculate required spending
                    // Need = Portfolio * (Rate / 100)
                    const need = portfolio * (rate / 100);
                    
                    // We need to know Guaranteed Income to get Total Spending
                    // Guaranteed = Old Spending - Old Need
                    const oldSpending = parseFloat(document.getElementById('expenses').value); // Current form value (before this drag?)
                    const oldNeed = window.currentAnalysis.monte_carlo.annual_withdrawal_need;
                    
                    // Warning: If we dragged spending previously without running analysis, oldNeed is stale.
                    // But usually we run analysis on change.
                    // Let's approximate guaranteed income from the last run results
                    // Guaranteed = (Target Annual Income used in analysis) - Old Need
                    // We can reconstruct Target from the analysis input, or just rely on 'expenses' input if it hasn't drifted too far.
                    // Let's use: Guaranteed = (Current Profile Spending) - Old Need
                    // Wait, Current Profile Spending might be equal to OldSpending if we just loaded.
                    
                    // Better approach: Calculate Guaranteed from profile inputs directly
                    // This duplicates logic but is safer.
                    // Actually, simpler:
                    // Annual Withdrawal Need = Total Spending - Guaranteed
                    // So Guaranteed = Total Spending - Annual Withdrawal Need
                    // Since 'Total Spending' was the input to the simulation that produced 'Annual Withdrawal Need', 
                    // we can use the values from `window.currentAnalysis` if we saved inputs there.
                    // We didn't save inputs explicitly in `currentAnalysis` root, but `annual_withdrawal_need` is there.
                    // Let's assume the `expenses` input hasn't changed since last run OR `runAnalysis` updates quickly.
                    
                    // Let's assume Guaranteed Income is constant (it is).
                    // Guaranteed = (Current Spending Input) - (Last Analysis Need) ?? No, that's circular if we changed spending.
                    
                    // Let's calculate guaranteed from the previous analysis snapshot:
                    // We know `withdrawalRate` = Need / Portfolio.
                    // So `Need` = Portfolio * (Rate/100).
                    // `Spending` = `Need` + `Guaranteed`.
                    // We need `Guaranteed`.
                    // From last run: `Guaranteed` = `Profile.target_annual_income` - `results.monte_carlo.annual_withdrawal_need`.
                    
                    // But we don't have easy access to the profile used for `currentAnalysis`.
                    // Let's use `guaranteed_income` from results if available?
                    // We added `guaranteed_income` to JSON response in app.py! 
                    // It is `person1.social_security * 12 + person2...`. 
                    // Wait, `guaranteed_income` in JSON is static SS. 
                    // `annual_withdrawal_need` accounts for pension too.
                    
                    // Let's rely on: Spending = (Portfolio * Rate) + (Spending - Need) [from last run]
                    // Guaranteed = Previous_Spending - Previous_Need.
                    // But `Previous_Spending` is tricky.
                    
                    // Let's just use the `guaranteed_income` + `pension` from the form as a rough estimate for the live slider?
                    // No, simpler:
                    // Annual Need = Portfolio * Rate%
                    // Spending = Annual Need + Guaranteed
                    // Guaranteed = (Previous Analysis Need) / (Previous Rate) ... no.
                    
                    // Let's use the helper: Guaranteed = Total_Spending - Need.
                    // We can get Total_Spending from the `expenses` input (assuming it was sync'd).
                    // But if we are dragging the rate slider, we want to update the expenses input.
                    
                    // Best way: 
                    // 1. Calculate `current_guaranteed` = (Current Expenses Value) - (Last Analysis Need).
                    //    (This assumes the current expenses value corresponds to the last analysis need).
                    //    If the user moved the spending slider, runAnalysis triggers. So usually they correspond.
                    // 2. New Need = Portfolio * New Rate.
                    // 3. New Spending = New Need + current_guaranteed.
                    
                    const lastNeed = window.currentAnalysis.monte_carlo.annual_withdrawal_need;
                    // We need the spending that generated this need.
                    // Let's approximate: Guaranteed = (Current Form Expenses) - lastNeed.
                    // If the user hasn't touched expenses since last run, this is correct.
                    // If they have, `expenses` is new, but `lastNeed` is old. Mismatch.
                    
                    // To fix this, we should store `last_spending_input` with the analysis results.
                    // But we don't have that yet.
                    
                    // Fallback: Re-calculate guaranteed from form inputs (SS + Pension).
                    const p1ss = parseFloat(document.getElementById('p1-ss').value) || 0;
                    const p2ss = parseFloat(document.getElementById('p2-ss').value) || 0;
                    const pen = parseFloat(document.getElementById('pension-annual').value) || 0;
                    // Plus income streams?
                    // This is getting complex to replicate frontend.
                    
                    // HACK: Use `window.currentAnalysis.monte_carlo.annual_withdrawal_need` and the *current calculated rate* to find guaranteed.
                    // Current Rate = Need / Portfolio.
                    // Guaranteed = Spending - Need.
                    // This assumes we know Spending.
                    
                    // Let's just use the `guaranteed_income` from the analysis result (sum of SS) + pension from form.
                    // It's an estimate for the slider UI. The actual `runAnalysis` will be precise.
                    const approxGuaranteed = (window.currentAnalysis.guaranteed_income || 0) + (parseFloat(document.getElementById('pension-annual').value) || 0);
                    
                    const newNeed = portfolio * (rate / 100);
                    const newSpending = Math.round(newNeed + approxGuaranteed);
                    
                    // Update Spending Slider/Input
                    document.getElementById('db-spending').value = newSpending;
                    document.getElementById('db-spending-val').textContent = '$' + newSpending.toLocaleString();
                    document.getElementById('expenses').value = newSpending;
                }
            });
            rateSlider.addEventListener('change', debounce(() => {
                runAnalysis();
            }, 300));

            // Retirement Year Lever
            const retireSlider = document.getElementById('db-retire-year');
            retireSlider.addEventListener('input', () => {
                const year = retireSlider.value;
                document.getElementById('db-retire-year-val').textContent = year;
                // Update main form (keep month/day same)
                const current = new Date(document.getElementById('p1-retire').value);
                const newDate = `${year}-${String(current.getMonth()+1).padStart(2,'0')}-${String(current.getDate()).padStart(2,'0')}`;
                document.getElementById('p1-retire').value = newDate;
            });
            retireSlider.addEventListener('change', debounce(() => {
                runAnalysis();
            }, 300));

            // Retirement Year Lever (Person 2)
            const retireSliderP2 = document.getElementById('db-retire-year-p2');
            retireSliderP2.addEventListener('input', () => {
                const year = retireSliderP2.value;
                document.getElementById('db-retire-year-p2-val').textContent = year;
                // Update main form (keep month/day same)
                const current = new Date(document.getElementById('p2-retire').value);
                const newDate = `${year}-${String(current.getMonth()+1).padStart(2,'0')}-${String(current.getDate()).padStart(2,'0')}`;
                document.getElementById('p2-retire').value = newDate;
            });
            retireSliderP2.addEventListener('change', debounce(() => {
                runAnalysis();
            }, 300));

            // Allocation Lever
            const allocSlider = document.getElementById('db-allocation');
            allocSlider.addEventListener('input', () => {
                const val = allocSlider.value;
                document.getElementById('db-allocation-val').textContent = val + '%';
                // Update main form sliders
                document.getElementById('stocks-slider').value = val;
                // Trigger existing update logic
                updateSliderDisplay(document.getElementById('stocks-slider'));
            });
                        allocSlider.addEventListener('change', debounce(() => {
                            runAnalysis();
                        }, 300));
            
                        // Tax Rate Lever
                        const taxSlider = document.getElementById('db-tax-rate');
                        taxSlider.addEventListener('input', () => {
                            const val = taxSlider.value;
                            document.getElementById('db-tax-rate-val').textContent = val + '%';
                        });
                        taxSlider.addEventListener('change', debounce(() => {
                            runAnalysis();
                        }, 300));
            
                        // Target Success Rate Lever
            
        }
        
        // --- Action Item Wizard ---
        let wizardItems = [];
        let currentWizardIndex = 0;

        async function startWizard() {
            // Reload latest items first
            await loadActionItems(true); // pass true to suppress render, we just want data
            
            // Filter for pending items sorted by priority
            const priorityOrder = { 'critical': 0, 'high': 1, 'medium': 2, 'low': 3 };
            wizardItems = window.currentActionItems
                .filter(i => i.status === 'pending')
                .sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

            if (wizardItems.length === 0) {
                alert("üéâ All action items are complete! Great job!");
                return;
            }

            currentWizardIndex = 0;
            document.getElementById('wizard-modal').classList.add('active');
            renderWizardStep();
        }

        function closeWizard() {
            document.getElementById('wizard-modal').classList.remove('active');
            loadActionItems(); // Refresh main list
        }

        function renderWizardStep() {
            const item = wizardItems[currentWizardIndex];
            const body = document.getElementById('wizard-body');
            const total = wizardItems.length;
            
            document.getElementById('wizard-progress').textContent = `Task ${currentWizardIndex + 1} of ${total}`;
            
            // Priority Badge Color
            const pColors = { 'critical': '#e74c3c', 'high': '#e67e22', 'medium': '#f39c12', 'low': '#3498db' };
            const pColor = pColors[item.priority] || '#95a5a6';

            // Subtasks HTML
            let subtasksHtml = '';
            if (!item.subtasks || item.subtasks.length === 0) {
                subtasksHtml = `
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-top: 20px;">
                        <p style="color: #666; margin-bottom: 10px;">No subtasks defined.</p>
                        <button class="secondary" onclick="generateSubtasks(${item.id})" style="font-size: 13px;">ü™Ñ Use AI to Breakdown Task</button>
                    </div>
                `;
            } else {
                subtasksHtml = '<ul style="list-style: none; margin-top: 20px;">';
                item.subtasks.forEach((sub, idx) => {
                    subtasksHtml += `
                        <li style="background: white; padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${sub.completed ? 'checked' : ''} onchange="toggleSubtask(${item.id}, ${idx})" style="width: 18px; height: 18px;">
                            <span style="${sub.completed ? 'text-decoration: line-through; color: #999;' : ''}">${sub.text}</span>
                        </li>
                    `;
                });
                subtasksHtml += '</ul>';
            }

            const html = `
                <div style="margin-bottom: 20px;">
                    <span style="background: ${pColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase;">${item.priority}</span>
                    <span style="color: #666; font-size: 13px; margin-left: 10px;">${item.category}</span>
                </div>
                
                <h3 style="font-size: 24px; margin-bottom: 15px; color: #2c3e50;">${item.description}</h3>
                
                ${item.due_date ? `<div style="margin-bottom: 20px; font-size: 14px; color: #e74c3c;">üìÖ Due: ${new Date(item.due_date).toLocaleDateString()}</div>` : ''}
                
                <div style="background: #f1f2f6; padding: 20px; border-radius: 8px; flex: 1;">
                    <h4 style="margin-bottom: 15px; font-size: 16px;">Action Plan</h4>
                    ${subtasksHtml}
                </div>
            `;

            body.innerHTML = html;

            // Smart Apply Logic for Artifacts
            const assistContainer = document.createElement('div');
            assistContainer.style.marginTop = '20px';
            
            if (item.action_data) {
                const dataStr = JSON.stringify(item.action_data).replace(/"/g, '&quot;');
                assistContainer.innerHTML = `
                    <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; border: 1px solid #3498db; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #2980b9;">‚ö° Smart Apply Available</strong>
                            <p style="font-size: 13px; margin-top: 5px;">The system can automatically update your profile to implement this recommendation.</p>
                        </div>
                        <button onclick="applyActionUpdate(${item.id}, ${dataStr})" style="background: #3498db; white-space: nowrap;">Implement Now</button>
                    </div>
                `;
            }
            body.appendChild(assistContainer);

            // Button States
            document.getElementById('wizard-complete-btn').style.display = 'inline-block';
            document.getElementById('wizard-ai-assist-btn').style.display = 'inline-block';
        }

        function wizardNext() {
            if (currentWizardIndex < wizardItems.length - 1) {
                currentWizardIndex++;
                renderWizardStep();
            } else {
                closeWizard();
            }
        }

        function wizardPrev() {
            if (currentWizardIndex > 0) {
                currentWizardIndex--;
                renderWizardStep();
            }
        }

        async function wizardMarkComplete() {
            const item = wizardItems[currentWizardIndex];
            if (confirm('Mark this task as complete?')) {
                await toggleActionStatus(item.id, 'pending'); // flips to completed
                // Remove from wizard array
                wizardItems.splice(currentWizardIndex, 1);
                
                if (wizardItems.length === 0) {
                    alert("üéâ All pending tasks completed!");
                    closeWizard();
                } else {
                    if (currentWizardIndex >= wizardItems.length) {
                        currentWizardIndex = wizardItems.length - 1;
                    }
                    renderWizardStep();
                }
            }
        }

        async function generateSubtasks(itemId) {
            const item = wizardItems.find(i => i.id === itemId);
            if (!item) return;

            const apiKey = checkApiKey();
            if (!apiKey) {
                alert("Please set API key in Settings first");
                return;
            }

            const bodyDiv = document.getElementById('wizard-body');
            const originalContent = bodyDiv.innerHTML;
            bodyDiv.innerHTML += '<div class="loading" style="position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center;">ü§ñ Generating subtasks...</div>';

            try {
                const prompt = `Break down this financial task into 3-5 specific, actionable sub-steps (checklist).
                Task: "${item.description}"
                Category: "${item.category}"
                
                Return ONLY a JSON array of strings. Example: ["Step 1", "Step 2"]`;

                const response = await fetch(`${API_URL}/advisor/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: prompt,
                        include_context: false,
                        api_key: apiKey
                    })
                });

                const data = await response.json();
                let steps = [];
                try {
                    const jsonText = data.response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    steps = JSON.parse(jsonText);
                } catch (e) {
                    steps = data.response.split('\n').filter(l => l.trim().length > 0).map(l => l.replace(/^- /, '').replace(/^\d+\. /, ''));
                }

                // Format as subtask objects
                const subtasks = steps.map(s => ({ text: s, completed: false }));
                
                // Save to backend
                await fetch(`${API_URL}/action-items`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: itemId, subtasks: subtasks })
                });

                // Update local model
                item.subtasks = subtasks;
                renderWizardStep();

            } catch (error) {
                alert('Error generating subtasks: ' + error.message);
                bodyDiv.innerHTML = originalContent;
            }
        }

        async function toggleSubtask(itemId, subtaskIndex) {
            const item = wizardItems.find(i => i.id === itemId);
            if (!item) return;

            item.subtasks[subtaskIndex].completed = !item.subtasks[subtaskIndex].completed;
            
            // Save to backend (silent update)
            await fetch(`${API_URL}/action-items`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: itemId, subtasks: item.subtasks })
            });
            
            renderWizardStep(); // Re-render to show strikethrough
        }

        async function wizardAIAssist() {
            const item = wizardItems[currentWizardIndex];
            const prompt = `I need help with this task: "${item.description}". 
            Category: ${item.category}.
            Can you provide a brief guide or explanation on how to get started?`;
            
            // Switch to Advisor tab and populate chat
            closeWizard();
            showTab('advisor');
            document.getElementById('chat-input').value = prompt;
            // Optionally auto-send: sendMessage(); 
        }

        // --- End Wizard Functions ---

        async function loadActionItems(suppressRender = false) {
            try {
                const profileName = getCurrentProfileName();
                const response = await fetch(`${API_URL}/action-items?profile_name=${encodeURIComponent(profileName)}`);
                const items = await response.json();
                
                // Store globally for wizard access
                window.currentActionItems = items;

                // Update Dashboard Widget
                updateCriticalActionsWidget(items);

                if (suppressRender) return;
                
                const total = items.length;
                const completed = items.filter(i => i.status === 'completed').length;
                const progressPct = total > 0 ? (completed / total) * 100 : 0;

                const progressHtml = `
                    <div style="margin-bottom: 20px; background: #f1f2f6; padding: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: 600;">
                            <span>Progress</span>
                            <span>${completed} of ${total} completed</span>
                        </div>
                        <div style="height: 10px; background: #ddd; border-radius: 5px; overflow: hidden;">
                            <div style="height: 100%; width: ${progressPct}%; background: #27ae60; transition: width 0.5s;"></div>
                        </div>
                    </div>
                `;

                const html = items.map(item => {
                    // Check if description already has a link
                    let actionLink = '';
                    if (!item.description.includes('<a href')) {
                        const query = encodeURIComponent(`${item.category} ${item.description} guide`);
                        actionLink = ` <a href="https://www.google.com/search?q=${query}" target="_blank" style="color: #3498db; text-decoration: none; font-size: 12px; border: 1px solid #3498db; padding: 2px 6px; border-radius: 4px; margin-left: 5px;">Search Guide ‚Üó</a>`;
                    }

                    const isCompleted = item.status === 'completed';
                    const itemStyle = isCompleted ? 'opacity: 0.6; background: #f8f9fa; border-left-color: #bdc3c7;' : '';
                    const descStyle = isCompleted ? 'text-decoration: line-through; color: #7f8c8d;' : '';

                    // Smart Apply Button
                    let applyBtn = '';
                    if (item.action_data && !isCompleted) {
                        const dataStr = JSON.stringify(item.action_data).replace(/"/g, '&quot;');
                        applyBtn = `
                            <button onclick="applyActionUpdate(${item.id}, ${dataStr})" 
                                    style="padding: 4px 10px; font-size: 12px; margin-left: 10px; background: #9b59b6;">
                                ‚ö° Apply Update
                            </button>
                        `;
                    }

                    return `
                    <li class="action-item ${item.priority}" style="${itemStyle} display: flex; gap: 15px; align-items: start;">
                        <div style="padding-top: 5px;">
                            <input type="checkbox" 
                                   ${isCompleted ? 'checked' : ''} 
                                   onchange="toggleActionStatus(${item.id}, '${item.status}')"
                                   style="width: 18px; height: 18px; cursor: pointer;">
                        </div>
                        <div style="flex: 1;">
                            <div class="action-item-header">
                                <span class="action-item-category">${item.category}</span>
                                <span class="action-item-priority priority-${item.priority}">${item.priority}</span>
                            </div>
                            <div style="${descStyle}">${item.description}${actionLink}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                Due: ${item.due_date ? new Date(item.due_date).toLocaleDateString() : 'No date'}
                                ${applyBtn}
                            </div>
                        </div>
                    </li>
                `}).join('');
                
                document.getElementById('action-items-list').innerHTML = progressHtml + (html || '<div class="loading">No action items</div>');
            } catch (error) {
                document.getElementById('action-items-list').innerHTML = '<div class="loading">Error loading items: ' + error.message + '</div>';
            }
        }

        function updateCriticalActionsWidget(items) {
            const widget = document.getElementById('critical-actions-widget');
            if (!widget) return;

            const criticalItems = items.filter(i => i.status === 'pending' && (i.priority === 'critical' || i.priority === 'high'));
            
            if (criticalItems.length > 0) {
                widget.style.display = 'block';
                document.getElementById('critical-actions-count').textContent = `You have ${criticalItems.length} urgent tasks pending that require your attention.`;
            } else {
                widget.style.display = 'none';
            }
        }

        async function toggleActionStatus(id, currentStatus) {
            const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
            try {
                await fetch(`${API_URL}/action-items`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: id, status: newStatus })
                });
                loadActionItems();
            } catch (error) {
                alert('Error updating status');
            }
        }

        async function applyActionUpdate(id, data) {
            if (!confirm(`This will update your profile settings:\n\nField: ${data.field}\nValue: ${data.value}\n\nProceed?`)) return;

            try {
                // Map fields to DOM IDs
                const fieldMap = {
                    'target_annual_income': 'target-income',
                    'annual_expenses': 'expenses',
                    'risk_tolerance': 'risk',
                    'pension_annual': 'pension-annual',
                    'stock_allocation': 'stocks-slider',
                    'social_security_p1': 'p1-ss',
                    'social_security_p2': 'p2-ss'
                };

                // Update Profile Form
                if (fieldMap[data.field]) {
                    const el = document.getElementById(fieldMap[data.field]);
                    if (el) {
                        el.value = data.value;
                        // Trigger change events if needed (e.g. for sliders)
                        if (el.type === 'range') {
                            updateSliderDisplay(el);
                            updateAllocationBars();
                        }
                    }
                } else if (data.field === 'retirement_date_p1') {
                    document.getElementById('p1-retire').value = data.value;
                } else if (data.field === 'retirement_date_p2') {
                    document.getElementById('p2-retire').value = data.value;
                }

                // Save Profile
                await saveCurrentProfile();

                // Mark Item as Completed
                await toggleActionStatus(id, 'pending'); // Will flip to completed

                alert('‚úÖ Profile updated and action item marked as complete!');
                
            } catch (error) {
                alert('Error applying update: ' + error.message);
            }
        }
        
        async function cleanupActionItems() {
            try {
                const response = await fetch(`${API_URL}/action-items/cleanup`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`Cleanup complete! Removed ${result.removed_count} duplicate items.`);
                    loadActionItems();
                } else {
                    alert('Cleanup failed: ' + result.error);
                }
            } catch (error) {
                alert('Request failed: ' + error.message);
            }
        }

        async function generateActionItems() {
            if (!window.currentAnalysis) {
                alert('Please run analysis first');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/generate-action-items`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        analysis: window.currentAnalysis,
                        profile_name: getCurrentProfileName()
                    })
                });

                const result = await response.json();
                loadActionItems();
            } catch (error) {
                alert('Error generating items: ' + error.message);
            }
        }

        async function runSelfAssessment() {
            const apiKey = checkApiKey();
            const provider = localStorage.getItem('default_llm') || 'gemini';
            
            if (!apiKey) {
                alert("Please set your API Keys in Settings first.");
                openSettings();
                return;
            }

            // Visual feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "Analyzing...";
            btn.disabled = true;

            const currentProfile = getCurrentProfileName();

            try {
                const response = await fetch(`${API_URL}/perform-self-assessment`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        api_key: apiKey,
                        profile_name: currentProfile,
                        profile_data: getFormData(),
                        llm_provider: provider
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`AI Assessment Complete!\n\nAdded ${result.items_created} new strategic tasks based on the Skills library.`);
                    loadActionItems();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // AI Advisor functions
        function checkApiKey() {
            const provider = localStorage.getItem('default_llm') || 'gemini';
            const geminiKey = localStorage.getItem('gemini_api_key');
            const claudeKey = localStorage.getItem('claude_api_key');
            
            const currentKey = (provider === 'gemini') ? geminiKey : claudeKey;
            
            if (currentKey) {
                document.getElementById('api-key-notice').style.display = 'none';
                document.getElementById('api-key-status').style.display = 'block';
            } else {
                document.getElementById('api-key-notice').style.display = 'block';
                document.getElementById('api-key-status').style.display = 'none';
            }

            // Update indicator
            const indicator = document.getElementById('current-llm-name');
            if (indicator) {
                indicator.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
            }

            return currentKey;
        }

        function applySettings(settings) {
            // Apply theme
            if (settings.theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }

            // Apply compact mode
            if (settings.compactMode) {
                document.body.classList.add('compact-mode');
            } else {
                document.body.classList.remove('compact-mode');
            }

            // Apply font size
            document.body.classList.remove('font-small', 'font-medium', 'font-large');
            document.body.classList.add('font-' + settings.fontSize);

            // Apply animations
            if (!settings.animations) {
                document.body.classList.add('no-animations');
            } else {
                document.body.classList.remove('no-animations');
            }

            // Update LLM indicator
            const provider = settings.defaultLLM || 'gemini';
            localStorage.setItem('default_llm', provider);
            checkApiKey();

            // Update header with user name
            const headerTitle = document.querySelector('header h1');
            if (settings.userName && settings.userName !== 'User') {
                document.querySelector('.subtitle').textContent = `${settings.userName}'s Financial Planning Dashboard`;
            } else {
                document.querySelector('.subtitle').textContent = 'Comprehensive financial, tax, estate, and legacy planning';
            }
        }


        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            const apiKey = checkApiKey();
            const provider = localStorage.getItem('default_llm') || 'gemini';
            
            if (!apiKey) {
                alert('Please set your API keys in Settings first');
                openSettings();
                return;
            }

            // Disable input while processing
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            input.disabled = true;

            // Add user message to chat
            addMessageToChat('user', message);
            input.value = '';

            const currentProfile = getCurrentProfileName();

            try {
                const response = await fetch(`${API_URL}/advisor/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: message,
                        api_key: apiKey,
                        include_context: true,
                        profile_name: currentProfile,
                        profile_data: getFormData(),
                        llm_provider: provider
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessageToChat('assistant', data.response);
                } else {
                    addMessageToChat('error', data.error || 'An error occurred');
                }
            } catch (error) {
                addMessageToChat('error', 'Error: ' + error.message);
            } finally {
                // Re-enable input
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                input.disabled = false;
                input.focus();
            }
        }

        function addMessageToChat(role, content) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            // Convert markdown-style formatting to HTML
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            messageDiv.innerHTML = formattedContent;
            messagesDiv.appendChild(messageDiv);

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handleChatKeypress(event) {
            // Send message on Enter (but allow Shift+Enter for new line)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function clearConversation() {
            if (!confirm('Are you sure you want to clear the conversation history?')) {
                return;
            }

            try {
                const profileName = getCurrentProfileName();
                await fetch(`${API_URL}/advisor/clear?profile_name=${encodeURIComponent(profileName)}`, {
                    method: 'POST'
                });

                document.getElementById('chat-messages').innerHTML = '';
            } catch (error) {
                alert('Error clearing conversation: ' + error.message);
            }
        }

        async function loadConversationHistory() {
            try {
                const profileName = getCurrentProfileName();
                const response = await fetch(`${API_URL}/advisor/history?profile_name=${encodeURIComponent(profileName)}`);
                const history = await response.json();

                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = '';
                
                history.forEach(msg => {
                    addMessageToChat(msg.role === 'user' ? 'user' : 'assistant', msg.content);
                });
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Slider helper functions
        function toggleAdvanced() {
            const advancedParams = document.getElementById('advanced-parameters');
            const button = event.target;
            if (advancedParams.classList.contains('show')) {
                advancedParams.classList.remove('show');
                button.textContent = 'Show Advanced Parameters';
            } else {
                advancedParams.classList.add('show');
                button.textContent = 'Hide Advanced Parameters';
            }
        }

        function resetToDefaults() {
            document.getElementById('stocks-slider').value = 50;
            document.getElementById('stock-return-slider').value = 10;
            document.getElementById('bond-return-slider').value = 4;
            document.getElementById('inflation-slider').value = 3;
            document.getElementById('stock-volatility-slider').value = 18;
            document.getElementById('bond-volatility-slider').value = 6;
            document.getElementById('inflation-volatility-slider').value = 1;
            document.getElementById('ss-discount-slider').value = 3;

            // Update all displays
            updateSliderDisplay(document.getElementById('stocks-slider'));
            updateSliderDisplay(document.getElementById('stock-return-slider'));
            updateSliderDisplay(document.getElementById('bond-return-slider'));
            updateSliderDisplay(document.getElementById('inflation-slider'));
            updateSliderDisplay(document.getElementById('stock-volatility-slider'));
            updateSliderDisplay(document.getElementById('bond-volatility-slider'));
            updateSliderDisplay(document.getElementById('inflation-volatility-slider'));
            updateSliderDisplay(document.getElementById('ss-discount-slider'));
        }

        function updateSliderDisplay(slider) {
            const id = slider.id;
            const value = parseFloat(slider.value);

            if (id === 'stocks-slider') {
                document.getElementById('stocks-value').textContent = value.toFixed(0);
                document.getElementById('bonds-value').textContent = (100 - value).toFixed(0);
            } else if (id === 'stock-return-slider') {
                document.getElementById('stock-return-value').textContent = value.toFixed(2);
            } else if (id === 'bond-return-slider') {
                document.getElementById('bond-return-value').textContent = value.toFixed(2);
            } else if (id === 'inflation-slider') {
                document.getElementById('inflation-value').textContent = value.toFixed(2);
            } else if (id === 'stock-volatility-slider') {
                document.getElementById('stock-volatility-value').textContent = value.toFixed(2);
            } else if (id === 'bond-volatility-slider') {
                document.getElementById('bond-volatility-value').textContent = value.toFixed(2);
            } else if (id === 'inflation-volatility-slider') {
                document.getElementById('inflation-volatility-value').textContent = value.toFixed(2);
            } else if (id === 'ss-discount-slider') {
                document.getElementById('ss-discount-value').textContent = value.toFixed(2);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function attachSliderListeners() {
            const sliders = document.querySelectorAll('.scenario-parameters input[type="range"]');

            sliders.forEach(slider => {
                // Update display on input (immediate feedback)
                slider.addEventListener('input', debounce(() => {
                    updateSliderDisplay(slider);
                }, 50));

                // Auto-run analysis on change if checkbox is checked
                slider.addEventListener('change', debounce(() => {
                    if (document.getElementById('auto-update-checkbox')?.checked) {
                        runAnalysis();
                    }
                }, 500));
            });
        }

        function attachAutoSaveListeners() {
            // Person 1 fields
            ['p1-name', 'p1-birth', 'p1-retire', 'p1-ss'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', debouncedAutoSave);
            });

            // Person 2 fields
            ['p2-name', 'p2-birth', 'p2-retire', 'p2-ss'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', debouncedAutoSave);
            });

            // Expenses
            const expenses = document.getElementById('expenses');
            if (expenses) expenses.addEventListener('input', debouncedAutoSave);

            // Market assumption sliders
            ['stocks-slider', 'stock-return-slider', 'stock-volatility-slider',
             'bond-return-slider', 'bond-volatility-slider', 'inflation-slider',
             'inflation-volatility-slider', 'ss-discount-slider', 'tax-rate-slider'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', debouncedAutoSave);
            });
        }

        // Check API key on load
        window.addEventListener('load', () => {
            checkApiKey();
            loadConversationHistory();
            attachDashboardListeners();
            attachSliderListeners();
            attachAutoSaveListeners();
            renderInvestmentTypes();
            fetchProfiles();
            refreshScenarios();
            updateIncomeOwnerLabels();

            // Update income owner dropdown labels when person names change
            document.getElementById('p1-name').addEventListener('input', updateIncomeOwnerLabels);
            document.getElementById('p2-name').addEventListener('input', () => {
                updateIncomeOwnerLabels();
                renderIncomeStreams(); // Also re-render table to show updated names
            });
            document.getElementById('p1-name').addEventListener('input', () => {
                renderIncomeStreams(); // Re-render table when person 1 name changes
            });
        });

        // loadProfile(); // Removed, user must select profile

        // ========================================
        // Settings Management
        // ========================================

        async function openSettings() {
            await loadSettings();
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        async function loadSettings() {
            const settings = getSettings();

            // Load theme
            document.getElementById('setting-theme').value = settings.theme;

            // Load compact mode
            document.getElementById('setting-compact').checked = settings.compactMode;

            // Load user name
            document.getElementById('setting-username').value = settings.userName;

            // Load font size
            document.getElementById('setting-fontsize').value = settings.fontSize;

            // Load auto-save
            document.getElementById('setting-autosave').checked = settings.autoSave;

            // Load animations
            document.getElementById('setting-animations').checked = settings.animations;

            // Load target success
            document.getElementById('setting-target-success').value = settings.targetSuccessRate || 90;

            // Load system settings from backend
            try {
                const response = await fetch(`${API_URL}/system/settings`);
                const sysSettings = await response.json();
                if (sysSettings.gemini_api_key) {
                    document.getElementById('setting-api-key').value = sysSettings.gemini_api_key;
                    localStorage.setItem('gemini_api_key', sysSettings.gemini_api_key);
                }
                if (sysSettings.claude_api_key) {
                    document.getElementById('setting-claude-api-key').value = sysSettings.claude_api_key;
                    localStorage.setItem('claude_api_key', sysSettings.claude_api_key);
                }
                if (sysSettings.default_llm) {
                    document.getElementById('setting-default-llm').value = sysSettings.default_llm;
                    localStorage.setItem('default_llm', sysSettings.default_llm);
                }
            } catch (e) {
                console.error("Failed to load system settings", e);
            }
        }

        function getSettings() {
            const defaults = {
                theme: 'light',
                compactMode: false,
                userName: 'User',
                fontSize: 'medium',
                autoSave: true,  // Auto-save enabled by default
                animations: true,
                defaultLLM: 'gemini',
                targetSuccessRate: 90
            };

            const stored = localStorage.getItem('app_settings');
            return stored ? { ...defaults, ...JSON.parse(stored) } : defaults;
        }

        async function saveSettings() {
            const settings = {
                theme: document.getElementById('setting-theme').value,
                compactMode: document.getElementById('setting-compact').checked,
                userName: document.getElementById('setting-username').value,
                fontSize: document.getElementById('setting-fontsize').value,
                autoSave: document.getElementById('setting-autosave').checked,
                animations: document.getElementById('setting-animations').checked,
                defaultLLM: document.getElementById('setting-default-llm').value,
                targetSuccessRate: parseInt(document.getElementById('setting-target-success').value)
            };

            const geminiKey = document.getElementById('setting-api-key').value.trim();
            const claudeKey = document.getElementById('setting-claude-api-key').value.trim();
            const defaultLLM = document.getElementById('setting-default-llm').value;

            localStorage.setItem('app_settings', JSON.stringify(settings));
            if (geminiKey) localStorage.setItem('gemini_api_key', geminiKey);
            if (claudeKey) localStorage.setItem('claude_api_key', claudeKey);
            localStorage.setItem('default_llm', defaultLLM);
            
            applySettings(settings);

            // Save to backend
            try {
                await fetch(`${API_URL}/system/settings`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        gemini_api_key: geminiKey,
                        claude_api_key: claudeKey,
                        default_llm: defaultLLM
                    })
                });
            } catch (e) {
                console.error("Failed to save system settings", e);
            }

            // Show success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: 15px 20px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
            `;
            notification.textContent = '‚úì Settings saved successfully';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);

            // Close the modal after a brief delay
            setTimeout(() => closeSettings(), 500);
        }

        function applySettings(settings) {
            // Apply theme
            if (settings.theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }

            // Apply compact mode
            if (settings.compactMode) {
                document.body.classList.add('compact-mode');
            } else {
                document.body.classList.remove('compact-mode');
            }

            // Apply font size
            document.body.classList.remove('font-small', 'font-medium', 'font-large');
            document.body.classList.add('font-' + settings.fontSize);

            // Apply animations
            if (!settings.animations) {
                document.body.classList.add('no-animations');
            } else {
                document.body.classList.remove('no-animations');
            }

            // Update header with user name
            const headerTitle = document.querySelector('header h1');
            if (settings.userName && settings.userName !== 'User') {
                document.querySelector('.subtitle').textContent = `${settings.userName}'s Financial Planning Dashboard`;
            } else {
                document.querySelector('.subtitle').textContent = 'Comprehensive financial, tax, estate, and legacy planning';
            }
        }

        function resetSettings() {
            if (!confirm('Are you sure you want to reset all settings to defaults?')) {
                return;
            }

            localStorage.removeItem('app_settings');
            const defaults = getSettings();
            applySettings(defaults);
            loadSettings();

            alert('Settings reset to defaults!');
        }

        // Apply settings on page load
        window.addEventListener('DOMContentLoaded', () => {
            const settings = getSettings();
            applySettings(settings);
        });

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('settings-modal');
            if (e.target === modal) {
                closeSettings();
            }
        });

    </script>

    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h2>‚öôÔ∏è Application Settings</h2>
                <button class="close-settings" onclick="closeSettings()">√ó</button>
            </div>

            <div class="settings-body">
                <!-- Appearance Settings -->
                <div class="setting-group">
                    <h3>üé® Appearance</h3>

                    <div class="setting-item">
                        <div>
                            <label>Theme</label>
                            <div class="description">Choose your preferred color scheme</div>
                        </div>
                        <select id="setting-theme">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Font Size</label>
                            <div class="description">Adjust text size for readability</div>
                        </div>
                        <select id="setting-fontsize">
                            <option value="small">Small</option>
                            <option value="medium">Medium</option>
                            <option value="large">Large</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Compact Mode</label>
                            <div class="description">Reduce spacing for more content density</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-compact">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Animations</label>
                            <div class="description">Enable smooth transitions and effects</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-animations">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Personalization Settings -->
                <div class="setting-group">
                    <h3>üë§ Personalization</h3>

                    <div class="setting-item">
                        <div>
                            <label>Your Name</label>
                            <div class="description">Personalize the dashboard header</div>
                        </div>
                        <input type="text" id="setting-username" placeholder="Enter your name">
                    </div>
                </div>

                <!-- System Configuration -->
                <div class="setting-group">
                    <h3>üîß System Configuration</h3>

                    <div class="setting-item">
                        <div>
                            <label>Default AI Provider</label>
                            <div class="description">Select the primary LLM for advisor features</div>
                        </div>
                        <select id="setting-default-llm">
                            <option value="gemini">Google Gemini</option>
                            <option value="claude">Anthropic Claude</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Gemini API Key</label>
                            <div class="description">Required for Google Gemini models</div>
                        </div>
                        <input type="password" id="setting-api-key" placeholder="AIza...">
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Claude API Key</label>
                            <div class="description">Required for Anthropic Claude models</div>
                        </div>
                        <input type="password" id="setting-claude-api-key" placeholder="sk-ant-...">
                    </div>
                </div>

                <!-- Behavior Settings -->
                <div class="setting-group">
                    <h3>‚ö° Behavior</h3>

                    <div class="setting-item">
                        <div>
                            <label>Target Success Rate (%)</label>
                            <div class="description">Define your minimum acceptable retirement success probability</div>
                        </div>
                        <input type="number" id="setting-target-success" min="50" max="100" style="width: 80px; min-width: 80px;">
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Auto-Save Profiles</label>
                            <div class="description">Automatically save changes to your profile</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-autosave">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="settings-footer">
                <button class="btn-reset" onclick="resetSettings()">Reset to Defaults</button>
                <button class="secondary" onclick="closeSettings()">Cancel</button>
                <button onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>
    <!-- Action Item Wizard Modal -->
    <div id="wizard-modal" class="settings-modal">
        <div class="settings-content" style="max-width: 800px;">
            <div class="settings-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h2 style="color: white;">‚ú® Action Item Wizard</h2>
                <button class="close-settings" onclick="closeWizard()" style="color: white;">√ó</button>
            </div>

            <div class="settings-body" id="wizard-body" style="min-height: 400px; display: flex; flex-direction: column;">
                <!-- Wizard content populated by JS -->
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: #666;">
                    Loading wizard...
                </div>
            </div>

            <div class="settings-footer" style="justify-content: space-between;">
                <button class="secondary" onclick="wizardPrev()">‚Üê Previous</button>
                <div>
                    <span id="wizard-progress" style="margin-right: 15px; color: #666; font-size: 13px;"></span>
                    <button id="wizard-ai-assist-btn" class="ai-button" onclick="wizardAIAssist()" style="display: none;">ü§ñ AI Assist</button>
                    <button id="wizard-complete-btn" class="secondary" onclick="wizardMarkComplete()" style="background: #27ae60; color: white; display: none;">Mark Complete</button>
                    <button onclick="wizardNext()">Next ‚Üí</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
