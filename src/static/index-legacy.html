<!DOCTYPE html>
<html>
<head>
    <title>Retirement Planning System</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Light theme (default) */
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #ecf0f1;
            --text-primary: #333;
            --text-secondary: #666;
            --text-light: #999;
            --header-bg: #2c3e50;
            --header-text: #ffffff;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --border-color: #ddd;
            --shadow: rgba(0,0,0,0.1);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --success-text: #155724;
            --warning-text: #856404;
            --success-bg: #d4edda;
            --warning-bg: #fff3cd;
            --danger-bg: #f8d7da;
            --info-bg: #d1ecf1;
            --info-color: #17a2b8;
            --card-gradient-1: #667eea;
            --card-gradient-2: #764ba2;
        }

        body.dark-mode {
            /* Dark theme */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-light: #808080;
            --header-bg: #1f1f1f;
            --header-text: #ffffff;
            --accent-color: #4dabf7;
            --accent-hover: #339af0;
            --border-color: #404040;
            --shadow: rgba(0,0,0,0.3);
            --success-color: #51cf66;
            --warning-color: #ffd43b;
            --danger-color: #ff6b6b;
            --success-text: #51cf66;
            --warning-text: #ffd43b;
            --success-bg: #1a3a1a;
            --warning-bg: #3a3a1a;
            --danger-bg: #3a1a1a;
            --info-bg: #1a2a3a;
            --info-color: #4dabf7;
            --card-gradient-1: #5c7cfa;
            --card-gradient-2: #9775fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header .header-content {
            flex: 1;
        }

        header .settings-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--header-text);
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        header .settings-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: var(--text-light);
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 500;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border: 1px solid var(--border-color);
            border-bottom: none;
            transition: all 0.3s;
        }

        .tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent-color);
            color: white;
            font-weight: 600;
            border-color: var(--accent-color);
        }

        .tab-content {
            display: none;
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            color: white;
        }
        
        .metric-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .metric-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .metric-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }
        
        input, select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        button {
            background: var(--accent-color);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: var(--accent-hover);
        }

        button.secondary {
            background: var(--text-secondary);
        }

        button.secondary:hover {
            background: var(--text-primary);
        }

        button.ai-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-left: 10px;
        }

        button.ai-button:hover {
            background: linear-gradient(135deg, #5568d3 0%, #63408a 100%);
        }

        .action-items-list {
            list-style: none;
        }
        
        .action-item {
            background: var(--bg-tertiary);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid var(--accent-color);
        }
        
        .action-item.critical {
            border-left-color: var(--danger-color);
        }

        .action-item.high {
            border-left-color: var(--warning-color);
        }

        .action-item.medium {
            border-left-color: var(--warning-color);
        }
        
        .action-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .action-item-category {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .action-item-priority {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-critical {
            background: var(--danger-color);
            color: white;
        }

        .priority-high {
            background: var(--warning-color);
            color: white;
        }

        .priority-medium {
            background: var(--warning-color);
            color: white;
        }
        
        .analysis-section {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .analysis-section h4 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-tertiary);
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
        }

        .chat-message.user {
            background: var(--accent-color);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .chat-message.assistant {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .chat-message.error {
            background: var(--danger-color);
            color: white;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 40px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .chat-button {
            padding: 10px 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .chat-button:hover {
            background: var(--accent-hover);
        }

        .chat-button:disabled {
            background: var(--text-light);
            cursor: not-allowed;
        }

        .api-key-notice {
            background: var(--warning-color);
            border: 1px solid var(--warning-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: var(--text-primary);
            opacity: 0.9;
        }

        .api-key-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .api-key-input input {
            flex: 1;
        }

        .scenario-parameters {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .scenario-parameters h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 18px;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .slider-value {
            font-weight: 700;
            color: var(--accent-color);
            font-size: 15px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            transition: background 0.3s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--accent-hover);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
            transition: background 0.3s;
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: var(--accent-hover);
        }

        .advanced-toggle {
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .advanced-parameters {
            display: none;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
        }

        .advanced-parameters.show {
            display: block;
        }

        .reset-button {
            background: var(--text-secondary);
            margin-top: 10px;
        }

        .reset-button:hover {
            background: var(--text-primary);
        }

        .auto-update-option {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-update-option input[type="checkbox"] {
            width: auto;
        }

        .assumptions-used {
            background: var(--bg-tertiary);
            border: 1px solid var(--success-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .assumptions-used h4 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 16px;
        }

        .assumptions-used p {
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .settings-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .settings-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px var(--shadow);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 20px 30px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            font-size: 22px;
            margin: 0;
        }

        .close-settings {
            background: transparent;
            color: var(--header-text);
            border: none;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-settings:hover {
            background: rgba(255,255,255,0.1);
        }

        .settings-body {
            padding: 20px;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-group h3 {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .setting-item label {
            flex: 1;
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .setting-item .description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .setting-item select,
        .setting-item input[type="text"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            min-width: 150px;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.4s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .settings-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-reset {
            background: var(--danger-color);
        }

        .btn-reset:hover {
            opacity: 0.9;
        }

        /* Font Size Classes */
        body.font-small {
            font-size: 13px;
        }

        body.font-small h1 {
            font-size: 24px;
        }

        body.font-small h2 {
            font-size: 20px;
        }

        body.font-small h3 {
            font-size: 17px;
        }

        body.font-medium {
            font-size: 15px;
        }

        body.font-large {
            font-size: 17px;
        }

        body.font-large h1 {
            font-size: 32px;
        }

        body.font-large h2 {
            font-size: 26px;
        }

        body.font-large h3 {
            font-size: 22px;
        }

        /* Compact Mode */
        body.compact-mode .container {
            padding: 15px;
        }

        body.compact-mode header {
            padding: 15px;
            margin-bottom: 20px;
        }

        body.compact-mode .tab-content {
            padding: 20px;
        }

        /* Welcome Screen Hover Effects */
        .welcome-card:hover, .learn-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 16px var(--shadow);
            border-color: var(--accent-color) !important;
        }

        body.compact-mode .metric-grid {
            gap: 15px;
            margin-bottom: 20px;
        }

        body.compact-mode .metric-card {
            padding: 15px;
        }

        body.compact-mode .analysis-section {
            padding: 15px;
            margin-bottom: 15px;
        }

        body.compact-mode .setting-item {
            padding: 8px 12px;
            margin-bottom: 6px;
        }

        /* Disable Animations */
        body.no-animations * {
            animation: none !important;
            transition: none !important;
        }

        /* Print Styles for Summary Report */
        @media print {
            body {
                background: var(--bg-secondary);
            }

            .container, header, .tabs {
                display: none !important;
            }

            #summary-tab {
                display: block !important;
                position: static;
                margin: 0;
                padding: 0;
            }

            .summary-report {
                max-width: 100% !important;
                margin: 0 !important;
                box-shadow: none !important;
            }

            .no-print {
                display: none !important;
            }

            .report-header {
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .summary-section h2 {
                page-break-after: avoid;
            }

            .summary-section {
                page-break-inside: avoid;
            }

            /* Preserve gradient backgrounds */
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Retirement & Wealth Planning System</h1>
                <div class="subtitle">Comprehensive financial, tax, estate, and legacy planning</div>
            </div>
            <button class="settings-btn" onclick="openSettings()">
                <span>‚öôÔ∏è</span>
                <span>Settings</span>
            </button>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('welcome')">‚ú® Welcome</button>
            <button class="tab" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="showTab('profile')">Profile & Data</button>
            <button class="tab" onclick="showTab('accounts')">Withdrawal Strategy</button>
            <button class="tab" onclick="showTab('analysis')">Analysis</button>
            <button class="tab" onclick="showTab('comparison')">Compare Scenarios</button>
            <button class="tab" onclick="showTab('actions')">Action Items</button>
            <button class="tab" onclick="showTab('advisor')">AI Advisor</button>
            <button class="tab" onclick="showTab('summary')">üìÑ Summary</button>
            <button class="tab" onclick="showTab('learn')">üìö Learn</button>
        </div>

        <div id="welcome-tab" class="tab-content active">
            <div style="max-width: 900px; margin: 0 auto; padding: 40px 20px;">
                <h1 style="font-size: 42px; margin-bottom: 20px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    Welcome to Your Retirement Planning Tool
                </h1>
                <p style="font-size: 18px; text-align: center; color: var(--text-secondary); margin-bottom: 50px;">
                    Plan your future with confidence. Let's get started!
                </p>

                <div style="display: grid; gap: 20px; margin-bottom: 40px;">
                    <div class="welcome-card" onclick="startProfileWizard()" style="cursor: pointer; padding: 30px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 12px; transition: all 0.3s; box-shadow: 0 2px 8px var(--shadow);">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ú®</div>
                        <h2 style="font-size: 24px; margin-bottom: 10px; color: var(--text-primary);">Create New Profile</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 0;">Start your retirement planning journey with our guided wizard. We'll walk you through every step.</p>
                    </div>

                    <div class="welcome-card" onclick="showExistingProfiles()" style="cursor: pointer; padding: 30px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 12px; transition: all 0.3s; box-shadow: 0 2px 8px var(--shadow);">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìÇ</div>
                        <h2 style="font-size: 24px; margin-bottom: 10px; color: var(--text-primary);">Open Existing Profile</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 0;">Continue working on your saved retirement plans.</p>
                        <div id="profile-list-container" style="margin-top: 20px; display: none;"></div>
                    </div>
                </div>

                <div style="margin-top: 60px;">
                    <h3 style="font-size: 24px; margin-bottom: 20px; color: var(--text-primary);">Learn About Retirement Planning</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div class="learn-card" onclick="showTab('learn')" style="cursor: pointer; padding: 20px; background: var(--bg-tertiary); border-radius: 8px; transition: all 0.3s;">
                            <h4 style="font-size: 18px; margin-bottom: 8px;">üìö Retirement Basics</h4>
                            <p style="font-size: 14px; color: var(--text-secondary); margin: 0;">Learn the fundamentals of retirement planning</p>
                        </div>
                        <div class="learn-card" onclick="showTab('learn')" style="cursor: pointer; padding: 20px; background: var(--bg-tertiary); border-radius: 8px; transition: all 0.3s;">
                            <h4 style="font-size: 18px; margin-bottom: 8px;">üèõÔ∏è Estate Planning</h4>
                            <p style="font-size: 14px; color: var(--text-secondary); margin: 0;">Protect your assets and legacy</p>
                        </div>
                        <div class="learn-card" onclick="showTab('learn')" style="cursor: pointer; padding: 20px; background: var(--bg-tertiary); border-radius: 8px; transition: all 0.3s;">
                            <h4 style="font-size: 18px; margin-bottom: 8px;">üí∞ Tax Strategies</h4>
                            <p style="font-size: 14px; color: var(--text-secondary); margin: 0;">Optimize your tax efficiency</p>
                        </div>
                        <div class="learn-card" onclick="showTab('learn')" style="cursor: pointer; padding: 20px; background: var(--bg-tertiary); border-radius: 8px; transition: all 0.3s;">
                            <h4 style="font-size: 18px; margin-bottom: 8px;">üìä Investment Basics</h4>
                            <p style="font-size: 14px; color: var(--text-secondary); margin: 0;">Build a solid investment foundation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Financial Control Center</h2>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <select id="dashboard-profile-select" style="padding: 6px; font-size: 13px; border-radius: 4px; border: 1px solid var(--border-color); max-width: 200px;" onchange="if(this.value) loadProfile(this.value)">
                        <option value="" disabled selected>Load Profile...</option>
                    </select>
                    <button onclick="showTab('profile')" style="padding: 6px 12px; font-size: 13px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--accent-hover)'" onmouseout="this.style.background='var(--accent-color)'">
                        ‚úèÔ∏è Edit Profile
                    </button>
                    <div style="font-size: 13px; color: var(--text-secondary);">
                        <span id="dashboard-last-updated">Last updated: Never</span>
                    </div>
                </div>
            </div>

            <!-- Top Row: Key Metrics -->
            <div id="dashboard-metrics" class="metric-grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <!-- Populated by JS -->
            </div>

            <!-- NEW: Critical Actions Widget -->
            <div id="critical-actions-widget" style="display: none; margin-bottom: 20px; background: var(--danger-bg); border: 1px solid var(--danger-color); border-radius: 8px; padding: 15px; border-left: 5px solid var(--danger-color);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">‚ö†Ô∏è</span>
                        <div>
                            <strong style="color: var(--text-primary);">Critical Actions Required</strong>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;" id="critical-actions-count">You have 0 urgent tasks pending.</p>
                        </div>
                    </div>
                    <button onclick="startWizard()" style="background: var(--danger-color); color: white; padding: 8px 16px; font-size: 13px; border: none; border-radius: 4px; cursor: pointer;">‚ö° Resolve Now</button>
                </div>
            </div>

            <!-- Middle Row: Main Chart -->
            <div class="analysis-section" style="padding: 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">Wealth Timeline Projection</h4>
                    <div style="font-size: 12px; display: flex; gap: 15px;">
                        <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #3498db; border-radius: 50%;"></span> Median</span>
                        <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #2ecc71; border-radius: 50%;"></span> Best Case</span>
                        <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #e74c3c; border-radius: 50%;"></span> Worst Case</span>
                    </div>
                </div>
                <div style="height: 350px; position: relative;">
                    <canvas id="dashboard-chart"></canvas>
                </div>
            </div>

            <!-- Asset Location & Liquidity Analysis -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- Asset Location Pie Chart -->
                <div class="analysis-section">
                    <h4 style="margin-bottom: 15px;">üìç Where Is Your Money?</h4>
                    <div style="height: 300px; position: relative;">
                        <canvas id="asset-location-chart"></canvas>
                    </div>
                    <div id="asset-location-summary" style="margin-top: 15px; padding: 15px; background: var(--bg-tertiary); border-radius: 6px; font-size: 13px;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Liquidity by Age Bar Chart -->
                <div class="analysis-section">
                    <h4 style="margin-bottom: 15px;">üí∞ Accessible Assets by Age</h4>
                    <div style="height: 300px; position: relative;">
                        <canvas id="liquidity-by-age-chart"></canvas>
                    </div>
                    <div id="liquidity-score" style="margin-top: 15px; padding: 15px; background: var(--bg-tertiary); border-radius: 6px; font-size: 13px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Age-Based Timeline -->
            <div class="analysis-section" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-left: 4px solid #667eea;">
                <h4 style="margin-bottom: 15px;">üóìÔ∏è Your Financial Timeline</h4>
                <div id="financial-timeline" style="position: relative; padding: 20px 0;">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Gap Analysis Widget -->
            <div id="gap-analysis-widget" class="analysis-section" style="display: none; margin-bottom: 20px; background: var(--warning-bg); border-left: 4px solid var(--warning-color);">
                <h4 style="margin-bottom: 15px; color: var(--text-primary);">‚ö†Ô∏è Portfolio Gap Analysis</h4>
                <div id="gap-analysis-content">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Bottom Row: Quick Levers -->
            <div class="analysis-section" style="background: var(--bg-tertiary); border-top: 4px solid #3498db;">
                <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    üéõÔ∏è Scenario Sandbox <span style="font-size: 12px; font-weight: normal; color: var(--text-secondary);">(Adjust to see immediate impact)</span>
                </h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                    <!-- Lever 1: Spending -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label for="db-spending" style="margin: 0;">Annual Spending</label>
                            <span style="font-weight: 700; color: #3498db;" id="db-spending-val">$100,000</span>
                        </div>
                        <input type="range" id="db-spending" min="40000" max="300000" step="1000" value="100000" style="width: 100%;">
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">Impacts portfolio depletion rate</div>
                    </div>

                    <!-- Lever 1b: Withdrawal Rate -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label for="db-withdraw-rate" style="margin: 0;">Initial Withdrawal Rate</label>
                            <span style="font-weight: 700; color: #3498db;" id="db-withdraw-rate-val">4.0%</span>
                        </div>
                        <input type="range" id="db-withdraw-rate" min="0" max="10" step="0.1" value="4.0" style="width: 100%;">
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">% of portfolio withdrawn in year 1</div>
                    </div>

                    <!-- Lever 2: Retirement Date (Person 1) -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label for="db-retire-month" style="margin: 0;"><span id="db-p1-label">Person 1</span> Retirement</label>
                        </div>
                        <input type="month" id="db-retire-month" min="2024-01" max="2050-12" value="2035-01" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px;">
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">Affects accumulation vs. withdrawal</div>
                    </div>

                    <!-- Lever 2b: Retirement Date (Person 2) -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label for="db-retire-month-p2" style="margin: 0;"><span id="db-p2-label">Person 2</span> Retirement</label>
                        </div>
                        <input type="month" id="db-retire-month-p2" min="2024-01" max="2050-12" value="2035-01" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px;">
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">Affects accumulation vs. withdrawal</div>
                    </div>

                    <!-- Lever 3: Stock Allocation -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label for="db-allocation" style="margin: 0;">Stock Allocation</label>
                            <span style="font-weight: 700; color: #3498db;" id="db-allocation-val">50%</span>
                        </div>
                        <input type="range" id="db-allocation" min="0" max="100" step="5" value="50" style="width: 100%;">
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">Growth potential vs volatility</div>
                    </div>

                    <!-- Lever 4: Assumed Tax Rate -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label for="db-tax-rate" style="margin: 0;">Assumed Tax Rate</label>
                            <span style="font-weight: 700; color: #3498db;" id="db-tax-rate-val">22%</span>
                        </div>
                        <input type="range" id="db-tax-rate" min="0" max="40" step="1" value="22" style="width: 100%;">
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">Estimated effective tax drag on withdrawals</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="profile-tab" class="tab-content">
            <h2>Financial Profile</h2>

            <!-- Profile Progress Indicator -->
            <div id="profile-progress-container"></div>

            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #bce0fd;">
                <h3 style="margin-bottom: 15px; color: #2980b9;">Profile Management</h3>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label style="font-size: 12px; display: block; margin-bottom: 5px;">Select Existing Profile</label>
                        <select id="profile-select" style="width: 100%; padding: 8px;" onchange="onProfileSelectChange()">
                            <option value="" disabled selected>Select a profile...</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: flex-end;">
                        <button class="secondary" style="background-color: #3498db; height: 38px; margin-top: 21px;" onclick="loadDefaultProfile()" title="Load default profile template">üìÑ Load Default</button>
                        <button class="secondary" style="background-color: #27ae60; height: 38px; margin-top: 21px;" onclick="loadSampleProfile()" title="Load comprehensive sample profile with all features">üì¶ Load Sample</button>
                        <button class="secondary" style="background-color: #e74c3c; height: 38px; margin-top: 21px;" onclick="deleteSelectedProfile()">Delete</button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: flex-end; border-top: 1px dashed #bce0fd; padding-top: 15px;">
                    <div style="flex: 1;">
                        <label style="font-size: 12px; display: block; margin-bottom: 5px;">Profile Name (Save As...)</label>
                        <input type="text" id="profile-name-input" placeholder="e.g. 'Conservative Scenario', 'Main Plan'" style="width: 100%;">
                    </div>
                    <button onclick="saveCurrentProfile()" style="height: 38px;">Save Profile</button>
                </div>
            </div>

            <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                <p style="margin: 0; font-size: 13px; color: var(--text-primary);">
                    <strong>üë´ About Joint Planning:</strong> This system is designed for individuals, or couples planning together.
                    When two names are entered, the analysis assumes a spousal/partner relationship with joint financial planning,
                    shared expenses, and survivor benefits where applicable.
                </p>
            </div>

            <div class="form-section">
                <h3>You</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="p1-name" value="Person 1">
                    </div>
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="p1-birth" value="1970-01-01">
                    </div>
                    <div class="form-group">
                        <label>Retirement Month & Year</label>
                        <div style="display: flex; gap: 8px;">
                            <select id="p1-retire-month" style="flex: 1;">
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select id="p1-retire-year" style="flex: 1;">
                                <!-- Years populated by JavaScript -->
                            </select>
                        </div>
                        <input type="hidden" id="p1-retire" value="2035-01-01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Social Security (monthly)</label>
                        <input type="number" id="p1-ss" value="3000">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Spouse/Partner</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="p2-name" value="Person 2">
                    </div>
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="p2-birth" value="1972-01-01">
                    </div>
                    <div class="form-group">
                        <label>Retirement Month & Year</label>
                        <div style="display: flex; gap: 8px;">
                            <select id="p2-retire-month" style="flex: 1;">
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select id="p2-retire-year" style="flex: 1;">
                                <!-- Years populated by JavaScript -->
                            </select>
                        </div>
                        <input type="hidden" id="p2-retire" value="2037-01-01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Social Security (monthly)</label>
                        <input type="number" id="p2-ss" value="2500">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Assets & Investments</h3>
                <p style="margin-bottom: 15px; font-size: 14px; color: var(--text-secondary);">
                    List all your investment holdings below. Categorize them by account type (e.g., Traditional IRA, Roth IRA) so we can apply the correct tax treatment.
                </p>
                
                <div style="overflow-x: auto;">
                    <table id="investment-types-table" style="margin-bottom: 15px;">
                        <thead>
                            <tr>
                                <th>Asset Name</th>
                                <th>Account Type</th>
                                <th>Value</th>
                                <th>Cost Basis</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="investment-types-body">
                            <!-- Rows rendered via JS -->
                        </tbody>
                        <tfoot>
                            <tr style="background: var(--bg-tertiary);">
                                <td colspan="2"><strong>Grand Total</strong></td>
                                <td id="investment-total-value"><strong>$0.00</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 4px; display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px;">
                    <div class="form-group" style="flex: 2; min-width: 200px;">
                        <label style="font-size: 12px;">Asset Name</label>
                        <input type="text" id="new-inv-class" placeholder="e.g., S&P 500 Index">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label style="font-size: 12px;">Account Type</label>
                        <select id="new-inv-account" onchange="highlightAccountFields()">
                            <optgroup label="Cash Accounts">
                                <option value="Checking">Checking Account</option>
                                <option value="Savings">Savings Account</option>
                            </optgroup>
                            <optgroup label="Taxable Investment">
                                <option value="Taxable Brokerage">Taxable Brokerage</option>
                            </optgroup>
                            <optgroup label="Tax-Deferred Retirement">
                                <option value="Traditional IRA">Traditional IRA</option>
                                <option value="401k">401(k)</option>
                                <option value="403b">403(b)</option>
                                <option value="401a">401(a)</option>
                                <option value="457b">457(b)</option>
                            </optgroup>
                            <optgroup label="Tax-Free Retirement">
                                <option value="Roth IRA">Roth IRA</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="Pension">Pension Lump Sum</option>
                                <option value="Liquid">Liquid (Legacy)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label style="font-size: 12px;">Value ($)</label>
                        <input type="number" id="new-inv-value" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 100px;">
                        <label style="font-size: 12px;">Basis ($)</label>
                        <input type="number" id="new-inv-basis" placeholder="Optional">
                    </div>
                    <button id="add-inv-btn" class="secondary" onclick="addInvestmentType()" style="height: 42px;">Add</button>
                </div>

                <!-- NEW: Integrated Paste Area -->
                <div id="asset-paste-area" 
                     style="border: 2px dashed #9b59b6; border-radius: 8px; padding: 30px; text-align: center; background: #fdfaff; cursor: pointer; transition: all 0.3s; margin-bottom: 20px;"
                     onclick="document.getElementById('asset-image-upload').click()"
                     onmouseover="this.style.background='#f5eeff'"
                     onmouseout="this.style.background='#fdfaff'">
                    <div style="font-size: 24px; margin-bottom: 10px;">üìã</div>
                    <div style="font-weight: 600; color: #9b59b6;">Paste image here (Cmd+V) or Click to Upload</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Take a screenshot of your accounts and paste it here to sync balances instantly.</div>
                    <input type="file" id="asset-image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this.files[0])">
                </div>
            </div>
            
            <div class="form-section">
                <h3>Income Streams & Pensions</h3>
                <p style="margin-bottom: 15px; font-size: 14px; color: var(--text-secondary);">
                    Add fixed income sources like pensions, rental income, or annuities. (Social Security is calculated separately above).
                </p>
                
                <div style="overflow-x: auto;">
                    <table id="income-streams-table" style="margin-bottom: 15px;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Owner</th>
                                <th>Annual Amount</th>
                                <th>Start Date</th>
                                <th>Inflation Adj.</th>
                                <th>Survivor %</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="income-streams-body">
                            <!-- Rows rendered via JS -->
                        </tbody>
                        <tfoot>
                            <tr style="background: var(--bg-tertiary);">
                                <td colspan="2"><strong>Total Annual Income</strong></td>
                                <td id="income-streams-total"><strong>$0.00</strong></td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 4px; display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 2; min-width: 150px;">
                        <label style="font-size: 12px;">Name</label>
                        <input type="text" id="new-inc-name" placeholder="e.g. IBM Pension" oninput="highlightIncomeFields()">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label style="font-size: 12px;">Owner</label>
                        <select id="new-inc-owner" onchange="suggestIncomeStartDate()">
                            <option value="person1">Person 1</option>
                            <option value="person2">Person 2</option>
                            <option value="joint">Joint</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 100px;">
                        <label style="font-size: 12px;">Amount ($/yr)</label>
                        <input type="number" id="new-inc-amount" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label style="font-size: 12px;">Start Date</label>
                        <input type="date" id="new-inc-start">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 80px;">
                        <label style="font-size: 12px;">Survivor %</label>
                        <input type="number" id="new-inc-survivor" placeholder="100" min="0" max="100" value="100">
                    </div>
                    <div class="form-group" style="width: 80px; align-items: center;">
                        <label style="font-size: 12px; margin-bottom: 8px;">Inflation?</label>
                        <input type="checkbox" id="new-inc-inflation" checked style="width: 18px; height: 18px;">
                    </div>
                    <button id="add-inc-btn" class="secondary" onclick="addIncomeStream()" style="height: 42px;">Add</button>
                </div>
            </div>

            <div class="form-section">
                <h3>Real Estate & Properties</h3>
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">
                    Track your home and other properties. Home equity counts toward net worth, and you can model future sale/downsize scenarios.
                </p>

                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--bg-tertiary); border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left;">Property Name</th>
                            <th style="padding: 12px; text-align: left;">Type</th>
                            <th style="padding: 12px; text-align: right;">Current Value</th>
                            <th style="padding: 12px; text-align: right;">Mortgage Balance</th>
                            <th style="padding: 12px; text-align: right;">Net Equity</th>
                            <th style="padding: 12px; text-align: right;">Annual Costs</th>
                            <th style="padding: 12px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="home-properties-body">
                        <!-- Rendered by JavaScript -->
                    </tbody>
                </table>

                <button type="button" onclick="showAddPropertyModal()" style="margin-top: 15px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    + Add Property
                </button>
            </div>

            <!-- Property Modal (detailed form) -->
            <div id="property-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
                <div style="background: var(--bg-secondary); margin: 50px auto; max-width: 600px; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 id="property-modal-title">Add Property</h3>

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Property Name</label>
                    <input type="text" id="prop-name" placeholder="e.g., Main Residence" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Property Type</label>
                    <select id="prop-type" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                        <option value="Primary Residence">Primary Residence</option>
                        <option value="Investment Property">Investment Property</option>
                        <option value="Vacation Home">Vacation Home</option>
                    </select>

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Current Market Value (Zillow estimate)</label>
                    <input type="number" id="prop-value" placeholder="e.g., 850000" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Mortgage Balance Remaining</label>
                    <input type="number" id="prop-mortgage" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Purchase Price (for tax basis)</label>
                    <input type="number" id="prop-purchase-price" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Purchase Date</label>
                    <input type="date" id="prop-purchase-date" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">

                    <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 15px;">Annual Costs</h4>

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Property Tax (annual)</label>
                    <input type="number" id="prop-tax" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Homeowner's Insurance (annual)</label>
                    <input type="number" id="prop-insurance" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Maintenance & Repairs (annual estimate)</label>
                    <input type="number" id="prop-maintenance" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">

                    <label style="display: block; margin-top: 15px; font-weight: 600;">HOA Fees (annual)</label>
                    <input type="number" id="prop-hoa" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">

                    <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 15px;">Future Plans (Optional)</h4>

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Annual Appreciation Rate (%)</label>
                    <input type="number" id="prop-appreciation" step="0.1" placeholder="Leave blank to use inflation rate" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Default: Uses inflation rate from market assumptions</p>

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Planned Sale Date</label>
                    <input type="date" id="prop-sale-date" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">When you plan to sell this property</p>

                    <label style="display: block; margin-top: 15px; font-weight: 600;">Replacement Home Cost</label>
                    <input type="number" id="prop-replacement" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Cost of home you'll buy after selling (for downsize scenarios)</p>

                    <div style="margin-top: 25px; display: flex; gap: 10px;">
                        <button type="button" onclick="saveProperty()" style="flex: 1; padding: 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Save Property</button>
                        <button type="button" onclick="closePropertyModal()" style="flex: 1; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Expenses & Goals</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Current Annual Expenses</label>
                        <input type="number" id="expenses" value="100000">
                    </div>
                    <!-- Legacy Pension Field (Hidden or Read-only if needed, kept for backward compat) -->
                    <div class="form-group" style="display:none;">
                        <label>Annual Pension Income (Legacy)</label>
                        <input type="number" id="pension-annual" value="0">
                    </div>
                    <div class="form-group">
                        <label>Target Retirement Income (Net)</label>
                        <input type="number" id="target-income" value="150000">
                    </div>
                    <div class="form-group">
                        <label>Risk Tolerance</label>
                        <select id="risk">
                            <option value="conservative">Conservative</option>
                            <option value="moderate" selected>Moderate</option>
                            <option value="aggressive">Aggressive</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="accounts-tab" class="tab-content">
            <h2>Tax-Efficient Withdrawal Strategy</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">Optimize the order and timing of withdrawals to minimize lifetime taxes and maximize wealth transfer.</p>

            <div class="analysis-section" style="background: var(--bg-tertiary); border-left: 4px solid #3498db;">
                <h3 style="color: var(--text-primary); margin-bottom: 15px;">üìä Current Account Balances</h3>
                <div id="account-balances-summary"></div>
            </div>

            <div class="analysis-section">
                <h3 style="color: var(--text-primary); margin-bottom: 15px;">üéØ Recommended Withdrawal Sequence</h3>
                <p style="margin-bottom: 20px; line-height: 1.6;">For <strong>tax efficiency</strong>, withdraw in this order to minimize taxes and preserve Roth accounts for wealth transfer:</p>

                <div style="display: grid; gap: 15px;">
                    <div style="padding: 15px; background: var(--bg-tertiary); border-left: 4px solid #27ae60; border-radius: 4px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">1Ô∏è‚É£ Taxable Accounts (Liquid Assets) ‚Äî FIRST</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                            <strong>Why:</strong> Taxed at lower capital gains rates (0-20%) vs ordinary income rates (10-37%). Use these before age 73 to delay RMDs and allow tax-deferred accounts to grow. Creates "tax-free" space for Roth conversions.
                        </div>
                    </div>

                    <div style="padding: 15px; background: var(--bg-tertiary); border-left: 4px solid #3498db; border-radius: 4px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">1.5Ô∏è‚É£ 457(b) Governmental Plans ‚Äî EARLY OPTION</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                            <strong>Why:</strong> Unique benefit: No 10% early withdrawal penalty regardless of age (once separated from service). If you retire before 59.5, use this <em>before</em> your IRAs/401ks to bridge the gap.
                        </div>
                    </div>

                    <div style="padding: 15px; background: var(--bg-tertiary); border-left: 4px solid #f39c12; border-radius: 4px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">2Ô∏è‚É£ Traditional IRA / 401(k) / 403(b) / 401(a) ‚Äî SECOND</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                            <strong>Why:</strong> Withdrawals taxed as ordinary income. Start taking strategic withdrawals after liquid is depleted to "fill up" lower tax brackets (12%, 22%). Warning: 10% penalty if under age 59.5 (unless using Rule of 55). At age 73, RMDs force withdrawals.
                        </div>
                        <div id="rmd-info" style="margin-top: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 3px; font-size: 12px;"></div>
                    </div>

                    <div style="padding: 15px; background: var(--bg-tertiary); border-left: 4px solid #9b59b6; border-radius: 4px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">3Ô∏è‚É£ Roth IRA ‚Äî LAST (Preserve for Heirs)</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                            <strong>Why:</strong> Tax-free withdrawals with no RMDs during your lifetime. Let this grow tax-free as long as possible. Excellent for wealth transfer - heirs get tax-free inherited Roth IRA. Only use if other accounts depleted or for strategic tax management.
                        </div>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h3 style="color: var(--text-primary); margin-bottom: 15px;">üí° Tax Optimization Strategies</h3>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: var(--warning-bg); border-radius: 4px; border: 1px solid var(--warning-color);">
                        <h4 style="color: var(--text-primary); margin-bottom: 10px;">Roth Conversions (Age 62-73)</h4>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">Convert Traditional IRA ‚Üí Roth IRA before RMDs begin:</p>
                        <ul style="font-size: 13px; color: var(--text-secondary); margin-left: 20px; line-height: 1.8;">
                            <li>Fill 12% tax bracket (~$94k income)</li>
                            <li>Pay taxes now at low rates vs higher rates later</li>
                            <li>Reduces future RMDs</li>
                            <li>Creates tax-free growth</li>
                        </ul>
                        <div id="roth-conversion-suggestion" style="margin-top: 10px; padding: 8px; background: var(--bg-secondary); border-radius: 3px; font-size: 12px;"></div>
                    </div>

                    <div style="padding: 15px; background: var(--info-bg); border-radius: 4px; border: 1px solid var(--info-color);">
                        <h4 style="color: var(--text-primary); margin-bottom: 10px;">QCDs (Age 70.5+)</h4>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">Qualified Charitable Distributions:</p>
                        <ul style="font-size: 13px; color: var(--text-secondary); margin-left: 20px; line-height: 1.8;">
                            <li>Direct IRA ‚Üí charity (up to $105k/year in 2024)</li>
                            <li>Counts toward RMD but excluded from taxable income</li>
                            <li>Reduces AGI (helps avoid IRMAA surcharges)</li>
                            <li>More tax-efficient than itemized deduction</li>
                        </ul>
                    </div>

                    <div style="padding: 15px; background: var(--success-bg); border-radius: 4px; border: 1px solid var(--success-color);">
                        <h4 style="color: var(--text-primary); margin-bottom: 10px;">Tax Bracket Management</h4>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">Strategic annual planning:</p>
                        <ul style="font-size: 13px; color: var(--text-secondary); margin-left: 20px; line-height: 1.8;">
                            <li>"Fill" 12% and 22% brackets each year</li>
                            <li>Avoid IRMAA thresholds (Medicare surcharges)</li>
                            <li>Consider state income taxes</li>
                            <li>Time capital gains with low-income years</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h3 style="color: var(--text-primary); margin-bottom: 15px;">üßÆ RMD Calculator</h3>
                <div id="rmd-calculator"></div>
            </div>

            <div class="analysis-section" style="background: var(--warning-bg); border-left: 4px solid var(--warning-color);">
                <h3 style="color: var(--text-primary); margin-bottom: 15px;">‚ö†Ô∏è Common Withdrawal Mistakes to Avoid</h3>
                <div style="display: grid; gap: 10px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 3px;">
                        <strong style="color: #c0392b;">‚ùå Withdrawing from Roth first</strong> ‚Äî Loses tax-free growth and wealth transfer benefits
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 3px;">
                        <strong style="color: #c0392b;">‚ùå Ignoring Roth conversions before RMDs</strong> ‚Äî Miss 11-year window (62-73) for tax arbitrage
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 3px;">
                        <strong style="color: #c0392b;">‚ùå Large IRA withdrawals pushing into high brackets</strong> ‚Äî Can trigger 22-24% rates unnecessarily
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 3px;">
                        <strong style="color: #c0392b;">‚ùå Not planning for IRMAA</strong> ‚Äî High income years (age 63+) increase Medicare premiums 2 years later
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: 4px; font-size: 13px; color: var(--text-secondary);">
                <strong>üìö Resources:</strong>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li><a href="https://www.irs.gov/retirement-plans/plan-participant-employee/retirement-topics-required-minimum-distributions-rmds" target="_blank">IRS RMD Rules</a></li>
                    <li><a href="https://www.irs.gov/retirement-plans/retirement-plans-faqs-regarding-iras-distributions-withdrawals" target="_blank">IRA Distribution Rules</a></li>
                    <li><a href="https://www.medicare.gov/your-medicare-costs/part-b-costs" target="_blank">Medicare IRMAA Thresholds</a></li>
                </ul>
            </div>
        </div>

        <div id="analysis-tab" class="tab-content">
            <h2>Financial Analysis</h2>

            <div class="scenario-parameters">
                <h3>Scenario Parameters</h3>

                <!-- Market Profile Preset Selector -->
                <div class="slider-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; color: var(--text-primary);">
                        <span>Market Profile Preset</span>
                    </label>
                    <select id="market-profile-preset" style="width: 100%; padding: 8px; margin-top: 8px; font-size: 14px; border: 2px solid #3498db; border-radius: 4px;" onchange="applyMarketPreset()">
                        <option value="custom">Custom (Manual Adjustment)</option>

                        <optgroup label="üìä Standard Portfolios">
                            <option value="conservative">Conservative 60/40 (9.5% return, 15% vol)</option>
                            <option value="sp500" selected>S&P 500 Historical (10% return, 18% vol)</option>
                            <option value="aggressive">Aggressive Growth (11% return, 20% vol)</option>
                        </optgroup>

                        <optgroup label="üöÄ Sector Focus">
                            <option value="growth">Growth/Tech Sector (12% return, 22% vol)</option>
                            <option value="tech-aggressive">Tech/AI Aggressive (15% return, 28% vol)</option>
                            <option value="healthcare">Healthcare Focus (11.5% return, 16% vol)</option>
                            <option value="financials">Financial Sector (10.5% return, 23% vol)</option>
                            <option value="energy">Energy Sector (9% return, 25% vol)</option>
                        </optgroup>

                        <optgroup label="üí∞ Income & Stability">
                            <option value="dividend">Dividend Aristocrats (9% return, 14% vol)</option>
                            <option value="bonds-heavy">Bond Heavy 30/70 (5.5% return, 8% vol)</option>
                            <option value="retirement-glide">Retirement Glide Path (7% return, 12% vol)</option>
                        </optgroup>

                        <optgroup label="üåç Global & Alternative">
                            <option value="emerging">Emerging Markets (13% return, 26% vol)</option>
                            <option value="international">International Diversified (9.5% return, 19% vol)</option>
                            <option value="gold-hedge">Inflation Hedge (8% return, 16% vol)</option>
                            <option value="real-estate">REIT Focus (10% return, 20% vol)</option>
                        </optgroup>

                        <optgroup label="üìâ Bear/Crisis Scenarios">
                            <option value="bear-market">Bear Market (-5% return, 25% vol)</option>
                            <option value="recession">Recession (2% return, 22% vol)</option>
                            <option value="stagflation">Stagflation (4% return, 5% inflation)</option>
                            <option value="crisis-2008">2008 Financial Crisis (-22% return, 35% vol)</option>
                        </optgroup>

                        <optgroup label="üìà Bull/Optimistic Scenarios">
                            <option value="bull-market">Bull Market (18% return, 14% vol)</option>
                            <option value="post-covid">Post-COVID Recovery (16% return, 20% vol)</option>
                            <option value="roaring-20s">Roaring 20s (14% return, 16% vol)</option>
                        </optgroup>

                        <optgroup label="üéØ Historical Periods">
                            <option value="dotcom-boom">Dot-com Boom (25% return, 30% vol)</option>
                            <option value="dotcom-bust">Dot-com Bust (-15% return, 32% vol)</option>
                            <option value="great-recession">Great Recession (-30% return, 38% vol)</option>
                            <option value="decade-2010s">2010s Bull Run (14% return, 15% vol)</option>
                        </optgroup>
                    </select>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 4px;" id="preset-description">
                        <strong>Tip:</strong> Select a preset to automatically configure returns and volatility, or choose "Custom" to manually adjust all parameters.
                    </div>
                </div>

                <div class="slider-group">
                    <label>
                        <span>Stock Allocation: <span class="slider-value" id="stocks-value">50</span>% (Bonds: <span id="bonds-value">50</span>%)</span>
                    </label>
                    <input type="range" id="stocks-slider" min="0" max="100" value="50" step="5">
                </div>

                <div class="slider-group">
                    <label>
                        <span>Stock Return Rate: <span class="slider-value" id="stock-return-value">10.00</span>%</span>
                    </label>
                    <input type="range" id="stock-return-slider" min="4" max="20" value="10" step="0.25">
                    <div style="font-size: 10px; color: var(--text-light); margin-top: 2px;">Higher returns = growth/tech focus (higher risk)</div>
                </div>

                <div class="slider-group">
                    <label>
                        <span>Bond Return Rate: <span class="slider-value" id="bond-return-value">4.00</span>%</span>
                    </label>
                    <input type="range" id="bond-return-slider" min="2" max="8" value="4" step="0.25">
                </div>

                <div class="slider-group">
                    <label>
                        <span>Inflation Rate: <span class="slider-value" id="inflation-value">3.00</span>%</span>
                    </label>
                    <input type="range" id="inflation-slider" min="0" max="6" value="3" step="0.25">
                </div>

                <div class="advanced-toggle">
                    <button class="secondary" onclick="toggleAdvanced()">Show Advanced Parameters</button>
                </div>

                <div class="advanced-parameters" id="advanced-parameters">
                    <div class="slider-group">
                        <label>
                            <span>Stock Volatility (Std Dev): <span class="slider-value" id="stock-volatility-value">18.00</span>%</span>
                        </label>
                        <input type="range" id="stock-volatility-slider" min="5" max="35" value="18" step="0.5">
                        <div style="font-size: 10px; color: var(--text-light); margin-top: 2px;">Tech/AI sectors can have 25-35% volatility</div>
                    </div>

                    <div class="slider-group">
                        <label>
                            <span>Bond Volatility (Std Dev): <span class="slider-value" id="bond-volatility-value">6.00</span>%</span>
                        </label>
                        <input type="range" id="bond-volatility-slider" min="2" max="12" value="6" step="0.5">
                    </div>

                    <div class="slider-group">
                        <label>
                            <span>Inflation Volatility (Std Dev): <span class="slider-value" id="inflation-volatility-value">1.00</span>%</span>
                        </label>
                        <input type="range" id="inflation-volatility-slider" min="0" max="3" value="1" step="0.25">
                    </div>

                    <div class="slider-group">
                        <label>
                            <span>Social Security Discount Rate: <span class="slider-value" id="ss-discount-value">3.00</span>%</span>
                        </label>
                        <input type="range" id="ss-discount-slider" min="0" max="8" value="3" step="0.25">
                    </div>
                </div>

                <div class="auto-update-option">
                    <input type="checkbox" id="auto-update-checkbox">
                    <label for="auto-update-checkbox" style="margin: 0;">Auto-update analysis when sliders change</label>
                </div>

                <button class="reset-button" onclick="resetToDefaults()">Reset to Defaults</button>
            </div>

            <div style="margin-bottom: 20px;">
                <button onclick="runAnalysis()">Run Complete Analysis</button>
                <button class="ai-button" onclick="getAIRecommendations()">ü§ñ AI Recommendations</button>
            </div>
            <div id="ai-recommendations" style="margin-bottom: 20px;"></div>
            <div id="analysis-results"></div>
        </div>

        <div id="comparison-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Compare Scenarios</h2>
                <button onclick="refreshScenarios()" class="secondary">Refresh List</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Saved Scenarios</h3>
                    <div id="scenarios-list" style="max-height: 400px; overflow-y: auto;">
                        <!-- List of scenarios -->
                        <div class="loading">Loading scenarios...</div>
                    </div>
                </div>
                
                <div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">Comparison Charts</h3>
                        <div style="height: 300px; margin-bottom: 30px;">
                            <canvas id="comparison-chart-bar"></canvas>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="comparison-chart-line"></canvas>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">Assumption Comparison</h3>
                        <div style="overflow-x: auto;">
                            <table id="comparison-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: var(--bg-tertiary); border-bottom: 2px solid #ddd;">
                                        <th style="padding: 10px; text-align: left;">Parameter</th>
                                        <!-- Scenario columns added by JS -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows added by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="actions-tab" class="tab-content">
            <h2>Action Items</h2>
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button onclick="startWizard()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">‚ú® Start Wizard</button>
                <button class="secondary" onclick="loadActionItems()">Refresh</button>
                <button class="secondary" onclick="generateActionItems()">Auto-Generate Items</button>
                <button class="secondary" onclick="runSelfAssessment()" style="background: #9b59b6;">Run AI Self-Assessment</button>
                <button class="secondary" onclick="cleanupActionItems()" style="background: #95a5a6;">Cleanup Duplicates</button>
            </div>
            <ul id="action-items-list" class="action-items-list"></ul>
        </div>

        <div id="advisor-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>AI Financial Advisor</h2>
                <div id="active-llm-indicator" style="font-size: 13px; padding: 4px 10px; background: var(--bg-tertiary); border-radius: 20px; border: 1px solid var(--border-color); color: var(--text-secondary);">
                    Provider: <span id="current-llm-name" style="font-weight: 600; color: var(--accent-color);">Gemini</span>
                </div>
            </div>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">
                Ask questions about your retirement plan, get personalized advice, and explore different scenarios.
                The AI advisor has full access to your financial profile and analysis results.
            </p>

            <div id="api-key-notice" class="api-key-notice" style="display: none;">
                <strong>API Key Required:</strong> To use the AI Advisor, please configure your API keys in the ‚öôÔ∏è Settings menu.
                <button class="secondary" onclick="openSettings()" style="margin-top: 10px; display: block;">Open Settings</button>
            </div>

            <div id="api-key-status" style="margin-bottom: 15px;">
                <button onclick="clearConversation()" class="secondary">Clear Conversation</button>
            </div>

            <div class="chat-container">
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <textarea
                        id="chat-input"
                        class="chat-input"
                        placeholder="Ask me anything about your retirement plan..."
                        onkeydown="handleChatKeypress(event)"></textarea>
                    <button id="send-button" class="chat-button" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <div id="summary-tab" class="tab-content">
            <div id="summary-content">
                <!-- Content will be generated dynamically -->
                <div style="text-align: center; padding: 60px 20px; color: var(--text-light);">
                    <h3>No Profile Loaded</h3>
                    <p>Please load or create a profile to view the financial summary.</p>
                </div>
            </div>
        </div>

        <div id="learn-tab" class="tab-content">
            <div style="max-width: 1200px; margin: 0 auto;">
                <h1 style="font-size: 32px; margin-bottom: 10px;">üìö Retirement Planning Education</h1>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">Choose your learning level and explore topics at your own pace.</p>

                <!-- Level Selector -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; overflow-x: auto; padding-bottom: 10px;">
                    <button class="level-btn active" data-level="1" onclick="selectLevel(1)" style="padding: 10px 20px; border: 2px solid var(--accent-color); background: var(--accent-color); color: white; border-radius: 20px; cursor: pointer; white-space: nowrap; transition: all 0.3s; font-weight: 600;">Level 1 - Beginner</button>
                    <button class="level-btn" data-level="2" onclick="selectLevel(2)" style="padding: 10px 20px; border: 2px solid var(--border-color); background: transparent; color: var(--text-primary); border-radius: 20px; cursor: pointer; white-space: nowrap; transition: all 0.3s;">Level 2 - Basic</button>
                    <button class="level-btn" data-level="3" onclick="selectLevel(3)" style="padding: 10px 20px; border: 2px solid var(--border-color); background: transparent; color: var(--text-primary); border-radius: 20px; cursor: pointer; white-space: nowrap; transition: all 0.3s;">Level 3 - Intermediate</button>
                    <button class="level-btn" data-level="4" onclick="selectLevel(4)" style="padding: 10px 20px; border: 2px solid var(--border-color); background: transparent; color: var(--text-primary); border-radius: 20px; cursor: pointer; white-space: nowrap; transition: all 0.3s;">Level 4 - Advanced</button>
                    <button class="level-btn" data-level="5" onclick="selectLevel(5)" style="padding: 10px 20px; border: 2px solid var(--border-color); background: transparent; color: var(--text-primary); border-radius: 20px; cursor: pointer; white-space: nowrap; transition: all 0.3s;">Level 5 - Expert</button>
                </div>

                <!-- Topics Grid -->
                <div id="learn-topics-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Topics populated by JavaScript -->
                </div>

                <!-- Content Display -->
                <div id="learn-content-display" style="display: none; background: var(--bg-secondary); padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px var(--shadow);">
                    <button onclick="closeLearningContent()" style="float: right; background: var(--text-secondary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚Üê Back to Topics</button>
                    <div id="learn-content-body" style="clear: both; padding-top: 20px;">
                        <!-- Markdown content rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Q&A Wizard Modal -->
    <div id="wizard-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-secondary); border-radius: 12px; width: 90%; max-width: 700px; max-height: 85vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; color: white;">
                <h2 style="margin: 0 0 8px 0; font-size: 24px;">üßô‚Äç‚ôÇÔ∏è Profile Q&A Wizard</h2>
                <p style="margin: 0; opacity: 0.9; font-size: 14px;">Help us understand your financial situation better</p>
            </div>

            <!-- Content Area -->
            <div style="flex: 1; overflow-y: auto; padding: 25px;">
                <div id="wizard-messages" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Messages will be added here -->
                </div>
            </div>

            <!-- Input Area -->
            <div style="border-top: 1px solid var(--border-color); padding: 20px; background: var(--bg-tertiary);">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="wizard-input" placeholder="Type your answer..."
                           style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;"
                           onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendWizardResponse(); }">
                    <button onclick="sendWizardResponse()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Send</button>
                </div>
                <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <button onclick="skipWizardQuestion()" class="secondary" style="font-size: 13px; padding: 6px 12px;">Skip Question</button>
                    <button onclick="closeWizard()" class="secondary" style="font-size: 13px; padding: 6px 12px;">Close Wizard</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const API_URL = '/api';
        let investmentTypes = [
            { name: 'Checking Account', account: 'Liquid', value: 25000, change: 0 },
            { name: 'Savings/HYSA', account: 'Liquid', value: 75000, change: 0 },
            { name: '401k (Vanguard)', account: 'Traditional IRA', value: 2800000, change: 0 },
            { name: 'Roth IRA (Fidelity)', account: 'Roth IRA', value: 850000, change: 0 }
        ];
        let incomeStreams = [];
        let accounts = []; // Legacy support for profile data structure
        let editingIncomeIndex = -1;
        let homeProperties = [];
        let editingPropertyIndex = -1;

        function getCurrentProfileName() {
            return document.getElementById('profile-name-input').value || 'main';
        }

        // Initialize retirement date selectors
        function initRetirementDateSelectors() {
            const currentYear = new Date().getFullYear();
            const p1YearSelect = document.getElementById('p1-retire-year');
            const p2YearSelect = document.getElementById('p2-retire-year');

            // Populate year dropdowns (current year to 50 years in future)
            for (let year = currentYear; year <= currentYear + 50; year++) {
                const option1 = document.createElement('option');
                option1.value = year;
                option1.textContent = year;
                p1YearSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = year;
                option2.textContent = year;
                p2YearSelect.appendChild(option2);
            }

            // Set default values from hidden inputs
            updateMonthYearFromDate('p1');
            updateMonthYearFromDate('p2');

            // Add change listeners to sync back to hidden inputs
            document.getElementById('p1-retire-month').addEventListener('change', () => syncRetirementDate('p1'));
            document.getElementById('p1-retire-year').addEventListener('change', () => syncRetirementDate('p1'));
            document.getElementById('p2-retire-month').addEventListener('change', () => syncRetirementDate('p2'));
            document.getElementById('p2-retire-year').addEventListener('change', () => syncRetirementDate('p2'));
        }

        function updateMonthYearFromDate(person) {
            const dateInput = document.getElementById(`${person}-retire`);
            const monthSelect = document.getElementById(`${person}-retire-month`);
            const yearSelect = document.getElementById(`${person}-retire-year`);

            if (dateInput.value) {
                const [year, month] = dateInput.value.split('-');
                monthSelect.value = month;
                yearSelect.value = year;
            }
        }

        function syncRetirementDate(person) {
            const monthSelect = document.getElementById(`${person}-retire-month`);
            const yearSelect = document.getElementById(`${person}-retire-year`);
            const dateInput = document.getElementById(`${person}-retire`);

            const month = monthSelect.value;
            const year = yearSelect.value;

            // Set to first day of selected month
            dateInput.value = `${year}-${month}-01`;
        }

        function highlightIncomeFields() {
            const name = document.getElementById('new-inc-name').value.toLowerCase();
            const survivorInput = document.getElementById('new-inc-survivor');
            const survivorGroup = survivorInput.parentElement;

            if (name.includes('pension')) {
                survivorInput.style.borderColor = '#3498db';
                if (!document.getElementById('survivor-note')) {
                    const note = document.createElement('div');
                    note.id = 'survivor-note';
                    note.style.fontSize = '10px';
                    note.style.color = '#3498db';
                    note.style.marginTop = '2px';
                    note.textContent = "Check survivor options";
                    survivorGroup.appendChild(note);
                }
            } else {
                survivorInput.style.borderColor = '#ddd';
                const note = document.getElementById('survivor-note');
                if (note) note.remove();
            }
        }

        // --- Income Stream Functions ---

        function updateIncomeOwnerLabels() {
            const person1Name = document.getElementById('p1-name').value || 'Person 1';
            const person2Name = document.getElementById('p2-name').value || 'Person 2';
            const select = document.getElementById('new-inc-owner');
            if (select) {
                select.options[0].text = person1Name;
                select.options[1].text = person2Name;
            }
        }

        function renderIncomeStreams() {
            const tbody = document.getElementById('income-streams-body');
            tbody.innerHTML = '';

            let totalValue = 0;

            incomeStreams.forEach((item, index) => {
                totalValue += item.amount;

                const tr = document.createElement('tr');
                if (index === editingIncomeIndex) {
                    tr.style.backgroundColor = '#fff3cd';
                }

                // Use actual person names from profile
                const person1Name = document.getElementById('p1-name').value || 'Person 1';
                const person2Name = document.getElementById('p2-name').value || 'Person 2';
                const ownerLabel = item.owner === 'person1' ? person1Name : item.owner === 'person2' ? person2Name : 'Joint';
                const survivorPct = item.survivor_benefit !== undefined ? item.survivor_benefit : 100;
                
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td><span style="padding: 2px 6px; background: var(--accent-color); border-radius: 4px; font-size: 12px; color: white; opacity: 0.9;">${ownerLabel}</span></td>
                    <td>$${item.amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${item.start_date}</td>
                    <td>${item.inflation_adjusted ? '‚úÖ' : '‚ùå'}</td>
                    <td>${survivorPct}%</td>
                    <td>
                        <button onclick="editIncomeStream(${index})" style="padding: 5px 10px; background: #f39c12; color: white; border: none; border-radius: 3px; font-size: 12px; margin-right: 5px; cursor: pointer;">Edit</button>
                        <button onclick="deleteIncomeStream(${index})" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; font-size: 12px; cursor: pointer;">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('income-streams-total').innerHTML = `<strong>$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>`;
        }

        function suggestIncomeStartDate() {
            const owner = document.getElementById('new-inc-owner').value;
            let dateFieldId = '';
            
            if (owner === 'person1') {
                dateFieldId = 'p1-retire';
            } else if (owner === 'person2') {
                dateFieldId = 'p2-retire';
            } else {
                dateFieldId = 'p1-retire'; // Default joint to p1
            }
            
            const retireDate = document.getElementById(dateFieldId).value;
            if (retireDate) {
                document.getElementById('new-inc-start').value = retireDate;
            }
        }

        function addIncomeStream() {
            const nameInput = document.getElementById('new-inc-name');
            const ownerInput = document.getElementById('new-inc-owner');
            const amountInput = document.getElementById('new-inc-amount');
            const startInput = document.getElementById('new-inc-start');
            const inflationInput = document.getElementById('new-inc-inflation');
            const survivorInput = document.getElementById('new-inc-survivor');
            
            const name = nameInput.value.trim();
            const owner = ownerInput.value;
            const amount = parseFloat(amountInput.value);
            const start_date = startInput.value;
            const inflation_adjusted = inflationInput.checked;
            const survivor_benefit = survivorInput.value ? parseFloat(survivorInput.value) : 100;
            
            if (!name || isNaN(amount) || !start_date) {
                alert('Please enter valid name, amount, and start date');
                return;
            }
            
            if (editingIncomeIndex > -1) {
                // Update existing
                incomeStreams[editingIncomeIndex] = { name, owner, amount, start_date, inflation_adjusted, survivor_benefit };
                editingIncomeIndex = -1;
                document.getElementById('add-inc-btn').textContent = 'Add';
            } else {
                // Add new
                incomeStreams.push({ name, owner, amount, start_date, inflation_adjusted, survivor_benefit });
            }

            renderIncomeStreams();
            debouncedAutoSave(); // Auto-save after adding/editing income stream

            // Clear inputs
            nameInput.value = '';
            amountInput.value = '';
            survivorInput.value = '100';
            nameInput.focus();
        }

        function editIncomeStream(index) {
            const item = incomeStreams[index];
            document.getElementById('new-inc-name').value = item.name;
            document.getElementById('new-inc-owner').value = item.owner;
            document.getElementById('new-inc-amount').value = item.amount;
            document.getElementById('new-inc-start').value = item.start_date;
            document.getElementById('new-inc-inflation').checked = item.inflation_adjusted;
            document.getElementById('new-inc-survivor').value = item.survivor_benefit !== undefined ? item.survivor_benefit : 100;
            
            editingIncomeIndex = index;
            document.getElementById('add-inc-btn').textContent = 'Update';
            renderIncomeStreams();
        }

        function deleteIncomeStream(index) {
            if (confirm('Remove this income stream?')) {
                if (index === editingIncomeIndex) {
                    editingIncomeIndex = -1;
                    document.getElementById('add-inc-btn').textContent = 'Add';
                } else if (index < editingIncomeIndex) {
                    editingIncomeIndex--;
                }
                incomeStreams.splice(index, 1);
                renderIncomeStreams();
                debouncedAutoSave(); // Auto-save after deleting income stream
            }
        }

        // Home Properties Management Functions
        function renderHomeProperties() {
            const tbody = document.getElementById('home-properties-body');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!homeProperties || homeProperties.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-light); padding: 20px;">No properties added yet</td></tr>';
                return;
            }

            let totalEquity = 0;

            homeProperties.forEach((prop, index) => {
                const equity = (prop.current_value || 0) - (prop.mortgage_balance || 0);
                const annualCosts = (
                    (prop.annual_property_tax || 0) +
                    (prop.annual_insurance || 0) +
                    (prop.annual_maintenance || 0) +
                    (prop.annual_hoa || 0)
                );

                totalEquity += equity;

                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #dee2e6';
                row.innerHTML = `
                    <td style="padding: 12px;">${prop.name}</td>
                    <td style="padding: 12px;">${prop.property_type}</td>
                    <td style="padding: 12px; text-align: right;">$${(prop.current_value || 0).toLocaleString()}</td>
                    <td style="padding: 12px; text-align: right;">$${(prop.mortgage_balance || 0).toLocaleString()}</td>
                    <td style="padding: 12px; text-align: right;"><strong>$${equity.toLocaleString()}</strong></td>
                    <td style="padding: 12px; text-align: right;">$${annualCosts.toLocaleString()}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="editProperty(${index})" style="padding: 6px 12px; margin: 0 4px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
                        <button onclick="deleteProperty(${index})" style="padding: 6px 12px; margin: 0 4px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.style.fontWeight = 'bold';
            totalRow.style.backgroundColor = 'var(--bg-tertiary)';
            totalRow.innerHTML = `
                <td colspan="4" style="padding: 12px;">Total Home Equity</td>
                <td style="padding: 12px; text-align: right;">$${totalEquity.toLocaleString()}</td>
                <td colspan="2"></td>
            `;
            tbody.appendChild(totalRow);
        }

        function showAddPropertyModal() {
            document.getElementById('property-modal').style.display = 'block';
            document.getElementById('property-modal-title').textContent = 'Add Property';
            clearPropertyForm();
            editingPropertyIndex = -1;
        }

        function closePropertyModal() {
            document.getElementById('property-modal').style.display = 'none';
        }

        function clearPropertyForm() {
            document.getElementById('prop-name').value = '';
            document.getElementById('prop-type').value = 'Primary Residence';
            document.getElementById('prop-value').value = '';
            document.getElementById('prop-mortgage').value = '0';
            document.getElementById('prop-purchase-price').value = '';
            document.getElementById('prop-purchase-date').value = '';
            document.getElementById('prop-tax').value = '0';
            document.getElementById('prop-insurance').value = '0';
            document.getElementById('prop-maintenance').value = '0';
            document.getElementById('prop-hoa').value = '0';
            document.getElementById('prop-appreciation').value = '';
            document.getElementById('prop-sale-date').value = '';
            document.getElementById('prop-replacement').value = '0';
        }

        function saveProperty() {
            const prop = {
                name: document.getElementById('prop-name').value,
                property_type: document.getElementById('prop-type').value,
                current_value: parseFloat(document.getElementById('prop-value').value) || 0,
                mortgage_balance: parseFloat(document.getElementById('prop-mortgage').value) || 0,
                purchase_price: parseFloat(document.getElementById('prop-purchase-price').value) || 0,
                purchase_date: document.getElementById('prop-purchase-date').value,
                annual_property_tax: parseFloat(document.getElementById('prop-tax').value) || 0,
                annual_insurance: parseFloat(document.getElementById('prop-insurance').value) || 0,
                annual_maintenance: parseFloat(document.getElementById('prop-maintenance').value) || 0,
                annual_hoa: parseFloat(document.getElementById('prop-hoa').value) || 0,
                appreciation_rate: parseFloat(document.getElementById('prop-appreciation').value) / 100 || null,
                planned_sale_date: document.getElementById('prop-sale-date').value,
                replacement_value: parseFloat(document.getElementById('prop-replacement').value) || 0
            };

            if (!prop.name) {
                alert('Please enter a property name');
                return;
            }

            if (editingPropertyIndex >= 0) {
                homeProperties[editingPropertyIndex] = prop;
            } else {
                homeProperties.push(prop);
            }

            renderHomeProperties();
            closePropertyModal();
            debouncedAutoSave();

            // Re-run analysis to show impact of property on retirement plan
            setTimeout(() => {
                runAnalysis();
            }, 500);
        }

        function editProperty(index) {
            const prop = homeProperties[index];

            document.getElementById('prop-name').value = prop.name;
            document.getElementById('prop-type').value = prop.property_type;
            document.getElementById('prop-value').value = prop.current_value;
            document.getElementById('prop-mortgage').value = prop.mortgage_balance || 0;
            document.getElementById('prop-purchase-price').value = prop.purchase_price || '';
            document.getElementById('prop-purchase-date').value = prop.purchase_date || '';
            document.getElementById('prop-tax').value = prop.annual_property_tax || 0;
            document.getElementById('prop-insurance').value = prop.annual_insurance || 0;
            document.getElementById('prop-maintenance').value = prop.annual_maintenance || 0;
            document.getElementById('prop-hoa').value = prop.annual_hoa || 0;
            document.getElementById('prop-appreciation').value = prop.appreciation_rate ? (prop.appreciation_rate * 100) : '';
            document.getElementById('prop-sale-date').value = prop.planned_sale_date || '';
            document.getElementById('prop-replacement').value = prop.replacement_value || 0;

            editingPropertyIndex = index;
            document.getElementById('property-modal-title').textContent = 'Edit Property';
            document.getElementById('property-modal').style.display = 'block';
        }

        function deleteProperty(index) {
            if (confirm('Are you sure you want to delete this property?')) {
                homeProperties.splice(index, 1);
                if (index === editingPropertyIndex) {
                    editingPropertyIndex = -1;
                } else if (index < editingPropertyIndex) {
                    editingPropertyIndex--;
                }
                renderHomeProperties();
                debouncedAutoSave();

                // Re-run analysis to show impact of property deletion on retirement plan
                setTimeout(() => {
                    runAnalysis();
                }, 500);
            }
        }

        // Render Withdrawal Strategy tab with user's data
        function renderWithdrawalStrategy() {
            // Get current account balances from investment types
            let liquid = 0;
            let tradIra = 0;
            let rothIra = 0;
            let pension = 0;

            investmentTypes.forEach(item => {
                if (item.account === 'Liquid') liquid += item.value;
                else if (item.account === 'Traditional IRA' || item.account === '401k' || item.account === '403b' || item.account === '401a' || item.account === '457b') tradIra += item.value;
                else if (item.account === 'Roth IRA') rothIra += item.value;
                else if (item.account === 'Pension') pension += item.value;
                else if (item.name === 'Cash') liquid += item.value;
                else tradIra += item.value;
            });

            const totalAssets = liquid + tradIra + rothIra + pension;

            // Render account balances summary
            const balancesHtml = `
                <div class="metric-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">üíµ Liquid/Taxable</div>
                        <div style="font-size: 20px; font-weight: 700; color: #27ae60;">$${liquid.toLocaleString()}</div>
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 3px;">${totalAssets > 0 ? ((liquid / totalAssets) * 100).toFixed(1) : 0}% of total</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">üè¶ Traditional IRA/401(k)</div>
                        <div style="font-size: 20px; font-weight: 700; color: #e67e22;">$${tradIra.toLocaleString()}</div>
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 3px;">${totalAssets > 0 ? ((tradIra / totalAssets) * 100).toFixed(1) : 0}% of total</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">üíé Roth IRA</div>
                        <div style="font-size: 20px; font-weight: 700; color: #9b59b6;">$${rothIra.toLocaleString()}</div>
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 3px;">${totalAssets > 0 ? ((rothIra / totalAssets) * 100).toFixed(1) : 0}% of total</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">üìä Total Assets</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">$${totalAssets.toLocaleString()}</div>
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 3px;">All retirement accounts</div>
                    </div>
                </div>
            `;
            document.getElementById('account-balances-summary').innerHTML = balancesHtml;

            // Calculate RMD info
            const p1BirthDate = new Date(document.getElementById('p1-birth').value || '1965-03-24');
            const ageNow = (new Date() - p1BirthDate) / (365.25 * 24 * 60 * 60 * 1000);
            const yearsUntilRMD = Math.max(0, 73 - ageNow);
            const ageAtRMD = Math.ceil(ageNow + yearsUntilRMD);

            let rmdHtml = '';
            if (yearsUntilRMD > 0) {
                rmdHtml = `<strong style="color: #27ae60;">‚úì You have ${Math.floor(yearsUntilRMD)} years until RMDs begin (age 73)</strong><br>
                           This is your <strong>Roth conversion window</strong> - convert Traditional IRA to Roth at low tax rates before RMDs force withdrawals.`;
            } else {
                const rmdFactor = ageAtRMD >= 73 ? (27.4 - (ageAtRMD - 73) * 1.0) : 27.4;
                const estimatedRMD = tradIra / rmdFactor;
                rmdHtml = `<strong style="color: #e67e22;">‚ö†Ô∏è RMDs have begun (age ${Math.floor(ageNow)})</strong><br>
                           Estimated RMD this year: <strong>$${estimatedRMD.toLocaleString(undefined, {maximumFractionDigits: 0})}</strong> (must withdraw annually)`;
            }
            document.getElementById('rmd-info').innerHTML = rmdHtml;

            // Roth conversion suggestion
            if (window.currentAnalysis && window.currentAnalysis.roth_conversion) {
                const roth = window.currentAnalysis.roth_conversion;
                let rothSuggestion = '';
                if (roth.opportunity === 'excellent') {
                    rothSuggestion = `<strong style="color: #27ae60;">‚úì Based on your analysis:</strong><br>
                                     Convert $${roth.annual_conversion_12_bracket?.toLocaleString() || 'N/A'}/year for ${roth.conversion_years} years<br>
                                     Tax cost: ~$${roth.tax_cost_12?.toLocaleString() || 'N/A'} (${((roth.tax_cost_12 / roth.total_convertible_12) * 100).toFixed(1)}% effective rate)`;
                } else {
                    rothSuggestion = `Run analysis to see your Roth conversion opportunity`;
                }
                document.getElementById('roth-conversion-suggestion').innerHTML = rothSuggestion;
            }

            // RMD Calculator
            let rmdCalcHtml = '<table style="font-size: 13px; width: 100%; border-collapse: collapse;"><thead><tr style="background: var(--bg-tertiary);"><th style="padding: 8px; text-align: left;">Age</th><th style="padding: 8px; text-align: right;">Life Expectancy Factor</th><th style="padding: 8px; text-align: right;">Est. RMD Amount</th><th style="padding: 8px; text-align: right;">% of Account</th></tr></thead><tbody>';

            for (let age = 73; age <= 85; age++) {
                const factor = 27.4 - (age - 73) * 1.0;
                const rmd = tradIra / factor;
                const pct = (rmd / tradIra) * 100;
                rmdCalcHtml += `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 8px;">${age}</td><td style="padding: 8px; text-align: right;">${factor.toFixed(1)}</td><td style="padding: 8px; text-align: right; font-weight: 600;">$${rmd.toLocaleString(undefined, {maximumFractionDigits: 0})}</td><td style="padding: 8px; text-align: right;">${pct.toFixed(2)}%</td></tr>`;
            }
            rmdCalcHtml += '</tbody></table>';
            rmdCalcHtml += '<p style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">Note: RMD factors decrease each year (you must withdraw larger % as you age). Calculated using 2024 Uniform Lifetime Table.</p>';
            document.getElementById('rmd-calculator').innerHTML = rmdCalcHtml;
        }

        async function handleImageUpload(file) {
            if (!file) return;

            const pasteArea = document.getElementById('asset-paste-area');
            const originalHtml = pasteArea.innerHTML;
            pasteArea.style.borderColor = "#3498db";
            pasteArea.innerHTML = `
                <div class="loading" style="padding: 0;">
                    <div style="font-size: 24px; margin-bottom: 10px;">ü§ñ</div>
                    <div style="font-weight: 600; color: #3498db;">Analyzing Screenshot...</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">This usually takes 3-5 seconds.</div>
                </div>
            `;

            try {
                const base64Image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Send existing assets to preserve field values (especially account types)
                const existing_assets = investmentTypes.map(asset => ({
                    name: asset.name,
                    type: asset.account,  // Maps to backend 'type' field
                    value: asset.value,
                    cost_basis: asset.cost_basis || 0
                }));

                const response = await fetch(`${API_URL}/extract-assets`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        image: base64Image,
                        llm_provider: localStorage.getItem('default_llm') || 'gemini',
                        existing_assets: existing_assets
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    if (data.assets && data.assets.length > 0) {
                        applyExtractedAssets(data.assets);
                    } else {
                        alert("No assets could be identified in the image.");
                    }
                } else {
                    alert("Error extracting assets: " + (data.error || "Unknown error"));
                }

            } catch (error) {
                console.error("Image upload error:", error);
                alert("Failed to process image: " + error.message);
            } finally {
                pasteArea.style.borderColor = "#9b59b6";
                pasteArea.innerHTML = originalHtml;
                document.getElementById('asset-image-upload').value = ''; // Reset
            }
        }

        function applyExtractedAssets(assets) {
            const updates = [];
            const adds = [];
            const matches = [];

            assets.forEach(extracted => {
                const value = parseFloat(extracted.value) || 0;
                if (value <= 0) return;

                // Simple name matching (case-insensitive, trimmed)
                const existing = investmentTypes.find(i => 
                    i.name.toLowerCase().trim() === extracted.name.toLowerCase().trim()
                );

                if (existing) {
                    if (Math.abs(existing.value - value) > 0.01) {
                        updates.push({
                            original: existing,
                            newName: extracted.name,
                            newValue: value,
                            type: extracted.type || existing.account
                        });
                    } else {
                        matches.push(existing.name);
                    }
                } else {
                    adds.push(extracted);
                }
            });

            if (updates.length === 0 && adds.length === 0) {
                alert(`Reconciliation complete: All ${matches.length} accounts in the image already match your profile.`);
                return;
            }

            // Build Confirmation Message
            let msg = "üìä Portfolio Reconciliation\n\n";
            
            if (updates.length > 0) {
                msg += "Update Existing Balances:\n";
                updates.forEach(u => {
                    msg += `‚Ä¢ ${u.original.name}: $${u.original.value.toLocaleString()} ‚Üí $${u.newValue.toLocaleString()}\n`;
                });
                msg += "\n";
            }

            if (adds.length > 0) {
                msg += "Add New Accounts:\n";
                adds.forEach(a => {
                    msg += `‚Ä¢ ${a.name} (${a.type}): $${parseFloat(a.value).toLocaleString()}\n`;
                });
                msg += "\n";
            }

            if (matches.length > 0) {
                msg += `(${matches.length} other accounts already matched perfectly)\n\n`;
            }

            msg += "Apply these changes?";

            if (confirm(msg)) {
                // Perform Updates
                // Backend has already merged data properly, so trust the type it returns
                updates.forEach(u => {
                    u.original.value = u.newValue;
                    // Only update type if backend provided one (it preserves existing types when image doesn't show type)
                    if (u.type) {
                        u.original.account = u.type;
                    }
                });

                // Perform Adds
                // Backend already provided correct type (either from image or defaulted to Liquid)
                adds.forEach(a => {
                    investmentTypes.push({
                        name: a.name,
                        account: a.type || 'Liquid',  // Trust backend's type determination
                        value: parseFloat(a.value),
                        cost_basis: parseFloat(a.cost_basis) || 0  // Preserve cost_basis if provided
                    });
                });

                renderInvestmentTypes();
                
                // Final Check: Are there accounts in our list NOT in the image?
                const extractedNames = assets.map(a => a.name.toLowerCase().trim());
                const missingInImage = investmentTypes.filter(i => 
                    !extractedNames.includes(i.name.toLowerCase().trim())
                );

                if (missingInImage.length > 0) {
                    const removeMsg = `The image did not contain ${missingInImage.length} accounts currently in your profile:\n` +
                        missingInImage.map(m => `‚Ä¢ ${m.name}`).join('\n') +
                        `\n\nShould these be DELETED (assuming the image is your complete portfolio)? \n\nClick CANCEL to keep them, or OK to delete.`;

                    if (confirm(removeMsg)) {
                        missingInImage.forEach(m => {
                            const idx = investmentTypes.indexOf(m);
                            if (idx > -1) investmentTypes.splice(idx, 1);
                        });
                        renderInvestmentTypes();
                    }
                }

                debouncedAutoSave(); // Auto-save after asset extraction
                alert("‚úÖ Portfolio synchronized successfully.");
            }
        }

        // Add paste event listener to the container
        document.addEventListener('paste', (event) => {
            // Only handle if we are on the profile tab
            if (!document.getElementById('profile-tab').classList.contains('active')) return;
            
            const clipboardData = event.clipboardData || (event.originalEvent ? event.originalEvent.clipboardData : null);
            if (!clipboardData) return;

            const items = clipboardData.items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    handleImageUpload(blob);
                    event.preventDefault(); 
                    return;
                }
            }
        });

        // Add Drag and Drop support
        window.addEventListener('DOMContentLoaded', () => {
            const pasteArea = document.getElementById('asset-paste-area');
            if (!pasteArea) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                pasteArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                pasteArea.addEventListener(eventName, () => {
                    pasteArea.style.background = '#f5eeff';
                    pasteArea.style.borderColor = '#3498db';
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                pasteArea.addEventListener(eventName, () => {
                    pasteArea.style.background = '#fdfaff';
                    pasteArea.style.borderColor = '#9b59b6';
                }, false);
            });

            pasteArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files && files[0]) {
                    handleImageUpload(files[0]);
                }
            }, false);
        });

        function highlightAccountFields() {
            const type = document.getElementById('new-inv-account').value;
            const basisInput = document.getElementById('new-inv-basis');
            const basisGroup = basisInput.parentElement;
            
            // Reset styles
            basisInput.style.borderColor = '#ddd';
            basisGroup.style.opacity = '1';

            if (type === 'Liquid') {
                basisInput.style.borderColor = '#3498db';
                basisInput.placeholder = "Enter Basis";
                // Add a small tooltip-like note if not exists
                if (!document.getElementById('basis-note')) {
                    const note = document.createElement('div');
                    note.id = 'basis-note';
                    note.style.fontSize = '10px';
                    note.style.color = '#3498db';
                    note.style.marginTop = '2px';
                    note.textContent = "Required for capital gains calc";
                    basisGroup.appendChild(note);
                }
            } else {
                basisInput.placeholder = "Optional";
                const note = document.getElementById('basis-note');
                if (note) note.remove();
            }
        }

        // State for editing
        let editingIndex = -1;

        function renderInvestmentTypes() {
            const tbody = document.getElementById('investment-types-body');
            tbody.innerHTML = '';
            
            const totalValue = investmentTypes.reduce((sum, item) => sum + item.value, 0);
            
            investmentTypes.forEach((item, index) => {
                const account = item.account || 'Unspecified';
                
                const tr = document.createElement('tr');
                if (index === editingIndex) {
                    tr.style.backgroundColor = '#fff3cd'; // Highlight row being edited
                }
                
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td><span style="padding: 2px 6px; background: var(--accent-color); border-radius: 4px; font-size: 12px; color: white; opacity: 0.9;">${account}</span></td>
                    <td>$${item.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${item.cost_basis ? '$' + item.cost_basis.toLocaleString() : '-'}</td>
                    <td>
                        <button onclick="editInvestmentType(${index})" style="padding: 5px 10px; background: #f39c12; color: white; border: none; border-radius: 3px; font-size: 12px; margin-right: 5px; cursor: pointer;">Edit</button>
                        <button onclick="deleteInvestmentType(${index})" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; font-size: 12px; cursor: pointer;">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('investment-total-value').innerHTML = `<strong>$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>`;
        }

        function addInvestmentType() {
            const nameInput = document.getElementById('new-inv-class');
            const accountInput = document.getElementById('new-inv-account');
            const valueInput = document.getElementById('new-inv-value');
            const basisInput = document.getElementById('new-inv-basis');
            
            const name = nameInput.value.trim();
            const account = accountInput.value;
            const value = parseFloat(valueInput.value);
            const cost_basis = basisInput.value ? parseFloat(basisInput.value) : 0;
            
            if (!name || isNaN(value)) {
                alert('Please enter a valid name and value');
                return;
            }
            
            if (editingIndex > -1) {
                // Update existing
                investmentTypes[editingIndex] = { name, account, value, cost_basis, change: 0 };
                editingIndex = -1;
                document.getElementById('add-inv-btn').textContent = 'Add';
            } else {
                // Add new
                investmentTypes.push({ name, account, value, cost_basis, change: 0 });
            }

            renderInvestmentTypes();
            debouncedAutoSave(); // Auto-save after adding/editing investment

            // Clear inputs
            nameInput.value = '';
            valueInput.value = '';
            basisInput.value = '';
            nameInput.focus();
        }

        function editInvestmentType(index) {
            const item = investmentTypes[index];
            document.getElementById('new-inv-class').value = item.name;
            document.getElementById('new-inv-account').value = item.account || 'Liquid';
            document.getElementById('new-inv-value').value = item.value;
            document.getElementById('new-inv-basis').value = item.cost_basis || '';
            
            editingIndex = index;
            document.getElementById('add-inv-btn').textContent = 'Update';
            renderInvestmentTypes();
        }

        function deleteInvestmentType(index) {
            if (confirm('Are you sure you want to remove this investment type?')) {
                if (index === editingIndex) {
                    editingIndex = -1;
                    document.getElementById('add-inv-btn').textContent = 'Add';
                    document.getElementById('new-inv-class').value = '';
                    document.getElementById('new-inv-value').value = '';
                    document.getElementById('new-inv-basis').value = '';
                } else if (index < editingIndex) {
                    editingIndex--; // Shift index if deleting item before current edit
                }

                investmentTypes.splice(index, 1);
                renderInvestmentTypes();
                debouncedAutoSave(); // Auto-save after deleting investment
            }
        }
        
        function showTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('onclick').includes(`'${tabName}'`)) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // Render withdrawal strategy tab when opened
            if (tabName === 'accounts') {
                renderWithdrawalStrategy();
            }
            
            // Refresh action items if switching to that tab
            if (tabName === 'actions') {
                loadActionItems();
            }

            // Refresh chat history if switching to advisor
            if (tabName === 'advisor') {
                loadConversationHistory();
            }
        }
        
        function getFormData() {
            // Aggregate assets from investmentTypes
            let liquid = 0;
            let tradIra = 0;
            let rothIra = 0;
            let pension = 0;

            investmentTypes.forEach(item => {
                if (item.account === 'Liquid') liquid += item.value;
                else if (item.account === 'Traditional IRA' || item.account === '401k' || item.account === '403b' || item.account === '401a' || item.account === '457b') tradIra += item.value;
                else if (item.account === 'Roth IRA') rothIra += item.value;
                else if (item.account === 'Pension') pension += item.value;
                // Fallback for legacy or unspecified
                else if (item.name === 'Cash') liquid += item.value;
                else tradIra += item.value; // Default bucket
            });

            return {
                person1: {
                    name: document.getElementById('p1-name').value,
                    birth_date: document.getElementById('p1-birth').value,
                    retirement_date: document.getElementById('p1-retire').value,
                    social_security: parseFloat(document.getElementById('p1-ss').value)
                },
                person2: {
                    name: document.getElementById('p2-name').value,
                    birth_date: document.getElementById('p2-birth').value,
                    retirement_date: document.getElementById('p2-retire').value,
                    social_security: parseFloat(document.getElementById('p2-ss').value)
                },
                children: [
                    {name: 'Child 1', birth_date: '2010-01-01'},
                    {name: 'Child 2', birth_date: '2012-01-01'}
                ],
                liquid_assets: liquid,
                traditional_ira: tradIra,
                roth_ira: rothIra,
                pension_lump_sum: pension,
                pension_annual: parseFloat(document.getElementById('pension-annual').value) || 0,
                annual_expenses: parseFloat(document.getElementById('expenses').value),
                target_annual_income: parseFloat(document.getElementById('target-income').value),
                risk_tolerance: document.getElementById('risk').value,
                asset_allocation: {
                    stocks: parseFloat(document.getElementById('stocks-slider').value) / 100,
                    bonds: (100 - parseFloat(document.getElementById('stocks-slider').value)) / 100
                },
                future_expenses: [],
                investment_types: investmentTypes,
                income_streams: incomeStreams,
                home_properties: homeProperties,
                accounts: accounts,
                assumed_tax_rate: (parseFloat(document.getElementById('db-tax-rate')?.value) || 22) / 100,
                market_assumptions: {
                    stock_allocation: parseFloat(document.getElementById('stocks-slider').value) / 100,
                    stock_return_mean: parseFloat(document.getElementById('stock-return-slider').value) / 100,
                    bond_return_mean: parseFloat(document.getElementById('bond-return-slider').value) / 100,
                    inflation_mean: parseFloat(document.getElementById('inflation-slider').value) / 100,
                    stock_return_std: parseFloat(document.getElementById('stock-volatility-slider').value) / 100,
                    bond_return_std: parseFloat(document.getElementById('bond-volatility-slider').value) / 100,
                    inflation_std: parseFloat(document.getElementById('inflation-volatility-slider').value) / 100,
                    ss_discount_rate: parseFloat(document.getElementById('ss-discount-slider').value) / 100
                }
            };
        }
        
        async function fetchProfiles() {
            try {
                const response = await fetch(`${API_URL}/profiles`);
                const profiles = await response.json();
                
                const select = document.getElementById('profile-select');
                const dbSelect = document.getElementById('dashboard-profile-select');
                
                const currentVal = select.value;
                
                // Helper to populate a select
                const populate = (selElement, placeholder) => {
                    selElement.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                    profiles.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.name;
                        option.textContent = `${p.name} (${new Date(p.updated_at).toLocaleDateString()})`;
                        selElement.appendChild(option);
                    });
                };

                populate(select, "Select a profile...");
                populate(dbSelect, "Load Profile...");
                
                // Restore selection if still exists
                if (currentVal && profiles.some(p => p.name === currentVal)) {
                    select.value = currentVal;
                    dbSelect.value = currentVal;
                }
            } catch (error) {
                console.error('Error fetching profiles:', error);
            }
        }

        function onProfileSelectChange() {
            const select = document.getElementById('profile-select');
            const nameInput = document.getElementById('profile-name-input');
            if (select.value) {
                nameInput.value = select.value;
                loadProfile(select.value);
            }
        }

        async function saveCurrentProfile() {
            const name = document.getElementById('profile-name-input').value.trim();
            if (!name) {
                alert('Please enter a profile name');
                return;
            }

            const data = getFormData();
            console.log("Saving profile data:", data);

            try {
                const response = await fetch(`${API_URL}/profile/${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    await fetchProfiles();
                    document.getElementById('profile-select').value = name;
                    document.getElementById('dashboard-profile-select').value = name;

                    // Show success notification
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 4px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        z-index: 10000;
                        font-weight: 600;
                    `;
                    notification.textContent = `‚úì Profile "${name}" saved successfully`;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);

                    // Check for level-up after saving
                    checkLevelUp();
                } else {
                    const result = await response.json();
                    alert('Error saving profile: ' + (result.error || response.statusText));
                }
            } catch (error) {
                console.error("Save error:", error);
                alert('Error saving profile: ' + error.message);
            }
        }

        // Silent auto-save without notifications
        async function autoSaveProfile() {
            const settings = getSettings();
            if (!settings.autoSave) return;

            const name = document.getElementById('profile-name-input').value.trim();
            if (!name) return; // Don't auto-save if no profile name

            const data = getFormData();

            try {
                const response = await fetch(`${API_URL}/profile/${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    // Update selects silently
                    document.getElementById('profile-select').value = name;
                    document.getElementById('dashboard-profile-select').value = name;
                    console.log(`Auto-saved profile: ${name}`);
                } else {
                    console.error('Auto-save failed:', response.statusText);
                }
            } catch (error) {
                console.error("Auto-save error:", error);
            }
        }

        // Debounced auto-save (1 second delay)
        const debouncedAutoSave = debounce(autoSaveProfile, 1000);
        
        async function loadSelectedProfile() {
            const name = document.getElementById('profile-select').value;
            if (!name) {
                alert('Please select a profile to load');
                return;
            }
            
            await loadProfile(name);
        }

        async function deleteSelectedProfile() {
            const name = document.getElementById('profile-select').value;
            if (!name) {
                alert('Please select a profile to delete');
                return;
            }

            if (!confirm(`Are you sure you want to delete profile "${name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/profile/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    document.getElementById('profile-name-input').value = '';
                    fetchProfiles();
                } else {
                    alert('Error deleting profile');
                }
            } catch (error) {
                alert('Error deleting profile: ' + error.message);
            }
        }

        async function loadSampleProfile() {
            if (!confirm('Load comprehensive sample profile?\n\nThis will create a new profile called "Sample Family - Complete Demo" with:\n‚Ä¢ Dual-income couple (Sarah & Michael)\n‚Ä¢ 16 investment accounts across all types\n‚Ä¢ 3 real estate properties\n‚Ä¢ 5 income streams\n‚Ä¢ Complete retirement planning scenario\n\nYour existing profiles will not be affected.')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/load-sample-profile`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}\n\nThe sample profile has been loaded. Select it from the dropdown to view.`);

                    // Refresh profile list
                    await fetchProfiles();

                    // Auto-select the sample profile
                    const select = document.getElementById('profile-select');
                    select.value = result.profile_name;

                    // Load the profile data
                    await loadProfile(result.profile_name);
                } else {
                    alert('‚ùå Error loading sample profile: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error loading sample profile: ' + error.message);
            }
        }

        async function loadDefaultProfile() {
            if (!confirm('Load default profile template?\n\nThis will create a new profile called "Default Profile" with:\n‚Ä¢ Dual-income couple (Jane & John)\n‚Ä¢ ~$3M total retirement savings\n‚Ä¢ 9 investment accounts (checking, savings, brokerage, IRAs, 401ks, Roths)\n‚Ä¢ 2 modest pensions\n‚Ä¢ Primary residence with mortgage\n‚Ä¢ $120k annual target income\n\nYour existing profiles will not be affected.')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/load-default-profile`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}\n\nThe default profile has been loaded. Select it from the dropdown to view.`);

                    // Refresh profile list
                    await fetchProfiles();

                    // Auto-select the default profile
                    const select = document.getElementById('profile-select');
                    select.value = result.profile_name;

                    // Load the profile data
                    await loadProfile(result.profile_name);
                } else {
                    alert('‚ùå Error loading default profile: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error loading default profile: ' + error.message);
            }
        }

        // Main load function (internal use)
        async function loadProfile(profileName = 'main') {
            console.log("Loading profile:", profileName);
            try {
                // Try to load specific profile
                let response = await fetch(`${API_URL}/profile/${encodeURIComponent(profileName)}`);
                
                // Fallback for backward compatibility if 404
                if (response.status === 404 && profileName === 'main') {
                    console.log("Main profile not found, skipping.");
                    return; 
                }

                if (!response.ok) {
                    throw new Error(`Failed to load profile (Status: ${response.status})`);
                }
                
                const data = await response.json();
                console.log("Loaded profile data:", data);
                
                if (data) {
                    document.getElementById('p1-name').value = data.person1.name;
                    document.getElementById('p1-birth').value = data.person1.birth_date;
                    document.getElementById('p1-retire').value = data.person1.retirement_date;
                    updateMonthYearFromDate('p1');
                    document.getElementById('p1-ss').value = data.person1.social_security;

                    document.getElementById('p2-name').value = data.person2.name;
                    document.getElementById('p2-birth').value = data.person2.birth_date;
                    document.getElementById('p2-retire').value = data.person2.retirement_date;
                    updateMonthYearFromDate('p2');
                    document.getElementById('p2-ss').value = data.person2.social_security;
                    
                    // No inputs to populate for assets anymore, handled by investmentTypes table
                    // document.getElementById('liquid').value = data.liquid_assets;
                    // ...
                    
                    document.getElementById('expenses').value = data.annual_expenses;
                    document.getElementById('pension-annual').value = data.pension_annual || 0;
                    document.getElementById('target-income').value = data.target_annual_income;
                    document.getElementById('risk').value = data.risk_tolerance;

                    // Load market assumptions if present
                    if (data.market_assumptions) {
                        const ma = data.market_assumptions;
                        if (ma.stock_allocation !== undefined) {
                            document.getElementById('stocks-slider').value = ma.stock_allocation * 100;
                        }
                        if (ma.stock_return_mean !== undefined) {
                            document.getElementById('stock-return-slider').value = ma.stock_return_mean * 100;
                        }
                        if (ma.bond_return_mean !== undefined) {
                            document.getElementById('bond-return-slider').value = ma.bond_return_mean * 100;
                        }
                        if (ma.inflation_mean !== undefined) {
                            document.getElementById('inflation-slider').value = ma.inflation_mean * 100;
                        }
                        if (ma.stock_return_std !== undefined) {
                            document.getElementById('stock-volatility-slider').value = ma.stock_return_std * 100;
                        }
                        if (ma.bond_return_std !== undefined) {
                            document.getElementById('bond-volatility-slider').value = ma.bond_return_std * 100;
                        }
                        if (ma.inflation_std !== undefined) {
                            document.getElementById('inflation-volatility-slider').value = ma.inflation_std * 100;
                        }
                        if (ma.ss_discount_rate !== undefined) {
                            document.getElementById('ss-discount-slider').value = ma.ss_discount_rate * 100;
                        }
                        
                        // Update displays
                        const sliders = ['stocks-slider', 'stock-return-slider', 'bond-return-slider', 
                                       'inflation-slider', 'stock-volatility-slider', 'bond-volatility-slider', 
                                       'inflation-volatility-slider', 'ss-discount-slider'];
                        sliders.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) updateSliderDisplay(el);
                        });
                    }

                    if (data.investment_types && Array.isArray(data.investment_types) && data.investment_types.length > 0) {
                        investmentTypes = data.investment_types;
                    } else {
                        // Migration: Create rows from legacy data fields if they exist and are > 0
                        investmentTypes = [];
                        if (data.liquid_assets > 0) {
                            investmentTypes.push({ name: 'Liquid Assets (Legacy)', account: 'Liquid', value: data.liquid_assets, change: 0 });
                        }
                        if (data.traditional_ira > 0) {
                            investmentTypes.push({ name: 'Traditional IRA/401k (Legacy)', account: 'Traditional IRA', value: data.traditional_ira, change: 0 });
                        }
                        if (data.roth_ira > 0) {
                            investmentTypes.push({ name: 'Roth IRA (Legacy)', account: 'Roth IRA', value: data.roth_ira, change: 0 });
                        }
                        if (data.pension_lump_sum > 0) {
                            investmentTypes.push({ name: 'Pension Lump Sum (Legacy)', account: 'Pension', value: data.pension_lump_sum, change: 0 });
                        }
                    }

                    if (data.income_streams && Array.isArray(data.income_streams)) {
                        incomeStreams = data.income_streams;
                    } else if (data.pension_annual > 0) {
                        // Migration: Move legacy pension annual to streams if it exists and streams is empty
                        incomeStreams = [{
                            name: 'Pension (Legacy)',
                            owner: 'person1', // Default
                            amount: data.pension_annual,
                            start_date: data.person1.retirement_date, // Guess
                            inflation_adjusted: true
                        }];
                    } else {
                        incomeStreams = [];
                    }

                    if (data.home_properties && Array.isArray(data.home_properties)) {
                        homeProperties = data.home_properties;
                    } else {
                        homeProperties = [];
                    }

                    if (data.accounts && Array.isArray(data.accounts)) {
                        accounts = data.accounts;
                    } else {
                        // Keep the default parsed data if nothing saved, or clear it if loading a different profile?
                        // For now, let's NOT clear it if it matches our initial hardcoded data, 
                        // but if we are loading a profile that *should* have empty accounts, we should probably clear it.
                        // However, to satisfy the user request "update the app with the following data", 
                        // we want this data to persist in the current session until saved.
                        // So we will only overwrite 'accounts' if data.accounts is explicitly present.
                    }

                    renderInvestmentTypes();
                    renderIncomeStreams();
                    renderHomeProperties();
                    updateIncomeOwnerLabels();

                    // Update input name to match loaded profile
                    document.getElementById('profile-name-input').value = profileName;
                    
                    // Sync selectors
                    const dbSelect = document.getElementById('dashboard-profile-select');
                    const mainSelect = document.getElementById('profile-select');
                    if (dbSelect) dbSelect.value = profileName;
                    if (mainSelect) mainSelect.value = profileName;

                    // Show success feedback
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 4px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        z-index: 10000;
                        font-weight: 600;
                    `;
                    notification.textContent = `‚úì Profile "${profileName}" loaded successfully`;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);

                    // Update progress indicator and initialize level tracking
                    previousLevel = getUserLevel();
                    updateProgressIndicator();

                    // Run analysis immediately to populate dashboard
                    runAnalysis();
                }
            } catch (error) {
                alert('Error loading profile: ' + error.message);
            }
        }
        
        async function runAnalysis() {
            const data = getFormData();
            const settings = getSettings();

            // Add simulation count to request
            data.simulations = settings.monteCarloSimulations || 10000;

            document.getElementById('analysis-results').innerHTML = '<div class="loading">Running analysis...</div>';

            try {
                const response = await fetch(`${API_URL}/analysis`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const results = await response.json();
                window.currentAnalysis = results;

                displayAnalysis(results);
                updateDashboard(results);
            } catch (error) {
                document.getElementById('analysis-results').innerHTML = '<div class="loading">Error: ' + error.message + '</div>';
            }
        }

        async function getAIRecommendations() {
            const resultsDiv = document.getElementById('ai-recommendations');
            resultsDiv.innerHTML = '<div class="loading">ü§ñ AI analyzing your financial profile and generating personalized recommendations...</div>';

            const provider = localStorage.getItem('default_llm') || 'gemini';

            try {
                const prompt = `Based on my complete financial profile and the comprehensive analysis results, please provide:

1. **Overall Assessment**: What's the most critical issue with my retirement plan?
2. **Primary Recommendation**: What single action would have the biggest impact on improving my retirement security?
3. **Social Security Strategy**: Should I claim at 62, 67, or 70? Why?
4. **Roth Conversion Strategy**: Should I do Roth conversions? How much and when?
5. **Spending Adjustments**: Do I need to reduce my target income? By how much?
6. **Risk Management**: What risks am I not addressing?
7. **Action Priority List**: Give me 3-5 specific actions ranked by impact

Please be direct and actionable. My success rate is currently ${window.currentAnalysis?.monte_carlo?.success_rate || 'unknown'}%.`;

                const response = await fetch(`${API_URL}/advisor/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: prompt,
                        include_context: true,
                        profile_data: getFormData(),
                        llm_provider: provider
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to get AI recommendations');
                }

                const data = await response.json();

                // Store the recommendations for later use
                window.currentAIRecommendations = data.response;

                // Format and display the recommendations
                const html = `
                    <div class="analysis-section" style="background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">ü§ñ AI-Powered Strategic Recommendations</h4>
                            <button class="secondary" onclick="getAIRecommendations()" style="font-size: 12px; padding: 6px 12px;">Refresh</button>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 4px; line-height: 1.8; white-space: pre-wrap;">${data.response}</div>

                        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #667eea33;">
                            <h5 style="margin: 0 0 10px 0; color: #667eea;">üìã Implement These Recommendations</h5>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="convertRecommendationsToActionItems()" style="background: #667eea; color: white;">
                                    ‚úÖ Convert to Action Items
                                </button>
                                <button onclick="showQuickApplyOptions()" class="secondary">
                                    ‚ö° Quick Apply
                                </button>
                                <button onclick="saveRecommendationsAsScenario()" class="secondary">
                                    üíæ Save as Scenario
                                </button>
                            </div>
                            <div id="quick-apply-options" style="margin-top: 15px;"></div>
                        </div>

                        <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary); font-style: italic;">
                            Powered by Google Gemini ‚Ä¢ <a href="#" onclick="localStorage.removeItem('gemini_api_key'); alert('API key cleared'); return false;">Clear API Key</a>
                        </div>
                    </div>
                `;

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="analysis-section" style="background: #f8d7da; border-left: 4px solid #dc3545;">
                        <h4 style="color: #721c24;">‚ùå Error Getting AI Recommendations</h4>
                        <p style="color: #721c24;">${error.message}</p>
                        <p style="font-size: 13px;">
                            <strong>Troubleshooting:</strong><br>
                            ‚Ä¢ Check that your Gemini API key is valid<br>
                            ‚Ä¢ Ensure you have internet connectivity<br>
                            ‚Ä¢ <a href="#" onclick="localStorage.removeItem('gemini_api_key'); alert('API key cleared. Click AI Recommendations again to enter a new key.'); return false;">Click here to reset API key</a>
                        </p>
                    </div>
                `;
            }
        }

        async function convertRecommendationsToActionItems() {
            if (!window.currentAIRecommendations) {
                alert('No recommendations to convert. Please get AI recommendations first.');
                return;
            }

            const loadingMsg = document.createElement('div');
            loadingMsg.innerHTML = '<div class="loading" style="margin-top: 10px;">ü§ñ Parsing recommendations into action items...</div>';
            document.getElementById('quick-apply-options').appendChild(loadingMsg);

            try {
                // Ask Gemini to parse the recommendations into structured action items
                const structurePrompt = `Please analyze these recommendations and extract specific, actionable items. For each action item, provide:
1. A category (one of: "Tax Planning", "Social Security", "Retirement Planning", "Investment Strategy", "Estate Planning", "Insurance", "Spending", "Income")
2. A clear, concise description (one sentence, action-oriented)
3. A priority (high, medium, or low)
4. A suggested due date (e.g., "Within 1 month", "Before retirement", "This year")
5. OPTIONAL: If the action involves changing a specific number or setting in the financial profile, provide an "action_data" object with "field" and "value".
   Supported fields:
   - "target_annual_income" (number)
   - "annual_expenses" (number)
   - "retirement_date_p1" (YYYY-MM-DD)
   - "retirement_date_p2" (YYYY-MM-DD)
   - "risk_tolerance" ("conservative", "moderate", "aggressive")
   - "social_security_p1" (monthly benefit number)
   - "stock_allocation" (number 0-100)

Return ONLY a JSON array of objects with this structure:
[
  {
    "category": "Tax Planning",
    "description": "Schedule meeting with CPA",
    "priority": "high",
    "due_date": "Within 1 month"
  },
  {
    "category": "Spending",
    "description": "Reduce annual spending goal to $140,000",
    "priority": "high",
    "due_date": "Immediate",
    "action_data": { "field": "target_annual_income", "value": 140000 }
  }
]

Here are the recommendations to parse:

${window.currentAIRecommendations}

Return ONLY the JSON array, no other text.`;

                const response = await fetch(`${API_URL}/advisor/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: structurePrompt,
                        include_context: false
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to parse recommendations');
                }

                const data = await response.json();

                // Try to extract JSON from the response
                let actionItems;
                try {
                    // Remove markdown code blocks if present
                    let jsonText = data.response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    actionItems = JSON.parse(jsonText);
                } catch (e) {
                    throw new Error('Could not parse AI response as JSON. Response: ' + data.response.substring(0, 200));
                }

                // Create action items via API
                let createdCount = 0;
                let existingCount = 0;
                for (const item of actionItems) {
                    const res = await fetch(`${API_URL}/action-items`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            category: item.category,
                            description: item.description,
                            priority: item.priority,
                            due_date: item.due_date,
                            action_data: item.action_data // Pass the smart action data
                        })
                    });
                    const resData = await res.json();
                    if (resData.status === 'success') {
                        createdCount++;
                    } else if (resData.status === 'exists') {
                        existingCount++;
                    }
                }

                loadingMsg.remove();

                const successMsg = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                        <p style="margin: 0; color: #155724;">
                            ‚úÖ Processed ${actionItems.length} recommendations:<br>
                            ‚Ä¢ ${createdCount} new action items created<br>
                            ${existingCount > 0 ? `‚Ä¢ ${existingCount} items already existed<br>` : ''}
                            <a href="#" onclick="showTab('actions'); return false;" style="margin-left: 10px; text-decoration: underline;">View Action Items ‚Üí</a>
                        </p>
                    </div>
                `;
                document.getElementById('quick-apply-options').innerHTML = successMsg;

            } catch (error) {
                loadingMsg.remove();
                document.getElementById('quick-apply-options').innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 4px; border-left: 4px solid #dc3545;">
                        <p style="margin: 0; color: #721c24;">‚ùå Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        function showQuickApplyOptions() {
            const optionsDiv = document.getElementById('quick-apply-options');

            // Get current analysis data
            const analysis = window.currentAnalysis;
            if (!analysis) {
                optionsDiv.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 4px; border-left: 4px solid #ffc107;">
                        <p style="margin: 0; color: #856404;">‚ö†Ô∏è Please run an analysis first to see quick apply options.</p>
                    </div>
                `;
                return;
            }

            // Parse recommendations to find common actions
            const recommendations = window.currentAIRecommendations || '';
            const lowerRecs = recommendations.toLowerCase();

            const options = [];

            // Check for Social Security delay recommendation
            if (lowerRecs.includes('delay') && (lowerRecs.includes('social security') || lowerRecs.includes('ss'))) {
                options.push({
                    label: 'üìÖ Delay Social Security to Age 70',
                    action: 'delaySocialSecurity',
                    description: 'Updates both retirement dates to age 70 for maximum benefits'
                });
            }

            // Check for income reduction recommendation
            const incomeMatch = recommendations.match(/reduce.*income.*?(\d+)%/i) ||
                               recommendations.match(/reduce.*spending.*?(\d+)%/i) ||
                               recommendations.match(/reduce.*target.*?(\d+)%/i);
            if (incomeMatch) {
                const percentage = incomeMatch[1];
                options.push({
                    label: `üí∞ Reduce Target Income by ${percentage}%`,
                    action: 'reduceIncome',
                    data: percentage,
                    description: `Adjusts target annual income down by ${percentage}%`
                });
            }

            // Check for Roth conversion recommendation
            if (analysis.roth_conversion_opportunity &&
                (lowerRecs.includes('roth conversion') || lowerRecs.includes('convert to roth'))) {
                options.push({
                    label: 'üîÑ Note Roth Conversion Strategy',
                    action: 'rothConversion',
                    description: 'Creates action item to implement Roth conversion plan'
                });
            }

            // Check for risk adjustment
            if (lowerRecs.includes('reduce risk') || lowerRecs.includes('conservative')) {
                options.push({
                    label: 'üìâ Adjust to Conservative Allocation',
                    action: 'conservativeAllocation',
                    description: 'Changes asset allocation to 40% stocks / 60% bonds'
                });
            } else if (lowerRecs.includes('increase') && lowerRecs.includes('stock')) {
                options.push({
                    label: 'üìà Adjust to Moderate Allocation',
                    action: 'moderateAllocation',
                    description: 'Changes asset allocation to 60% stocks / 40% bonds'
                });
            }

            if (options.length === 0) {
                optionsDiv.innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 4px; border-left: 4px solid #2196f3;">
                        <p style="margin: 0; color: #014361;">
                            ‚ÑπÔ∏è No quick-apply options detected in recommendations. Use "Convert to Action Items" instead.
                        </p>
                    </div>
                `;
                return;
            }

            const html = `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 4px; border: 1px solid #667eea;">
                    <h6 style="margin: 0 0 10px 0; color: #667eea;">‚ö° Quick Apply Options</h6>
                    ${options.map(opt => `
                        <div style="margin-bottom: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 3px;">${opt.label}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${opt.description}</div>
                                </div>
                                <button onclick="applyQuickAction('${opt.action}', ${opt.data ? `'${opt.data}'` : 'null'})"
                                        style="padding: 6px 12px; font-size: 12px; background: #667eea; color: white; white-space: nowrap;">
                                    Apply
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            optionsDiv.innerHTML = html;
        }

        async function applyQuickAction(action, data) {
            const optionsDiv = document.getElementById('quick-apply-options');

            try {
                switch(action) {
                    case 'delaySocialSecurity':
                        // Update retirement dates to age 70
                        const p1Birth = new Date(document.getElementById('p1-birth').value);
                        const p2Birth = new Date(document.getElementById('p2-birth').value);

                        const p1Age70 = new Date(p1Birth);
                        p1Age70.setFullYear(p1Age70.getFullYear() + 70);

                        const p2Age70 = new Date(p2Birth);
                        p2Age70.setFullYear(p2Age70.getFullYear() + 70);

                        document.getElementById('p1-retire').value = p1Age70.toISOString().split('T')[0];
                        document.getElementById('p2-retire').value = p2Age70.toISOString().split('T')[0];

                        optionsDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724;">
                                    ‚úÖ Updated retirement dates to age 70. Don't forget to save your profile and re-run analysis!
                                </p>
                            </div>
                        `;
                        break;

                    case 'reduceIncome':
                        const currentIncome = parseFloat(document.getElementById('target-income').value);
                        const reduction = parseFloat(data) / 100;
                        const newIncome = Math.round(currentIncome * (1 - reduction));

                        document.getElementById('target-income').value = newIncome;

                        optionsDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724;">
                                    ‚úÖ Reduced target income from $${currentIncome.toLocaleString()} to $${newIncome.toLocaleString()}. Save profile and re-run analysis.
                                </p>
                            </div>
                        `;
                        break;

                    case 'rothConversion':
                        const rothItem = await fetch(`${API_URL}/action-items`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                category: 'Tax Planning',
                                description: 'Implement Roth conversion strategy as recommended by AI advisor',
                                priority: 'high',
                                due_date: 'Before next tax year'
                            })
                        });

                        optionsDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724;">
                                    ‚úÖ Created action item for Roth conversion strategy.
                                    <a href="#" onclick="showTab('action-items'); return false;" style="margin-left: 10px; text-decoration: underline;">View Action Items ‚Üí</a>
                                </p>
                            </div>
                        `;
                        break;

                    case 'conservativeAllocation':
                        document.getElementById('stocks').value = 40;
                        document.getElementById('bonds').value = 60;
                        updateAllocationBars();

                        optionsDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724;">
                                    ‚úÖ Updated allocation to 40% stocks / 60% bonds (conservative). Save profile and re-run analysis.
                                </p>
                            </div>
                        `;
                        break;

                    case 'moderateAllocation':
                        document.getElementById('stocks').value = 60;
                        document.getElementById('bonds').value = 40;
                        updateAllocationBars();

                        optionsDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724;">
                                    ‚úÖ Updated allocation to 60% stocks / 40% bonds (moderate). Save profile and re-run analysis.
                                </p>
                            </div>
                        `;
                        break;
                }
            } catch (error) {
                optionsDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 4px; border-left: 4px solid #dc3545;">
                        <p style="margin: 0; color: #721c24;">‚ùå Error applying action: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function saveRecommendationsAsScenario() {
            if (!window.currentAnalysis || !window.currentAIRecommendations) {
                alert('Please run an analysis and get AI recommendations first.');
                return;
            }

            const scenarioName = prompt('Enter a name for this scenario:', 'AI Recommended Plan');
            if (!scenarioName) return;

            try {
                const response = await fetch(`${API_URL}/scenarios`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: scenarioName,
                        parameters: getFormData(),
                        results: window.currentAnalysis,
                        ai_recommendations: window.currentAIRecommendations
                    })
                });

                if (response.ok) {
                    document.getElementById('quick-apply-options').innerHTML = `
                        <div style="background: var(--success-bg); padding: 15px; border-radius: 4px; border-left: 4px solid var(--success-color);">
                            <p style="margin: 0; color: var(--text-primary);">
                                ‚úÖ Saved scenario "${scenarioName}" with AI recommendations!
                            </p>
                        </div>
                    `;
                } else {
                    throw new Error('Failed to save scenario');
                }
            } catch (error) {
                alert('Error saving scenario: ' + error.message);
            }
        }

        function displayAnalysis(results) {
            const assumptions = results.market_assumptions_used;

            const html = `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 10px; gap: 10px;">
                    <button class="secondary" onclick="downloadPDF()" style="font-size: 13px;">Download PDF Report</button>
                    <button class="secondary" onclick="saveAsScenario()" style="font-size: 13px;">Save Results as Scenario</button>
                </div>

                <div class="assumptions-used">
                    <h4>Analysis Parameters Used:</h4>
                    <p><strong>Asset Allocation:</strong> ${(assumptions.stock_allocation * 100).toFixed(0)}% stocks, ${(100 - assumptions.stock_allocation * 100).toFixed(0)}% bonds</p>
                    <p><strong>Expected Returns:</strong> ${(assumptions.stock_return_mean * 100).toFixed(2)}% stocks, ${(assumptions.bond_return_mean * 100).toFixed(2)}% bonds</p>
                    <p><strong>Expected Inflation:</strong> ${(assumptions.inflation_mean * 100).toFixed(2)}%</p>
                    <p><strong>Volatility (Std Dev):</strong> Stocks ${(assumptions.stock_return_std * 100).toFixed(2)}%, Bonds ${(assumptions.bond_return_std * 100).toFixed(2)}%, Inflation ${(assumptions.inflation_std * 100).toFixed(2)}%</p>
                    <p><strong>Social Security Discount Rate:</strong> ${(assumptions.ss_discount_rate * 100).toFixed(2)}%</p>
                </div>

                <div class="analysis-section">
                    <h4>Monte Carlo Retirement Simulation</h4>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;"><em>Based on ${(results.monte_carlo.simulations_run || 10000).toLocaleString()} simulations</em></p>
                    <p><strong>Success Rate:</strong> ${results.monte_carlo.success_rate.toFixed(1)}%</p>
                    <p><strong>Starting Portfolio:</strong> $${results.monte_carlo.starting_portfolio.toLocaleString()}</p>
                    <p><strong>Annual Withdrawal Need:</strong> $${results.monte_carlo.annual_withdrawal_need.toLocaleString()}</p>
                    <p><strong>Median Ending Balance:</strong> $${results.monte_carlo.median_ending_balance.toLocaleString()}</p>
                    <p><strong>5th Percentile (worst case):</strong> $${results.monte_carlo.percentile_5.toLocaleString()}</p>
                    <p><strong>95th Percentile (best case):</strong> $${results.monte_carlo.percentile_95.toLocaleString()}</p>

                    ${(() => {
                        const settings = getSettings();
                        const targetRate = settings.targetSuccessRate || 90;
                        const warningThreshold = targetRate - 10;
                        const withdrawalRate = (results.monte_carlo.annual_withdrawal_need / results.monte_carlo.starting_portfolio) * 100;
                        const successRate = results.monte_carlo.success_rate;
                        const failureRate = 100 - successRate;
                        let narrative = '';
                        let rationaleBg = '';
                        let rationaleIcon = '';

                        if (successRate >= targetRate) {
                            rationaleBg = 'var(--success-bg)';
                            rationaleIcon = '‚úì';
                            if (withdrawalRate <= 4) {
                                narrative = `<strong>Your Plan Looks Strong</strong><br><br>
                                    Your ${withdrawalRate.toFixed(2)}% withdrawal rate is conservative and aligns with the "4% rule." With a ${successRate.toFixed(1)}% success rate, this means only ${failureRate.toFixed(0)} out of 100 scenarios run out of money.<br><br>
                                    <strong>What happens in those ${failureRate.toFixed(0)} scenarios?</strong><br>
                                    Failures typically occur when markets decline 30%+ in the first 5 years of retirement (sequence-of-returns risk), combined with sustained inflation above ${(assumptions.inflation_mean * 100 + 2).toFixed(1)}%. Even in these scenarios, you typically have 15+ years before running out.<br><br>
                                    <strong>Why this works:</strong> Your conservative withdrawal rate leaves cushion for market volatility, and you're likely to end with substantial wealth in most scenarios.`;
                            } else {
                                narrative = `<strong>Your Plan Succeeds Despite Higher Withdrawals</strong><br><br>
                                    Your ${withdrawalRate.toFixed(2)}% withdrawal rate is above the traditional 4% rule, yet your ${successRate.toFixed(1)}% success rate exceeds your ${targetRate}% target.<br><br>
                                    <strong>What makes this work?</strong><br>
                                    Likely factors: higher stock allocation (${(assumptions.stock_allocation * 100).toFixed(0)}%), income streams reducing portfolio dependence, or shorter retirement time horizon. In the ${failureRate.toFixed(0)}% of failed scenarios, money runs out when early bear markets (losses >25% in first 3 years) combine with high inflation.<br><br>
                                    <strong>Watch for:</strong> RMDs at age 73 may push you into higher tax brackets, potentially draining portfolios faster than planned.`;
                            }
                        } else if (successRate >= warningThreshold) {
                            rationaleBg = 'var(--warning-bg)';
                            rationaleIcon = '‚ö†';
                            narrative = `<strong>Your Plan Needs Minor Adjustments</strong><br><br>
                                Your ${withdrawalRate.toFixed(2)}% withdrawal rate yields a ${successRate.toFixed(1)}% success rate, ${(targetRate - successRate).toFixed(1)} points below your ${targetRate}% target. This means ${failureRate.toFixed(0)} out of 100 scenarios fail.<br><br>
                                <strong>What happens in failed scenarios?</strong><br>
                                Money typically runs out around age ${(() => {
                                    const data = getFormData();
                                    const retireAge = Math.floor((new Date(data.person1.retirement_date) - new Date(data.person1.birth_date)) / (1000 * 60 * 60 * 24 * 365.25));
                                    return retireAge + 18; // Rough estimate
                                })()}, usually triggered by poor market returns in years 1-5 of retirement (down 20%+), followed by insufficient recovery. RMDs at age 73 can accelerate depletion by forcing larger taxable withdrawals.<br><br>
                                <strong>Small fixes make a big difference:</strong><br>
                                ‚Ä¢ Reduce spending by 5-8% ‚Üí adds ~3-5 points to success rate<br>
                                ‚Ä¢ Delay retirement 1 year ‚Üí adds ~2-4 points<br>
                                ‚Ä¢ Shift 10% to bonds ‚Üí reduces volatility, adds ~2 points<br>
                                ‚Ä¢ Plan Roth conversions before age 73 ‚Üí reduces RMD tax drag`;
                        } else if (successRate >= 50) {
                            rationaleBg = 'var(--danger-bg)';
                            rationaleIcon = '‚ö†';
                            narrative = `<strong>Your Plan Has Significant Risk</strong><br><br>
                                With a ${successRate.toFixed(1)}% success rate, ${failureRate.toFixed(0)} out of 100 scenarios fail. Your ${withdrawalRate.toFixed(2)}% withdrawal rate is straining your portfolio.<br><br>
                                <strong>What happens in failed scenarios?</strong><br>
                                In roughly half of the simulations, you run out of money, typically between ages ${(() => {
                                    const data = getFormData();
                                    const retireAge = Math.floor((new Date(data.person1.retirement_date) - new Date(data.person1.birth_date)) / (1000 * 60 * 60 * 24 * 365.25));
                                    return `${retireAge + 12}-${retireAge + 18}`;
                                })()} when early market downturns (30%+ losses in first 3 years) combine with persistent inflation. The median ending balance near $0 means even average market conditions barely sustain you.<br><br>
                                <strong>Why failures occur:</strong><br>
                                1. <strong>Sequence risk:</strong> Bear markets early in retirement lock in losses through forced selling<br>
                                2. <strong>RMD tax drag:</strong> At 73, required distributions push you into higher brackets, accelerating depletion<br>
                                3. <strong>Inflation erosion:</strong> ${withdrawalRate.toFixed(2)}% today becomes ${(withdrawalRate * 1.5).toFixed(2)}% in 15 years with 3% inflation<br><br>
                                <strong>Actions to consider:</strong><br>
                                ‚Ä¢ Reduce spending 10-15% (adds ~7-10 points)<br>
                                ‚Ä¢ Delay retirement 2-3 years (adds ~8-12 points)<br>
                                ‚Ä¢ Generate part-time income $20-30K/year (adds ~5-8 points)<br>
                                ‚Ä¢ Increase stock allocation if you have time horizon >15 years`;
                        } else {
                            rationaleBg = 'var(--danger-bg)';
                            rationaleIcon = '‚úó';
                            narrative = `<strong>Your Current Plan Is Unsustainable</strong><br><br>
                                With only a ${successRate.toFixed(1)}% success rate, ${failureRate.toFixed(0)} out of 100 scenarios fail. Your ${withdrawalRate.toFixed(2)}% withdrawal rate far exceeds sustainable levels.<br><br>
                                <strong>What happens in most scenarios?</strong><br>
                                Money runs out between ages ${(() => {
                                    const data = getFormData();
                                    const retireAge = Math.floor((new Date(data.person1.retirement_date) - new Date(data.person1.birth_date)) / (1000 * 60 * 60 * 24 * 365.25));
                                    return `${retireAge + 8}-${retireAge + 15}`;
                                })()}, even with average market returns. You're withdrawing principal so fast that compound growth can't keep up. Any bear market accelerates failure dramatically.<br><br>
                                <strong>Why this doesn't work:</strong><br>
                                1. <strong>Withdrawal too high:</strong> ${withdrawalRate.toFixed(2)}% vs sustainable 4-5%<br>
                                2. <strong>Time horizon:</strong> Portfolio needs ${Math.round((withdrawalRate - 4) * 5)} more years of growth<br>
                                3. <strong>Tax trap:</strong> Pre-tax accounts face RMDs at 73, forcing larger taxable withdrawals<br>
                                4. <strong>No margin for error:</strong> Any deviation from perfect conditions causes failure<br><br>
                                <strong>Required actions (choose multiple):</strong><br>
                                ‚Ä¢ <strong>Critical:</strong> Reduce spending 20%+ OR delay retirement 3-5 years<br>
                                ‚Ä¢ Work part-time: $40-50K/year adds ~12-15 points to success rate<br>
                                ‚Ä¢ Downsize home: $200K+ proceeds adds ~4-6 points<br>
                                ‚Ä¢ Re-evaluate retirement lifestyle: Target income may need 15-25% reduction<br>
                                ‚Ä¢ Consider phased retirement: Work 2-3 more years full-time, then part-time`;
                        }

                        const borderColor = successRate >= targetRate ? 'var(--success-color)' : successRate >= warningThreshold ? 'var(--warning-color)' : 'var(--danger-color)';
                        const textColor = 'var(--text-primary)';

                        return `
                            <div style="margin-top: 15px; padding: 15px; background: ${rationaleBg}; border-left: 4px solid ${borderColor}; border-radius: 4px; color: ${textColor};">
                                <div style="margin: 0;">${rationaleIcon} ${narrative}</div>
                            </div>
                        `;
                    })()}

                    <div style="margin-top: 20px; height: 300px;">
                        <canvas id="analysis-timeline-chart"></canvas>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h4>Social Security Optimization</h4>
                    <table>
                        <tr>
                            <th>Strategy</th>
                            <th>You Claim At</th>
                            <th>Spouse Claim At</th>
                            <th>Your Monthly</th>
                            <th>Spouse Monthly</th>
                            <th>Lifetime NPV</th>
                        </tr>
                        ${results.social_security_optimization.map(s => `
                            <tr>
                                <td>${s.person1_claim_age === 70 && s.person2_claim_age === 70 ? '‚úì Recommended' : ''}</td>
                                <td>${s.person1_claim_age}</td>
                                <td>${s.person2_claim_age}</td>
                                <td>$${s.person1_monthly.toLocaleString()}</td>
                                <td>$${s.person2_monthly.toLocaleString()}</td>
                                <td>$${s.lifetime_benefit_npv.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
                
                <div class="analysis-section">
                    <h4>Roth Conversion Opportunity</h4>
                    <p><strong>Status:</strong> ${results.roth_conversion.opportunity}</p>
                    ${results.roth_conversion.conversion_years ? `
                        <p><strong>Conversion Window:</strong> ${results.roth_conversion.conversion_years} years</p>
                        <p><strong>Annual Conversion (12% bracket):</strong> $${results.roth_conversion.annual_conversion_12_bracket.toLocaleString()}</p>
                        <p><strong>Total Convertible:</strong> $${results.roth_conversion.total_convertible_12.toLocaleString()}</p>
                        <p><strong>Tax Cost:</strong> $${results.roth_conversion.tax_cost_12.toLocaleString()}</p>
                        <p><strong>Recommendation:</strong> ${results.roth_conversion.recommendation}</p>
                    ` : `<p>${results.roth_conversion.reason}</p>`}
                </div>
                
                <div class="analysis-section">
                    <h4>Wealth Transfer Strategy</h4>
                    <p><strong>Annual Gift Capacity:</strong> $${results.wealth_transfer.annual_gift_capacity.toLocaleString()}</p>
                    <p><strong>Per Child:</strong> $${results.wealth_transfer.per_child_annual.toLocaleString()}/year</p>
                    <p><strong>Lifetime Gifting:</strong> $${results.wealth_transfer.lifetime_gift_capacity.toLocaleString()} over ${results.wealth_transfer.years_of_gifting} years</p>
                    <p><strong>% of Estate:</strong> ${results.wealth_transfer.percentage_transferred.toFixed(1)}%</p>
                    <p><strong>Recommendation:</strong> ${results.wealth_transfer.recommendation}</p>
                </div>
            `;
            
            document.getElementById('analysis-results').innerHTML = html;
            
            // Render Timeline Chart
            if (results.monte_carlo.timeline) {
                const ctx = document.getElementById('analysis-timeline-chart').getContext('2d');
                
                // Destroy existing if any (pseudo-check)
                if (window.analysisChart) window.analysisChart.destroy();
                
                window.analysisChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: results.monte_carlo.timeline.years,
                        datasets: [
                            {
                                label: 'Median Portfolio',
                                data: results.monte_carlo.timeline.median,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: '95th Percentile',
                                data: results.monte_carlo.timeline.p95,
                                borderColor: '#2ecc71',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: '5th Percentile',
                                data: results.monte_carlo.timeline.p5,
                                borderColor: '#e74c3c',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Projected Portfolio Balance',
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary').trim() || '#000',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                labels: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-primary').trim() || '#000',
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() || '#666'
                                },
                                grid: {
                                    color: getComputedStyle(document.body).getPropertyValue('--border-color').trim() || '#ddd'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Balance ($)',
                                    color: getComputedStyle(document.body).getPropertyValue('--text-primary').trim() || '#000'
                                },
                                ticks: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() || '#666'
                                },
                                grid: {
                                    color: getComputedStyle(document.body).getPropertyValue('--border-color').trim() || '#ddd'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Scenario Management
        async function downloadPDF() {
            if (!window.currentAnalysis) {
                alert('Please run an analysis first.');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/report/pdf`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        profile: getFormData(),
                        analysis: window.currentAnalysis
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `retirement_plan_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('Failed to generate PDF');
                }
            } catch (error) {
                alert('Error downloading PDF: ' + error.message);
            }
        }

        async function saveAsScenario() {
            if (!window.currentAnalysis) return;
            
            const currentProfileName = document.getElementById('profile-name-input').value || 'New Scenario';
            const name = prompt("Enter a name for this scenario:", currentProfileName);
            
            if (!name) return;
            
            // We save the inputs (from form) and the outputs (currentAnalysis)
            const payload = {
                name: name,
                parameters: getFormData(),
                results: window.currentAnalysis
            };
            
            try {
                const response = await fetch(`${API_URL}/scenarios`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    refreshScenarios();
                } else {
                    alert('Failed to save scenario');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        let savedScenarios = [];
        let selectedScenarioIds = [];
        
        async function refreshScenarios() {
            try {
                const response = await fetch(`${API_URL}/scenarios`);
                savedScenarios = await response.json();

                // Remove deleted scenarios from selection
                const validIds = savedScenarios.map(s => s.id);
                selectedScenarioIds = selectedScenarioIds.filter(id => validIds.includes(id));

                renderScenariosList();

                // Update comparison charts if scenarios are selected
                if (selectedScenarioIds.length > 0) {
                    await compareScenarios();
                }
            } catch (e) {
                console.error("Failed to load scenarios", e);
            }
        }
        
        function renderScenariosList() {
            const list = document.getElementById('scenarios-list');
            list.innerHTML = '';

            savedScenarios.forEach(s => {
                const item = document.createElement('div');
                item.style.padding = '10px';
                item.style.borderBottom = '1px solid #eee';
                item.style.display = 'flex';
                item.style.alignItems = 'center';
                item.style.gap = '10px';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = s.id;

                // Restore checked state from selectedScenarioIds
                checkbox.checked = selectedScenarioIds.includes(s.id);

                checkbox.onchange = (e) => {
                    if (e.target.checked) selectedScenarioIds.push(s.id);
                    else selectedScenarioIds = selectedScenarioIds.filter(id => id !== s.id);
                    compareScenarios();
                };

                const label = document.createElement('div');
                label.style.flex = 1;
                label.innerHTML = `<strong>${s.name}</strong><br><span style="font-size:11px;color:#777">${new Date(s.created_at).toLocaleString()}</span>`;

                const delBtn = document.createElement('button');
                delBtn.textContent = '√ó';
                delBtn.style.padding = '2px 6px';
                delBtn.style.fontSize = '12px';
                delBtn.style.background = '#e74c3c';
                delBtn.onclick = async () => {
                    await fetch(`${API_URL}/scenarios/${s.id}`, { method: 'DELETE' });
                    refreshScenarios();
                };

                item.append(checkbox, label, delBtn);
                list.append(item);
            });
        }
        
        async function compareScenarios() {
            if (selectedScenarioIds.length === 0) {
                // Clear charts
                if (window.compBarChart) window.compBarChart.destroy();
                if (window.compLineChart) window.compLineChart.destroy();
                // Clear table
                const table = document.getElementById('comparison-table');
                const tbody = table.tBodies[0];
                tbody.innerHTML = '';
                return;
            }

            try {
                // Fetch details for selected scenarios, filter out any that fail (e.g., 404)
                const detailsPromises = selectedScenarioIds.map(id =>
                    fetch(`${API_URL}/scenarios/${id}`)
                        .then(r => {
                            if (!r.ok) return null;
                            return r.json();
                        })
                        .catch(() => null)
                );

                const details = (await Promise.all(detailsPromises)).filter(d => d !== null);

                if (details.length === 0) {
                    // All scenarios failed to load, clear charts
                    if (window.compBarChart) window.compBarChart.destroy();
                    if (window.compLineChart) window.compLineChart.destroy();
                    return;
                }

                renderComparisonCharts(details);
            } catch (e) {
                console.error("Error comparing scenarios:", e);
            }
        }
        
        function renderComparisonCharts(scenarios) {
            // Bar Chart: Success Rate & Outcomes
            const ctxBar = document.getElementById('comparison-chart-bar').getContext('2d');
            if (window.compBarChart) window.compBarChart.destroy();
            
            window.compBarChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: scenarios.map(s => s.name),
                    datasets: [
                        {
                            label: 'Success Rate (%)',
                            data: scenarios.map(s => s.results.monte_carlo.success_rate),
                            backgroundColor: '#2ecc71',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Median Ending Balance ($M)',
                            data: scenarios.map(s => s.results.monte_carlo.median_ending_balance / 1000000),
                            backgroundColor: '#3498db',
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Worst Case (5th %ile) ($M)',
                            data: scenarios.map(s => s.results.monte_carlo.percentile_5 / 1000000),
                            backgroundColor: '#e74c3c',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Success Rate (%)' },
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Balance ($M)' },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 0) {
                                        label += context.parsed.y.toFixed(1) + '%';
                                    } else {
                                        label += '$' + context.parsed.y.toFixed(2) + 'M';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // Line Chart: Median Trajectory Comparison
            const ctxLine = document.getElementById('comparison-chart-line').getContext('2d');
            if (window.compLineChart) window.compLineChart.destroy();
            
            const colors = ['#3498db', '#e74c3c', '#9b59b6', '#f1c40f', '#34495e'];
            
            // Ensure we have data before rendering
            if (scenarios.length > 0 && scenarios[0].results.monte_carlo.timeline) {
                window.compLineChart = new Chart(ctxLine, {
                    type: 'line',
                    data: {
                        labels: scenarios[0].results.monte_carlo.timeline.years, 
                        datasets: scenarios.map((s, i) => ({
                            label: s.name,
                            data: s.results.monte_carlo.timeline.median,
                            borderColor: colors[i % colors.length],
                            fill: false,
                            tension: 0.1
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Median Portfolio Performance Comparison' }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: 'Balance ($)' },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Assumption Comparison Table
            const table = document.getElementById('comparison-table');
            const thead = table.tHead.rows[0];
            const tbody = table.tBodies[0];
            
            // Reset headers (keep first 'Parameter' col)
            while (thead.cells.length > 1) {
                thead.deleteCell(1);
            }
            tbody.innerHTML = '';
            
            // Add Scenario Columns
            scenarios.forEach(s => {
                const th = document.createElement('th');
                th.textContent = s.name;
                th.style.padding = '10px';
                th.style.textAlign = 'center';
                thead.appendChild(th);
            });
            
            // Helper to add row
            const addRow = (label, getValue) => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #eee';
                
                const tdLabel = document.createElement('td');
                tdLabel.textContent = label;
                tdLabel.style.padding = '8px';
                tdLabel.style.fontWeight = '500';
                tr.appendChild(tdLabel);
                
                scenarios.forEach(s => {
                    const td = document.createElement('td');
                    try {
                        td.textContent = getValue(s.parameters);
                    } catch (e) {
                        td.textContent = '-';
                    }
                    td.style.padding = '8px';
                    td.style.textAlign = 'center';
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            };
            
            // Add Data Rows
            addRow('Stock Allocation', p => (p.market_assumptions.stock_allocation * 100).toFixed(0) + '%');
            addRow('Stock Return', p => (p.market_assumptions.stock_return_mean * 100).toFixed(2) + '%');
            addRow('Bond Return', p => (p.market_assumptions.bond_return_mean * 100).toFixed(2) + '%');
            addRow('Inflation', p => (p.market_assumptions.inflation_mean * 100).toFixed(2) + '%');
            addRow('Annual Expenses', p => '$' + p.annual_expenses.toLocaleString());
            addRow('Retirement Date', p => new Date(p.person1.retirement_date).getFullYear());
        }
        
        function updateDashboard(results) {
            updateDashboardMetrics(results);
            updateDashboardChart(results);
            renderAssetLocationChart();
            renderLiquidityByAgeChart();
            renderFinancialTimeline();
            renderGapAnalysis(results);
        }

        function updateDashboardMetrics(results) {
            const settings = getSettings();
            const targetRate = settings.targetSuccessRate || 90;
            const warningThreshold = targetRate - 10;

            const successClass = results.monte_carlo.success_rate >= targetRate ? 'success' : 
                               results.monte_carlo.success_rate >= warningThreshold ? 'warning' : 'danger';
            
            const successBg = results.monte_carlo.success_rate >= targetRate ? 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' :
                            results.monte_carlo.success_rate >= warningThreshold ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' :
                            'linear-gradient(135deg, #ff6b6b 0%, #c0392b 100%)';

            const withdrawalRate = (results.monte_carlo.annual_withdrawal_need / results.monte_carlo.starting_portfolio) * 100;
            const withdrawalClass = withdrawalRate <= 4.0 ? '#2ecc71' : withdrawalRate <= 5.0 ? '#f39c12' : '#e74c3c';

            const html = `
                <div class="metric-card" style="background: ${successBg}; transition: background 0.3s ease;">
                    <div class="metric-label">Success Rate (Target: ${targetRate}%)</div>
                    <div class="metric-value">${results.monte_carlo.success_rate.toFixed(0)}%</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Probability money lasts to age 90</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Median Net Worth (Age 90)</div>
                    <div class="metric-value">$${(results.monte_carlo.median_ending_balance / 1000000).toFixed(2)}M</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Inflation-adjusted legacy</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%)">
                    <div class="metric-label">Safe Withdrawal Rate</div>
                    <div class="metric-value">${withdrawalRate.toFixed(2)}%</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Target: < 4.0%</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #f39c12 0%, #d35400 100%)">
                    <div class="metric-label">RMD Age (Start)</div>
                    <div class="metric-value">73</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Tax planning deadline</div>
                </div>
            `;
            
            document.getElementById('dashboard-metrics').innerHTML = html;
            document.getElementById('dashboard-last-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();

            // --- Sync Dashboard Levers ---
            
            // 1. Spending Lever
            if (document.activeElement.id !== 'db-spending') {
                const spending = parseInt(document.getElementById('expenses').value) || 0;
                const slider = document.getElementById('db-spending');
                
                // Dynamic Range Adjustment
                if (spending > parseInt(slider.max)) slider.max = Math.ceil(spending * 1.5 / 1000) * 1000;
                if (spending < parseInt(slider.min) && spending > 0) slider.min = 0;
                
                slider.value = spending;
                document.getElementById('db-spending-val').textContent = '$' + spending.toLocaleString();
            }

            // 2. Withdrawal Rate Lever (Derived)
            if (document.activeElement.id !== 'db-withdraw-rate') {
                document.getElementById('db-withdraw-rate').value = withdrawalRate.toFixed(1);
                document.getElementById('db-withdraw-rate-val').textContent = withdrawalRate.toFixed(1) + '%';
            }

            // 3. Retirement Month Levers
            const syncRetireLever = (inputId, monthInputId, labelId, nameInputId) => {
                if (document.activeElement.id !== monthInputId) {
                    const dateVal = document.getElementById(inputId).value;
                    if (dateVal) {
                        const date = new Date(dateVal);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const monthValue = `${year}-${month}`;
                        document.getElementById(monthInputId).value = monthValue;
                    }
                }
                // Update Name Label
                const name = document.getElementById(nameInputId).value || (nameInputId.includes('p1') ? 'Person 1' : 'Person 2');
                const label = document.getElementById(labelId);
                if (label) label.textContent = name;
            };

            syncRetireLever('p1-retire', 'db-retire-month', 'db-p1-label', 'p1-name');
            syncRetireLever('p2-retire', 'db-retire-month-p2', 'db-p2-label', 'p2-name');

            // 4. Allocation Lever
            if (document.activeElement.id !== 'db-allocation') {
                const allocation = document.getElementById('stocks-slider').value;
                document.getElementById('db-allocation').value = allocation;
                document.getElementById('db-allocation-val').textContent = allocation + '%';
            }
        }

        function updateDashboardChart(results) {
            // Render Dashboard Chart
            if (results.monte_carlo.timeline) {
                const ctx = document.getElementById('dashboard-chart').getContext('2d');
                
                if (window.dashboardChart) window.dashboardChart.destroy();
                
                window.dashboardChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: results.monte_carlo.timeline.years,
                        datasets: [
                            {
                                label: 'Median Portfolio',
                                data: results.monte_carlo.timeline.median,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0
                            },
                            {
                                label: 'Best Case (95%)',
                                data: results.monte_carlo.timeline.p95,
                                borderColor: '#2ecc71',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0
                            },
                            {
                                label: 'Worst Case (5%)',
                                data: results.monte_carlo.timeline.p5,
                                borderColor: '#e74c3c',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + Math.round(context.raw).toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: getComputedStyle(document.body).getPropertyValue('--border-color').trim() || '#f0f0f0'
                                },
                                ticks: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() || '#666',
                                    callback: function(value) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                }
                            },
                            x: {
                                grid: { display: false },
                                ticks: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() || '#666'
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderAssetLocationChart() {
            const data = getFormData();
            const invTypes = data.investment_types || [];

            let cash = 0, taxable = 0, pretax = 0, roth = 0;

            invTypes.forEach(inv => {
                const val = inv.value || 0;
                const acc = inv.account || 'Liquid';

                if (acc === 'Checking' || acc === 'Savings') {
                    cash += val;
                } else if (acc === 'Liquid' || acc === 'Taxable Brokerage') {
                    taxable += val;
                } else if (acc === 'Traditional IRA' || acc === '401k' || acc === '403b' || acc === '401a' || acc === '457b' || acc === 'Pension') {
                    pretax += val;
                } else if (acc === 'Roth IRA') {
                    roth += val;
                }
            });

            const total = cash + taxable + pretax + roth;

            if (total === 0) {
                document.getElementById('asset-location-summary').innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No investment accounts added yet.</p>';
                return;
            }

            const ctx = document.getElementById('asset-location-chart').getContext('2d');

            if (window.assetLocationChart) window.assetLocationChart.destroy();

            window.assetLocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cash', 'Taxable', 'Pre-Tax', 'Roth'],
                    datasets: [{
                        data: [cash, taxable, pretax, roth],
                        backgroundColor: ['#95a5a6', '#3498db', '#e67e22', '#9b59b6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary').trim() || '#fff',
                                font: {
                                    size: 13
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: $${(value/1000).toFixed(0)}K (${pct}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const pct = ((value / total) * 100).toFixed(1);
                                    return context.label + ': $' + value.toLocaleString() + ' (' + pct + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Summary text
            const cashPct = ((cash / total) * 100).toFixed(0);
            const taxablePct = ((taxable / total) * 100).toFixed(0);
            const pretaxPct = ((pretax / total) * 100).toFixed(0);
            const rothPct = ((roth / total) * 100).toFixed(0);

            document.getElementById('asset-location-summary').innerHTML = `
                <p style="margin-bottom: 10px;"><strong>Total Portfolio: $${total.toLocaleString()}</strong></p>
                <p style="margin-bottom: 8px; line-height: 1.5;">
                    üí° <strong>Tax Diversification:</strong> ${pretaxPct}% in pre-tax accounts means you'll pay taxes on withdrawals.
                    ${rothPct}% in Roth gives you tax-free income.
                    ${taxablePct}% in taxable provides flexibility with capital gains treatment.
                </p>
                ${pretaxPct > 70 ? `<p style="color: var(--warning-text, #f39c12); margin-top: 10px;">‚ö†Ô∏è Consider Roth conversions to reduce future RMD tax burden.</p>` : ''}
                ${rothPct > 40 ? `<p style="color: var(--success-text, #27ae60); margin-top: 10px;">‚úÖ Strong Roth allocation provides tax-free retirement income!</p>` : ''}
            `;
        }

        function renderLiquidityByAgeChart() {
            const data = getFormData();
            const invTypes = data.investment_types || [];
            const p1BirthDate = new Date(data.person1.birth_date);
            const currentYear = new Date().getFullYear();
            const currentAge = currentYear - p1BirthDate.getFullYear();

            let cash = 0, taxable = 0, pretax457 = 0, pretaxStd = 0, roth = 0;

            invTypes.forEach(inv => {
                const val = inv.value || 0;
                const acc = inv.account || 'Liquid';

                if (acc === 'Checking' || acc === 'Savings') {
                    cash += val;
                } else if (acc === 'Liquid' || acc === 'Taxable Brokerage') {
                    taxable += val;
                } else if (acc === '457b') {
                    pretax457 += val;
                } else if (acc === 'Traditional IRA' || acc === '401k' || acc === '403b' || acc === '401a' || acc === 'Pension') {
                    pretaxStd += val;
                } else if (acc === 'Roth IRA') {
                    roth += val;
                }
            });

            const ages = [currentAge, 59.5, 62, 67, 73];
            const accessible = ages.map(age => {
                let total = cash + taxable; // Always accessible

                if (age >= 55) total += pretax457; // 457b no penalty after separation
                if (age >= 59.5) total += pretaxStd; // Standard pre-tax no penalty
                if (age >= 59.5) total += roth; // Roth no penalty (but save for last)

                return total;
            });

            const ctx = document.getElementById('liquidity-by-age-chart').getContext('2d');

            if (window.liquidityChart) window.liquidityChart.destroy();

            window.liquidityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ages.map(a => `Age ${a}`),
                    datasets: [{
                        label: 'Accessible Without Penalty',
                        data: accessible,
                        backgroundColor: '#27ae60',
                        borderColor: '#229954',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Accessible: $' + context.raw.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() || '#ccc',
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border-color').trim() || '#444'
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() || '#ccc'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            const accessibleNow = cash + taxable;
            const accessibleAt595 = cash + taxable + pretax457 + pretaxStd + roth;
            const totalAssets = cash + taxable + pretax457 + pretaxStd + roth;

            document.getElementById('liquidity-score').innerHTML = `
                <p style="margin-bottom: 10px;"><strong>Current Age: ${currentAge}</strong></p>
                <p style="margin-bottom: 8px;">
                    üíµ <strong>Accessible Today:</strong> $${accessibleNow.toLocaleString()} (${((accessibleNow/totalAssets)*100).toFixed(0)}% of total)
                </p>
                <p style="margin-bottom: 8px;">
                    üîì <strong>At Age 59.5:</strong> $${accessibleAt595.toLocaleString()} (${((accessibleAt595/totalAssets)*100).toFixed(0)}% of total)
                </p>
                ${currentAge < 59.5 && accessibleNow < totalAssets * 0.15 ?
                    `<p style="color: var(--warning-text, #f39c12); margin-top: 10px;">‚ö†Ô∏è Only ${((accessibleNow/totalAssets)*100).toFixed(0)}% accessible before age 59.5. Consider maintaining more in taxable accounts for early retirement flexibility.</p>`
                    : ''}
            `;
        }

        function renderFinancialTimeline() {
            const data = getFormData();
            const p1BirthDate = new Date(data.person1.birth_date);
            const p1RetireDate = new Date(data.person1.retirement_date);
            const currentYear = new Date().getFullYear();
            const currentAge = currentYear - p1BirthDate.getFullYear();

            const milestones = [];

            // Retirement
            const retireAge = Math.floor((p1RetireDate - p1BirthDate) / (1000 * 60 * 60 * 24 * 365.25));
            const retireYear = p1RetireDate.getFullYear();
            milestones.push({
                age: retireAge,
                year: retireYear,
                icon: 'üéØ',
                title: `Retire`,
                description: `Begin retirement withdrawals`,
                color: '#3498db'
            });

            // Social Security eligibility
            if (currentAge < 70) {
                milestones.push({
                    age: 62,
                    year: p1BirthDate.getFullYear() + 62,
                    icon: 'üí∞',
                    title: 'SS Early Eligibility',
                    description: 'Reduced benefits available',
                    color: '#95a5a6'
                });
                milestones.push({
                    age: 67,
                    year: p1BirthDate.getFullYear() + 67,
                    icon: 'üíµ',
                    title: 'SS Full Retirement',
                    description: 'Full benefits available',
                    color: '#27ae60'
                });
            }

            // Medicare
            if (currentAge < 65) {
                milestones.push({
                    age: 65,
                    year: p1BirthDate.getFullYear() + 65,
                    icon: 'üè•',
                    title: 'Medicare Begins',
                    description: 'Healthcare coverage starts',
                    color: '#e74c3c'
                });
            }

            // RMDs
            if (currentAge < 73) {
                milestones.push({
                    age: 73,
                    year: p1BirthDate.getFullYear() + 73,
                    icon: 'üìã',
                    title: 'RMDs Begin',
                    description: 'Required minimum distributions',
                    color: '#e67e22'
                });
            }

            // Income streams
            if (data.income_streams) {
                data.income_streams.forEach(stream => {
                    const startDate = new Date(stream.start_date);
                    const startAge = Math.floor((startDate - p1BirthDate) / (1000 * 60 * 60 * 24 * 365.25));
                    milestones.push({
                        age: startAge,
                        year: startDate.getFullYear(),
                        icon: 'üíº',
                        title: stream.name,
                        description: `$${stream.amount.toLocaleString()}/year`,
                        color: '#9b59b6'
                    });
                });
            }

            // Property sales
            if (data.home_properties) {
                data.home_properties.forEach(prop => {
                    if (prop.planned_sale_date) {
                        const saleDate = new Date(prop.planned_sale_date);
                        const saleAge = Math.floor((saleDate - p1BirthDate) / (1000 * 60 * 60 * 24 * 365.25));
                        milestones.push({
                            age: saleAge,
                            year: saleDate.getFullYear(),
                            icon: 'üè°',
                            title: `Sell ${prop.name}`,
                            description: `Est. $${prop.current_value.toLocaleString()}`,
                            color: '#16a085'
                        });
                    }
                });
            }

            // Sort by age
            milestones.sort((a, b) => a.age - b.age);

            // Render timeline
            let html = '<div style="display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px;">';

            milestones.forEach((m, i) => {
                const isPast = currentAge > m.age;
                const isCurrent = currentAge === m.age;
                const opacity = isPast ? '0.5' : '1.0';

                html += `
                    <div style="min-width: 180px; opacity: ${opacity}; position: relative;">
                        <div style="text-align: center; margin-bottom: 10px;">
                            <div style="font-size: 32px; margin-bottom: 5px;">${m.icon}</div>
                            <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 2px;">${m.title}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Age ${m.age} (${m.year})</div>
                        </div>
                        <div style="padding: 10px; background: var(--bg-secondary); border: 2px solid ${m.color}; border-radius: 6px; font-size: 12px; text-align: center; color: var(--text-primary);">
                            ${m.description}
                        </div>
                        ${isCurrent ? '<div style="text-align: center; margin-top: 5px; color: var(--text-primary); font-weight: 700; font-size: 11px;">‚Üê You are here</div>' : ''}
                    </div>
                `;

                if (i < milestones.length - 1) {
                    html += `<div style="align-self: center; color: var(--text-light); font-size: 20px; padding: 0 10px;">‚Üí</div>`;
                }
            });

            html += '</div>';

            if (milestones.length === 0) {
                html = '<p style="color: var(--text-secondary); font-style: italic;">Add income streams or property sales to see your timeline.</p>';
            }

            document.getElementById('financial-timeline').innerHTML = html;
        }

        function renderGapAnalysis(results) {
            if (!results || !results.monte_carlo) return;

            const successRate = results.monte_carlo.success_rate;
            const targetRate = 90;

            if (successRate >= targetRate) {
                document.getElementById('gap-analysis-widget').style.display = 'none';
                return;
            }

            document.getElementById('gap-analysis-widget').style.display = 'block';

            const gap = targetRate - successRate;
            const data = getFormData();
            const totalAssets = (data.investment_types || []).reduce((sum, inv) => sum + (inv.value || 0), 0);

            // Estimate needed additional assets (rough heuristic: 2% success rate ‚âà $100K more assets)
            const estimatedNeed = gap * 50000;

            let html = `
                <p style="margin-bottom: 15px; font-size: 14px;">
                    Your current success rate is <strong>${successRate.toFixed(0)}%</strong>, which is
                    <strong>${gap.toFixed(0)} percentage points</strong> below the recommended ${targetRate}% target.
                </p>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h5 style="margin: 0 0 10px 0; color: #856404;">Recommended Actions:</h5>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                        <li><strong>Increase savings by ~$${estimatedNeed.toLocaleString()}</strong> to reach ${targetRate}% success rate</li>
                        <li>Reduce annual spending by ${(data.target_annual_income * 0.1).toLocaleString()} (10%) to improve sustainability</li>
                        <li>Delay retirement by 1-2 years to allow more accumulation</li>
                        <li>Consider a more conservative allocation during early retirement years</li>
                    </ul>
                </div>
                <p style="font-size: 12px; color: var(--text-secondary); font-style: italic;">
                    üí° These are general recommendations. Use the Scenario Sandbox below to model specific changes.
                </p>
            `;

            document.getElementById('gap-analysis-content').innerHTML = html;
        }

        function attachDashboardListeners() {
            // Spending Lever
            const spendingSlider = document.getElementById('db-spending');
            spendingSlider.addEventListener('input', () => {
                const val = parseInt(spendingSlider.value);
                document.getElementById('db-spending-val').textContent = '$' + val.toLocaleString();
                // Update main form
                document.getElementById('expenses').value = val;
                
                // Update Rate Slider locally for immediate feedback (approximate)
                if (window.currentAnalysis) {
                    const portfolio = window.currentAnalysis.monte_carlo.starting_portfolio;
                    // We need guaranteed income. Estimate it:
                    const currentNeed = window.currentAnalysis.monte_carlo.annual_withdrawal_need;
                    const oldSpending = parseFloat(window.currentAnalysis.market_assumptions_used?.last_spending || val); // Fallback
                    // Actually, simpler: Analysis result has annual_withdrawal_need based on the INPUT spending.
                    // If we change spending, need changes by same amount.
                    // Guaranteed = Spending - Need.
                    // New Need = New Spending - Guaranteed.
                    // Rate = New Need / Portfolio * 100.
                    
                    // But we don't have guaranteed easily available without calculating.
                    // Let's just let the debounce analysis update the rate slider.
                    // Or do a rough calc if we want:
                    // const guaranteed = val - currentNeed; // This assumes val matches the analysis input, which it might not yet.
                }
            });
            spendingSlider.addEventListener('change', debounce(() => {
                runAnalysis();
            }, 300));

            // Withdrawal Rate Lever
            const rateSlider = document.getElementById('db-withdraw-rate');
            rateSlider.addEventListener('input', () => {
                const rate = parseFloat(rateSlider.value);
                document.getElementById('db-withdraw-rate-val').textContent = rate.toFixed(1) + '%';
                
                if (window.currentAnalysis) {
                    const portfolio = window.currentAnalysis.monte_carlo.starting_portfolio;
                    // Calculate required spending
                    // Need = Portfolio * (Rate / 100)
                    const need = portfolio * (rate / 100);
                    
                    // We need to know Guaranteed Income to get Total Spending
                    // Guaranteed = Old Spending - Old Need
                    const oldSpending = parseFloat(document.getElementById('expenses').value); // Current form value (before this drag?)
                    const oldNeed = window.currentAnalysis.monte_carlo.annual_withdrawal_need;
                    
                    // Warning: If we dragged spending previously without running analysis, oldNeed is stale.
                    // But usually we run analysis on change.
                    // Let's approximate guaranteed income from the last run results
                    // Guaranteed = (Target Annual Income used in analysis) - Old Need
                    // We can reconstruct Target from the analysis input, or just rely on 'expenses' input if it hasn't drifted too far.
                    // Let's use: Guaranteed = (Current Profile Spending) - Old Need
                    // Wait, Current Profile Spending might be equal to OldSpending if we just loaded.
                    
                    // Better approach: Calculate Guaranteed from profile inputs directly
                    // This duplicates logic but is safer.
                    // Actually, simpler:
                    // Annual Withdrawal Need = Total Spending - Guaranteed
                    // So Guaranteed = Total Spending - Annual Withdrawal Need
                    // Since 'Total Spending' was the input to the simulation that produced 'Annual Withdrawal Need', 
                    // we can use the values from `window.currentAnalysis` if we saved inputs there.
                    // We didn't save inputs explicitly in `currentAnalysis` root, but `annual_withdrawal_need` is there.
                    // Let's assume the `expenses` input hasn't changed since last run OR `runAnalysis` updates quickly.
                    
                    // Let's assume Guaranteed Income is constant (it is).
                    // Guaranteed = (Current Spending Input) - (Last Analysis Need) ?? No, that's circular if we changed spending.
                    
                    // Let's calculate guaranteed from the previous analysis snapshot:
                    // We know `withdrawalRate` = Need / Portfolio.
                    // So `Need` = Portfolio * (Rate/100).
                    // `Spending` = `Need` + `Guaranteed`.
                    // We need `Guaranteed`.
                    // From last run: `Guaranteed` = `Profile.target_annual_income` - `results.monte_carlo.annual_withdrawal_need`.
                    
                    // But we don't have easy access to the profile used for `currentAnalysis`.
                    // Let's use `guaranteed_income` from results if available?
                    // We added `guaranteed_income` to JSON response in app.py! 
                    // It is `person1.social_security * 12 + person2...`. 
                    // Wait, `guaranteed_income` in JSON is static SS. 
                    // `annual_withdrawal_need` accounts for pension too.
                    
                    // Let's rely on: Spending = (Portfolio * Rate) + (Spending - Need) [from last run]
                    // Guaranteed = Previous_Spending - Previous_Need.
                    // But `Previous_Spending` is tricky.
                    
                    // Let's just use the `guaranteed_income` + `pension` from the form as a rough estimate for the live slider?
                    // No, simpler:
                    // Annual Need = Portfolio * Rate%
                    // Spending = Annual Need + Guaranteed
                    // Guaranteed = (Previous Analysis Need) / (Previous Rate) ... no.
                    
                    // Let's use the helper: Guaranteed = Total_Spending - Need.
                    // We can get Total_Spending from the `expenses` input (assuming it was sync'd).
                    // But if we are dragging the rate slider, we want to update the expenses input.
                    
                    // Best way: 
                    // 1. Calculate `current_guaranteed` = (Current Expenses Value) - (Last Analysis Need).
                    //    (This assumes the current expenses value corresponds to the last analysis need).
                    //    If the user moved the spending slider, runAnalysis triggers. So usually they correspond.
                    // 2. New Need = Portfolio * New Rate.
                    // 3. New Spending = New Need + current_guaranteed.
                    
                    const lastNeed = window.currentAnalysis.monte_carlo.annual_withdrawal_need;
                    // We need the spending that generated this need.
                    // Let's approximate: Guaranteed = (Current Form Expenses) - lastNeed.
                    // If the user hasn't touched expenses since last run, this is correct.
                    // If they have, `expenses` is new, but `lastNeed` is old. Mismatch.
                    
                    // To fix this, we should store `last_spending_input` with the analysis results.
                    // But we don't have that yet.
                    
                    // Fallback: Re-calculate guaranteed from form inputs (SS + Pension).
                    const p1ss = parseFloat(document.getElementById('p1-ss').value) || 0;
                    const p2ss = parseFloat(document.getElementById('p2-ss').value) || 0;
                    const pen = parseFloat(document.getElementById('pension-annual').value) || 0;
                    // Plus income streams?
                    // This is getting complex to replicate frontend.
                    
                    // HACK: Use `window.currentAnalysis.monte_carlo.annual_withdrawal_need` and the *current calculated rate* to find guaranteed.
                    // Current Rate = Need / Portfolio.
                    // Guaranteed = Spending - Need.
                    // This assumes we know Spending.
                    
                    // Let's just use the `guaranteed_income` from the analysis result (sum of SS) + pension from form.
                    // It's an estimate for the slider UI. The actual `runAnalysis` will be precise.
                    const approxGuaranteed = (window.currentAnalysis.guaranteed_income || 0) + (parseFloat(document.getElementById('pension-annual').value) || 0);
                    
                    const newNeed = portfolio * (rate / 100);
                    const newSpending = Math.round(newNeed + approxGuaranteed);
                    
                    // Update Spending Slider/Input
                    document.getElementById('db-spending').value = newSpending;
                    document.getElementById('db-spending-val').textContent = '$' + newSpending.toLocaleString();
                    document.getElementById('expenses').value = newSpending;
                }
            });
            rateSlider.addEventListener('change', debounce(() => {
                runAnalysis();
            }, 300));

            // Retirement Month Lever
            const retireMonthInput = document.getElementById('db-retire-month');
            retireMonthInput.addEventListener('input', () => {
                const monthValue = retireMonthInput.value; // Format: "YYYY-MM"
                // Update main form with first day of selected month
                const newDate = `${monthValue}-01`;
                document.getElementById('p1-retire').value = newDate;
            });
            retireMonthInput.addEventListener('change', debounce(() => {
                runAnalysis();
            }, 300));

            // Retirement Month Lever (Person 2)
            const retireMonthInputP2 = document.getElementById('db-retire-month-p2');
            retireMonthInputP2.addEventListener('input', () => {
                const monthValue = retireMonthInputP2.value; // Format: "YYYY-MM"
                // Update main form with first day of selected month
                const newDate = `${monthValue}-01`;
                document.getElementById('p2-retire').value = newDate;
            });
            retireMonthInputP2.addEventListener('change', debounce(() => {
                runAnalysis();
            }, 300));

            // Allocation Lever
            const allocSlider = document.getElementById('db-allocation');
            allocSlider.addEventListener('input', () => {
                const val = allocSlider.value;
                document.getElementById('db-allocation-val').textContent = val + '%';
                // Update main form sliders
                document.getElementById('stocks-slider').value = val;
                // Trigger existing update logic
                updateSliderDisplay(document.getElementById('stocks-slider'));
            });
                        allocSlider.addEventListener('change', debounce(() => {
                            runAnalysis();
                        }, 300));
            
                        // Tax Rate Lever
                        const taxSlider = document.getElementById('db-tax-rate');
                        taxSlider.addEventListener('input', () => {
                            const val = taxSlider.value;
                            document.getElementById('db-tax-rate-val').textContent = val + '%';
                        });
                        taxSlider.addEventListener('change', debounce(() => {
                            runAnalysis();
                        }, 300));
            
                        // Target Success Rate Lever
            
        }
        
        // --- Action Item Wizard ---
        let wizardItems = [];
        let currentWizardIndex = 0;

        async function startWizard() {
            // Reload latest items first
            await loadActionItems(true); // pass true to suppress render, we just want data
            
            // Filter for pending items sorted by priority
            const priorityOrder = { 'critical': 0, 'high': 1, 'medium': 2, 'low': 3 };
            wizardItems = window.currentActionItems
                .filter(i => i.status === 'pending')
                .sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

            if (wizardItems.length === 0) {
                alert("üéâ All action items are complete! Great job!");
                return;
            }

            currentWizardIndex = 0;
            document.getElementById('wizard-modal').classList.add('active');
            renderWizardStep();
        }

        function closeWizard() {
            document.getElementById('wizard-modal').classList.remove('active');
            loadActionItems(); // Refresh main list
        }

        function renderWizardStep() {
            const item = wizardItems[currentWizardIndex];
            const body = document.getElementById('wizard-body');
            const total = wizardItems.length;
            
            document.getElementById('wizard-progress').textContent = `Task ${currentWizardIndex + 1} of ${total}`;
            
            // Priority Badge Color
            const pColors = { 'critical': '#e74c3c', 'high': '#e67e22', 'medium': '#f39c12', 'low': '#3498db' };
            const pColor = pColors[item.priority] || '#95a5a6';

            // Subtasks HTML
            let subtasksHtml = '';
            if (!item.subtasks || item.subtasks.length === 0) {
                subtasksHtml = `
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 8px; margin-top: 20px;">
                        <p style="color: var(--text-secondary); margin-bottom: 10px;">No subtasks defined.</p>
                        <button class="secondary" onclick="generateSubtasks(${item.id})" style="font-size: 13px;">ü™Ñ Use AI to Breakdown Task</button>
                    </div>
                `;
            } else {
                subtasksHtml = '<ul style="list-style: none; margin-top: 20px;">';
                item.subtasks.forEach((sub, idx) => {
                    subtasksHtml += `
                        <li style="background: var(--bg-secondary); padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${sub.completed ? 'checked' : ''} onchange="toggleSubtask(${item.id}, ${idx})" style="width: 18px; height: 18px;">
                            <span style="${sub.completed ? 'text-decoration: line-through; color: var(--text-light);' : ''}">${sub.text}</span>
                        </li>
                    `;
                });
                subtasksHtml += '</ul>';
            }

            const html = `
                <div style="margin-bottom: 20px;">
                    <span style="background: ${pColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase;">${item.priority}</span>
                    <span style="color: var(--text-secondary); font-size: 13px; margin-left: 10px;">${item.category}</span>
                </div>
                
                <h3 style="font-size: 24px; margin-bottom: 15px; color: var(--text-primary);">${item.description}</h3>
                
                ${item.due_date ? `<div style="margin-bottom: 20px; font-size: 14px; color: #e74c3c;">üìÖ Due: ${new Date(item.due_date).toLocaleDateString()}</div>` : ''}
                
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; flex: 1;">
                    <h4 style="margin-bottom: 15px; font-size: 16px;">Action Plan</h4>
                    ${subtasksHtml}
                </div>
            `;

            body.innerHTML = html;

            // Smart Apply Logic for Artifacts
            const assistContainer = document.createElement('div');
            assistContainer.style.marginTop = '20px';
            
            if (item.action_data) {
                const dataStr = JSON.stringify(item.action_data).replace(/"/g, '&quot;');
                assistContainer.innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; border: 1px solid #3498db; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #2980b9;">‚ö° Smart Apply Available</strong>
                            <p style="font-size: 13px; margin-top: 5px;">The system can automatically update your profile to implement this recommendation.</p>
                        </div>
                        <button onclick="applyActionUpdate(${item.id}, ${dataStr})" style="background: #3498db; white-space: nowrap;">Implement Now</button>
                    </div>
                `;
            }
            body.appendChild(assistContainer);

            // Button States
            document.getElementById('wizard-complete-btn').style.display = 'inline-block';
            document.getElementById('wizard-ai-assist-btn').style.display = 'inline-block';
        }

        function wizardNext() {
            if (currentWizardIndex < wizardItems.length - 1) {
                currentWizardIndex++;
                renderWizardStep();
            } else {
                closeWizard();
            }
        }

        function wizardPrev() {
            if (currentWizardIndex > 0) {
                currentWizardIndex--;
                renderWizardStep();
            }
        }

        async function wizardMarkComplete() {
            const item = wizardItems[currentWizardIndex];
            if (confirm('Mark this task as complete?')) {
                await toggleActionStatus(item.id, 'pending'); // flips to completed
                // Remove from wizard array
                wizardItems.splice(currentWizardIndex, 1);
                
                if (wizardItems.length === 0) {
                    alert("üéâ All pending tasks completed!");
                    closeWizard();
                } else {
                    if (currentWizardIndex >= wizardItems.length) {
                        currentWizardIndex = wizardItems.length - 1;
                    }
                    renderWizardStep();
                }
            }
        }

        async function generateSubtasks(itemId) {
            const item = wizardItems.find(i => i.id === itemId);
            if (!item) return;

            const bodyDiv = document.getElementById('wizard-body');
            const originalContent = bodyDiv.innerHTML;
            bodyDiv.innerHTML += '<div class="loading" style="position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center;">ü§ñ Generating subtasks...</div>';

            try {
                const prompt = `Break down this financial task into 3-5 specific, actionable sub-steps (checklist).
                Task: "${item.description}"
                Category: "${item.category}"

                Return ONLY a JSON array of strings. Example: ["Step 1", "Step 2"]`;

                const response = await fetch(`${API_URL}/advisor/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: prompt,
                        include_context: false
                    })
                });

                const data = await response.json();
                let steps = [];
                try {
                    const jsonText = data.response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    steps = JSON.parse(jsonText);
                } catch (e) {
                    steps = data.response.split('\n').filter(l => l.trim().length > 0).map(l => l.replace(/^- /, '').replace(/^\d+\. /, ''));
                }

                // Format as subtask objects
                const subtasks = steps.map(s => ({ text: s, completed: false }));
                
                // Save to backend
                await fetch(`${API_URL}/action-items`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: itemId, subtasks: subtasks })
                });

                // Update local model
                item.subtasks = subtasks;
                renderWizardStep();

            } catch (error) {
                alert('Error generating subtasks: ' + error.message);
                bodyDiv.innerHTML = originalContent;
            }
        }

        async function toggleSubtask(itemId, subtaskIndex) {
            const item = wizardItems.find(i => i.id === itemId);
            if (!item) return;

            item.subtasks[subtaskIndex].completed = !item.subtasks[subtaskIndex].completed;
            
            // Save to backend (silent update)
            await fetch(`${API_URL}/action-items`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: itemId, subtasks: item.subtasks })
            });
            
            renderWizardStep(); // Re-render to show strikethrough
        }

        async function wizardAIAssist() {
            const item = wizardItems[currentWizardIndex];
            const prompt = `I need help with this task: "${item.description}". 
            Category: ${item.category}.
            Can you provide a brief guide or explanation on how to get started?`;
            
            // Switch to Advisor tab and populate chat
            closeWizard();
            showTab('advisor');
            document.getElementById('chat-input').value = prompt;
            // Optionally auto-send: sendMessage(); 
        }

        // --- End Wizard Functions ---

        async function loadActionItems(suppressRender = false) {
            try {
                const profileName = getCurrentProfileName();
                const response = await fetch(`${API_URL}/action-items?profile_name=${encodeURIComponent(profileName)}`);
                const items = await response.json();
                
                // Store globally for wizard access
                window.currentActionItems = items;

                // Update Dashboard Widget
                updateCriticalActionsWidget(items);

                if (suppressRender) return;
                
                const total = items.length;
                const completed = items.filter(i => i.status === 'completed').length;
                const progressPct = total > 0 ? (completed / total) * 100 : 0;

                const progressHtml = `
                    <div style="margin-bottom: 20px; background: var(--bg-tertiary); padding: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: 600;">
                            <span>Progress</span>
                            <span>${completed} of ${total} completed</span>
                        </div>
                        <div style="height: 10px; background: #ddd; border-radius: 5px; overflow: hidden;">
                            <div style="height: 100%; width: ${progressPct}%; background: #27ae60; transition: width 0.5s;"></div>
                        </div>
                    </div>
                `;

                const html = items.map(item => {
                    // Check if description already has a link
                    let actionLink = '';
                    if (!item.description.includes('<a href')) {
                        const query = encodeURIComponent(`${item.category} ${item.description} guide`);
                        actionLink = ` <a href="https://www.google.com/search?q=${query}" target="_blank" style="color: #3498db; text-decoration: none; font-size: 12px; border: 1px solid #3498db; padding: 2px 6px; border-radius: 4px; margin-left: 5px;">Search Guide ‚Üó</a>`;
                    }

                    const isCompleted = item.status === 'completed';
                    const itemStyle = isCompleted ? 'opacity: 0.6; background: var(--bg-tertiary); border-left-color: #bdc3c7;' : '';
                    const descStyle = isCompleted ? 'text-decoration: line-through; color: var(--text-secondary);' : '';

                    // Smart Apply Button
                    let applyBtn = '';
                    if (item.action_data && !isCompleted) {
                        const dataStr = JSON.stringify(item.action_data).replace(/"/g, '&quot;');
                        applyBtn = `
                            <button onclick="applyActionUpdate(${item.id}, ${dataStr})" 
                                    style="padding: 4px 10px; font-size: 12px; margin-left: 10px; background: #9b59b6;">
                                ‚ö° Apply Update
                            </button>
                        `;
                    }

                    return `
                    <li class="action-item ${item.priority}" style="${itemStyle} display: flex; gap: 15px; align-items: start;">
                        <div style="padding-top: 5px;">
                            <input type="checkbox" 
                                   ${isCompleted ? 'checked' : ''} 
                                   onchange="toggleActionStatus(${item.id}, '${item.status}')"
                                   style="width: 18px; height: 18px; cursor: pointer;">
                        </div>
                        <div style="flex: 1;">
                            <div class="action-item-header">
                                <span class="action-item-category">${item.category}</span>
                                <span class="action-item-priority priority-${item.priority}">${item.priority}</span>
                            </div>
                            <div style="${descStyle}">${item.description}${actionLink}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Due: ${item.due_date ? new Date(item.due_date).toLocaleDateString() : 'No date'}
                                ${applyBtn}
                            </div>
                        </div>
                    </li>
                `}).join('');
                
                document.getElementById('action-items-list').innerHTML = progressHtml + (html || '<div class="loading">No action items</div>');
            } catch (error) {
                document.getElementById('action-items-list').innerHTML = '<div class="loading">Error loading items: ' + error.message + '</div>';
            }
        }

        function updateCriticalActionsWidget(items) {
            const widget = document.getElementById('critical-actions-widget');
            if (!widget) return;

            const criticalItems = items.filter(i => i.status === 'pending' && (i.priority === 'critical' || i.priority === 'high'));
            
            if (criticalItems.length > 0) {
                widget.style.display = 'block';
                document.getElementById('critical-actions-count').textContent = `You have ${criticalItems.length} urgent tasks pending that require your attention.`;
            } else {
                widget.style.display = 'none';
            }
        }

        async function toggleActionStatus(id, currentStatus) {
            const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
            try {
                await fetch(`${API_URL}/action-items`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: id, status: newStatus })
                });
                loadActionItems();
            } catch (error) {
                alert('Error updating status');
            }
        }

        async function applyActionUpdate(id, data) {
            if (!confirm(`This will update your profile settings:\n\nField: ${data.field}\nValue: ${data.value}\n\nProceed?`)) return;

            try {
                // Map fields to DOM IDs
                const fieldMap = {
                    'target_annual_income': 'target-income',
                    'annual_expenses': 'expenses',
                    'risk_tolerance': 'risk',
                    'pension_annual': 'pension-annual',
                    'stock_allocation': 'stocks-slider',
                    'social_security_p1': 'p1-ss',
                    'social_security_p2': 'p2-ss'
                };

                // Update Profile Form
                if (fieldMap[data.field]) {
                    const el = document.getElementById(fieldMap[data.field]);
                    if (el) {
                        el.value = data.value;
                        // Trigger change events if needed (e.g. for sliders)
                        if (el.type === 'range') {
                            updateSliderDisplay(el);
                            updateAllocationBars();
                        }
                    }
                } else if (data.field === 'retirement_date_p1') {
                    document.getElementById('p1-retire').value = data.value;
                } else if (data.field === 'retirement_date_p2') {
                    document.getElementById('p2-retire').value = data.value;
                }

                // Save Profile
                await saveCurrentProfile();

                // Mark Item as Completed
                await toggleActionStatus(id, 'pending'); // Will flip to completed

                alert('‚úÖ Profile updated and action item marked as complete!');
                
            } catch (error) {
                alert('Error applying update: ' + error.message);
            }
        }
        
        async function cleanupActionItems() {
            try {
                const response = await fetch(`${API_URL}/action-items/cleanup`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`Cleanup complete! Removed ${result.removed_count} duplicate items.`);
                    loadActionItems();
                } else {
                    alert('Cleanup failed: ' + result.error);
                }
            } catch (error) {
                alert('Request failed: ' + error.message);
            }
        }

        async function generateActionItems() {
            if (!window.currentAnalysis) {
                alert('Please run analysis first');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/generate-action-items`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        analysis: window.currentAnalysis,
                        profile_name: getCurrentProfileName()
                    })
                });

                const result = await response.json();
                loadActionItems();
            } catch (error) {
                alert('Error generating items: ' + error.message);
            }
        }

        async function runSelfAssessment() {
            const provider = localStorage.getItem('default_llm') || 'gemini';

            // Visual feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "Analyzing...";
            btn.disabled = true;

            const currentProfile = getCurrentProfileName();

            try {
                const response = await fetch(`${API_URL}/perform-self-assessment`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        profile_name: currentProfile,
                        profile_data: getFormData(),
                        llm_provider: provider
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`AI Assessment Complete!\n\nAdded ${result.items_created} new strategic tasks based on the Skills library.`);
                    loadActionItems();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // AI Advisor functions
        function checkApiKey() {
            const provider = localStorage.getItem('default_llm') || 'gemini';

            // API keys are now configured via environment variables on the backend
            // We always show the status as configured since we can't check env vars from the frontend
            document.getElementById('api-key-notice').style.display = 'none';
            document.getElementById('api-key-status').style.display = 'block';

            // Update indicator
            const indicator = document.getElementById('current-llm-name');
            if (indicator) {
                indicator.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
            }

            return true; // Return true since keys are checked on backend
        }

        function applySettings(settings) {
            // Apply theme
            if (settings.theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }

            // Apply compact mode
            if (settings.compactMode) {
                document.body.classList.add('compact-mode');
            } else {
                document.body.classList.remove('compact-mode');
            }

            // Apply font size
            document.body.classList.remove('font-small', 'font-medium', 'font-large');
            document.body.classList.add('font-' + settings.fontSize);

            // Apply animations
            if (!settings.animations) {
                document.body.classList.add('no-animations');
            } else {
                document.body.classList.remove('no-animations');
            }

            // Update LLM indicator
            const provider = settings.defaultLLM || 'gemini';
            localStorage.setItem('default_llm', provider);
            checkApiKey();

            // Update header with user name
            const headerTitle = document.querySelector('header h1');
            if (settings.userName && settings.userName !== 'User') {
                document.querySelector('.subtitle').textContent = `${settings.userName}'s Financial Planning Dashboard`;
            } else {
                document.querySelector('.subtitle').textContent = 'Comprehensive financial, tax, estate, and legacy planning';
            }
        }


        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            const provider = localStorage.getItem('default_llm') || 'gemini';

            // Disable input while processing
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            input.disabled = true;

            // Add user message to chat
            addMessageToChat('user', message);
            input.value = '';

            const currentProfile = getCurrentProfileName();

            try {
                const response = await fetch(`${API_URL}/advisor/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: message,
                        include_context: true,
                        profile_name: currentProfile,
                        profile_data: getFormData(),
                        llm_provider: provider
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessageToChat('assistant', data.response, data.action_data);
                } else {
                    addMessageToChat('error', data.error || 'An error occurred');
                }
            } catch (error) {
                addMessageToChat('error', 'Error: ' + error.message);
            } finally {
                // Re-enable input
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                input.disabled = false;
                input.focus();
            }
        }

        function addMessageToChat(role, content, actionData = null) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            // Convert markdown-style formatting to HTML
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            messageDiv.innerHTML = formattedContent;

            // If action_data is present, add action buttons
            if (actionData && role === 'assistant') {
                const actionsDiv = document.createElement('div');
                actionsDiv.style.marginTop = '15px';
                actionsDiv.style.padding = '15px';
                actionsDiv.style.background = '#f0f9ff';
                actionsDiv.style.borderLeft = '4px solid #3498db';
                actionsDiv.style.borderRadius = '4px';

                const actionsHeader = document.createElement('div');
                actionsHeader.innerHTML = '<strong>‚ö° AI Recommendations Available</strong>';
                actionsHeader.style.marginBottom = '10px';
                actionsDiv.appendChild(actionsHeader);

                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.gap = '10px';
                buttonContainer.style.flexWrap = 'wrap';

                // Apply to Current Profile button
                const applyBtn = document.createElement('button');
                applyBtn.textContent = '‚úì Apply to Current Profile';
                applyBtn.style.padding = '8px 16px';
                applyBtn.style.background = '#2ecc71';
                applyBtn.style.color = 'white';
                applyBtn.style.border = 'none';
                applyBtn.style.borderRadius = '4px';
                applyBtn.style.cursor = 'pointer';
                applyBtn.style.fontSize = '13px';
                applyBtn.onclick = () => applyActionData(actionData);
                buttonContainer.appendChild(applyBtn);

                // Save as Optimized Profile button
                const saveOptimizedBtn = document.createElement('button');
                saveOptimizedBtn.textContent = 'üíæ Save as Optimized Profile';
                saveOptimizedBtn.style.padding = '8px 16px';
                saveOptimizedBtn.style.background = '#3498db';
                saveOptimizedBtn.style.color = 'white';
                saveOptimizedBtn.style.border = 'none';
                saveOptimizedBtn.style.borderRadius = '4px';
                saveOptimizedBtn.style.cursor = 'pointer';
                saveOptimizedBtn.style.fontSize = '13px';
                saveOptimizedBtn.onclick = () => saveAsOptimizedProfile(actionData);
                buttonContainer.appendChild(saveOptimizedBtn);

                actionsDiv.appendChild(buttonContainer);
                messageDiv.appendChild(actionsDiv);
            }

            messagesDiv.appendChild(messageDiv);

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function applyActionData(actionData) {
            if (!actionData) return;

            // Apply recommendations to current profile
            if (actionData.retirement_date_p1) {
                document.getElementById('p1-retire').value = actionData.retirement_date_p1;
            }
            if (actionData.retirement_date_p2) {
                document.getElementById('p2-retire').value = actionData.retirement_date_p2;
            }
            if (actionData.stock_allocation !== undefined) {
                const stockSlider = document.getElementById('stock-allocation');
                if (stockSlider) {
                    stockSlider.value = actionData.stock_allocation;
                    // Trigger the update display if there's an onchange handler
                    stockSlider.dispatchEvent(new Event('input'));
                }
            }
            if (actionData.target_annual_income !== undefined) {
                const incomeInput = document.getElementById('target-income');
                if (incomeInput) {
                    incomeInput.value = actionData.target_annual_income;
                }
            }
            if (actionData.annual_expenses !== undefined) {
                const expensesInput = document.getElementById('annual-expenses');
                if (expensesInput) {
                    expensesInput.value = actionData.annual_expenses;
                }
            }
            if (actionData.p1_ss_monthly !== undefined) {
                const p1SSInput = document.getElementById('p1-ss');
                if (p1SSInput) {
                    p1SSInput.value = actionData.p1_ss_monthly;
                }
            }
            if (actionData.p2_ss_monthly !== undefined) {
                const p2SSInput = document.getElementById('p2-ss');
                if (p2SSInput) {
                    p2SSInput.value = actionData.p2_ss_monthly;
                }
            }

            // Auto-save the changes
            debouncedAutoSave();

            // Show confirmation and switch to profile tab
            showNotification('‚úÖ AI recommendations applied to current profile!', 'success');
            showTab('profile');
        }

        async function saveAsOptimizedProfile(actionData) {
            if (!actionData) return;

            const currentProfileName = getCurrentProfileName();
            const newProfileName = prompt('Enter name for optimized profile:', `${currentProfileName} (Optimized)`);

            if (!newProfileName) return;

            try {
                // Get current profile data
                const currentData = getFormData();

                // Apply action_data recommendations to the data
                if (actionData.retirement_date_p1) {
                    currentData.person1.retirement_date = actionData.retirement_date_p1;
                }
                if (actionData.retirement_date_p2) {
                    currentData.person2.retirement_date = actionData.retirement_date_p2;
                }
                if (actionData.stock_allocation !== undefined) {
                    currentData.market_assumptions.stock_allocation = actionData.stock_allocation;
                }
                if (actionData.target_annual_income !== undefined) {
                    currentData.target_annual_income = actionData.target_annual_income;
                }
                if (actionData.annual_expenses !== undefined) {
                    currentData.annual_expenses = actionData.annual_expenses;
                }
                if (actionData.p1_ss_monthly !== undefined) {
                    currentData.person1.social_security = actionData.p1_ss_monthly;
                }
                if (actionData.p2_ss_monthly !== undefined) {
                    currentData.person2.social_security = actionData.p2_ss_monthly;
                }

                // Save as new profile
                const response = await fetch(`${API_URL}/profile/${encodeURIComponent(newProfileName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentData)
                });

                if (response.ok) {
                    showNotification(`‚úÖ Optimized profile "${newProfileName}" created successfully!`, 'success');
                    await refreshProfilesList();
                    await loadProfile(newProfileName);
                } else {
                    const error = await response.json();
                    showNotification('‚ùå Error creating optimized profile: ' + (error.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }

        function handleChatKeypress(event) {
            // Send message on Enter (but allow Shift+Enter for new line)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function clearConversation() {
            if (!confirm('Are you sure you want to clear the conversation history?')) {
                return;
            }

            try {
                const profileName = getCurrentProfileName();
                await fetch(`${API_URL}/advisor/clear?profile_name=${encodeURIComponent(profileName)}`, {
                    method: 'POST'
                });

                document.getElementById('chat-messages').innerHTML = '';
            } catch (error) {
                alert('Error clearing conversation: ' + error.message);
            }
        }

        async function loadConversationHistory() {
            try {
                const profileName = getCurrentProfileName();
                const response = await fetch(`${API_URL}/advisor/history?profile_name=${encodeURIComponent(profileName)}`);
                const history = await response.json();

                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = '';
                
                history.forEach(msg => {
                    addMessageToChat(msg.role === 'user' ? 'user' : 'assistant', msg.content);
                });
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Slider helper functions
        function toggleAdvanced() {
            const advancedParams = document.getElementById('advanced-parameters');
            const button = event.target;
            if (advancedParams.classList.contains('show')) {
                advancedParams.classList.remove('show');
                button.textContent = 'Show Advanced Parameters';
            } else {
                advancedParams.classList.add('show');
                button.textContent = 'Hide Advanced Parameters';
            }
        }

        function applyMarketPreset() {
            const preset = document.getElementById('market-profile-preset').value;

            if (preset === 'custom') {
                // Don't change anything, let user manually adjust
                return;
            }

            // Define preset configurations based on historical market data
            const presets = {
                // Standard Portfolios
                'conservative': {
                    stock_allocation: 60,
                    stock_return: 9.5,
                    stock_volatility: 15,
                    bond_return: 4.5,
                    bond_volatility: 5,
                    inflation: 2.5,
                    description: 'Conservative 60/40 balanced portfolio'
                },
                'sp500': {
                    stock_allocation: 80,
                    stock_return: 10.0,      // Historical S&P 500 average ~10%
                    stock_volatility: 18,    // Historical S&P 500 volatility
                    bond_return: 4.0,
                    bond_volatility: 6,
                    inflation: 3.0,
                    description: 'S&P 500 historical performance'
                },
                'aggressive': {
                    stock_allocation: 90,
                    stock_return: 11.0,
                    stock_volatility: 20,
                    bond_return: 4.0,
                    bond_volatility: 6,
                    inflation: 3.0,
                    description: 'Aggressive Growth portfolio'
                },

                // Sector Focus
                'growth': {
                    stock_allocation: 90,
                    stock_return: 12.0,      // Growth/tech sector average
                    stock_volatility: 22,    // Higher volatility for tech
                    bond_return: 4.0,
                    bond_volatility: 6,
                    inflation: 3.0,
                    description: 'Growth and technology sector focus'
                },
                'tech-aggressive': {
                    stock_allocation: 95,
                    stock_return: 15.0,      // Aggressive tech/AI sector
                    stock_volatility: 28,    // High volatility for emerging tech
                    bond_return: 4.0,
                    bond_volatility: 6,
                    inflation: 3.0,
                    description: 'Aggressive tech/AI sector with high growth potential'
                },
                'healthcare': {
                    stock_allocation: 85,
                    stock_return: 11.5,      // Healthcare historically stable growth
                    stock_volatility: 16,    // Moderate volatility
                    bond_return: 4.0,
                    bond_volatility: 6,
                    inflation: 3.0,
                    description: 'Healthcare sector focus with defensive characteristics'
                },
                'financials': {
                    stock_allocation: 85,
                    stock_return: 10.5,      // Financial sector average
                    stock_volatility: 23,    // High volatility, sensitive to rates
                    bond_return: 4.0,
                    bond_volatility: 6,
                    inflation: 3.0,
                    description: 'Financial sector exposure with cyclical sensitivity'
                },
                'energy': {
                    stock_allocation: 80,
                    stock_return: 9.0,       // Energy sector volatile returns
                    stock_volatility: 25,    // Very high volatility
                    bond_return: 4.0,
                    bond_volatility: 6,
                    inflation: 3.5,          // Energy correlates with inflation
                    description: 'Energy sector with commodity exposure'
                },

                // Income & Stability
                'dividend': {
                    stock_allocation: 75,
                    stock_return: 9.0,       // Dividend aristocrats lower growth
                    stock_volatility: 14,    // Low volatility blue chips
                    bond_return: 4.5,
                    bond_volatility: 5,
                    inflation: 2.5,
                    description: 'Dividend Aristocrats for income stability'
                },
                'bonds-heavy': {
                    stock_allocation: 30,    // Only 30% stocks
                    stock_return: 10.0,
                    stock_volatility: 18,
                    bond_return: 4.5,
                    bond_volatility: 5,
                    inflation: 2.5,
                    description: 'Bond Heavy 30/70 portfolio for capital preservation'
                },
                'retirement-glide': {
                    stock_allocation: 50,    // Balanced for retirees
                    stock_return: 10.0,
                    stock_volatility: 15,
                    bond_return: 4.0,
                    bond_volatility: 5,
                    inflation: 2.5,
                    description: 'Retirement Glide Path balanced allocation'
                },

                // Global & Alternative
                'emerging': {
                    stock_allocation: 90,
                    stock_return: 13.0,      // Higher growth potential
                    stock_volatility: 26,    // Very high volatility
                    bond_return: 5.0,        // Emerging market bonds yield more
                    bond_volatility: 8,
                    inflation: 4.0,          // Higher inflation in emerging markets
                    description: 'Emerging Markets with high growth potential'
                },
                'international': {
                    stock_allocation: 85,
                    stock_return: 9.5,       // Slightly lower than US
                    stock_volatility: 19,    // Similar to US
                    bond_return: 3.5,        // Lower yields internationally
                    bond_volatility: 7,
                    inflation: 2.5,
                    description: 'International Diversified portfolio'
                },
                'gold-hedge': {
                    stock_allocation: 70,    // Mixed with commodities
                    stock_return: 8.0,       // Lower returns with hedge
                    stock_volatility: 16,    // Reduced by gold hedge
                    bond_return: 4.0,
                    bond_volatility: 6,
                    inflation: 2.0,          // Gold hedges inflation
                    description: 'Inflation Hedge with gold/commodities'
                },
                'real-estate': {
                    stock_allocation: 85,
                    stock_return: 10.0,      // REITs historical average
                    stock_volatility: 20,    // Moderate-high volatility
                    bond_return: 4.0,
                    bond_volatility: 6,
                    inflation: 3.0,
                    description: 'REIT Focus for real estate exposure'
                },

                // Bear/Crisis Scenarios
                'bear-market': {
                    stock_allocation: 80,
                    stock_return: -5.0,      // Negative returns in bear market
                    stock_volatility: 25,    // High volatility during decline
                    bond_return: 3.5,        // Flight to safety
                    bond_volatility: 5,
                    inflation: 2.0,
                    description: 'Bear Market conditions (-20% to -40% decline)'
                },
                'recession': {
                    stock_allocation: 70,
                    stock_return: 2.0,       // Low positive or flat returns
                    stock_volatility: 22,    // Elevated volatility
                    bond_return: 4.0,        // Bonds outperform
                    bond_volatility: 6,
                    inflation: 1.5,          // Low inflation in recession
                    description: 'Recession scenario with economic contraction'
                },
                'stagflation': {
                    stock_allocation: 70,
                    stock_return: 4.0,       // Low growth
                    stock_volatility: 20,
                    bond_return: 2.0,        // Real rates negative
                    bond_volatility: 8,      // Bond volatility high
                    inflation: 5.0,          // High inflation key feature
                    description: 'Stagflation with high inflation and low growth'
                },
                'crisis-2008': {
                    stock_allocation: 80,
                    stock_return: -22.0,     // S&P 500 lost 37% in 2008
                    stock_volatility: 35,    // Extreme volatility
                    bond_return: 5.0,        // Treasuries rallied
                    bond_volatility: 8,
                    inflation: 0.1,          // Near deflationary
                    description: '2008 Financial Crisis conditions'
                },

                // Bull/Optimistic Scenarios
                'bull-market': {
                    stock_allocation: 90,
                    stock_return: 18.0,      // Strong bull market gains
                    stock_volatility: 14,    // Lower vol in uptrend
                    bond_return: 3.5,
                    bond_volatility: 5,
                    inflation: 2.5,
                    description: 'Bull Market with sustained upward trend'
                },
                'post-covid': {
                    stock_allocation: 90,
                    stock_return: 16.0,      // 2020-2021 recovery
                    stock_volatility: 20,    // Still elevated
                    bond_return: 1.5,        // Near-zero rates
                    bond_volatility: 6,
                    inflation: 4.5,          // Supply chain inflation
                    description: 'Post-COVID Recovery conditions (2020-2021)'
                },
                'roaring-20s': {
                    stock_allocation: 90,
                    stock_return: 14.0,      // Strong sustained growth
                    stock_volatility: 16,
                    bond_return: 4.0,
                    bond_volatility: 6,
                    inflation: 3.0,
                    description: 'Roaring 20s style economic boom'
                },

                // Historical Periods
                'dotcom-boom': {
                    stock_allocation: 95,
                    stock_return: 25.0,      // Late 90s tech bubble gains
                    stock_volatility: 30,    // High volatility even in boom
                    bond_return: 5.5,        // Higher rates in late 90s
                    bond_volatility: 6,
                    inflation: 2.5,
                    description: 'Dot-com Boom (1997-1999) conditions'
                },
                'dotcom-bust': {
                    stock_allocation: 80,
                    stock_return: -15.0,     // 2000-2002 crash
                    stock_volatility: 32,    // Extreme volatility
                    bond_return: 6.0,        // Flight to quality
                    bond_volatility: 6,
                    inflation: 2.5,
                    description: 'Dot-com Bust (2000-2002) crash period'
                },
                'great-recession': {
                    stock_allocation: 80,
                    stock_return: -30.0,     // 2008-2009 losses
                    stock_volatility: 38,    // Unprecedented volatility
                    bond_return: 5.5,        // Treasuries soared
                    bond_volatility: 8,
                    inflation: -0.4,         // Deflationary
                    description: 'Great Recession (2008-2009) conditions'
                },
                'decade-2010s': {
                    stock_allocation: 85,
                    stock_return: 14.0,      // 2010-2019 bull run
                    stock_volatility: 15,    // Lower vol bull market
                    bond_return: 3.0,        // Low rate environment
                    bond_volatility: 5,
                    inflation: 1.8,          // Low inflation decade
                    description: '2010s Bull Run with low rates/inflation'
                }
            };

            const config = presets[preset];
            if (!config) return;

            // Apply the preset values to all sliders
            document.getElementById('stocks-slider').value = config.stock_allocation;
            document.getElementById('stock-return-slider').value = config.stock_return;
            document.getElementById('stock-volatility-slider').value = config.stock_volatility;
            document.getElementById('bond-return-slider').value = config.bond_return;
            document.getElementById('bond-volatility-slider').value = config.bond_volatility;
            document.getElementById('inflation-slider').value = config.inflation;

            // Update all displays
            updateSliderDisplay(document.getElementById('stocks-slider'));
            updateSliderDisplay(document.getElementById('stock-return-slider'));
            updateSliderDisplay(document.getElementById('stock-volatility-slider'));
            updateSliderDisplay(document.getElementById('bond-return-slider'));
            updateSliderDisplay(document.getElementById('bond-volatility-slider'));
            updateSliderDisplay(document.getElementById('inflation-slider'));

            // Show a notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #3498db;
                color: white;
                padding: 15px 20px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
            `;
            notification.textContent = `‚úì Applied ${config.description}`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function resetToDefaults() {
            document.getElementById('stocks-slider').value = 50;
            document.getElementById('stock-return-slider').value = 10;
            document.getElementById('bond-return-slider').value = 4;
            document.getElementById('inflation-slider').value = 3;
            document.getElementById('stock-volatility-slider').value = 18;
            document.getElementById('bond-volatility-slider').value = 6;
            document.getElementById('inflation-volatility-slider').value = 1;
            document.getElementById('ss-discount-slider').value = 3;

            // Update all displays
            updateSliderDisplay(document.getElementById('stocks-slider'));
            updateSliderDisplay(document.getElementById('stock-return-slider'));
            updateSliderDisplay(document.getElementById('bond-return-slider'));
            updateSliderDisplay(document.getElementById('inflation-slider'));
            updateSliderDisplay(document.getElementById('stock-volatility-slider'));
            updateSliderDisplay(document.getElementById('bond-volatility-slider'));
            updateSliderDisplay(document.getElementById('inflation-volatility-slider'));
            updateSliderDisplay(document.getElementById('ss-discount-slider'));
        }

        function updateSliderDisplay(slider) {
            const id = slider.id;
            const value = parseFloat(slider.value);

            if (id === 'stocks-slider') {
                document.getElementById('stocks-value').textContent = value.toFixed(0);
                document.getElementById('bonds-value').textContent = (100 - value).toFixed(0);
            } else if (id === 'stock-return-slider') {
                document.getElementById('stock-return-value').textContent = value.toFixed(2);
            } else if (id === 'bond-return-slider') {
                document.getElementById('bond-return-value').textContent = value.toFixed(2);
            } else if (id === 'inflation-slider') {
                document.getElementById('inflation-value').textContent = value.toFixed(2);
            } else if (id === 'stock-volatility-slider') {
                document.getElementById('stock-volatility-value').textContent = value.toFixed(2);
            } else if (id === 'bond-volatility-slider') {
                document.getElementById('bond-volatility-value').textContent = value.toFixed(2);
            } else if (id === 'inflation-volatility-slider') {
                document.getElementById('inflation-volatility-value').textContent = value.toFixed(2);
            } else if (id === 'ss-discount-slider') {
                document.getElementById('ss-discount-value').textContent = value.toFixed(2);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function attachSliderListeners() {
            const sliders = document.querySelectorAll('.scenario-parameters input[type="range"]');
            const marketSliders = ['stocks-slider', 'stock-return-slider', 'stock-volatility-slider',
                                  'bond-return-slider', 'bond-volatility-slider', 'inflation-slider'];

            sliders.forEach(slider => {
                // Update display on input (immediate feedback)
                slider.addEventListener('input', debounce(() => {
                    updateSliderDisplay(slider);
                }, 50));

                // If a market slider is manually changed, switch preset to "custom"
                if (marketSliders.includes(slider.id)) {
                    slider.addEventListener('input', () => {
                        const presetSelector = document.getElementById('market-profile-preset');
                        if (presetSelector && presetSelector.value !== 'custom') {
                            presetSelector.value = 'custom';
                        }
                    });
                }

                // Auto-run analysis on change if checkbox is checked
                slider.addEventListener('change', debounce(() => {
                    if (document.getElementById('auto-update-checkbox')?.checked) {
                        runAnalysis();
                    }
                }, 500));
            });
        }

        function attachAutoSaveListeners() {
            // Person 1 fields
            ['p1-name', 'p1-birth', 'p1-retire', 'p1-ss'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', debouncedAutoSave);
            });

            // Person 2 fields
            ['p2-name', 'p2-birth', 'p2-retire', 'p2-ss'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', debouncedAutoSave);
            });

            // Expenses
            const expenses = document.getElementById('expenses');
            if (expenses) expenses.addEventListener('input', debouncedAutoSave);

            // Market assumption sliders
            ['stocks-slider', 'stock-return-slider', 'stock-volatility-slider',
             'bond-return-slider', 'bond-volatility-slider', 'inflation-slider',
             'inflation-volatility-slider', 'ss-discount-slider', 'tax-rate-slider'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', debouncedAutoSave);
            });
        }

        // Check API key on load
        window.addEventListener('load', () => {
            checkApiKey();
            loadConversationHistory();
            attachDashboardListeners();
            attachSliderListeners();
            attachAutoSaveListeners();
            renderInvestmentTypes();
            fetchProfiles();
            refreshScenarios();
            updateIncomeOwnerLabels();
            initRetirementDateSelectors();

            // Update income owner dropdown labels when person names change
            document.getElementById('p1-name').addEventListener('input', updateIncomeOwnerLabels);
            document.getElementById('p2-name').addEventListener('input', () => {
                updateIncomeOwnerLabels();
                renderIncomeStreams(); // Also re-render table to show updated names
            });
            document.getElementById('p1-name').addEventListener('input', () => {
                renderIncomeStreams(); // Re-render table when person 1 name changes
            });
        });

        // loadProfile(); // Removed, user must select profile

        // ========================================
        // Settings Management
        // ========================================

        async function openSettings() {
            await loadSettings();
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        async function loadSettings() {
            const settings = getSettings();

            // Load theme
            document.getElementById('setting-theme').value = settings.theme;

            // Load compact mode
            document.getElementById('setting-compact').checked = settings.compactMode;

            // Load user name
            document.getElementById('setting-username').value = settings.userName;

            // Load font size
            document.getElementById('setting-fontsize').value = settings.fontSize;

            // Load auto-save
            document.getElementById('setting-autosave').checked = settings.autoSave;

            // Load animations
            document.getElementById('setting-animations').checked = settings.animations;

            // Load target success
            document.getElementById('setting-target-success').value = settings.targetSuccessRate || 90;

            // Load Monte Carlo simulations
            const simCount = settings.monteCarloSimulations || 10000;
            document.getElementById('setting-simulations').value = simCount;
            document.getElementById('sim-count-display').textContent = simCount.toLocaleString();

            // Load system settings from backend
            try {
                const response = await fetch(`${API_URL}/system/settings`);
                const sysSettings = await response.json();
                if (sysSettings.default_llm) {
                    document.getElementById('setting-default-llm').value = sysSettings.default_llm;
                    localStorage.setItem('default_llm', sysSettings.default_llm);
                }
            } catch (e) {
                console.error("Failed to load system settings", e);
            }

            // Load backup settings from backend
            try {
                const response = await fetch(`${API_URL}/backup/settings`);
                const backupSettings = await response.json();
                document.getElementById('setting-autobackup-enabled').checked = backupSettings.auto_backup_enabled || false;
                document.getElementById('setting-autobackup-interval').value = backupSettings.auto_backup_interval_hours || 24;

                // Display last backup time
                if (backupSettings.last_backup_time) {
                    const lastBackupDate = new Date(backupSettings.last_backup_time);
                    document.getElementById('last-backup-time').textContent =
                        `Last backup: ${lastBackupDate.toLocaleString()}`;
                } else {
                    document.getElementById('last-backup-time').textContent = 'No backups yet';
                }
            } catch (e) {
                console.error("Failed to load backup settings", e);
            }

            // Load backup list
            refreshBackupList();
        }

        function getSettings() {
            const defaults = {
                theme: 'light',
                compactMode: false,
                userName: 'User',
                fontSize: 'medium',
                autoSave: true,  // Auto-save enabled by default
                animations: true,
                defaultLLM: 'gemini',
                targetSuccessRate: 90,
                monteCarloSimulations: 10000
            };

            const stored = localStorage.getItem('app_settings');
            return stored ? { ...defaults, ...JSON.parse(stored) } : defaults;
        }

        async function saveSettings() {
            const settings = {
                theme: document.getElementById('setting-theme').value,
                compactMode: document.getElementById('setting-compact').checked,
                userName: document.getElementById('setting-username').value,
                fontSize: document.getElementById('setting-fontsize').value,
                autoSave: document.getElementById('setting-autosave').checked,
                animations: document.getElementById('setting-animations').checked,
                defaultLLM: document.getElementById('setting-default-llm').value,
                targetSuccessRate: parseInt(document.getElementById('setting-target-success').value),
                monteCarloSimulations: parseInt(document.getElementById('setting-simulations').value)
            };

            const defaultLLM = document.getElementById('setting-default-llm').value;

            localStorage.setItem('app_settings', JSON.stringify(settings));
            localStorage.setItem('default_llm', defaultLLM);

            applySettings(settings);

            // Save backup settings to backend
            try {
                await fetch(`${API_URL}/backup/settings`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        auto_backup_enabled: document.getElementById('setting-autobackup-enabled').checked,
                        auto_backup_interval_hours: parseInt(document.getElementById('setting-autobackup-interval').value)
                    })
                });
            } catch (e) {
                console.error("Failed to save backup settings", e);
            }

            // Save to backend
            try {
                await fetch(`${API_URL}/system/settings`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        default_llm: defaultLLM
                    })
                });
            } catch (e) {
                console.error("Failed to save system settings", e);
            }

            // Show success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: 15px 20px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
            `;
            notification.textContent = '‚úì Settings saved successfully';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);

            // Close the modal after a brief delay
            setTimeout(() => closeSettings(), 500);
        }

        function applySettings(settings) {
            // Apply theme
            if (settings.theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }

            // Apply compact mode
            if (settings.compactMode) {
                document.body.classList.add('compact-mode');
            } else {
                document.body.classList.remove('compact-mode');
            }

            // Apply font size
            document.body.classList.remove('font-small', 'font-medium', 'font-large');
            document.body.classList.add('font-' + settings.fontSize);

            // Apply animations
            if (!settings.animations) {
                document.body.classList.add('no-animations');
            } else {
                document.body.classList.remove('no-animations');
            }

            // Update header with user name
            const headerTitle = document.querySelector('header h1');
            if (settings.userName && settings.userName !== 'User') {
                document.querySelector('.subtitle').textContent = `${settings.userName}'s Financial Planning Dashboard`;
            } else {
                document.querySelector('.subtitle').textContent = 'Comprehensive financial, tax, estate, and legacy planning';
            }
        }

        function resetSettings() {
            if (!confirm('Are you sure you want to reset all settings to defaults?')) {
                return;
            }

            localStorage.removeItem('app_settings');
            const defaults = getSettings();
            applySettings(defaults);
            loadSettings();

            alert('Settings reset to defaults!');
        }

        // ========================================
        // Backup Management Functions
        // ========================================

        async function createManualBackup() {
            try {
                const button = event.target;
                button.disabled = true;
                button.textContent = 'Creating...';

                const response = await fetch(`${API_URL}/backup/create`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const result = await response.json();
                if (result.success) {
                    alert(`‚úì Backup created successfully: ${result.backup_path}`);
                    refreshBackupList();

                    // Update last backup time
                    const now = new Date();
                    document.getElementById('last-backup-time').textContent =
                        `Last backup: ${now.toLocaleString()}`;
                } else {
                    alert(`‚úó Backup failed: ${result.error}`);
                }

                button.disabled = false;
                button.textContent = 'Create Backup';
            } catch (e) {
                console.error('Backup error:', e);
                alert('‚úó Failed to create backup');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Create Backup';
                }
            }
        }

        async function refreshBackupList() {
            try {
                const response = await fetch(`${API_URL}/backup/list`);
                const result = await response.json();

                const listEl = document.getElementById('backup-list');
                if (result.backups && result.backups.length > 0) {
                    listEl.innerHTML = '';
                    result.backups.forEach(backup => {
                        const item = document.createElement('div');
                        item.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 10px;
                            margin-bottom: 8px;
                            background: var(--bg-tertiary);
                            border-radius: 6px;
                            border: 1px solid var(--border-color);
                        `;

                        const info = document.createElement('div');
                        info.style.cssText = 'flex: 1;';

                        const name = document.createElement('div');
                        name.style.cssText = 'font-weight: 600; color: var(--text-primary); margin-bottom: 4px;';
                        name.textContent = formatBackupTimestamp(backup.timestamp);

                        const size = document.createElement('div');
                        size.style.cssText = 'font-size: 12px; color: var(--text-secondary);';
                        size.textContent = `${backup.size_mb} MB`;

                        info.appendChild(name);
                        info.appendChild(size);

                        const actions = document.createElement('div');
                        actions.style.cssText = 'display: flex; gap: 8px;';

                        const restoreBtn = document.createElement('button');
                        restoreBtn.textContent = 'Restore';
                        restoreBtn.style.cssText = `
                            padding: 6px 12px;
                            background: var(--accent-color);
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                        `;
                        restoreBtn.onclick = () => restoreBackup(backup.name);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.style.cssText = `
                            padding: 6px 12px;
                            background: var(--danger-color);
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                        `;
                        deleteBtn.onclick = () => deleteBackup(backup.name);

                        actions.appendChild(restoreBtn);
                        actions.appendChild(deleteBtn);

                        item.appendChild(info);
                        item.appendChild(actions);
                        listEl.appendChild(item);
                    });
                } else {
                    listEl.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 20px;">No backups found</div>';
                }
            } catch (e) {
                console.error('Failed to load backups:', e);
                document.getElementById('backup-list').innerHTML =
                    '<div style="text-align: center; color: var(--danger-color); padding: 20px;">Error loading backups</div>';
            }
        }

        function formatBackupTimestamp(timestamp) {
            // Format: 20260112_175510 -> Jan 12, 2026 5:55 PM
            const year = timestamp.substr(0, 4);
            const month = timestamp.substr(4, 2);
            const day = timestamp.substr(6, 2);
            const hour = timestamp.substr(9, 2);
            const minute = timestamp.substr(11, 2);

            const date = new Date(year, month - 1, day, hour, minute);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        async function restoreBackup(backupName) {
            if (!confirm(`Are you sure you want to restore from backup "${formatBackupTimestamp(backupName)}"?\n\nThis will replace all current data!`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/backup/restore/${encodeURIComponent(backupName)}`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    alert(`‚úì Restored from backup successfully!\n\nThe page will reload now.`);
                    location.reload();
                } else {
                    alert(`‚úó Restore failed: ${result.error}`);
                }
            } catch (e) {
                console.error('Restore error:', e);
                alert('‚úó Failed to restore backup');
            }
        }

        async function deleteBackup(backupName) {
            if (!confirm(`Are you sure you want to delete backup "${formatBackupTimestamp(backupName)}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/backup/delete/${encodeURIComponent(backupName)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    alert(`‚úì Backup deleted successfully`);
                    refreshBackupList();
                } else {
                    alert(`‚úó Delete failed: ${result.error}`);
                }
            } catch (e) {
                console.error('Delete error:', e);
                alert('‚úó Failed to delete backup');
            }
        }

        // Apply settings on page load
        window.addEventListener('DOMContentLoaded', () => {
            const settings = getSettings();
            applySettings(settings);
        });

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('settings-modal');
            if (e.target === modal) {
                closeSettings();
            }
        });

        // ===== AI Q&A WIZARD FUNCTIONS =====
        let wizardConversation = [];
        let wizardQuestionQueue = [];

        async function startWizard() {
            const profileName = getCurrentProfileName();
            if (!profileName || profileName === 'main') {
                alert('Please save your profile first before starting the wizard.');
                return;
            }

            // Check if API key is configured
            const hasKey = await checkApiKey();
            if (!hasKey) {
                alert('Please configure your API keys in Settings before using the wizard.');
                return;
            }

            // Initialize wizard
            wizardConversation = [];
            document.getElementById('wizard-messages').innerHTML = '';
            document.getElementById('wizard-input').value = '';

            // Show modal
            document.getElementById('wizard-modal').style.display = 'flex';

            // Add welcome message
            addWizardMessage('ai', 'Hello! I\'m here to help complete your financial profile. Let me analyze what information we have and what might be missing...');

            // Call backend to analyze profile
            setTimeout(() => analyzeProfileCompleteness(), 1000);
        }

        async function analyzeProfileCompleteness() {
            try {
                const profileName = getCurrentProfileName();
                const profileData = collectProfileData();

                const response = await fetch(`${API_URL}/wizard/analyze`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        profile_name: profileName,
                        profile: profileData
                    })
                });

                const result = await response.json();

                if (result.questions && result.questions.length > 0) {
                    wizardQuestionQueue = result.questions;
                    addWizardMessage('ai', result.analysis_summary || 'I have a few questions to help optimize your plan.');
                    askNextWizardQuestion();
                } else {
                    addWizardMessage('ai', '‚úÖ Your profile looks complete! No additional information needed at this time.');
                }
            } catch (error) {
                addWizardMessage('ai', '‚ùå Error analyzing profile: ' + error.message);
            }
        }

        // Welcome Screen Functions
        function showExistingProfiles() {
            const container = document.getElementById('profile-list-container');
            const profileSelect = document.getElementById('profile-select');

            if (container.style.display === 'none') {
                let html = '<select id="welcome-profile-select" style="width: 100%; padding: 12px; margin-top: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);" onchange="if(this.value) { loadProfile(this.value); showTab(\'dashboard\'); }">';
                html += '<option value="" disabled selected>Select a profile...</option>';
                for (let i = 1; i < profileSelect.options.length; i++) {
                    html += `<option value="${profileSelect.options[i].value}">${profileSelect.options[i].text}</option>`;
                }
                html += '</select>';
                container.innerHTML = html;
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // Profile Creation Wizard State
        let wizardData = {};
        let currentWizardStep = 0;
        const wizardSteps = [
            { id: 'welcome', title: 'Getting Started', fields: [] },
            { id: 'profile_name', title: 'Profile Name', fields: ['profile_name'] },
            { id: 'person1_basic', title: 'Your Information', fields: ['p1_name', 'p1_birth'] },
            { id: 'person1_retirement', title: 'Your Retirement Plan', fields: ['p1_retire', 'p1_ss'] },
            { id: 'person2_check', title: 'Spouse/Partner', fields: ['has_person2'] },
            { id: 'person2_basic', title: 'Partner Information', fields: ['p2_name', 'p2_birth'], conditional: true },
            { id: 'person2_retirement', title: 'Partner Retirement', fields: ['p2_retire', 'p2_ss'], conditional: true },
            { id: 'expenses', title: 'Living Expenses', fields: ['annual_expenses', 'target_income'] },
            { id: 'risk_tolerance', title: 'Risk Assessment', fields: ['risk'] },
            { id: 'investments_intro', title: 'Investment Accounts', fields: [] },
            { id: 'investments', title: 'Your Investments', fields: ['investments'] },
            { id: 'income_streams', title: 'Income Sources', fields: ['income'] },
            { id: 'properties', title: 'Real Estate', fields: ['properties'] },
            { id: 'market_assumptions', title: 'Market Assumptions', fields: ['assumptions'] },
            { id: 'review', title: 'Review & Complete', fields: [] }
        ];

        async function startProfileWizard() {
            // Check for in-progress wizard
            const savedProgress = localStorage.getItem('wizard_in_progress');
            if (savedProgress) {
                const resume = confirm('You have a wizard in progress. Would you like to continue where you left off?');
                if (resume) {
                    const progress = JSON.parse(savedProgress);
                    wizardData = progress.data;
                    currentWizardStep = progress.step;
                } else {
                    localStorage.removeItem('wizard_in_progress');
                    wizardData = { profile_name: '', has_person2: false, investments: [], income: [], properties: [] };
                    currentWizardStep = 0;
                }
            } else {
                wizardData = { profile_name: '', has_person2: false, investments: [], income: [], properties: [] };
                currentWizardStep = 0;
            }

            document.getElementById('profile-wizard-modal').classList.add('active');
            renderWizardStep();
        }

        function renderWizardStep() {
            const step = wizardSteps[currentWizardStep];
            const body = document.getElementById('profile-wizard-body');
            const total = wizardSteps.length;

            // Skip conditional steps if needed
            if (step.conditional && !wizardData.has_person2) {
                if (currentWizardStep < total - 1) {
                    currentWizardStep++;
                    renderWizardStep();
                }
                return;
            }

            // Update header
            document.getElementById('wizard-step-title').textContent = step.title;
            document.getElementById('wizard-progress-text').textContent = `Step ${currentWizardStep + 1} of ${total}`;
            document.getElementById('wizard-progress-bar').style.width = `${((currentWizardStep + 1) / total) * 100}%`;

            // Update buttons
            document.getElementById('wizard-prev-btn').disabled = currentWizardStep === 0;
            document.getElementById('wizard-next-btn').textContent = currentWizardStep === total - 1 ? 'Complete ‚úì' : 'Next ‚Üí';

            // Render step content
            body.innerHTML = getStepContent(step);
        }

        function getStepContent(step) {
            switch(step.id) {
                case 'welcome':
                    return `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>
                            <h2 style="font-size: 28px; margin-bottom: 15px; color: var(--text-primary);">Let's Build Your Retirement Plan</h2>
                            <p style="font-size: 16px; color: var(--text-secondary); line-height: 1.6; max-width: 500px; margin: 0 auto 30px;">
                                This wizard will guide you through creating a comprehensive retirement plan.
                                We'll collect information about your finances, goals, and timeline to create
                                personalized projections and recommendations.
                            </p>
                            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; text-align: left; max-width: 500px; margin: 0 auto;">
                                <h3 style="font-size: 16px; margin-bottom: 10px; color: var(--text-primary);">You'll provide:</h3>
                                <ul style="color: var(--text-secondary); font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
                                    <li>Personal information (names, ages, retirement dates)</li>
                                    <li>Investment accounts and balances</li>
                                    <li>Income sources (pensions, Social Security)</li>
                                    <li>Real estate holdings</li>
                                    <li>Risk tolerance and goals</li>
                                </ul>
                            </div>
                            <p style="margin-top: 20px; font-size: 13px; color: var(--text-light);">
                                ‚è±Ô∏è Takes about 10-15 minutes ‚Ä¢ üíæ Save anytime and continue later
                            </p>
                        </div>
                    `;

                case 'profile_name':
                    return `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 15px; color: var(--text-primary);">What would you like to name this profile?</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">Choose a name that helps you identify this plan (e.g., "Our Retirement Plan" or "John & Jane 2026").</p>
                            <input type="text" id="wizard-profile-name" value="${wizardData.profile_name || ''}"
                                   placeholder="Enter profile name..."
                                   style="width: 100%; padding: 14px; font-size: 16px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary);"
                                   onkeyup="wizardData.profile_name = this.value">
                            <p style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">
                                üí° Tip: Use a descriptive name that you'll recognize later
                            </p>
                        </div>
                    `;

                case 'person1_basic':
                    return `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 15px; color: var(--text-primary);">Tell us about yourself</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 25px;">We'll use this to calculate your retirement timeline and Social Security benefits.</p>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Full Name</label>
                                <input type="text" id="wizard-p1-name" value="${wizardData.p1_name || ''}"
                                       placeholder="Enter your name"
                                       style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);"
                                       onkeyup="wizardData.p1_name = this.value">
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Date of Birth</label>
                                <input type="date" id="wizard-p1-birth" value="${wizardData.p1_birth || ''}"
                                       style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);"
                                       onchange="wizardData.p1_birth = this.value">
                                <p style="font-size: 13px; color: var(--text-secondary); margin-top: 6px;">üí° This helps us calculate your age at retirement and Social Security eligibility.</p>
                            </div>
                        </div>
                    `;

                case 'person1_retirement':
                    const currentYear = new Date().getFullYear();
                    let retireYearOptions = '';
                    for (let year = currentYear; year <= currentYear + 50; year++) {
                        const selected = wizardData.p1_retire_year == year ? 'selected' : '';
                        retireYearOptions += `<option value="${year}" ${selected}>${year}</option>`;
                    }
                    return `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 15px; color: var(--text-primary);">When do you plan to retire?</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 25px;">This is when you plan to stop working and start drawing from your retirement savings.</p>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Target Retirement Year</label>
                                <select id="wizard-p1-retire-year" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);" onchange="wizardData.p1_retire_year = this.value">
                                    <option value="">Select year...</option>
                                    ${retireYearOptions}
                                </select>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Estimated Monthly Social Security (at full retirement age)</label>
                                <input type="number" id="wizard-p1-ss" value="${wizardData.p1_ss || ''}"
                                       placeholder="e.g., 3000"
                                       style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);"
                                       onkeyup="wizardData.p1_ss = this.value">
                                <p style="font-size: 13px; color: var(--text-secondary); margin-top: 6px;">
                                    üí° Check your estimate at <a href="https://www.ssa.gov/myaccount/" target="_blank" style="color: var(--accent-color);">ssa.gov/myaccount</a>
                                </p>
                            </div>
                        </div>
                    `;

                case 'person2_check':
                    return `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 15px; color: var(--text-primary);">Are you planning retirement with a spouse or partner?</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 25px;">Including a partner helps us plan for joint expenses, survivor benefits, and coordinated Social Security strategies.</p>

                            <div style="display: flex; gap: 15px;">
                                <button onclick="wizardData.has_person2 = true; wizardNextStep();" style="flex: 1; padding: 40px 20px; border: 2px solid var(--border-color); border-radius: 12px; background: ${wizardData.has_person2 ? 'var(--accent-color)' : 'var(--bg-secondary)'}; color: ${wizardData.has_person2 ? 'white' : 'var(--text-primary)'}; cursor: pointer; transition: all 0.3s; font-size: 16px;">
                                    <div style="font-size: 48px; margin-bottom: 10px;">üë•</div>
                                    <div style="font-weight: 600;">Yes, planning together</div>
                                </button>
                                <button onclick="wizardData.has_person2 = false; currentWizardStep += 2; wizardNextStep();" style="flex: 1; padding: 40px 20px; border: 2px solid var(--border-color); border-radius: 12px; background: ${wizardData.has_person2 === false ? 'var(--accent-color)' : 'var(--bg-secondary)'}; color: ${wizardData.has_person2 === false ? 'white' : 'var(--text-primary)'}; cursor: pointer; transition: all 0.3s; font-size: 16px;">
                                    <div style="font-size: 48px; margin-bottom: 10px;">üôã</div>
                                    <div style="font-weight: 600;">No, just me</div>
                                </button>
                            </div>
                        </div>
                    `;

                case 'expenses':
                    return `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 15px; color: var(--text-primary);">What are your expected living expenses?</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 25px;">Help us understand your financial needs in retirement.</p>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Annual Living Expenses (in today's dollars)</label>
                                <input type="number" id="wizard-annual-expenses" value="${wizardData.annual_expenses || ''}"
                                       placeholder="e.g., 80000"
                                       style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);"
                                       onkeyup="wizardData.annual_expenses = this.value">
                                <p style="font-size: 13px; color: var(--text-secondary); margin-top: 6px;">
                                    üí° Include housing, food, healthcare, entertainment, travel, etc.
                                </p>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Target Annual Income in Retirement</label>
                                <input type="number" id="wizard-target-income" value="${wizardData.target_income || ''}"
                                       placeholder="e.g., 100000"
                                       style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);"
                                       onkeyup="wizardData.target_income = this.value">
                                <p style="font-size: 13px; color: var(--text-secondary); margin-top: 6px;">
                                    üí° Often 70-80% of pre-retirement income. Include buffer for unexpected costs.
                                </p>
                            </div>
                        </div>
                    `;

                case 'risk_tolerance':
                    return `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 15px; color: var(--text-primary);">What's your investment risk tolerance?</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 25px;">This helps determine your asset allocation between stocks and bonds.</p>

                            <div style="display: grid; gap: 12px;">
                                ${['Conservative', 'Balanced', 'Aggressive'].map(risk => `
                                    <button onclick="wizardData.risk = '${risk}'; document.querySelectorAll('.risk-btn').forEach(b => b.style.background = 'var(--bg-secondary)'); this.style.background = 'var(--accent-color)'; this.style.color = 'white';" class="risk-btn" style="padding: 20px; border: 2px solid var(--border-color); border-radius: 8px; background: ${wizardData.risk === risk ? 'var(--accent-color)' : 'var(--bg-secondary)'}; color: ${wizardData.risk === risk ? 'white' : 'var(--text-primary)'}; cursor: pointer; text-align: left; transition: all 0.3s;">
                                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px;">${risk}</div>
                                        <div style="font-size: 13px; opacity: 0.9;">
                                            ${risk === 'Conservative' ? 'Prioritize stability, lower volatility (30% stocks / 70% bonds)' :
                                              risk === 'Balanced' ? 'Balance growth and stability (60% stocks / 40% bonds)' :
                                              'Maximize growth potential, accept higher volatility (85% stocks / 15% bonds)'}
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;

                case 'investments_intro':
                    return `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 64px; margin-bottom: 20px;">üí∞</div>
                            <h2 style="font-size: 28px; margin-bottom: 15px; color: var(--text-primary);">Let's Add Your Investment Accounts</h2>
                            <p style="font-size: 16px; color: var(--text-secondary); line-height: 1.6; max-width: 500px; margin: 0 auto 30px;">
                                On the next screen, you'll be able to add all your investment accounts:
                                checking, savings, 401(k), IRA, brokerage, and more.
                            </p>
                            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; text-align: left; max-width: 500px; margin: 0 auto;">
                                <h3 style="font-size: 14px; margin-bottom: 10px; color: var(--text-primary);">üí° Pro Tip:</h3>
                                <p style="color: var(--text-secondary); font-size: 13px; line-height: 1.6; margin: 0;">
                                    You can upload a screenshot of your account balances and we'll use AI to extract the information automatically!
                                </p>
                            </div>
                        </div>
                    `;

                case 'investments':
                    let investmentsHtml = '<div style="padding: 20px;"><h3 style="margin-bottom: 15px;">Your Investment Accounts</h3><p style="color: var(--text-secondary); margin-bottom: 20px;">Add all accounts: checking, savings, 401k, IRA, brokerage, etc.</p>';
                    investmentsHtml += '<div id="wizard-investments-list" style="margin-bottom: 15px;">';
                    if (wizardData.investments && wizardData.investments.length > 0) {
                        wizardData.investments.forEach((inv, idx) => {
                            investmentsHtml += `<div style="padding: 12px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <div><strong>${inv.name}</strong> (${inv.account}): $${parseInt(inv.value).toLocaleString()}</div>
                                <button onclick="wizardRemoveInvestment(${idx})" style="padding: 4px 8px; background: var(--danger-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                            </div>`;
                        });
                    } else {
                        investmentsHtml += '<p style="color: var(--text-light); font-style: italic;">No accounts added yet</p>';
                    }
                    investmentsHtml += '</div>';
                    investmentsHtml += `<button onclick="wizardAddInvestmentForm()" style="width: 100%; padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer;">+ Add Investment Account</button>`;
                    investmentsHtml += '<div id="wizard-investment-form" style="display: none; margin-top: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px;"></div>';
                    investmentsHtml += '</div>';
                    return investmentsHtml;

                case 'review':
                    let reviewHtml = '<div style="padding: 20px;"><h2 style="margin-bottom: 20px; text-align: center;">Review Your Profile</h2>';
                    reviewHtml += '<div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin-bottom: 15px;">';
                    reviewHtml += `<h3 style="margin-bottom: 10px;">Profile: ${wizardData.profile_name || 'Unnamed'}</h3>`;
                    reviewHtml += `<p><strong>You:</strong> ${wizardData.p1_name || 'Not provided'}</p>`;
                    if (wizardData.has_person2) {
                        reviewHtml += `<p><strong>Partner:</strong> ${wizardData.p2_name || 'Not provided'}</p>`;
                    }
                    reviewHtml += `<p><strong>Annual Expenses:</strong> $${parseInt(wizardData.annual_expenses || 0).toLocaleString()}</p>`;
                    reviewHtml += `<p><strong>Investment Accounts:</strong> ${(wizardData.investments || []).length}</p>`;
                    reviewHtml += '</div>';
                    reviewHtml += '<p style="text-align: center; color: var(--text-secondary);">Click "Complete" to save your profile and run your first analysis!</p>';
                    reviewHtml += '</div>';
                    return reviewHtml;

                default:
                    return `<div style="padding: 20px;"><p>Step content for ${step.id} coming soon...</p></div>`;
            }
        }

        function wizardNextStep() {
            const step = wizardSteps[currentWizardStep];
            if (!validateWizardStep(step)) return;

            if (currentWizardStep === wizardSteps.length - 1) {
                completeWizard();
                return;
            }

            currentWizardStep++;
            renderWizardStep();
        }

        function wizardPrevStep() {
            if (currentWizardStep > 0) {
                currentWizardStep--;
                renderWizardStep();
            }
        }

        function validateWizardStep(step) {
            if (step.id === 'profile_name' && !wizardData.profile_name) {
                alert('Please enter a profile name');
                return false;
            }
            return true;
        }

        function closeProfileWizard() {
            if (confirm('Exit wizard? Your progress can be saved.')) {
                document.getElementById('profile-wizard-modal').classList.remove('active');
            }
        }

        function wizardSaveForLater() {
            localStorage.setItem('wizard_in_progress', JSON.stringify({
                data: wizardData,
                step: currentWizardStep,
                timestamp: Date.now()
            }));
            alert('‚úì Progress saved! Continue where you left off next time.');
            document.getElementById('profile-wizard-modal').classList.remove('active');
        }

        function wizardAddInvestmentForm() {
            const form = document.getElementById('wizard-investment-form');
            form.style.display = 'block';
            form.innerHTML = `
                <h4 style="margin-bottom: 15px;">Add Investment Account</h4>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Account Name</label>
                    <input type="text" id="inv-name" placeholder="e.g., Fidelity 401k" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Account Type</label>
                    <select id="inv-type" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                        <option value="Liquid">Checking/Savings</option>
                        <option value="Taxable Brokerage">Taxable Brokerage</option>
                        <option value="Traditional IRA">Traditional IRA/401k</option>
                        <option value="Roth IRA">Roth IRA</option>
                        <option value="Pension">Pension</option>
                    </select>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Current Value ($)</label>
                    <input type="number" id="inv-value" placeholder="e.g., 250000" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="wizardSaveInvestment()" style="flex: 1; padding: 10px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                    <button onclick="document.getElementById('wizard-investment-form').style.display='none'" style="flex: 1; padding: 10px; background: var(--text-secondary); color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `;
        }

        function wizardSaveInvestment() {
            const name = document.getElementById('inv-name').value;
            const account = document.getElementById('inv-type').value;
            const value = document.getElementById('inv-value').value;

            if (!name || !value) {
                alert('Please fill in account name and value');
                return;
            }

            if (!wizardData.investments) wizardData.investments = [];
            wizardData.investments.push({ name, account, value: parseFloat(value), cost_basis: 0, change: 0 });

            document.getElementById('wizard-investment-form').style.display = 'none';
            renderWizardStep();
        }

        function wizardRemoveInvestment(idx) {
            wizardData.investments.splice(idx, 1);
            renderWizardStep();
        }

        async function completeWizard() {
            const profileData = {
                person1: {
                    name: wizardData.p1_name || 'Person 1',
                    birth_date: wizardData.p1_birth || '1970-01-01',
                    retirement_date: wizardData.p1_retire_year ? `${wizardData.p1_retire_year}-01-01` : '2035-01-01',
                    social_security: parseFloat(wizardData.p1_ss) || 3000
                },
                person2: wizardData.has_person2 ? {
                    name: wizardData.p2_name || 'Person 2',
                    birth_date: wizardData.p2_birth || '1970-01-01',
                    retirement_date: wizardData.p2_retire_year ? `${wizardData.p2_retire_year}-01-01` : '2035-01-01',
                    social_security: parseFloat(wizardData.p2_ss) || 3000
                } : { name: '', birth_date: '', retirement_date: '', social_security: 0 },
                investment_types: wizardData.investments || [],
                income_streams: wizardData.income || [],
                home_properties: wizardData.properties || [],
                annual_expenses: parseFloat(wizardData.annual_expenses) || 100000,
                target_annual_income: parseFloat(wizardData.target_income) || 150000,
                risk_tolerance: wizardData.risk || 'Balanced',
                market_assumptions: {
                    stock_allocation: wizardData.risk === 'Conservative' ? 30 : wizardData.risk === 'Aggressive' ? 85 : 60,
                    stock_return_mean: 7.0,
                    bond_return_mean: 3.0,
                    inflation_mean: 2.5,
                    stock_return_std: 18.0,
                    bond_return_std: 5.0,
                    inflation_std: 1.5,
                    ss_discount_rate: 0.0
                }
            };

            try {
                const response = await fetch(`${API_URL}/profile/${encodeURIComponent(wizardData.profile_name)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(profileData)
                });

                if (response.ok) {
                    localStorage.removeItem('wizard_in_progress');
                    document.getElementById('profile-wizard-body').innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 72px; margin-bottom: 20px;">üéâ</div>
                            <h2 style="font-size: 32px; margin-bottom: 15px; color: var(--text-primary);">Profile Complete!</h2>
                            <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 30px;">
                                Your retirement profile has been created. Let's run your first analysis!
                            </p>
                        </div>
                    `;
                    document.getElementById('wizard-prev-btn').style.display = 'none';
                    document.getElementById('wizard-save-later-btn').style.display = 'none';
                    document.getElementById('wizard-next-btn').textContent = 'Go to Dashboard';
                    document.getElementById('wizard-next-btn').onclick = () => {
                        document.getElementById('profile-wizard-modal').classList.remove('active');
                        loadProfile(wizardData.profile_name);
                        showTab('dashboard');
                        setTimeout(() => runAnalysis(), 500);
                    };
                }
            } catch (error) {
                alert('Error saving profile: ' + error.message);
            }
        }

        // ===== LEARNING SYSTEM =====

        const learningTopics = {
            1: [ // Beginner
                { file: 'retirement-planning-SKILL.md', title: 'Retirement Planning Basics', emoji: 'üìö', description: 'Core concepts and getting started' },
                { file: 'investment-policy-SKILL.md', title: 'Investment Fundamentals', emoji: 'üìä', description: 'Understanding investment principles' }
            ],
            2: [ // Basic
                { file: 'retirement-planning-SKILL.md', title: 'Retirement Strategies', emoji: 'üéØ', description: 'Planning your retirement timeline' },
                { file: 'healthcare-gap-SKILL.md', title: 'Healthcare Planning', emoji: 'üè•', description: 'Healthcare costs and Medicare' },
                { file: 'education-planning-SKILL.md', title: 'Education Planning', emoji: 'üéì', description: '529 plans and education savings' }
            ],
            3: [ // Intermediate
                { file: 'estate-legal-SKILL.md', title: 'Estate Planning', emoji: 'üèõÔ∏è', description: 'Wills, trusts, and legacy planning' },
                { file: 'tax-strategy-SKILL.md', title: 'Tax Optimization', emoji: 'üí∞', description: 'Tax-efficient withdrawal strategies' },
                { file: 'real-estate-SKILL.md', title: 'Real Estate in Retirement', emoji: 'üè†', description: 'Property planning and reverse mortgages' }
            ],
            4: [ // Advanced
                { file: 'wealth-transfer-SKILL.md', title: 'Wealth Transfer', emoji: 'üíé', description: 'Advanced estate and gift strategies' },
                { file: 'charitable-giving-SKILL.md', title: 'Charitable Giving', emoji: '‚ù§Ô∏è', description: 'Tax-efficient philanthropy' },
                { file: 'investment-policy-SKILL.md', title: 'Advanced Investing', emoji: 'üìà', description: 'Portfolio optimization and rebalancing' }
            ],
            5: [ // Expert
                { file: 'wealth-transfer-SKILL.md', title: 'Advanced Wealth Strategies', emoji: 'üèÜ', description: 'Complex estate planning techniques' },
                { file: 'lifestyle-design-SKILL.md', title: 'Lifestyle Design', emoji: '‚ú®', description: 'Comprehensive retirement lifestyle planning' },
                { file: 'tax-strategy-SKILL.md', title: 'Advanced Tax Planning', emoji: 'üßÆ', description: 'Complex tax optimization strategies' }
            ]
        };

        let currentLevel = 1;

        function selectLevel(level) {
            currentLevel = level;

            // Update button styles
            document.querySelectorAll('.level-btn').forEach(btn => {
                if (parseInt(btn.dataset.level) === level) {
                    btn.style.background = 'var(--accent-color)';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'var(--accent-color)';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-primary)';
                    btn.style.borderColor = 'var(--border-color)';
                    btn.classList.remove('active');
                }
            });

            // Render topics for this level
            renderTopicsGrid(level);
        }

        function renderTopicsGrid(level) {
            const grid = document.getElementById('learn-topics-grid');
            const topics = learningTopics[level];

            let html = '';
            topics.forEach(topic => {
                const progress = getLearningProgress(topic.file, level);
                const progressBadge = progress ? '<span style="position: absolute; top: 10px; right: 10px; background: var(--accent-color); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">‚úì Read</span>' : '';

                html += `
                    <div class="topic-card" onclick="loadEducationalContent('${topic.file}', ${level})"
                         style="cursor: pointer; padding: 25px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 12px; transition: all 0.3s; box-shadow: 0 2px 8px var(--shadow); position: relative;">
                        ${progressBadge}
                        <div style="font-size: 48px; margin-bottom: 15px;">${topic.emoji}</div>
                        <h3 style="font-size: 20px; margin-bottom: 10px; color: var(--text-primary);">${topic.title}</h3>
                        <p style="font-size: 14px; color: var(--text-secondary); margin: 0;">${topic.description}</p>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        async function loadEducationalContent(filename, level) {
            try {
                const response = await fetch(`${API_URL}/skills/${filename}`);
                const data = await response.json();

                if (data.content) {
                    // Simple markdown to HTML conversion
                    let html = data.content
                        .replace(/^### (.+)$/gm, '<h3 style="font-size: 20px; margin-top: 25px; margin-bottom: 10px; color: var(--text-primary);">$1</h3>')
                        .replace(/^## (.+)$/gm, '<h2 style="font-size: 24px; margin-top: 30px; margin-bottom: 12px; color: var(--text-primary);">$1</h2>')
                        .replace(/^# (.+)$/gm, '<h1 style="font-size: 28px; margin-bottom: 15px; color: var(--text-primary);">$1</h1>')
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.+?)\*/g, '<em>$1</em>')
                        .replace(/^- (.+)$/gm, '<li style="margin-left: 20px; margin-bottom: 8px; color: var(--text-secondary);">$1</li>')
                        .replace(/\n\n/g, '</p><p style="margin-bottom: 15px; line-height: 1.6; color: var(--text-secondary);">')
                        .replace(/\n/g, '<br>');

                    document.getElementById('learn-content-body').innerHTML = '<div style="line-height: 1.6;">' + html + '</div>';
                    document.getElementById('learn-topics-grid').style.display = 'none';
                    document.getElementById('learn-content-display').style.display = 'block';

                    // Track progress
                    trackLearningProgress(filename, level);
                } else {
                    alert('Content not available yet. This feature requires the backend endpoint to be set up.');
                }
            } catch (error) {
                console.error('Error loading content:', error);
                alert('Error loading content. The skills endpoint may not be available yet.');
            }
        }

        function closeLearningContent() {
            document.getElementById('learn-content-display').style.display = 'none';
            document.getElementById('learn-topics-grid').style.display = 'grid';
        }

        function trackLearningProgress(filename, level) {
            let progress = JSON.parse(localStorage.getItem('learning_progress') || '{}');
            if (!progress[level]) progress[level] = [];
            if (!progress[level].includes(filename)) {
                progress[level].push(filename);
                localStorage.setItem('learning_progress', JSON.stringify(progress));
            }
            // Re-render to show progress badge
            renderTopicsGrid(level);
        }

        function getLearningProgress(filename, level) {
            const progress = JSON.parse(localStorage.getItem('learning_progress') || '{}');
            return progress[level] && progress[level].includes(filename);
        }

        // Initialize learning topics on page load
        window.addEventListener('load', () => {
            renderTopicsGrid(1);
        });

        // ===== LEVEL-BASED PROGRESSION SYSTEM =====

        function calculateProfileCompleteness() {
            const profileName = getCurrentProfileName();
            if (!profileName || profileName === 'main') return 0;

            let score = 0;
            const maxScore = 100;

            // Get current profile data
            const p1Name = document.getElementById('p1-name')?.value || '';
            const p1Birth = document.getElementById('p1-birth')?.value || '';
            const p1Retire = document.getElementById('p1-retire')?.value || '';
            const p1SS = parseFloat(document.getElementById('p1-ss')?.value || 0);

            // Basic info (20 points)
            if (p1Name && p1Name !== 'Person 1') score += 5;
            if (p1Birth && p1Birth !== '1970-01-01') score += 5;
            if (p1Retire && p1Retire !== '2035-01-01') score += 5;
            if (p1SS > 0) score += 5;

            // Investments (30 points)
            if (investmentTypes && investmentTypes.length >= 1) score += 10;
            if (investmentTypes && investmentTypes.length >= 3) score += 10;
            if (investmentTypes && investmentTypes.some(i => i.cost_basis > 0)) score += 10;

            // Income streams (20 points)
            if (incomeStreams && incomeStreams.length >= 1) score += 10;
            if (incomeStreams && incomeStreams.length >= 2) score += 10;

            // Properties (15 points)
            if (homeProperties && homeProperties.length >= 1) score += 15;

            // Goals & assumptions (15 points)
            const expenses = parseFloat(document.getElementById('expenses')?.value || 0);
            const targetIncome = parseFloat(document.getElementById('target-income')?.value || 0);
            if (expenses > 0) score += 5;
            if (targetIncome > 0) score += 5;

            // Market assumptions set (check if not default values)
            const stockSlider = document.getElementById('stocks-slider')?.value;
            if (stockSlider && stockSlider != 60) score += 5;

            return Math.min(score, maxScore);
        }

        function getUserLevel() {
            const score = calculateProfileCompleteness();
            if (score < 20) return 1;
            if (score < 40) return 2;
            if (score < 60) return 3;
            if (score < 80) return 4;
            return 5;
        }

        function getLevelName(level) {
            const names = {
                1: 'Beginner',
                2: 'Basic',
                3: 'Intermediate',
                4: 'Advanced',
                5: 'Expert'
            };
            return names[level] || 'Unknown';
        }

        function checkFeatureAccess(feature) {
            const level = getUserLevel();
            const featureRequirements = {
                'analysis': 3,      // Need 60% complete
                'scenarios': 4,     // Need 80% complete
                'advisor': 2        // Need 40% complete
            };

            return level >= (featureRequirements[feature] || 1);
        }

        function showLevelUpNotification(newLevel) {
            const messages = {
                2: 'üéâ Level 2 Unlocked! You can now use the AI Advisor.',
                3: 'üöÄ Level 3 Unlocked! Analysis features are now available.',
                4: '‚≠ê Level 4 Unlocked! Scenario comparison is now available.',
                5: 'üèÜ Level 5 Achieved! All features unlocked. You\'re a retirement planning expert!'
            };

            if (messages[newLevel]) {
                // Show notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    z-index: 10001;
                    animation: slideInRight 0.5s ease-out;
                    max-width: 400px;
                    font-size: 16px;
                    font-weight: 600;
                `;
                notification.textContent = messages[newLevel];
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.5s ease-in';
                    setTimeout(() => notification.remove(), 500);
                }, 5000);
            }
        }

        function renderProgressIndicator() {
            const score = calculateProfileCompleteness();
            const level = getUserLevel();
            const levelName = getLevelName(level);

            return `
                <div style="background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid var(--accent-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: var(--text-primary); font-size: 16px;">Profile Completeness</span>
                        <span style="font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${score}%</span>
                    </div>
                    <div style="width: 100%; height: 10px; background: var(--border-color); border-radius: 5px; overflow: hidden; margin-bottom: 10px;">
                        <div style="width: ${score}%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.5s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 14px; color: var(--text-secondary);">
                            Level ${level} - ${levelName}
                        </span>
                        ${score < 100 ? `<span style="font-size: 13px; color: var(--text-light);">${100 - score}% to completion</span>` : '<span style="font-size: 13px; color: #27ae60; font-weight: 600;">‚úì Complete!</span>'}
                    </div>
                </div>
            `;
        }

        function updateProgressIndicator() {
            const container = document.getElementById('profile-progress-container');
            if (container) {
                container.innerHTML = renderProgressIndicator();
            }
        }

        // Check for level up when profile changes
        let previousLevel = 0;
        function checkLevelUp() {
            const currentLevel = getUserLevel();
            if (currentLevel > previousLevel && previousLevel > 0) {
                showLevelUpNotification(currentLevel);
            }
            previousLevel = currentLevel;
        }

        function askNextWizardQuestion() {
            if (wizardQuestionQueue.length === 0) {
                addWizardMessage('ai', 'üéâ Thank you! I\'ve gathered all the information I need. Your profile has been updated. Running fresh analysis...');
                setTimeout(() => {
                    runAnalysis();
                    updateSummaryTab();
                    closeWizard();
                }, 2000);
                return;
            }

            const question = wizardQuestionQueue[0];
            addWizardMessage('ai', question.question);
        }

        function sendWizardResponse() {
            const input = document.getElementById('wizard-input');
            const userResponse = input.value.trim();

            if (!userResponse) return;

            addWizardMessage('user', userResponse);
            input.value = '';

            // Process the response
            processWizardResponse(userResponse);
        }

        async function processWizardResponse(userResponse) {
            try {
                const currentQuestion = wizardQuestionQueue.shift();

                const response = await fetch(`${API_URL}/wizard/process`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        profile_name: getCurrentProfileName(),
                        question: currentQuestion,
                        response: userResponse,
                        profile: collectProfileData()
                    })
                });

                const result = await response.json();

                if (result.update_applied) {
                    addWizardMessage('ai', '‚úì Got it! Information saved.');

                    // Apply updates to form if provided
                    if (result.profile_updates) {
                        applyProfileUpdates(result.profile_updates);
                    }
                }

                if (result.follow_up) {
                    wizardQuestionQueue.unshift({ question: result.follow_up, field: currentQuestion.field });
                }

                setTimeout(() => askNextWizardQuestion(), 800);

            } catch (error) {
                addWizardMessage('ai', '‚ùå Error processing response: ' + error.message);
            }
        }

        function skipWizardQuestion() {
            wizardQuestionQueue.shift();
            addWizardMessage('ai', 'Okay, skipping that one.');
            setTimeout(() => askNextWizardQuestion(), 500);
        }

        function closeWizard() {
            document.getElementById('wizard-modal').style.display = 'none';
        }

        function addWizardMessage(role, text) {
            const messagesDiv = document.getElementById('wizard-messages');
            const messageDiv = document.createElement('div');

            if (role === 'ai') {
                messageDiv.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 16px; border-radius: 12px 12px 12px 2px; max-width: 80%; align-self: flex-start;';
            } else {
                messageDiv.style.cssText = 'background: var(--bg-tertiary); color: var(--text-primary); padding: 12px 16px; border-radius: 12px 12px 2px 12px; max-width: 80%; align-self: flex-end; border: 1px solid var(--border-color);';
            }

            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function applyProfileUpdates(updates) {
            // Apply updates to the form
            for (const [key, value] of Object.entries(updates)) {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                }
            }
        }

        // ===== SUMMARY TAB FUNCTIONS =====
        function updateSummaryTab() {
            const profileName = getCurrentProfileName();
            const profileData = collectProfileData();
            const analysis = window.currentAnalysis;

            if (!profileData.person1.name) {
                document.getElementById('summary-content').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-light);">
                        <h3>No Profile Loaded</h3>
                        <p>Please load or create a profile to view the financial summary.</p>
                    </div>
                `;
                return;
            }

            generateSummaryReport(profileName, profileData, analysis);
        }

        function generateSummaryReport(profileName, profile, analysis) {
            const p1 = profile.person1;
            const p2 = profile.person2;

            // Calculate ages and years to retirement
            const calcAge = (birthDate) => {
                if (!birthDate) return 'N/A';
                const today = new Date();
                const birth = new Date(birthDate);
                return Math.floor((today - birth) / (365.25 * 24 * 60 * 60 * 1000));
            };

            const calcYearsTo = (targetDate) => {
                if (!targetDate) return 'N/A';
                const today = new Date();
                const target = new Date(targetDate);
                const years = (target - today) / (365.25 * 24 * 60 * 60 * 1000);
                return years > 0 ? years.toFixed(1) : '0';
            };

            const p1Age = calcAge(p1.birth_date);
            const p2Age = calcAge(p2.birth_date);
            const p1YearsToRetire = calcYearsTo(p1.retirement_date);
            const p2YearsToRetire = calcYearsTo(p2.retirement_date);

            // Calculate total assets
            const totalAssets = profile.investment_types.reduce((sum, inv) => sum + inv.value, 0);
            const totalCostBasis = profile.investment_types.reduce((sum, inv) => sum + (inv.cost_basis || 0), 0);
            const unrealizedGains = totalAssets - totalCostBasis;

            // Calculate by account type
            const assetsByType = {};
            profile.investment_types.forEach(inv => {
                if (!assetsByType[inv.account]) assetsByType[inv.account] = 0;
                assetsByType[inv.account] += inv.value;
            });

            const totalHomeValue = profile.home_properties?.reduce((sum, prop) => sum + prop.current_value, 0) || 0;
            const totalMortgages = profile.home_properties?.reduce((sum, prop) => sum + (prop.mortgage_balance || 0), 0) || 0;

            // Success rate styling
            const successRate = analysis?.monte_carlo?.success_rate || 0;
            const successColor = successRate >= 90 ? '#2ecc71' : successRate >= 75 ? '#f39c12' : '#e74c3c';
            const successStatus = successRate >= 90 ? 'Excellent' : successRate >= 75 ? 'Good' : 'Needs Attention';

            const html = `
                <div class="summary-report" style="max-width: 1200px; margin: 0 auto;">
                    <!-- Header with Logo -->
                    <div class="report-header" style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; border-radius: 12px 12px 0 0;">
                        <img src="pan-rps-logo.svg" alt="PAN RPS" style="max-width: 350px; margin-bottom: 15px;">
                        <h1 style="margin: 10px 0; font-size: 28px;">Financial Profile Summary</h1>
                        <p style="margin: 5px 0; opacity: 0.9; font-size: 16px;">Profile: <strong>${profileName}</strong></p>
                        <p style="margin: 5px 0; opacity: 0.7; font-size: 14px;">Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>

                    <!-- Main Content -->
                    <div style="background: var(--bg-secondary); padding: 40px;">
                        <!-- Demographics Section -->
                        <div class="summary-section" style="margin-bottom: 40px;">
                            <h2 style="color: var(--text-primary); border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 25px;">
                                üë• Demographics
                            </h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                                ${p1.name ? `
                                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid #3498db;">
                                    <h3 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 18px;">${p1.name}</h3>
                                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 14px;">
                                        <div><strong>Current Age:</strong> ${p1Age}</div>
                                        <div><strong>Date of Birth:</strong> ${p1.birth_date ? new Date(p1.birth_date).toLocaleDateString() : 'N/A'}</div>
                                        <div><strong>Retirement Date:</strong> ${p1.retirement_date ? new Date(p1.retirement_date).toLocaleDateString() : 'N/A'}</div>
                                        <div><strong>Years to Retirement:</strong> <span style="color: #3498db; font-weight: 600;">${p1YearsToRetire}</span></div>
                                        <div><strong>Social Security:</strong> $${(p1.social_security || 0).toLocaleString()}/month</div>
                                    </div>
                                </div>
                                ` : ''}
                                ${p2.name ? `
                                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid #2ecc71;">
                                    <h3 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 18px;">${p2.name}</h3>
                                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 14px;">
                                        <div><strong>Current Age:</strong> ${p2Age}</div>
                                        <div><strong>Date of Birth:</strong> ${p2.birth_date ? new Date(p2.birth_date).toLocaleDateString() : 'N/A'}</div>
                                        <div><strong>Retirement Date:</strong> ${p2.retirement_date ? new Date(p2.retirement_date).toLocaleDateString() : 'N/A'}</div>
                                        <div><strong>Years to Retirement:</strong> <span style="color: #2ecc71; font-weight: 600;">${p2YearsToRetire}</span></div>
                                        <div><strong>Social Security:</strong> $${(p2.social_security || 0).toLocaleString()}/month</div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Financial Overview -->
                        <div class="summary-section" style="margin-bottom: 40px;">
                            <h2 style="color: var(--text-primary); border-bottom: 3px solid #2ecc71; padding-bottom: 10px; margin-bottom: 25px;">
                                üí∞ Financial Overview
                            </h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">Total Investment Assets</div>
                                    <div style="font-size: 32px; font-weight: bold;">$${(totalAssets/1000000).toFixed(2)}M</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">Real Estate Value</div>
                                    <div style="font-size: 32px; font-weight: bold;">$${(totalHomeValue/1000000).toFixed(2)}M</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">Annual Expenses</div>
                                    <div style="font-size: 32px; font-weight: bold;">$${(profile.annual_expenses/1000).toFixed(0)}K</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">Plan Success Rate</div>
                                    <div style="font-size: 32px; font-weight: bold;">${successRate.toFixed(0)}%</div>
                                    <div style="font-size: 12px; opacity: 0.9;">${successStatus}</div>
                                </div>
                            </div>

                            <!-- Asset Allocation Chart -->
                            <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 8px;">
                                <h3 style="margin: 0 0 20px 0; color: var(--text-primary);">Asset Allocation by Account Type</h3>
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    ${Object.entries(assetsByType).map(([type, value]) => {
                                        const percentage = (value / totalAssets * 100).toFixed(1);
                                        const colors = {
                                            'Checking': '#3498db',
                                            'Savings': '#2ecc71',
                                            'Liquid': '#1abc9c',
                                            'Taxable Brokerage': '#9b59b6',
                                            'Traditional IRA': '#e67e22',
                                            '401k': '#e74c3c',
                                            '403b': '#c0392b',
                                            '401a': '#d35400',
                                            '457b': '#f39c12',
                                            'Roth IRA': '#16a085',
                                            'Pension': '#27ae60'
                                        };
                                        const color = colors[type] || '#95a5a6';
                                        return `
                                            <div>
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px;">
                                                    <span style="font-weight: 600;">${type}</span>
                                                    <span>$${value.toLocaleString()} (${percentage}%)</span>
                                                </div>
                                                <div style="background: #ecf0f1; height: 24px; border-radius: 12px; overflow: hidden;">
                                                    <div style="background: ${color}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Retirement Milestones -->
                        <div class="summary-section" style="margin-bottom: 40px;">
                            <h2 style="color: var(--text-primary); border-bottom: 3px solid #f39c12; padding-bottom: 10px; margin-bottom: 25px;">
                                üéØ Key Milestones
                            </h2>
                            <div style="position: relative; padding-left: 30px;">
                                ${p1.retirement_date ? `
                                <div style="position: relative; margin-bottom: 25px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid #3498db;">
                                    <div style="position: absolute; left: -38px; top: 20px; width: 16px; height: 16px; background: #3498db; border-radius: 50%; border: 3px solid white;"></div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">${p1.name} Retirement</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">${new Date(p1.retirement_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })} (${p1YearsToRetire} years)</div>
                                </div>
                                ` : ''}
                                ${p2.retirement_date ? `
                                <div style="position: relative; margin-bottom: 25px; padding: 15px; background: #e8f8f5; border-radius: 8px; border-left: 4px solid #2ecc71;">
                                    <div style="position: absolute; left: -38px; top: 20px; width: 16px; height: 16px; background: #2ecc71; border-radius: 50%; border: 3px solid white;"></div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">${p2.name} Retirement</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">${new Date(p2.retirement_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })} (${p2YearsToRetire} years)</div>
                                </div>
                                ` : ''}
                                ${profile.income_streams && profile.income_streams.length > 0 ? profile.income_streams.map(stream => `
                                <div style="position: relative; margin-bottom: 25px; padding: 15px; background: #fef5e7; border-radius: 8px; border-left: 4px solid #f39c12;">
                                    <div style="position: absolute; left: -38px; top: 20px; width: 16px; height: 16px; background: #f39c12; border-radius: 50%; border: 3px solid white;"></div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">${stream.name} Begins</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">$${stream.amount.toLocaleString()}/year starting ${new Date(stream.start_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}</div>
                                </div>
                                `).join('') : ''}
                            </div>
                        </div>

                        <!-- Action Items -->
                        <div class="summary-section" style="margin-bottom: 40px;">
                            <h2 style="color: var(--text-primary); border-bottom: 3px solid #e74c3c; padding-bottom: 10px; margin-bottom: 25px;">
                                ‚úÖ Action Items
                            </h2>
                            <div id="summary-action-items" style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px;">
                                <p style="color: var(--text-secondary);">Loading action items...</p>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div style="text-align: center; padding: 30px 20px; border-top: 2px solid #ecf0f1; margin-top: 40px; color: var(--text-secondary);">
                            <p style="margin: 0; font-size: 13px;">This report was generated by <strong>PAN RPS</strong> - Professional Financial Analysis & Planning</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px;">For informational purposes only. Consult with a qualified financial advisor for personalized advice.</p>
                        </div>
                    </div>

                    <!-- Print Button -->
                    <div class="no-print" style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 0 0 12px 12px;">
                        <button onclick="window.print()" style="padding: 15px 40px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                            üñ®Ô∏è Print Summary Report
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('summary-content').innerHTML = html;
            loadSummaryActionItems();
        }

        async function loadSummaryActionItems() {
            try {
                const profileName = getCurrentProfileName();
                const response = await fetch(`${API_URL}/action-items?profile_name=${encodeURIComponent(profileName)}`);
                const items = await response.json();

                const itemsDiv = document.getElementById('summary-action-items');
                if (items.length === 0) {
                    itemsDiv.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No action items found. <a href="#" onclick="showTab(\'actions\'); return false;">Add some in the Action Items tab</a>.</p>';
                    return;
                }

                const priorityIcons = { high: 'üî¥', medium: 'üü°', low: 'üü¢' };
                const statusColors = { pending: '#f39c12', in_progress: '#3498db', completed: '#2ecc71' };

                itemsDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${items.slice(0, 8).map(item => `
                            <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: var(--bg-secondary); border-radius: 6px; border-left: 4px solid ${statusColors[item.status]};">
                                <span style="font-size: 20px;">${priorityIcons[item.priority]}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 3px;">${item.description}</div>
                                    ${item.due_date ? `<div style="font-size: 12px; color: var(--text-secondary);">Due: ${new Date(item.due_date).toLocaleDateString()}</div>` : ''}
                                </div>
                                <div style="font-size: 11px; padding: 4px 10px; background: ${statusColors[item.status]}; color: white; border-radius: 12px; text-transform: uppercase; font-weight: 600;">
                                    ${item.status.replace('_', ' ')}
                                </div>
                            </div>
                        `).join('')}
                        ${items.length > 8 ? `<p style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-top: 10px;">... and ${items.length - 8} more. <a href="#" onclick="showTab('actions'); return false;">View all</a></p>` : ''}
                    </div>
                `;
            } catch (error) {
                document.getElementById('summary-action-items').innerHTML = '<p style="color: #e74c3c;">Error loading action items.</p>';
            }
        }

        // Update summary when switching to summary tab
        const originalShowTab = showTab;
        showTab = function(tabName) {
            originalShowTab(tabName);
            if (tabName === 'summary') {
                updateSummaryTab();
            }
        };

    </script>

    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h2>‚öôÔ∏è Application Settings</h2>
                <button class="close-settings" onclick="closeSettings()">√ó</button>
            </div>

            <div class="settings-body">
                <!-- Appearance Settings -->
                <div class="setting-group">
                    <h3>üé® Appearance</h3>

                    <div class="setting-item">
                        <div>
                            <label>Theme</label>
                            <div class="description">Choose your preferred color scheme</div>
                        </div>
                        <select id="setting-theme">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Font Size</label>
                            <div class="description">Adjust text size for readability</div>
                        </div>
                        <select id="setting-fontsize">
                            <option value="small">Small</option>
                            <option value="medium">Medium</option>
                            <option value="large">Large</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Compact Mode</label>
                            <div class="description">Reduce spacing for more content density</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-compact">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Animations</label>
                            <div class="description">Enable smooth transitions and effects</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-animations">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Personalization Settings -->
                <div class="setting-group">
                    <h3>üë§ Personalization</h3>

                    <div class="setting-item">
                        <div>
                            <label>Your Name</label>
                            <div class="description">Personalize the dashboard header</div>
                        </div>
                        <input type="text" id="setting-username" placeholder="Enter your name">
                    </div>
                </div>

                <!-- System Configuration -->
                <div class="setting-group">
                    <h3>üîß System Configuration</h3>

                    <div class="setting-item">
                        <div>
                            <label>Default AI Provider</label>
                            <div class="description">Select the primary LLM for advisor features</div>
                        </div>
                        <select id="setting-default-llm">
                            <option value="gemini">Google Gemini</option>
                            <option value="claude">Anthropic Claude</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>API Keys</label>
                            <div class="description">
                                Set API keys via environment variables before starting the server:<br>
                                <code style="font-size: 0.85em; background: var(--border-color); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-top: 4px;">
                                    export GEMINI_API_KEY="..." && export ANTHROPIC_API_KEY="..."
                                </code>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup Settings -->
                <div class="setting-group">
                    <h3>üíæ Auto-Backup</h3>

                    <div class="setting-item">
                        <div>
                            <label>Enable Auto-Backup</label>
                            <div class="description">Automatically backup your data at regular intervals</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-autobackup-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Backup Frequency</label>
                            <div class="description">How often to create automatic backups</div>
                        </div>
                        <select id="setting-autobackup-interval">
                            <option value="24">Daily</option>
                            <option value="168">Weekly</option>
                            <option value="720">Monthly</option>
                            <option value="6">Every 6 hours</option>
                            <option value="12">Every 12 hours</option>
                        </select>
                    </div>

                    <div class="setting-item" style="flex-direction: column; align-items: flex-start; padding: 20px; background: var(--bg-tertiary); border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 12px;">
                            <div>
                                <label style="margin-bottom: 4px;">Manual Backup</label>
                                <div class="description">Create a backup now</div>
                                <div id="last-backup-time" class="description" style="margin-top: 8px; color: var(--success-color);"></div>
                            </div>
                            <button onclick="createManualBackup()" style="padding: 10px 20px; background: var(--success-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Create Backup
                            </button>
                        </div>
                    </div>

                    <div class="setting-item" style="flex-direction: column; align-items: flex-start;">
                        <div style="width: 100%; margin-bottom: 12px;">
                            <label>Backup Management</label>
                            <div class="description">View, restore, or delete backups</div>
                        </div>
                        <div id="backup-list" style="width: 100%; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; background: var(--bg-secondary);">
                            <div style="text-align: center; color: var(--text-light); padding: 20px;">Loading backups...</div>
                        </div>
                        <button onclick="refreshBackupList()" style="margin-top: 10px; padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Refresh List
                        </button>
                    </div>
                </div>

                <!-- Behavior Settings -->
                <div class="setting-group">
                    <h3>‚ö° Behavior</h3>

                    <div class="setting-item">
                        <div>
                            <label>Target Success Rate (%)</label>
                            <div class="description">Define your minimum acceptable retirement success probability</div>
                        </div>
                        <input type="number" id="setting-target-success" min="50" max="100" style="width: 80px; min-width: 80px;">
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Auto-Save Profiles</label>
                            <div class="description">Automatically save changes to your profile</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-autosave">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div>
                            <label>Monte Carlo Simulations</label>
                            <div class="description">Number of scenarios to run for each analysis (1,000 - 50,000). More = accurate but slower. <strong>Current: <span id="sim-count-display">10,000</span></strong></div>
                        </div>
                        <input type="number" id="setting-simulations" min="1000" max="50000" step="1000" value="10000" style="width: 100px; min-width: 100px;" oninput="document.getElementById('sim-count-display').textContent = parseInt(this.value).toLocaleString()">
                    </div>
                </div>
            </div>

            <div class="settings-footer">
                <button class="btn-reset" onclick="resetSettings()">Reset to Defaults</button>
                <button class="secondary" onclick="closeSettings()">Cancel</button>
                <button onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>
    <!-- Action Item Wizard Modal -->
    <div id="wizard-modal" class="settings-modal">
        <div class="settings-content" style="max-width: 800px;">
            <div class="settings-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h2 style="color: white;">‚ú® Action Item Wizard</h2>
                <button class="close-settings" onclick="closeWizard()" style="color: white;">√ó</button>
            </div>

            <div class="settings-body" id="wizard-body" style="min-height: 400px; display: flex; flex-direction: column;">
                <!-- Wizard content populated by JS -->
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                    Loading wizard...
                </div>
            </div>

            <div class="settings-footer" style="justify-content: space-between;">
                <button class="secondary" onclick="wizardPrev()">‚Üê Previous</button>
                <div>
                    <span id="wizard-progress" style="margin-right: 15px; color: var(--text-secondary); font-size: 13px;"></span>
                    <button id="wizard-ai-assist-btn" class="ai-button" onclick="wizardAIAssist()" style="display: none;">ü§ñ AI Assist</button>
                    <button id="wizard-complete-btn" class="secondary" onclick="wizardMarkComplete()" style="background: #27ae60; color: white; display: none;">Mark Complete</button>
                    <button onclick="wizardNext()">Next ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Creation Wizard Modal -->
    <div id="profile-wizard-modal" class="settings-modal">
        <div class="settings-content" style="max-width: 800px; max-height: 90vh;">
            <div class="settings-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h2 style="color: white;">‚ú® Profile Creation Wizard</h2>
                <button class="close-settings" onclick="closeProfileWizard()" style="color: white;">√ó</button>
            </div>

            <div style="padding: 20px 30px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span id="wizard-step-title" style="font-weight: 600; font-size: 16px; color: var(--text-primary);">Getting Started</span>
                    <span id="wizard-progress-text" style="color: var(--text-secondary); font-size: 14px;">Step 1 of 15</span>
                </div>
                <div style="width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden;">
                    <div id="wizard-progress-bar" style="width: 6.67%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
                </div>
            </div>

            <div class="settings-body" id="profile-wizard-body" style="min-height: 350px; max-height: calc(90vh - 280px); overflow-y: auto;">
                <!-- Step content rendered here -->
            </div>

            <div class="settings-footer" style="justify-content: space-between;">
                <button id="wizard-prev-btn" class="secondary" onclick="wizardPrevStep()" disabled>‚Üê Previous</button>
                <button id="wizard-save-later-btn" class="secondary" onclick="wizardSaveForLater()" style="position: absolute; left: 50%; transform: translateX(-50%);">üíæ Save & Continue Later</button>
                <button id="wizard-next-btn" onclick="wizardNextStep()">Next ‚Üí</button>
            </div>
        </div>
    </div>

</body>
</html>
