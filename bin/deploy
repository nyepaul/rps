#!/bin/bash
# Deploy RPS to /var/www/rps.pan2.app/
# This script copies the application to the Apache web directory and sets up configuration

set -e  # Exit on error

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Configuration
SOURCE_DIR="/home/paul/src/rps"
TARGET_DIR="/var/www/rps.pan2.app"
APACHE_CONFIG_SOURCE="${SOURCE_DIR}/apache2/rps.pan2.app.conf"
APACHE_CONFIG_TARGET="/etc/apache2/sites-available/rps.pan2.app.conf"
SERVICE_NAME="rps"

echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${GREEN}‚ïë              RPS Deployment to Production                      ‚ïë${NC}"
echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# Check if running as root or with sudo
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: This script must be run as root or with sudo${NC}"
    echo "Usage: sudo ./bin/deploy"
    exit 1
fi

# Pull latest code from git
echo -e "${YELLOW}‚Üí Pulling latest code from git...${NC}"
cd "$SOURCE_DIR"
sudo -u paul git pull 2>&1 | grep -E "Already up to date|Updating|Fast-forward" || {
    echo -e "${RED}  ‚ö† Warning: git pull had issues (may have local changes)${NC}"
}

# Create target directory if it doesn't exist
echo -e "${YELLOW}Creating target directory...${NC}"
mkdir -p "$TARGET_DIR"

# Copy application files (excluding venv, cache, data, logs, etc.)
echo -e "${YELLOW}‚Üí Syncing application files...${NC}"
RSYNC_OUTPUT=$(rsync -a --delete \
    --exclude='*.pyc' \
    --exclude='__pycache__' \
    --exclude='src/venv' \
    --exclude='venv' \
    --exclude='.git' \
    --exclude='data/*.db' \
    --exclude='data/*.db-*' \
    --exclude='logs' \
    --exclude='backups' \
    --exclude='.pytest_cache' \
    --exclude='*.log' \
    --exclude='.claude' \
    --exclude='.idea' \
    --exclude='.vscode' \
    --exclude='.DS_Store' \
    --exclude='*.swp' \
    --exclude='*.swo' \
    "$SOURCE_DIR/" "$TARGET_DIR/" 2>&1)
echo -e "  ‚úì Files synced"

# Create necessary directories
echo -e "${YELLOW}Creating data and logs directories...${NC}"
mkdir -p "$TARGET_DIR/data"
mkdir -p "$TARGET_DIR/logs"

# Set up Python virtual environment
echo -e "${YELLOW}‚Üí Checking Python virtual environment...${NC}"
if [ ! -f "$TARGET_DIR/venv/bin/pip" ] || ! "$TARGET_DIR/venv/bin/pip" --version > /dev/null 2>&1; then
    echo -e "  Creating virtual environment..."
    rm -rf "$TARGET_DIR/venv"
    python3 -m venv "$TARGET_DIR/venv"
fi
echo -e "  ‚úì Virtual environment ready"

# Install dependencies
echo -e "${YELLOW}‚Üí Installing Python dependencies...${NC}"
"$TARGET_DIR/venv/bin/pip" install --quiet --upgrade pip 2>&1 | grep -E "ERROR|WARNING" || true
PIP_OUTPUT=$("$TARGET_DIR/venv/bin/pip" install --quiet -r "$TARGET_DIR/requirements.txt" 2>&1)
if [ $? -eq 0 ]; then
    echo -e "  ‚úì Dependencies installed"
else
    echo -e "${RED}  ‚ö† Dependency installation had warnings${NC}"
    echo "$PIP_OUTPUT" | grep -E "ERROR|WARNING"
fi

# Run database migrations
echo -e "${YELLOW}‚Üí Running database migrations...${NC}"
DB_FILE="$TARGET_DIR/data/planning.db"
MIGRATION_LOG="$TARGET_DIR/logs/migration.log"

if [ -f "$DB_FILE" ]; then
    # Backup database before migration
    BACKUP_FILE="$TARGET_DIR/backups/planning_$(date +%Y%m%d_%H%M%S).db"
    mkdir -p "$TARGET_DIR/backups"
    cp "$DB_FILE" "$BACKUP_FILE"
    echo -e "  ‚úì Database backed up: $(basename $BACKUP_FILE)"

    # Run Alembic migrations (suppress expected errors, log to file)
    cd "$TARGET_DIR"
    if [ -d "migrations" ]; then
        ALEMBIC_OUTPUT=$("$TARGET_DIR/venv/bin/alembic" upgrade head 2>&1 || true)
        echo "$ALEMBIC_OUTPUT" > "$MIGRATION_LOG"

        # Check if there were real errors (not expected "no such column" errors)
        if echo "$ALEMBIC_OUTPUT" | grep -q "ERROR" && ! echo "$ALEMBIC_OUTPUT" | grep -q "no such column: content"; then
            echo -e "${RED}  ‚ö† Migration errors detected (see $MIGRATION_LOG)${NC}"
        else
            echo -e "  ‚úì Alembic migrations checked"
        fi
    fi

    # Run custom migration scripts if they exist (silently, log errors only)
    MIGRATION_ERRORS=""
    if [ -f "$TARGET_DIR/scripts/apply_feedback_migration.py" ]; then
        "$TARGET_DIR/venv/bin/python3" "$TARGET_DIR/scripts/apply_feedback_migration.py" >> "$MIGRATION_LOG" 2>&1 || MIGRATION_ERRORS+="feedback "
    fi

    if [ -f "$TARGET_DIR/scripts/apply_feedback_content_migration.py" ]; then
        "$TARGET_DIR/venv/bin/python3" "$TARGET_DIR/scripts/apply_feedback_content_migration.py" >> "$MIGRATION_LOG" 2>&1 || MIGRATION_ERRORS+="feedback_content "
    fi

    if [ -f "$TARGET_DIR/scripts/add_super_admin_flag.py" ]; then
        "$TARGET_DIR/venv/bin/python3" "$TARGET_DIR/scripts/add_super_admin_flag.py" >> "$MIGRATION_LOG" 2>&1 || MIGRATION_ERRORS+="super_admin "
    fi

    if [ -n "$MIGRATION_ERRORS" ]; then
        echo -e "  ‚Ñπ Some migrations skipped (already applied): $MIGRATION_ERRORS"
    fi

    echo -e "  ‚úì Database migrations completed"
else
    echo -e "  ‚Ñπ Database will be created on first run"
fi

# Set ownership to www-data
echo -e "${YELLOW}‚Üí Setting permissions...${NC}"
chown -R www-data:www-data "$TARGET_DIR"
chmod -R 755 "$TARGET_DIR"
chmod -R 775 "$TARGET_DIR/data"
chmod -R 775 "$TARGET_DIR/logs"
chmod -R 775 "$TARGET_DIR/backups" 2>/dev/null || mkdir -p "$TARGET_DIR/backups" && chmod -R 775 "$TARGET_DIR/backups"
echo -e "  ‚úì Permissions set"

# Copy Apache configuration
echo -e "${YELLOW}‚Üí Configuring Apache...${NC}"
cp "$APACHE_CONFIG_SOURCE" "$APACHE_CONFIG_TARGET"
chmod 644 "$APACHE_CONFIG_TARGET"
a2enmod proxy proxy_http headers >/dev/null 2>&1 || true
a2ensite rps.pan2.app.conf >/dev/null 2>&1
echo -e "  ‚úì Apache configured"

# Create systemd service file
echo -e "${YELLOW}‚Üí Creating systemd service...${NC}"
cat > "/etc/systemd/system/${SERVICE_NAME}.service" << EOF
[Unit]
Description=RPS - Retirement and Wealth Planning System
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=$TARGET_DIR
Environment="PATH=$TARGET_DIR/venv/bin"
Environment="MPLCONFIGDIR=$TARGET_DIR/.config/matplotlib"
Environment="FLASK_ENV=production"
Environment="SESSION_COOKIE_SECURE=false"
ExecStart=$TARGET_DIR/venv/bin/gunicorn -w 4 -b 127.0.0.1:5137 --access-logfile - --error-logfile - "src.app:create_app('production')"
Restart=always
RestartSec=10
StandardOutput=append:$TARGET_DIR/logs/rps.log
StandardError=append:$TARGET_DIR/logs/rps-error.log

[Install]
WantedBy=multi-user.target
EOF

# Validate application can start
echo -e "${YELLOW}‚Üí Validating application...${NC}"
cd "$TARGET_DIR"
VALIDATION_OUTPUT=$("$TARGET_DIR/venv/bin/python" -c "from src.app import create_app; create_app('production')" 2>&1)
if [ $? -ne 0 ]; then
    echo -e "${RED}  ‚úó Application failed to load${NC}"
    echo "$VALIDATION_OUTPUT"
    exit 1
fi
echo -e "  ‚úì Application validated"

# Reload systemd
echo -e "${YELLOW}‚Üí Restarting services...${NC}"
systemctl daemon-reload
systemctl enable "$SERVICE_NAME" >/dev/null 2>&1
systemctl restart "$SERVICE_NAME"

# Test Apache configuration
APACHE_TEST=$(apache2ctl configtest 2>&1)
if [ $? -eq 0 ]; then
    systemctl reload apache2
    echo -e "  ‚úì Apache reloaded"
else
    echo -e "${RED}  ‚úó Apache configuration error${NC}"
    echo "$APACHE_TEST"
    exit 1
fi

echo -e "  ‚úì RPS service restarted"

# Check service status and extract version
echo ""
echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${GREEN}‚ïë                    DEPLOYMENT COMPLETE                         ‚ïë${NC}"
echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# Extract and display version prominently
if [ -f "$TARGET_DIR/src/__version__.py" ]; then
    VERSION=$(grep '^__version__' "$TARGET_DIR/src/__version__.py" | cut -d'"' -f2)
    RELEASE_DATE=$(grep '^__release_date__' "$TARGET_DIR/src/__version__.py" | cut -d'"' -f2)
    RELEASE_NOTES=$(grep '^__release_notes__' "$TARGET_DIR/src/__version__.py" | cut -d'"' -f2)
    
    # Get Git info
    GIT_COMMIT=$(cd "$SOURCE_DIR" && git rev-parse --short HEAD 2>/dev/null || echo "unknown")
    GIT_SUBJECT=$(cd "$SOURCE_DIR" && git log -1 --format=%s 2>/dev/null || echo "unknown")

    echo -e "${GREEN}üì¶ Version:${NC}      $VERSION"
    echo -e "${GREEN}üìÖ Released:${NC}     $RELEASE_DATE"
    echo -e "${GREEN}üöÄ Deployed:${NC}     $(date '+%Y-%m-%d %H:%M:%S')"
    echo -e "${GREEN}Commit:${NC}       $GIT_COMMIT - $GIT_SUBJECT"
    echo -e "${GREEN}üìù Changes:${NC}      $RELEASE_NOTES"
    echo ""
fi

# Technical details
echo -e "${YELLOW}üîß Technical Details:${NC}"
echo "   Deployed to:      $TARGET_DIR"
echo "   Service:          $SERVICE_NAME"
echo "   Python:           $(python3 --version | cut -d' ' -f2)"
echo "   Gunicorn workers: 4"
echo "   Port (internal):  5137"
echo "   Port (external):  8087"
echo ""

# Service status
SERVICE_STATUS=$(systemctl is-active "$SERVICE_NAME")
if [ "$SERVICE_STATUS" = "active" ]; then
    echo -e "${GREEN}‚úì Service Status:${NC} Running"
else
    echo -e "${RED}‚úó Service Status:${NC} $SERVICE_STATUS"
fi

# Show running process info
SERVICE_PID=$(systemctl show -p MainPID --value "$SERVICE_NAME")
if [ "$SERVICE_PID" != "0" ]; then
    UPTIME=$(ps -p "$SERVICE_PID" -o etime= | xargs)
    echo "   Main PID:         $SERVICE_PID (uptime: $UPTIME)"
fi
echo ""

# Access URLs
echo -e "${YELLOW}üåê Access URLs:${NC}"
echo "   https://rps.pan2.app                 (Production - via Cloudflare)"
echo "   http://192.168.87.50:8087            (Local network - by IP)"
echo "   http://nas:8087                      (Local network - by hostname)"
echo ""

# Quick reference
echo -e "${YELLOW}üìö Quick Commands:${NC}"
echo "   sudo systemctl status $SERVICE_NAME"
echo "   sudo systemctl restart $SERVICE_NAME"
echo "   sudo journalctl -u $SERVICE_NAME -f"
echo "   tail -f $TARGET_DIR/logs/rps.log"
