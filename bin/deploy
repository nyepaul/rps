#!/bin/bash
# Deploy RPS to /var/www/rps.pan2.app/
# This script copies the application to the Apache web directory and sets up configuration

set -e  # Exit on error

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Configuration
SOURCE_DIR="/home/paul/src/rps"
TARGET_DIR="/var/www/rps.pan2.app"
APACHE_CONFIG_SOURCE="${SOURCE_DIR}/apache2/rps.pan2.app.conf"
APACHE_CONFIG_TARGET="/etc/apache2/sites-available/rps.pan2.app.conf"
SERVICE_NAME="rps"

echo -e "${GREEN}=== RPS Deployment Script ===${NC}"
echo ""

# Check if running as root or with sudo
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: This script must be run as root or with sudo${NC}"
    echo "Usage: sudo ./bin/deploy"
    exit 1
fi

# Create target directory if it doesn't exist
echo -e "${YELLOW}Creating target directory...${NC}"
mkdir -p "$TARGET_DIR"

# Copy application files (excluding venv, cache, data, logs, etc.)
echo -e "${YELLOW}Copying application files...${NC}"
rsync -av --delete \
    --exclude='*.pyc' \
    --exclude='__pycache__' \
    --exclude='src/venv' \
    --exclude='venv' \
    --exclude='.git' \
    --exclude='data/*.db' \
    --exclude='data/*.db-*' \
    --exclude='logs' \
    --exclude='backups' \
    --exclude='.pytest_cache' \
    --exclude='*.log' \
    --exclude='.claude' \
    --exclude='.idea' \
    --exclude='.vscode' \
    --exclude='.DS_Store' \
    --exclude='*.swp' \
    --exclude='*.swo' \
    "$SOURCE_DIR/" "$TARGET_DIR/"

# Create necessary directories
echo -e "${YELLOW}Creating data and logs directories...${NC}"
mkdir -p "$TARGET_DIR/data"
mkdir -p "$TARGET_DIR/logs"

# Set up Python virtual environment
echo -e "${YELLOW}Setting up Python virtual environment...${NC}"
if [ ! -f "$TARGET_DIR/venv/bin/pip" ] || ! "$TARGET_DIR/venv/bin/pip" --version > /dev/null 2>&1; then
    echo -e "${YELLOW}Creating (or recreating broken) virtual environment...${NC}"
    rm -rf "$TARGET_DIR/venv"
    python3 -m venv "$TARGET_DIR/venv"
fi

# Install dependencies
echo -e "${YELLOW}Installing Python dependencies...${NC}"
"$TARGET_DIR/venv/bin/pip" install --upgrade pip
"$TARGET_DIR/venv/bin/pip" install -r "$TARGET_DIR/requirements.txt"

# Set ownership to www-data
echo -e "${YELLOW}Setting file ownership to www-data...${NC}"
chown -R www-data:www-data "$TARGET_DIR"
chmod -R 755 "$TARGET_DIR"
chmod -R 775 "$TARGET_DIR/data"
chmod -R 775 "$TARGET_DIR/logs"

# Copy Apache configuration
echo -e "${YELLOW}Installing Apache configuration...${NC}"
cp "$APACHE_CONFIG_SOURCE" "$APACHE_CONFIG_TARGET"
chmod 644 "$APACHE_CONFIG_TARGET"

# Enable required Apache modules
echo -e "${YELLOW}Enabling Apache modules...${NC}"
a2enmod proxy proxy_http headers || true

# Enable site
echo -e "${YELLOW}Enabling RPS site...${NC}"
a2ensite rps.pan2.app.conf

# Create systemd service file
echo -e "${YELLOW}Creating systemd service...${NC}"
cat > "/etc/systemd/system/${SERVICE_NAME}.service" << EOF
[Unit]
Description=RPS - Retirement and Wealth Planning System
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=$TARGET_DIR
Environment="PATH=$TARGET_DIR/venv/bin"
Environment="MPLCONFIGDIR=$TARGET_DIR/.config/matplotlib"
Environment="FLASK_ENV=production"
ExecStart=$TARGET_DIR/venv/bin/gunicorn -w 4 -b 127.0.0.1:5137 --access-logfile - --error-logfile - "src.app:create_app('production')"
Restart=always
RestartSec=10
StandardOutput=append:$TARGET_DIR/logs/rps.log
StandardError=append:$TARGET_DIR/logs/rps-error.log

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd
echo -e "${YELLOW}Reloading systemd...${NC}"
systemctl daemon-reload

# Enable and start the service
echo -e "${YELLOW}Enabling and starting RPS service...${NC}"
systemctl enable "$SERVICE_NAME"
systemctl restart "$SERVICE_NAME"

# Test Apache configuration
echo -e "${YELLOW}Testing Apache configuration...${NC}"
if apache2ctl configtest; then
    echo -e "${GREEN}Apache configuration is valid${NC}"
else
    echo -e "${RED}Apache configuration has errors!${NC}"
    exit 1
fi

# Reload Apache
echo -e "${YELLOW}Reloading Apache...${NC}"
systemctl reload apache2

# Check service status
echo ""
echo -e "${GREEN}=== Deployment Summary ===${NC}"
echo ""
echo "Application deployed to: $TARGET_DIR"
echo "Apache config: $APACHE_CONFIG_TARGET"
echo "Service name: $SERVICE_NAME"
echo ""
echo -e "${YELLOW}Service Status:${NC}"
systemctl status "$SERVICE_NAME" --no-pager | head -10
echo ""
echo -e "${GREEN}Deployment complete!${NC}"
echo ""
echo "Access the application:"
echo "  - Direct to Flask:  http://localhost:5137"
echo "  - Via Apache:       http://localhost:8087"
echo "  - External:         https://rps.pan2.app (via Cloudflare Tunnel)"
echo ""
echo -e "${YELLOW}IMPORTANT:${NC} Configure Cloudflare Tunnel to point to http://localhost:8087"
echo ""
echo "Useful commands:"
echo "  sudo systemctl status $SERVICE_NAME    # Check service status"
echo "  sudo systemctl restart $SERVICE_NAME   # Restart service"
echo "  sudo journalctl -u $SERVICE_NAME -f    # View logs"
echo "  tail -f $TARGET_DIR/logs/rps.log    # View application logs"
