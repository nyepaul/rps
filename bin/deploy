#!/bin/bash
# Deploy RPS to /var/www/rps.pan2.app/
# This script copies the application to the Apache web directory and sets up configuration

set -e  # Exit on error

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Configuration
SOURCE_DIR="/home/paul/src/rps"
TARGET_DIR="/var/www/rps.pan2.app"
APACHE_CONFIG_SOURCE="${SOURCE_DIR}/apache2/rps.pan2.app.conf"
APACHE_CONFIG_TARGET="/etc/apache2/sites-available/rps.pan2.app.conf"
SERVICE_NAME="rps"
PREV_COMMIT_FILE="$TARGET_DIR/DEPLOYED_COMMIT"

# --- 1. PRE-DEPLOYMENT INFO ---

# Extract version information from source (fail gracefully if missing)
VERSION="unknown"
RELEASE_DATE="unknown"
RELEASE_NOTES="unknown"
if [ -f "$SOURCE_DIR/src/static/version.json" ]; then
    VERSION=$(grep '"version":' "$SOURCE_DIR/src/static/version.json" | cut -d'"' -f4)
    RELEASE_DATE=$(grep '"release_date":' "$SOURCE_DIR/src/static/version.json" | cut -d'"' -f4)
    RELEASE_NOTES=$(grep '"release_notes":' "$SOURCE_DIR/src/static/version.json" | cut -d'"' -f4)
fi

echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘              RPS Deployment to Production                      â•‘${NC}"
echo -e "${GREEN}â•‘              Version: $VERSION                            â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Show Tech Details Early
echo -e "${YELLOW}ğŸ”§ Deployment Specifications:${NC}"
echo "   Source Directory: $SOURCE_DIR"
echo "   Target Directory: $TARGET_DIR"
echo "   Service Name:     $SERVICE_NAME"
echo "   Python Version:   $(python3 --version | cut -d' ' -f2)"
echo "   OS:               $(lsb_release -ds 2>/dev/null || cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2 || uname -sr)"
echo "   Disk Space:       $(df -h "$TARGET_DIR" | tail -1 | awk '{print $4 " available on " $6}')"
echo "   Memory:           $(free -h | grep Mem | awk '{print $2 " total, " $4 " free"}')"
echo ""

# Check if running as root or with sudo
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: This script must be run as root or with sudo${NC}"
    echo "Usage: sudo ./bin/deploy"
    exit 1
fi

# Capture previous commit before pulling or modifying anything
PREV_COMMIT=""
if [ -f "$PREV_COMMIT_FILE" ]; then
    PREV_COMMIT=$(cat "$PREV_COMMIT_FILE")
fi

# --- 2. DEPLOYMENT STEPS ---

# Pull latest code from git
echo -e "${YELLOW}â†’ Pulling latest code from git...${NC}"
cd "$SOURCE_DIR"
sudo -u paul git pull 2>&1 | grep -E "Already up to date|Updating|Fast-forward" || {
    echo -e "${RED}  âš  Warning: git pull had issues (may have local changes)${NC}"
}

# Capture git info after pull
CURRENT_COMMIT_FULL=$(git rev-parse HEAD)
GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
GIT_SUBJECT=$(git log -1 --format=%s 2>/dev/null || echo "unknown")

# Create target directory if it doesn't exist
echo -e "${YELLOW}Creating target directory...${NC}"
mkdir -p "$TARGET_DIR"

# Copy application files (excluding venv, cache, data, logs, etc.)
echo -e "${YELLOW}â†’ Syncing application files...${NC}"
rsync -a --delete \
    --exclude='*.pyc' \
    --exclude='__pycache__' \
    --exclude='src/venv' \
    --exclude='venv' \
    --exclude='.git' \
    --exclude='data/*.db' \
    --exclude='data/*.db-*' \
    --exclude='logs' \
    --exclude='backups' \
    --exclude='.pytest_cache' \
    --exclude='*.log' \
    --exclude='.claude' \
    --exclude='.idea' \
    --exclude='.vscode' \
    --exclude='.DS_Store' \
    --exclude='*.swp' \
    --exclude='*.swo' \
    --exclude='DEPLOYED_COMMIT' \
    "$SOURCE_DIR/" "$TARGET_DIR/"
echo -e "  âœ“ Files synced"

# Create necessary directories
echo -e "${YELLOW}Creating data and logs directories...${NC}"
mkdir -p "$TARGET_DIR/data"
mkdir -p "$TARGET_DIR/logs"

# Set up Python virtual environment
echo -e "${YELLOW}â†’ Checking Python virtual environment...${NC}"
if [ ! -f "$TARGET_DIR/venv/bin/pip" ] || ! "$TARGET_DIR/venv/bin/pip" --version > /dev/null 2>&1; then
    echo -e "  Creating virtual environment..."
    rm -rf "$TARGET_DIR/venv"
    python3 -m venv "$TARGET_DIR/venv"
fi
echo -e "  âœ“ Virtual environment ready"

# Install dependencies
echo -e "${YELLOW}â†’ Installing Python dependencies...${NC}"
"$TARGET_DIR/venv/bin/pip" install --quiet --upgrade pip 2>&1 | grep -E "ERROR|WARNING" || true
PIP_OUTPUT=$("$TARGET_DIR/venv/bin/pip" install --quiet -r "$TARGET_DIR/requirements.txt" 2>&1)
if [ $? -eq 0 ]; then
    echo -e "  âœ“ Dependencies installed"
else
    echo -e "${RED}  âš  Dependency installation had warnings${NC}"
    echo "$PIP_OUTPUT" | grep -E "ERROR|WARNING"
fi

# Run database migrations
echo -e "${YELLOW}â†’ Running database migrations...${NC}"
DB_FILE="$TARGET_DIR/data/planning.db"
MIGRATION_LOG="$TARGET_DIR/logs/migration.log"

if [ -f "$DB_FILE" ]; then
    # Backup database before migration
    BACKUP_FILE="$TARGET_DIR/backups/planning_$(date +%Y%m%d_%H%M%S).db"
    mkdir -p "$TARGET_DIR/backups"
    cp "$DB_FILE" "$BACKUP_FILE"
    echo -e "  âœ“ Database backed up: $(basename $BACKUP_FILE)"

    # Run Alembic migrations (suppress expected errors, log to file)
    cd "$TARGET_DIR"
    if [ -d "migrations" ]; then
        ALEMBIC_OUTPUT=$("$TARGET_DIR/venv/bin/alembic" upgrade head 2>&1 || true)
        echo "$ALEMBIC_OUTPUT" > "$MIGRATION_LOG"

        # Check if there were real errors (not expected "no such column" errors)
        if echo "$ALEMBIC_OUTPUT" | grep -q "ERROR" && ! echo "$ALEMBIC_OUTPUT" | grep -q "no such column: content"; then
            echo -e "${RED}  âš  Migration errors detected (see $MIGRATION_LOG)${NC}"
        else
            echo -e "  âœ“ Alembic migrations checked"
        fi
    fi

    # Run custom migration scripts if they exist (silently, log errors only)
    MIGRATION_ERRORS=""
    if [ -f "$TARGET_DIR/scripts/apply_feedback_migration.py" ]; then
        "$TARGET_DIR/venv/bin/python3" "$TARGET_DIR/scripts/apply_feedback_migration.py" >> "$MIGRATION_LOG" 2>&1 || MIGRATION_ERRORS+="feedback "
    fi

    if [ -f "$TARGET_DIR/scripts/apply_feedback_content_migration.py" ]; then
        "$TARGET_DIR/venv/bin/python3" "$TARGET_DIR/scripts/apply_feedback_content_migration.py" >> "$MIGRATION_LOG" 2>&1 || MIGRATION_ERRORS+="feedback_content "
    fi

    if [ -f "$TARGET_DIR/scripts/add_super_admin_flag.py" ]; then
        "$TARGET_DIR/venv/bin/python3" "$TARGET_DIR/scripts/add_super_admin_flag.py" >> "$MIGRATION_LOG" 2>&1 || MIGRATION_ERRORS+="super_admin "
    fi

    if [ -n "$MIGRATION_ERRORS" ]; then
        echo -e "  â„¹ Some migrations skipped (already applied): $MIGRATION_ERRORS"
    fi

    echo -e "  âœ“ Database migrations completed"
else
    echo -e "  â„¹ Database will be created on first run"
fi

# Set ownership to www-data
echo -e "${YELLOW}â†’ Setting permissions...${NC}"
chown -R www-data:www-data "$TARGET_DIR"
chmod -R 755 "$TARGET_DIR"
chmod -R 775 "$TARGET_DIR/data"
chmod -R 775 "$TARGET_DIR/logs"
chmod -R 775 "$TARGET_DIR/backups" 2>/dev/null || mkdir -p "$TARGET_DIR/backups" && chmod -R 775 "$TARGET_DIR/backups"
echo -e "  âœ“ Permissions set"

# Copy Apache configuration
echo -e "${YELLOW}â†’ Configuring Apache...${NC}"
cp "$APACHE_CONFIG_SOURCE" "$APACHE_CONFIG_TARGET"
chmod 644 "$APACHE_CONFIG_TARGET"
a2enmod proxy proxy_http headers >/dev/null 2>&1 || true
a2ensite rps.pan2.app.conf >/dev/null 2>&1
echo -e "  âœ“ Apache configured"

# Create systemd service file
echo -e "${YELLOW}â†’ Creating systemd service...${NC}"
cat > "/etc/systemd/system/${SERVICE_NAME}.service" << EOF
[Unit]
Description=RPS - Retirement and Wealth Planning System
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=$TARGET_DIR
Environment="PATH=$TARGET_DIR/venv/bin"
Environment="MPLCONFIGDIR=$TARGET_DIR/.config/matplotlib"
Environment="FLASK_ENV=production"
Environment="SESSION_COOKIE_SECURE=false"
ExecStart=$TARGET_DIR/venv/bin/gunicorn -w 4 --timeout 600 -b 127.0.0.1:5137 --access-logfile - --error-logfile - "src.app:create_app('production')"
Restart=always
RestartSec=10
StandardOutput=append:$TARGET_DIR/logs/rps.log
StandardError=append:$TARGET_DIR/logs/rps-error.log

[Install]
WantedBy=multi-user.target
EOF

# Validate application can start (with timeout)
echo -e "${YELLOW}â†’ Validating application...${NC}"
cd "$TARGET_DIR"
if command -v timeout >/dev/null 2>&1; then
    TIMEOUT_CMD="timeout 15s"
else
    TIMEOUT_CMD=""
fi

# Show real-time output for validation to diagnose hangs
set +e
VALIDATION_ERROR=$( $TIMEOUT_CMD "$TARGET_DIR/venv/bin/python" -c "from src.app import create_app; create_app('production'); print('Application factory successfully loaded.')" 2>&1 )
RET_CODE=$?
set -e

if [ $RET_CODE -eq 124 ]; then
    echo -e "${RED}  âœ— Application validation timed out (15s).${NC}"
    echo -e "    ${YELLOW}Note: This often happens if Redis is not running or ENCRYPTION_KEY is missing.${NC}"
elif [ $RET_CODE -ne 0 ]; then
    echo -e "${RED}  âœ— Application failed to load:${NC}"
    echo "$VALIDATION_ERROR" | sed 's/^/    /'
    exit 1
else
    echo -e "  âœ“ Application validated: $(echo "$VALIDATION_ERROR" | tail -1)"
fi

# Reload systemd
echo -e "${YELLOW}â†’ Restarting services...${NC}"
systemctl daemon-reload
systemctl enable "$SERVICE_NAME" >/dev/null 2>&1
systemctl restart "$SERVICE_NAME"

# Test Apache configuration
APACHE_TEST=$(apache2ctl configtest 2>&1)
if [ $? -eq 0 ]; then
    systemctl reload apache2
    echo -e "  âœ“ Apache reloaded"
else
    echo -e "${RED}  âœ— Apache configuration error${NC}"
    echo "$APACHE_TEST"
    exit 1
fi

echo -e "  âœ“ RPS service restarted"

# Save current commit for next time
echo "$CURRENT_COMMIT_FULL" > "$PREV_COMMIT_FILE"
chown www-data:www-data "$PREV_COMMIT_FILE"

# --- 3. FINAL REPORT ---

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘                    DEPLOYMENT COMPLETE                         â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# --- TECH REPORT SECTION ---
echo -e "${YELLOW}ğŸ“‹ Deployment Tech Report (Changelog):${NC}"
cd "$SOURCE_DIR"
if [ -n "$PREV_COMMIT" ] && [ "$PREV_COMMIT" != "$CURRENT_COMMIT_FULL" ]; then
     echo "   Changes since last deployment ($PREV_COMMIT):"
     echo "   --------------------------------------------"
     git --no-pager log --pretty=format:"   * %h - %s (%an, %ar)" "$PREV_COMMIT..HEAD"
     echo ""
     echo ""
     echo "   Files modified:"
     git --no-pager diff --stat "$PREV_COMMIT..HEAD" | sed 's/^/   /'
elif [ "$PREV_COMMIT" == "$CURRENT_COMMIT_FULL" ]; then
     echo "   No code changes detected since last deployment."
else
     echo "   First deployment with tracking or history unavailable."
     echo "   Recent commits:"
     git --no-pager log -n 5 --pretty=format:"   * %h - %s (%an, %ar)"
fi
echo ""

# Final Status
SERVICE_STATUS=$(systemctl is-active "$SERVICE_NAME")
if [ "$SERVICE_STATUS" = "active" ]; then
    echo -e "${GREEN}âœ“ Service Status:${NC} Running"
    SERVICE_PID=$(systemctl show -p MainPID --value "$SERVICE_NAME")
    UPTIME=$(ps -p "$SERVICE_PID" -o etime= | xargs)
    echo "   Main PID:         $SERVICE_PID (uptime: $UPTIME)"
else
    echo -e "${RED}âœ— Service Status:${NC} $SERVICE_STATUS"
fi
echo ""

# Access URLs
echo -e "${YELLOW}ğŸŒ Access URLs:${NC}"
echo "   https://rps.pan2.app                 (Production - via Cloudflare)"
echo "   http://192.168.87.50:8087            (Local network - by IP)"
echo "   http://nas:8087                      (Local network - by hostname)"
echo ""

# Quick reference
echo -e "${YELLOW}ğŸ“š Quick Commands:${NC}"
echo "   sudo systemctl status $SERVICE_NAME"
echo "   sudo systemctl restart $SERVICE_NAME"
echo "   sudo journalctl -u $SERVICE_NAME -f"
echo "   tail -f $TARGET_DIR/logs/rps.log"
echo ""

# DISPLAY VERSION SUMMARY LAST
echo -e "${GREEN}ğŸ“¦ Version:${NC}      $VERSION"
echo -e "${GREEN}ğŸ“… Released:${NC}     $RELEASE_DATE"
echo -e "${GREEN}ğŸš€ Deployed:${NC}     $(date '+%Y-%m-%d %H:%M:%S')"
echo -e "${GREEN}Commit:${NC}       $GIT_COMMIT - $GIT_SUBJECT"
echo -e "${GREEN}ğŸ“ Changes:${NC}      $RELEASE_NOTES"
echo ""